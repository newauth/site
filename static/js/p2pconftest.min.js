'use strict';var sseconnecturl="/newauth/api/joinConversation/",confpostmsgurl="/newauth/api/addmessagetoconversation/";navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate;
window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;var confflake,confusername,localStream=null,confpostmsgconnection=null,confsseeventsource=null,localUser;const configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};let room,pc;
function findconfusers(){var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("POST","/newauth/api/getflakeconfusers/"+confflake+"/"+confusername,!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var b=c.responseText;null!=b&&0<b.length&&(b=JSON.parse(b).length,startWebRTC(2===b))}};c.send(null)}function onSuccess(){}function onError(c){console.error(c)}
function loadconfstartbutton(c){var b=document.getElementById("flakeconfmodallaunchbutton"),a=document.createElement("a");a.setAttribute("data-toggle","modal");a.setAttribute("href","#flake-conf-start-modal");var d=document.createElement("img");d.src="/static/icons/video-call-64.png";d.width="40";d.height="40";a.appendChild(d);b.appendChild(a);"undefined"!==typeof c&&(document.getElementById("auto-join-conf").value=c,b.classList.add("fadeInOut"),c=document.createElement("p"),c.setAttribute("id","JoinConfNotification"),
c.appendChild(document.createTextNode("Conference in progress. Click to join.")),b.appendChild(c))}
function joinflakeconference(c){var b=document.createElement("input");document.body.appendChild(b);b.setAttribute("value",newauthurl+"/f/"+c);b.select();document.execCommand("copy");document.body.removeChild(b);b=document.getElementById("conferencecontainerRow");var a=document.getElementById("confmodalbody");null!=a&&null!=b&&(a.innerHTML="",a.appendChild(b),b.style.display="block");establishFlakeConfSSEConnection(findconfusers,c)}
function exitflakeconference(){null!=localStream&&(localStream.getTracks().forEach(function(b){console.log("stopping track "+b.id);b.stop()}),console.log("stopped local video"));var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("GET","/newauth/api/dropfromFlakeConf/"+confflake+"/"+confusername,!1);c.withCredentials=!0;c.send(null);null!=confsseeventsource&&(confsseeventsource.close(),confsseeventsource=null,console.log("conf SSE event source closed"));$("#flake-conf-start-modal").modal("hide")}
function establishFlakeConfSSEConnection(c,b){confflake=b;null!=confusername?localUser=confusername:(confusername=Math.floor(1E3*Math.random()),console.log("passing a random username "+confusername),localUser=confusername,null!=document.getElementById("localstreamnamedisplay")&&(document.getElementById("localstreamnamedisplay").innerText=confusername));null==confpostmsgconnection&&(confpostmsgconnection=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),confpostmsgconnection.open("POST",
confpostmsgurl+confflake+"/"+confusername,!1),confpostmsgconnection.withCredentials=!0,confpostmsgconnection.setRequestHeader("Content-Type","application/json"));"undefined"!==typeof EventSource?null==confsseeventsource?(confsseeventsource=new EventSource(sseconnecturl+confflake+"/"+confusername),confsseeventsource.onerror=function(){console.log("EventSource "+sseconnecturl+confflake+"/"+confusername+" failed to connect.");document.getElementById("flake-conf-updates").innerText="EventSource "+sseconnecturl+
confflake+"/"+confusername+" failed to connect."},confsseeventsource.addEventListener("open",c),console.log("Connected to conf SSE event source"),document.getElementById("flake-conf-updates").innerText="Connected to conf SSE event source",confsseeventsource.onmessage=function(a){0==a.data.length?document.getElementById("flake-conf-updates").innerText+="NO data in message event ":(a=JSON.parse(a.data),"undefined"!==typeof a.message&&"undefined"!==typeof a.message.type&&"user_left"===a.message.type&&
(document.getElementById("flake-conf-updates").innerText+="message received "+JSON.stringify(a.message)),a.sdp?document.getElementById("flake-conf-updates").innerText+="sdp event data received "+JSON.stringify(a.sdp):a.candidate&&(document.getElementById("flake-conf-updates").innerText+="candidate received "+JSON.stringify(a.candidate)))}):(console.log("Conf SSE event source is aleady connected"),c()):document.getElementById("flake-conf-updates").innerText="This browser does not support EventSource API. Instant messsaging will not work."}
function sendMessage(c,b,a,d){confpostmsgconnection=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");confpostmsgconnection.open("POST","/newauth/api/addmessagetoconversation/",!1);confpostmsgconnection.withCredentials=!0;confpostmsgconnection.setRequestHeader("Content-Type","application/json");c="undefined"===typeof d||0==d.length?JSON.stringify({sender:{phones:[a]},message:c,sdp:"sdp here",conversationID:b,permanent:"false"}):JSON.stringify({sender:{flake:d},message:c,
sdp:"sdp here",conversationID:b,permanent:"false"});confpostmsgconnection.send(c)}
function startWebRTC(c){pc=new RTCPeerConnection(configuration);pc.onicecandidate=function(b){b.candidate&&sendMessage({candidate:b.candidate})};c&&(pc.onnegotiationneeded=function(){pc.createOffer().then(localDescCreated).catch(onError)});pc.ontrack=function(b){console.log("gotRemotetrack",b.track);var a=document.getElementById("remoteVideo");if(null==a){var c=document.getElementById("conferenceRow");a=document.createElement("video");a.setAttribute("id","remoteVideo");a.autoplay=!0;a.playsinline=
!0;c.appendChild(a)}try{if(null==a.srcObject){a.srcObject=new MediaStream;a.srcObject.addTrack(b.track,a.srcObject);console.log("remote stream attached to remotevideo.srcobject ID "+b.track.id+" muted "+b.track.muted);a.style.height="60%";a.style.width="100%";a.style.zIndex=0;var e=document.getElementById("localVideo");e.style.position="absolute";e.style.height="100px";e.style.width="100px";e.style.bottom="5px";e.style.right="5px";e.style.zIndex=a.style.zIndex+1}else a.srcObject.addTrack(b.track,
a.srcObject)}catch(f){console.log("exception in remote stream attached to remotevideo.srcbj, setting remotevideo.src instead ",f),a.src=window.URL.createObjectURL(b.stream)}};navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(b){var a=document.getElementById("localVideo");localStream=b;a.srcObject=b;b.getTracks().forEach(function(a){pc.addTrack(a,b)});document.getElementById("callhangupbutton").style.display="block"},onError)}
function localDescCreated(c){pc.setLocalDescription(c,function(){sendMessage({sdp:pc.localDescription})},onError)}function displayflakechatmodal(c){$("#display-flake-messages-modal").modal("show")};