'use strict';var sseconnecturl="/newauth/api/joinFlakeConf/",confpostmsgurl="/newauth/api/sendmessagetoflakeconfuser/";navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate;
window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;var confflake,confusername,localStream=null,confpostmsgconnection=null,confsseeventsource=null,localUser;const configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};let room,pc;
function findconfusers(){var a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("POST","/newauth/api/getflakeconfusers/"+confflake+"/"+confusername,!1);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var b=a.responseText;null!=b&&0<b.length&&(b=JSON.parse(b).length,startWebRTC(2===b))}};a.send(null)}function onSuccess(){}function onError(a){console.error(a)}
function loadconfstartbutton(a){var b=document.getElementById("flakeconfmodallaunchbutton"),c=document.createElement("a");c.setAttribute("data-toggle","modal");c.setAttribute("href","#flake-conf-start-modal");var d=document.createElement("img");d.src="/static/icons/video-call-64.png";d.width="40";d.height="40";c.appendChild(d);b.appendChild(c);"undefined"!==typeof a&&(document.getElementById("auto-join-conf").value=a,b.classList.add("fadeInOut"),a=document.createElement("p"),a.setAttribute("id","JoinConfNotification"),
a.appendChild(document.createTextNode("Conference in progress. Click to join.")),b.appendChild(a))}
function joinflakeconference(a){var b=document.createElement("input");document.body.appendChild(b);b.setAttribute("value",newauthurl+"/f/"+a);b.select();document.execCommand("copy");document.body.removeChild(b);b=document.getElementById("conferencecontainerRow");var c=document.getElementById("confmodalbody");null!=c&&null!=b&&(c.innerHTML="",c.appendChild(b),b.style.display="block");establishFlakeConfSSEConnection(findconfusers,a)}
function exitflakeconference(){null!=localStream&&(localStream.getTracks().forEach(function(b){console.log("stopping track "+b.id);b.stop()}),console.log("stopped local video"));var a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("GET","/newauth/api/dropfromFlakeConf/"+confflake+"/"+confusername,!1);a.withCredentials=!0;a.send(null);null!=confsseeventsource&&(confsseeventsource.close(),confsseeventsource=null,console.log("conf SSE event source closed"));$("#flake-conf-start-modal").modal("hide")}
function establishFlakeConfSSEConnection(a,b){confflake=b;null!=confusername?localUser=confusername:(confusername=Math.floor(1E3*Math.random()),console.log("passing a random username "+confusername),localUser=confusername,null!=document.getElementById("localstreamnamedisplay")&&(document.getElementById("localstreamnamedisplay").innerText=confusername));null==confpostmsgconnection&&(confpostmsgconnection=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),confpostmsgconnection.open("POST",
confpostmsgurl+confflake+"/"+confusername,!1),confpostmsgconnection.withCredentials=!0,confpostmsgconnection.setRequestHeader("Content-Type","application/json"));"undefined"!==typeof EventSource?null==confsseeventsource?(confsseeventsource=new EventSource(sseconnecturl+confflake+"/"+confusername),confsseeventsource.onerror=function(){console.log("EventSource "+sseconnecturl+confflake+"/"+confusername+" failed to connect.");document.getElementById("flake-conf-updates").innerText="EventSource "+sseconnecturl+
confflake+"/"+confusername+" failed to connect."},confsseeventsource.addEventListener("open",a),console.log("Connected to conf SSE event source"),document.getElementById("flake-conf-updates").innerText="Waiting for Peer.."):(console.log("Conf SSE event source is aleady connected"),a()):document.getElementById("flake-conf-updates").innerText="This browser does not support EventSource API. Instant messsaging will not work."}
function sendMessage(a){confpostmsgconnection=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");confpostmsgconnection.open("POST",confpostmsgurl+confflake+"/"+confusername,!1);confpostmsgconnection.withCredentials=!0;confpostmsgconnection.setRequestHeader("Content-Type","application/json");confpostmsgconnection.send(JSON.stringify(a))}
function startWebRTC(a){pc=new RTCPeerConnection(configuration);pc.onicecandidate=function(b){b.candidate&&sendMessage({candidate:b.candidate})};a&&(pc.onnegotiationneeded=function(){pc.createOffer().then(localDescCreated).catch(onError)});pc.ontrack=function(b){console.log("gotRemotetrack",b.track);var a=document.getElementById("remoteVideo");if(null==a){var d=document.getElementById("conferenceRow");a=document.createElement("video");a.setAttribute("id","remoteVideo");a.autoplay=!0;a.playsinline=
!0;d.appendChild(a)}try{if(null==a.srcObject){a.srcObject=new MediaStream;a.srcObject.addTrack(b.track,a.srcObject);console.log("remote stream attached to remotevideo.srcobject ID "+b.track.id+" muted "+b.track.muted);a.style.height="60%";a.style.width="100%";a.style.zIndex=0;var e=document.getElementById("localVideo");e.style.position="absolute";e.style.height="100px";e.style.width="100px";e.style.bottom="5px";e.style.right="5px";e.style.zIndex=a.style.zIndex+1}else a.srcObject.addTrack(b.track,
a.srcObject)}catch(f){console.log("exception in remote stream attached to remotevideo.srcbj, setting remotevideo.src instead ",f),a.src=window.URL.createObjectURL(b.stream)}};navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(a){var b=document.getElementById("localVideo");localStream=a;b.srcObject=a;a.getTracks().forEach(function(b){pc.addTrack(b,a)});document.getElementById("callhangupbutton").style.display="block"},onError);confsseeventsource.onmessage=function(a){if(0!=a.data.length){a=
JSON.parse(a.data);if("undefined"!==typeof a.message&&"undefined"!==typeof a.message.type&&"user_left"===a.message.type&&null!=document.getElementById("JoinConfNotification")){var b=document.getElementById("flakeconfmodallaunchbutton");null!=b&&(b.style.display="none")}a.sdp?(console.log("sdp event data received "+JSON.stringify(a)),pc.setRemoteDescription(new RTCSessionDescription(a.sdp),function(){"offer"===pc.remoteDescription.type&&pc.createAnswer().then(localDescCreated).catch(onError)},onError)):
a.candidate&&pc.addIceCandidate(new RTCIceCandidate(a.candidate),onSuccess,onError)}}}function localDescCreated(a){pc.setLocalDescription(a,function(){sendMessage({sdp:pc.localDescription})},onError)}function displayflakechatmodal(a){$("#display-flake-messages-modal").modal("show")};