'use strict';var orgdatainsystem,orgownerflake,orgpublickey,orgID,orgkey="";
function submitencorgdata(b,a,f){if(f){if("org-secure"===a&&(0==document.getElementById("org-secure-sitepwd").value.length||0==document.getElementById("org-secure-siteuser").value.length||0==document.getElementById("org-secure-siteUrl").value.length)||"fin"===a&&0==document.getElementById("fin-institution").value.length)return!1;createOrgData(a)}"fin"===a&&(document.getElementById(a+"-seq").value="2");"oth"===a&&(document.getElementById(a+"-seq").value="3");f=document.getElementById(a+"-data").value;
f=getEncMessageUsingPublickey(f,orgpublickey);var c="",d="";null!=document.getElementById("datetimepickerst")&&(c=document.getElementById("datetimepickerst").getElementsByTagName("INPUT")[0].value,d=document.getElementById("datetimepickeren").getElementsByTagName("INPUT")[0].value);console.log("about to add org data start date being set "+c);var e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");e.open("POST","/secure/addorgdata",!1);e.withCredentials=!0;e.setRequestHeader("Content-Type",
"application/json");e.send(JSON.stringify({group:a,salt:document.getElementById(a+"-slt").value,iterations:document.getElementById(a+"-itns").value,section:"org-credentials",seq:0,startdate:c,enddate:d,data:f,ownerflake:orgownerflake,orgid:b,publicKey:"",privateKey:"",createdate:document.getElementById(a+"-crdate").value,lastupdatedate:document.getElementById(a+"-upddate").value,dononotify:!0}));"oth"===a&&(document.getElementById(a+"-data").value=JSON.stringify(filecontentobject),document.getElementById(a+
"-data"),f=encryptwithstretchedkey(a,vaultkey),e.open("POST","/secure/addorgdata",!1),e.withCredentials=!0,e.setRequestHeader("Content-Type","application/json"),e.send(JSON.stringify({group:a,salt:document.getElementById(a+"-slt").value,iterations:document.getElementById(a+"-itns").value,data:f,sequence:filecontentobject.fileseq,createdate:document.getElementById(a+"-crdate").value,lastupdatedate:document.getElementById(a+"-upddate").value})));$("#"+a+"Modal").modal("hide");$("#orgcredscollapse").collapse("show");
return!1}
function createOrgData(b){var a="";"org-secure"===b&&(a='"key": "publickey of the user", "credential": {"siteUrl":"'+document.getElementById("org-secure-siteUrl").value+'", "sitedesc":"'+document.getElementById("org-secure-sitedesc").value+'", "siteuser":"'+document.getElementById("org-secure-siteuser").value+'", "sitepwd":"'+document.getElementById("org-secure-sitepwd").value+'"}, ',addCredentialToOrgPage());"fin"===b&&(a='"institution":"'+document.getElementById("fin-institution").value+'", "accType":"'+
document.getElementById("fin-accType").value+'", "acctNum":"'+document.getElementById("fin-acctNum").value+'", ',addFinDataToSecurePage());if("oth"===b)for(var f=document.getElementById("secure-file").files,c=0;c<f.length;c++){var d=f[c];if(1<d.size/1024/1024)alert("Files greater than 1 MB not supported right now.");else{var e={"secure-file":d.name,filetype:d.type,filesize:d.size,fileseq:lastfileseq+1};document.getElementById("secure-file-content");filecontentobject={"secure-file":d.name,filetype:d.type,
filesize:d.size,fileseq:lastfileseq+1,content:document.getElementById("secure-file-content").value};a+=JSON.stringify(e);c<f.length-1&&(a+=", ");addFileDataToSecurePage(d.name,d.type,d.size,lastfileseq+1)}}if(0<orgdatainsystem.trim().length)if(f=JSON.parse(orgdatainsystem.trim()),0<f.length){if("org-secure"===b){d="";for(e=0;e<f.length;e++)if("org-credentials"===f[e].section&&0==parseInt(f[e].seq)){c=new sjcl.ecc.elGamal.secretKey(sjcl.ecc.curves.c384,sjcl.ecc.curves.c384.field.fromBits(sjcl.codec.base64.toBits(orgkey)));
var g=JSON.parse(sjcl.decrypt(c,f[e].data));for(c=0;c<g.length;c++)d+=JSON.stringify(g[c]),c<g.length&&(d+=", ")}if(null==document.getElementById("inform-receiver"))console.log("in 1 existingsites "+d),document.getElementById("org-secure-data").value="["+d+"{"+a.substring(0,a.length-2)+"}]";else for(e=document.getElementsByName("infoshareoption"),c=0,g=e.length;c<g;c++)e[c].checked&&("T"==e[c].value&&(console.log("in 2 existingsites "+d),document.getElementById(b+"-seq").value="0",document.getElementById("org-secure-data").value=
"{"+a.substring(0,a.length-2)+"}"),"R"==e[c].value&&(console.log("in 3 existingsites "+d),document.getElementById("org-secure-data").value="["+d+"{"+a.substring(0,a.length-2)+"}]"))}if("fin"===b){d="";for(e=0;e<f.length;e++)if(2===f[e].sequence)for(g=JSON.parse(decryptwithstretchedkey("fin",vaultkey,f[e].data)),c=0;c<g.length;c++)d+=JSON.stringify(g[c]),c<g.length&&(d+=", ");document.getElementById("fin-data").value="["+d+"{"+a.substring(0,a.length-2)+"}]"}if("oth"===b){b=a;for(e=0;e<f.length;e++)if(3===
f[e].sequence)for(g=JSON.parse(decryptwithstretchedkey("oth",vaultkey,f[e].data)),c=0;c<g.length;c++)b+=", "+JSON.stringify(g[c]),lastfileseq=g[c].fileseq;document.getElementById("oth-data").value="["+b+"]"}}else"oth"===b?document.getElementById(b+"-data").value="["+a+"]":document.getElementById(b+"-data").value="[{"+a.substring(0,a.length-2)+"}]";else"oth"===b?document.getElementById(b+"-data").value="["+a+"]":document.getElementById(b+"-data").value="[{"+a.substring(0,a.length-2)+"}]"}
function addCredentialNotificationToOrgPage(){var b=document.getElementById("org-secure-notification").value;var a=document.getElementById("org-secure-startdate").value;var f=document.getElementById("org-secure-endate").value;var c="Coming in";if(null!=b&&0<b.length){var d=document.createElement("div");b=Date.now();var e="";b<parseInt(a)?e=gettimedifference(parseInt(a),!0):null!=f&&0<f.length?b<parseInt(f)&&(c="Visible for",e=gettimedifference(parseInt(f),!0)):(c="Shared Credential",d.style.backgroundColor=
"#ededed");d.classList.add("col-md-2");d.classList.add("col-xs-4");d.classList.add("website-cred-display");d.style.height="100px";a=document.createElement("div");a.classList.add("center-block");a.classList.add("text-center");a.style.height="80px";f=document.createElement("img");f.setAttribute("src","https://www.google.com/s2/favicons?domain\x3dhttps://newauth.io");f.setAttribute("height","24");f.setAttribute("width","24");f.classList.add("center-block");b=document.createElement("div");b.style.textAlign=
"center";var g=document.createElement("p");g.classList.add("font-weight-bold");g.style.maxWidth="100px";g.style.margin="auto";e=document.createTextNode(e);g.appendChild(e);b.appendChild(g);e=document.createElement("p");e.style.maxWidth="100px";e.style.margin="auto";null!=c&&0<c.trim().length&&(c=c.charAt(0).toUpperCase()+c.substring(1,c.length),c=document.createTextNode(c),g=document.createElement("strong"),g.appendChild(c),e.appendChild(g),a.appendChild(e),a.appendChild(document.createElement("br")));
a.appendChild(f);a.appendChild(b);d.addEventListener("mouseover",function(a){d.style.border="1px solid #828282"},!1);d.addEventListener("mouseout",function(a){d.style.border="none";clearTimeout(copytimer)},!1);c=document.getElementById("org-credentials");d.appendChild(a);createcardlayout(c,d)}}
function addCredentialToOrgPage(){var b=document.getElementById("org-secure-siteUrl").value;var a=document.getElementById("org-secure-siteuser").value;var f=document.getElementById("org-secure-sitepwd").value;var c=document.getElementById("org-secure-sitedesc").value;if("undefined"!==b){if(null==c||0==c.length){var d=getDomain(b);null!=d&&(c=d.split(".")[0])}var e=document.createElement("div");e.classList.add("col-md-2");e.classList.add("col-xs-4");e.classList.add("website-cred-display");e.style.height=
"100px";d=document.createElement("div");d.classList.add("center-block");d.classList.add("text-center");d.style.height="80px";var g=document.createElement("img");g.setAttribute("src","https://www.google.com/s2/favicons?domain\x3d"+b);g.setAttribute("height","24");g.setAttribute("width","24");g.setAttribute("alt",b);g.classList.add("center-block");var k=document.createElement("div");k.style.textAlign="center";k.style.backgroundColor="inherit";var h=document.createElement("p");h.classList.add("font-weight-bold");
h.style.maxWidth="100px";h.style.margin="auto";var l=document.createTextNode(a);h.appendChild(l);k.appendChild(h);h=document.createElement("p");h.style.maxWidth="100px";h.style.margin="auto";null!=c&&0<c.trim().length&&(c.trim().startsWith("Shared")&&(d.style.backgroundColor="#ededed"),c=c.charAt(0).toUpperCase()+c.substring(1,c.length),c=document.createTextNode(c),l=document.createElement("strong"),l.appendChild(c),h.appendChild(l),d.appendChild(h),d.appendChild(document.createElement("br")));d.appendChild(g);
d.appendChild(k);e.addEventListener("mouseover",function(a){e.style.border="1px solid #828282"},!1);e.addEventListener("mouseout",function(a){e.style.border="none";clearTimeout(copytimer)},!1);e.addEventListener("click",function(c){var d=document.getElementsByClassName("website-cred-display"),e;for(e=0;e<d.length;e++)d[e].style.background="transparent",makeallchildrentransparent(d[e]);if(c.target.classList.contains("website-cred-display"))c.target.style.background="#e2e2e2";else{for(d=c.target;!d.classList.contains("website-cred-display");)d=
d.parentElement;d.classList.contains("website-cred-display")&&(d.style.background="#e2e2e2")}copyInfoToClipboard(c,b,a,f)},!1);g=document.getElementById("org-credentials");e.appendChild(d);createcardlayout(g,e)}}
function displayOrgDataClear(){if(null==otherkeys||0==otherkeys.length)getsecureuserdatafromdb("ORGKEY",function(a){extractOrgKeysFromsecuredata(a);decryptandlayoutorgdata()});else{for(var b=0;b<otherkeys.length;b++)if(otherkeys[b].org&&orgownerflake==otherkeys[b].org.split(":\x3d")[0]&&orgID==otherkeys[b].org.split(":\x3d")[1]){orgkey=otherkeys[b].privkey;decryptandlayoutorgdata();break}null!=orgkey&&0!=orgkey.length||getsecureuserdatafromdb("ORGKEY",function(a){extractOrgKeysFromsecuredata(a);decryptandlayoutorgdata()})}}
function decryptandlayoutorgdata(){var b=document.getElementById("org-credentials");b.removeEventListener("mouseenter",unblur,!1);b.removeEventListener("mouseleave",blur,!1);b.classList.remove("blur");if(0<orgdatainsystem.trim().length&&0<JSON.parse(orgdatainsystem).length){b=JSON.parse(orgdatainsystem);document.getElementById("org-credentials").innerHTML="";for(var a=0;a<b.length;a++){"org-credentials"===b[a].section&&(null!=document.getElementById("clear-sites-btn")&&(document.getElementById("clear-sites-btn").style.display=
"inline-block"),document.getElementById("org-credentials"));var f=new sjcl.ecc.elGamal.secretKey(sjcl.ecc.curves.c384,sjcl.ecc.curves.c384.field.fromBits(sjcl.codec.base64.toBits(orgkey)));if(null!=b[a].data){f=JSON.parse(sjcl.decrypt(f,b[a].data));for(var c=0;c<f.length;c++)"org-credentials"===b[a].section&&(document.getElementById("org-secure-siteUrl").value=f[c].credential.siteUrl,document.getElementById("org-secure-siteuser").value=f[c].credential.siteuser,document.getElementById("org-secure-sitepwd").value=
f[c].credential.sitepwd,document.getElementById("org-secure-sitedesc").value=f[c].credential.sitedesc,document.getElementById("org-secure-seq").value=b[a].seq,document.getElementById("org-secure-slt").value=b[a].salt,document.getElementById("org-secure-itns").value=b[a].iterations,document.getElementById("org-secure-crdate").value=b[a].createdate,document.getElementById("org-secure-stdate").value=b[a].startdate,document.getElementById("org-secure-upddate").value=b[a].lastupdatedate,addCredentialToOrgPage())}else null!=
b[a].notification&&0<b[a].notification.length&&"org-credentials"===b[a].section&&(document.getElementById("org-secure-notification").value=b[a].notification,document.getElementById("org-secure-startdate").value=b[a].startdate,document.getElementById("org-secure-endate").value=b[a].enddate,addCredentialNotificationToOrgPage())}document.getElementById("org-secure-siteUrl").value="";document.getElementById("org-secure-siteuser").value="";document.getElementById("org-secure-sitepwd").value=""}}
function extractOrgKeysFromsecuredata(b){null!=b&&"ERROR"!==b&&(otherkeys.push(b),addOrgPrivateKeytoUserData(b.org,b.privkey));for(b=0;b<otherkeys.length;b++)if(otherkeys[b].org&&orgownerflake==otherkeys[b].org.split(":\x3d")[0]&&orgID==otherkeys[b].org.split(":\x3d")[1]){orgkey=otherkeys[b].privkey;break}}
function displayorgdata(){document.getElementById("org-credentials").classList.add("blur");if(0<orgdatainsystem.trim().length&&0<JSON.parse(orgdatainsystem).length){for(var b=JSON.parse(orgdatainsystem),a=0;a<b.length;a++){var f=JSON.parse(b[a].data);if("org-credentials"===b[a].section){null!=document.getElementById("clear-sites-btn")&&(document.getElementById("clear-sites-btn").style.display="inline-block");var c=document.createElement("p");c.style.wordWrap="break-word";c.style.maxWidth="90%";c.style.display=
"inline-block";c.style.fontSize="16px";f=null!=f?300<f.ct.length?f.ct.substr(0,300)+"...":f.ct:b[a].notification;f=document.createTextNode(f);c.appendChild(f);document.getElementById("org-credentials").appendChild(c)}}document.getElementById("org-secure-siteUrl").value="";document.getElementById("org-secure-siteuser").value="";document.getElementById("org-secure-sitepwd").value=""}}
function clearsecureuserdatafromdb(b){var a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("POST","/secure/clearsecureuserdata",!0);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");a.send(JSON.stringify({flake:orgownerflake,tag:b}))}
function clearAllOrgCredentials(b){if(confirm("Do you want to remove all credentials in this view?. Click OK to continue.")){var a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("POST","/secure/clearorgdata",!0);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");a.send(JSON.stringify({ownerflake:orgownerflake,section:"org-credentials",orgid:b,createdate:document.getElementById("org-secure-crdate").value}));showOrgPage(orgownerflake,b)}return!1}
function displaymembersindiv(b,a){var f=document.createElement("ul"),c=function(){document.getElementById(b).innerHTML="";a.forEach(function(a){var b=document.createElement("li"),c=document.createElement("p");c.classList.add("text-muted");c.appendChild(document.createTextNode(a));b.appendChild(c);f.appendChild(b)});document.getElementById(b).appendChild(f)};if(null!=a&&0<a.length)c();else{var d=new XMLHttpRequest;d.open("GET","/newauth/api/getOrgMembers/"+orgownerflake+"/"+orgID,!1);d.setRequestHeader("Content-Type",
"application/json");d.onreadystatechange=function(){4==d.readyState&&200==d.status&&(a=d.responseText,c())};d.send(null)}};