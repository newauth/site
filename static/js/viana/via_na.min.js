'use strict';let BASE_URL="/",STYLESHEET=BASE_URL+"static/css/app.css",CONTENT_URL=BASE_URL+"vn/init",ROOT="via-newauth",flakesondevice,oldtonewflakeconverter={},newtooldflakeconverter={},nainitialized=!1,overlayloaded=!1,highusagedevice=!1,hostsite="Default",overlay,displayedimgindex=0;const supportedAPI="init message bindhostuserid getauthenticateduser successhandler failurehandler logout".split(" ");let elements=[],configurations={},authenticateduser={};"use strict";
var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(b){this.toString=function(){return"CORRUPT: "+this.message};this.message=b},invalid:function(b){this.toString=function(){return"INVALID: "+this.message};this.message=b},bug:function(b){this.toString=function(){return"BUG: "+this.message};this.message=b},notReady:function(b){this.toString=function(){return"NOT READY: "+this.message};this.message=b}},bitArray:{bitSlice:function(b,a,c){b=sjcl.bitArray.m(b.slice(a/
32),32-(a&31)).slice(1);return void 0===c?b:sjcl.bitArray.clamp(b,c-a)},extract:function(b,a,c){var d=Math.floor(-a-c&31);return((a+c-1^a)&-32?b[a/32|0]<<32-d^b[a/32+1|0]>>>d:b[a/32|0]>>>d)&(1<<c)-1},concat:function(b,a){if(0===b.length||0===a.length)return b.concat(a);var c=b[b.length-1],d=sjcl.bitArray.getPartial(c);return 32===d?b.concat(a):sjcl.bitArray.m(a,d,c|0,b.slice(0,b.length-1))},bitLength:function(b){var a=b.length;return 0===a?0:32*(a-1)+sjcl.bitArray.getPartial(b[a-1])},clamp:function(b,
a){if(32*b.length<a)return b;b=b.slice(0,Math.ceil(a/32));var c=b.length;a&=31;0<c&&a&&(b[c-1]=sjcl.bitArray.partial(a,b[c-1]&2147483648>>a-1,1));return b},partial:function(b,a,c){return 32===b?a:(c?a|0:a<<32-b)+1099511627776*b},getPartial:function(b){return Math.round(b/1099511627776)||32},equal:function(b,a){if(sjcl.bitArray.bitLength(b)!==sjcl.bitArray.bitLength(a))return!1;var c=0,d;for(d=0;d<b.length;d++)c|=b[d]^a[d];return 0===c},m:function(b,a,c,d){var e;for(void 0===d&&(d=[]);32<=a;a-=32)d.push(c),
c=0;if(0===a)return d.concat(b);for(e=0;e<b.length;e++)d.push(c|b[e]>>>a),c=b[e]<<32-a;e=b.length?b[b.length-1]:0;b=sjcl.bitArray.getPartial(e);d.push(sjcl.bitArray.partial(a+b&31,32<a+b?c:d.pop(),1));return d},s:function(b,a){return[b[0]^a[0],b[1]^a[1],b[2]^a[2],b[3]^a[3]]},byteswapM:function(b){var a;for(a=0;a<b.length;++a){var c=b[a];b[a]=c>>>24|c>>>8&65280|(c&65280)<<8|c<<24}return b}}};
sjcl.codec.utf8String={fromBits:function(b){var a="",c=sjcl.bitArray.bitLength(b),d,e;for(d=0;d<c/8;d++)0===(d&3)&&(e=b[d/4]),a+=String.fromCharCode(e>>>8>>>8>>>8),e<<=8;return decodeURIComponent(escape(a))},toBits:function(b){b=unescape(encodeURIComponent(b));var a=[],c,d=0;for(c=0;c<b.length;c++)d=d<<8|b.charCodeAt(c),3===(c&3)&&(a.push(d),d=0);c&3&&a.push(sjcl.bitArray.partial(8*(c&3),d));return a}};
sjcl.codec.base64={i:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(b,a,c){var d="",e=0,f=sjcl.codec.base64.i,h=0,g=sjcl.bitArray.bitLength(b);c&&(f=f.substr(0,62)+"-_");for(c=0;6*d.length<g;)d+=f.charAt((h^b[c]>>>e)>>>26),6>e?(h=b[c]<<6-e,e+=26,c++):(h<<=6,e-=6);for(;d.length&3&&!a;)d+="\x3d";return d},toBits:function(b,a){b=b.replace(/\s|=/g,"");var c=[],d=0,e=sjcl.codec.base64.i,f=0;a&&(e=e.substr(0,62)+"-_");for(a=0;a<b.length;a++){var h=e.indexOf(b.charAt(a));
if(0>h)throw new sjcl.exception.invalid("this isn't base64!");26<d?(d-=26,c.push(f^h>>>d),f=h<<32-d):(d+=6,f^=h<<32-d)}d&56&&c.push(sjcl.bitArray.partial(d&56,f,1));return c}};sjcl.codec.base64url={fromBits:function(b){return sjcl.codec.base64.fromBits(b,1,1)},toBits:function(b){return sjcl.codec.base64.toBits(b,1)}};sjcl.hash.sha256=function(b){this.g[0]||r(this);b?(this.f=b.f.slice(0),this.c=b.c.slice(0),this.a=b.a):this.reset()};sjcl.hash.sha256.hash=function(b){return(new sjcl.hash.sha256).update(b).finalize()};
sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this.f=this.l.slice(0);this.c=[];this.a=0;return this},update:function(b){"string"===typeof b&&(b=sjcl.codec.utf8String.toBits(b));var a=this.c=sjcl.bitArray.concat(this.c,b);var c=this.a;b=this.a=c+sjcl.bitArray.bitLength(b);if(9007199254740991<b)throw new sjcl.exception.invalid("Cannot hash more than 2^53 - 1 bits");if("undefined"!==typeof Uint32Array){var d=new Uint32Array(a),e=0;for(c=512+c-(512+c&511);c<=b;c+=512)u(this,d.subarray(16*
e,16*(e+1))),e+=1;a.splice(0,16*e)}else for(c=512+c-(512+c&511);c<=b;c+=512)u(this,a.splice(0,16));return this},finalize:function(){var b,a=this.c,c=this.f;a=sjcl.bitArray.concat(a,[sjcl.bitArray.partial(1,1)]);for(b=a.length+2;b&15;b++)a.push(0);a.push(Math.floor(this.a/4294967296));for(a.push(this.a|0);a.length;)u(this,a.splice(0,16));this.reset();return c},l:[],g:[]};
function u(b,a){var c,d,e=b.f,f=b.g,h=e[0],g=e[1],k=e[2],l=e[3],m=e[4],n=e[5],p=e[6],q=e[7];for(b=0;64>b;b++)16>b?c=a[b]:(c=a[b+1&15],d=a[b+14&15],c=a[b&15]=(c>>>7^c>>>18^c>>>3^c<<25^c<<14)+(d>>>17^d>>>19^d>>>10^d<<15^d<<13)+a[b&15]+a[b+9&15]|0),c=c+q+(m>>>6^m>>>11^m>>>25^m<<26^m<<21^m<<7)+(p^m&(n^p))+f[b],q=p,p=n,n=m,m=l+c|0,l=k,k=g,g=h,h=c+(g&k^l&(g^k))+(g>>>2^g>>>13^g>>>22^g<<30^g<<19^g<<10)|0;e[0]=e[0]+h|0;e[1]=e[1]+g|0;e[2]=e[2]+k|0;e[3]=e[3]+l|0;e[4]=e[4]+m|0;e[5]=e[5]+n|0;e[6]=e[6]+p|0;e[7]=
e[7]+q|0}function r(b){function a(a){return 4294967296*(a-Math.floor(a))|0}for(var c=0,d=2,e,f;64>c;d++){f=!0;for(e=2;e*e<=d;e++)if(0===d%e){f=!1;break}f&&(8>c&&(b.l[c]=a(Math.pow(d,.5))),b.g[c]=a(Math.pow(d,1/3)),c++)}}sjcl.misc.hmac=function(b,a){this.j=a=a||sjcl.hash.sha256;var c=[[],[]],d,e=a.prototype.blockSize/32;this.b=[new a,new a];b.length>e&&(b=a.hash(b));for(d=0;d<e;d++)c[0][d]=b[d]^909522486,c[1][d]=b[d]^1549556828;this.b[0].update(c[0]);this.b[1].update(c[1]);this.h=new a(this.b[0])};
sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(b){if(this.o)throw new sjcl.exception.invalid("encrypt on already updated hmac called!");this.update(b);return this.digest(b)};sjcl.misc.hmac.prototype.reset=function(){this.h=new this.j(this.b[0]);this.o=!1};sjcl.misc.hmac.prototype.update=function(b){this.o=!0;this.h.update(b)};sjcl.misc.hmac.prototype.digest=function(){var b=this.h.finalize();b=(new this.j(this.b[1])).update(b).finalize();this.reset();return b};
sjcl.misc.pbkdf2=function(b,a,c,d,e){c=c||1E4;if(0>d||0>c)throw new sjcl.exception.invalid("invalid params to pbkdf2");"string"===typeof b&&(b=sjcl.codec.utf8String.toBits(b));"string"===typeof a&&(a=sjcl.codec.utf8String.toBits(a));e=e||sjcl.misc.hmac;b=new e(b);var f,h,g,k,l=[],m=sjcl.bitArray;for(k=1;32*l.length<(d||1);k++){e=f=b.encrypt(m.concat(a,[k]));for(h=1;h<c;h++)for(f=b.encrypt(f),g=0;g<f.length;g++)e[g]^=f[g];l=l.concat(e)}d&&(l=m.clamp(l,d));return l};
"undefined"!==typeof module&&module.exports&&(module.exports=sjcl);"function"===typeof define&&define([],function(){return sjcl});var vnns=vnns||{getuserdata:function(){return authenticateduser},close:function(){close()},bindhostUser:function(b){bindHostUser(b)}};function requestStylesheet(b){stylesheet=document.createElement("link");stylesheet.rel="stylesheet";stylesheet.type="text/css";stylesheet.href=b;stylesheet.media="all";document.lastChild.firstChild.appendChild(stylesheet)}
function app(b){console.log("VIANEWAUTH starting");b=b[b.VIANEWAUTH];b.fns=vnns;if(b=b.q)for(var a=0;a<b.length;a++)if("init"==b[a][0].toLowerCase()){sc=document.getElementsByTagName("script");for(let a=0;a<sc.length;a++)if(s=sc.item(a),s.src&&s.src.match(/via_na\.js$/)){let a=s.src.match(/^https?:\/\/([^\/?#]+)(?:[\/?#]|$)/i);BASE_URL=a&&a[1];BASE_URL="https://"+BASE_URL+"/";console.log("BASE_URL set "+BASE_URL)}configurations=extendObject(configurations,b[a][1]);verifyHostId(configurations.hostId);
nainitialized?"postauth"==configurations.mode?console.log("VIANEWAUTH started in postauth mode ",configurations):console.log("VIANEWAUTH started ",configurations):console.log("VIANEWAUTH could not be started ",configurations)}else apiHandler(b[a][0],b[a][1]);b=apiHandler;b.configurations=configurations}
function apiHandler(b,a){if(nainitialized){if(!b)throw Error("API method required");b=b.toLowerCase();if(-1===supportedAPI.indexOf(b))throw Error("Method "+b+" is not supported");console.log("Handling API call "+b,a);switch(b){case "message":show(a);break;case "bindhostuserid":bindHostUser(a);break;case "getauthenticateduser":getauthenticateduser();break;case "successhandler":registerauthsuccesshandler(a);break;case "failurehandler":registerauthfailurehandler(a);break;case "logout":logoutfromnewauth(a);
break;default:console.warn("No handler defined for "+b)}}}function extendObject(b,a){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}
function showOverlay(b){if(!overlayloaded){let c=document.createElement("div");overlay=document.createElement("div");overlay.innerHTML="\x3cdiv class\x3d'via-na-overlay'\x3e\x3c/div\x3e";var a=document.createElement("span");a.innerHTML="\x26times;";a.style.float="right";a.style.padding="2px 5px";a.style.fontSize="1.6em";a.style.top="0px";a.style.display="inline-block";a.style.color="#d3d3d3";a.style.cursor="default";a.addEventListener("mouseover",function(a){a.target.style.color="#eee"});a.addEventListener("mouseout",
function(a){a.target.style.color="#d3d3d3"});a.addEventListener("click",close);overlay.getElementsByClassName("via-na-overlay")[0].appendChild(a);setoverlaystyle();a=document.createElement("h2");a.style.textAlign="center";let d="Sign In to "+hostsite+" via Newauth";0<b.length&&(d=b);b=document.createTextNode(d);a.style.position="relative";a.style.color="#e2e2e2";a.appendChild(b);overlay.getElementsByClassName("via-na-overlay")[0].appendChild(a);for(b=0;b<flakesondevice.length;b++)overlay.getElementsByClassName("via-na-overlay")[0].appendChild(createflakediv(flakesondevice[b]));
overlay.getElementsByClassName("via-na-overlay")[0].appendChild(createusernamebox());b=document.createElement("h5");b.style.textAlign="center";b.style.position="absolute";b.style.bottom="10px";b.style.left="50%";b.style.transform="translate(-50%,0)";b.appendChild(document.createTextNode("Do not have a Newauth account? Create it at https://newauth.io"));b.style.color="#d3d3d3";overlay.getElementsByClassName("via-na-overlay")[0].appendChild(b);c.appendChild(overlay);let e=setInterval(function(){let a=
parseFloat(overlay.getElementsByClassName("via-na-overlay")[0].style.opacity);.92<a?clearInterval(e):(a+=.04,overlay.getElementsByClassName("via-na-overlay")[0].style.opacity=a)},20);0<c.children.length&&(elements.push(c.children[0]),document.body.appendChild(c));overlayloaded=!0}}
function createflakediv(b){let a=document.createElement("div");var c=document.createTextNode(b.giveout);a.style.textAlign="center";a.style.fontFamily="inherit";a.style.backgroundColor="#e3e3e3";a.style.borderColor="#aaa";a.style.margin="10px";a.style.fontSize="1em";a.style.padding="10px 10px";a.style.position="relative";a.style.left="50%";a.style.maxWidth="400px";a.style.marginLeft="-200px";a.style.boxShadow="2px 2px 4px lightgray";a.style.overflowWrap="break-word";a.style.wordWrap="break-word";a.style.cursor=
"default";a.addEventListener("click",function(){authviaflake(b.flake)});a.appendChild(c);if(null!=b.extIds){c=document.createElement("div");let d=document.createTextNode(b.extIds);c.style.textAlign="bottom";c.style.bottom="0";c.style.fontSize="0.8em";c.style.padding="2px 2px";c.style.margin="2px";c.style.overflowWrap="break-word";c.style.wordWrap="break-word";c.style.cursor="default";c.appendChild(d);a.appendChild(c)}return a}
function createusernamebox(){var b=document.createElement("div");b.style.position="absolute";b.style.left="50%";b.style.top="50%";b.style.overflow="hidden";b.style.paddingRight=".5em";b.style.maxWidth="400px";b.style.marginLeft="-200px";b.style.transform="translate(0, -50%)";var a=document.createElement("input");a.setAttribute("type","password");a.setAttribute("size","50");a.setAttribute("placeholder","Newauth user name");a.setAttribute("id","username-input-box");a.style.width="300px";a.style.height=
"30px";a.addEventListener("keydown",function(b){if(13===b.keyCode||9===b.keyCode)b=a.value,6>b.length?(a.style.border="1px solid red",a.setAttribute("placeholder","Minimum 6 characters"),setTimeout(function(){a.style.border="";a.setAttribute("placeholder","Newauth user name")},3E3)):(b=hashUserForAuthentication(b),authviausername(b))});var c=document.createElement("button"),d=document.createTextNode("Enter");c.appendChild(d);c.style.height="35px";c.addEventListener("click",function(){var b=a.value;
6>b.length?(a.style.border="1px solid red",a.setAttribute("placeholder","Minimum 6 characters"),setTimeout(function(){a.style.border="";a.setAttribute("placeholder","Newauth user name")},3E3)):(b=hashUserForAuthentication(b),authviausername(b))});b.appendChild(a);b.appendChild(c);return b}
function showButton(){let b=document.getElementById("via-newauth-button"),a=document.createElement("button");a.title="Login with Newauth";a.style.backgroundImage="url("+BASE_URL+"image/-4)";a.style.borderRadius="4px";a.style.width="400px";a.style.height="94px";a.style.border="none";a.style.color="#fdfdfd";a.style.padding="15px 32px";a.style.textAlign="center";a.style.textDecoration="none";a.style.display="inline-block";a.style.fontSize="32px";a.style.fontWeight="bold";a.style.transition="background-image 4s ease-in-out";
var c=document.createTextNode("Login");a.appendChild(c);a.onclick=function(a){a.preventDefault();showOverlay(configurations.banner)};b.appendChild(a);document.body.appendChild(b);setTimeout(function(){a.style.backgroundImage="url('file:///C:/temp/abstract-bg.jpg')"},2E3)}
function authviausername(b){let a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c=BASE_URL+"vn/auththroughusername";a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var b=JSON.parse(a.responseText);if(null!=b.newChallenge)showimagesonoverlay(b.newChallenge);else if(null!=b.flakejson){authenticateduser=JSON.parse(b.flakejson);if(null!=flakesondevice)for(b=0;b<flakesondevice.length;b++)flakesondevice[b].flake==newtooldflakeconverter[authenticateduser.flake]&&
(authenticateduser.extIds=flakesondevice[b].extIds);displayflakeonverlay(authenticateduser);setTimeout(configurations.onAuthCallback,1200)}}};a.open("POST",c,!1);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");b=JSON.stringify({username:b,screenwidth:window.screen.availWidth,screenheight:window.screen.availHeight});a.send(b)}
function authviaflake(b){newtooldflakeconverter.NEWFLAKE=b;let a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var c=BASE_URL+"vn/auththroughflake";a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var c=JSON.parse(a.responseText);if(null!=c.newChallenge)showimagesonoverlay(c.newChallenge);else if(null!=c.flakejson){authenticateduser=JSON.parse(c.flakejson);oldtonewflakeconverter[b]=authenticateduser.flake;newtooldflakeconverter[authenticateduser.flake]=
b;if(null!=flakesondevice)for(c=0;c<flakesondevice.length;c++)flakesondevice[c].flake==newtooldflakeconverter[authenticateduser.flake]&&(authenticateduser.extIds=flakesondevice[c].extIds);displayflakeonverlay(authenticateduser);setTimeout(configurations.onAuthCallback,1200)}}};a.open("POST",c,!1);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");c=JSON.stringify({userflake:b,screenwidth:window.screen.availWidth,screenheight:window.screen.availHeight});a.send(c)}
function showimagesonoverlay(b){if(null!=overlay.getElementsByClassName("via-na-overlay")){overlay.getElementsByClassName("via-na-overlay")[0].innerHTML="";displayedimgindex=0;var a=document.createElement("span");a.innerHTML="\x26times;";a.style.float="right";a.style.padding="2px 5px";a.style.fontSize="1.6em";a.style.top="0px";a.style.display="inline-block";a.style.color="#d3d3d3";a.style.cursor="default";a.addEventListener("mouseover",function(a){a.target.style.color="#eee"});a.addEventListener("mouseout",
function(a){a.target.style.color="#d3d3d3"});a.addEventListener("click",close);overlay.getElementsByClassName("via-na-overlay")[0].appendChild(a);a=document.createElement("div");overlay.getElementsByClassName("via-na-overlay")[0].appendChild(a);if(0==b.images.length)showmessageonoverlay("This Newauth profile is not setup properly. Please set it up first");else{let c=[],d=b.images[0].imageid,e=[];for(let f=0;f<b.images.length;f++){let h=new Image;if(displayedimgindex==f){e[f]=document.createElement("IMG");
e[f].setAttribute("id",b.images[f].imageid);e[f].alt="...Loading";e[f].style.margin="auto";e[f].style.marginWidth="auto";e[f].style.marginHeight="auto";e[f].style.display="none";e[f].style.maxWidth=.8*window.innerWidth+"px";e[f].style.maxHeight=.9*window.innerHeight+"px";let g=e[f];e[f].onclick=function(a){a=getMousePos2(g,a);c.push({imgID:d,delay:1234,clickX:parseInt(a.x),clickY:parseInt(a.y),imgWidth:g.width,imgHeight:g.height});displayedimgindex===b.images.length-1?(g.style.display="none",postimageclickdata(c)):
(g.style.display="block",d=b.images[displayedimgindex+1].imageid,h.src=BASE_URL+"image/"+b.images[displayedimgindex+1].imageid,displayedimgindex++)};a.appendChild(e[f]);h.src=BASE_URL+"image/"+b.images[f].imageid;h.onload=function(){g.src=this.src;0===displayedimgindex&&(g.style.display="block")}}}}}}
function postimageclickdata(b){let a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c=BASE_URL+"vn/postclickdataforauth";a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){let c=JSON.parse(a.responseText);if(null!=c.newChallenge){overlay.getElementsByClassName("via-na-overlay")[0].style.background="#888";if(configurations.onAuthFailCallback)configurations.onAuthFailCallback();setTimeout(function(){showimagesonoverlay(c.newChallenge)},400)}else if(null!=
c.flakejson){authenticateduser=JSON.parse(c.flakejson);oldtonewflakeconverter[newtooldflakeconverter.NEWFLAKE]=authenticateduser.flake;newtooldflakeconverter[authenticateduser.flake]=newtooldflakeconverter.NEWFLAKE;if(null!=flakesondevice)for(var b=0;b<flakesondevice.length;b++)flakesondevice[b].flake==newtooldflakeconverter[authenticateduser.flake]&&(authenticateduser.extIds=flakesondevice[b].extIds);displayflakeonverlay(JSON.parse(c.flakejson));setTimeout(close,800);setTimeout(configurations.onAuthCallback,
1200)}}};a.open("POST",c,!1);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");b=JSON.stringify(b);showmessageonoverlay("... Authenticating");a.send(b)}
function showmessageonoverlay(b){overlay.getElementsByClassName("via-na-overlay")[0].innerHTML="";overlay.getElementsByClassName("via-na-overlay")[0].style.background="#0a0a0a";var a=document.createElement("span");a.innerHTML="\x26times;";a.style.float="right";a.style.padding="2px 5px";a.style.fontSize="1.6em";a.style.top="0px";a.style.display="inline-block";a.style.color="#d3d3d3";a.style.cursor="default";a.addEventListener("mouseover",function(a){a.target.style.color="#eee"});a.addEventListener("mouseout",
function(a){a.target.style.color="#d3d3d3"});a.addEventListener("click",close);overlay.getElementsByClassName("via-na-overlay")[0].appendChild(a);a=document.createElement("div");b=document.createTextNode(b);a.style.top=.05*window.innerHeight+"px";a.style.left=.1*window.innerWidth+"px";a.style.color="#d3d3d3";a.appendChild(b);overlay.getElementsByClassName("via-na-overlay")[0].appendChild(a)}
function getMousePos2(b,a){let c=b.getBoundingClientRect();return 0==c.right-c.left||0==c.bottom-c.top?{x:Math.round(a.clientX),y:Math.round(a.clientY)}:{x:Math.round((a.clientX-c.left)/(c.right-c.left)*b.width),y:Math.round((a.clientY-c.top)/(c.bottom-c.top)*b.height)}}
function displayflakeonverlay(b){var a=overlay.getElementsByClassName("via-na-overlay")[0];a.style.background="#fff";if(null==a)return alert("No div for canvas"),!1;if(a.clientWidth<a.clientHeight){var c=2*a.clientWidth;var d=2*a.clientWidth}else c=2*a.clientHeight,d=2*a.clientHeight;a.innerHTML="\x3cdiv id\x3d'flkcancontainer'\x3e\x3c/div\x3e";a=document.getElementById("flkcancontainer");a.style.width="100%";a.style.height="100%";a.style.left="0";a.style.top="0";a.style.position="absolute";a.style.backgroundColor=
"white";c=getCanvasWithFlakeImage(b,c,d,"large");var e=getCanvasWithFlakeImage(b,100,100,"tiny");a.style.background="url("+c.toDataURL()+")";a.style.backgroundPosition="center center";a.style.backgroundRepeat="no-repeat";c=document.createElement("div");c.style.width="100%";c.style.height="100%";c.style.opacity="0.96";c.style.left="0";c.style.top="0";c.style.position="absolute";c.setAttribute("id","background-dimmmer");a.appendChild(c);overlay.getElementsByClassName("via-na-overlay")[0].appendChild(a);
a=document.createElement("div");a.style.left="50%";a.style.width="50%";a.style.height="16%";a.style.top="50%";a.style.margin="-8% 0 0 -25%";a.style.position="relative";a.style.opacity="0.96";a.style.padding="30px 30px";a.style.backgroundColor="#d3d3d3";a.style.borderColor="#a00";d=document.createElement("img");d.width="100";d.height="100";d.align="left";d.src=e.toDataURL();e=document.createElement("div");e.style.float="left";e.style.maxWidth="70%";e.style.height="90%";e.style.marginLeft="20px";let f=
document.createElement("p");f.style.fontSize="80%";let h=document.createTextNode("Newauth user: "+b.giveout);a.appendChild(d);f.appendChild(h);f.style.fontSize="80%";e.appendChild(f);f=document.createElement("p");f.style.fontSize="80%";h=document.createTextNode("Flake: "+b.flake);f.appendChild(h);e.appendChild(f);f=document.createElement("p");f.style.fontSize="80%";h=document.createTextNode("Last Authenticated: "+gettimedifference(b.crtime)+" ago");f.appendChild(h);e.appendChild(f);f=document.createElement("p");
f.style.fontSize="80%";h=document.createTextNode("Associated "+hostsite+" IDs: "+authenticateduser.extIds);f.appendChild(h);e.appendChild(f);a.appendChild(e);c.appendChild(a)}
function getCanvasWithFlakeImage(b,a,c,d){var e=createHiDPICanvas(a,c);e.width=a;e.height=c;if(null!=b){a="test".constructor;if(b.constructor===a)var f=b;else null!=b.flake&&(f=b.flake);c=e.width/2;for(var h=e.height/2,g=e.getContext("2d"),k=0;k<f.length;k++){var l=.015625*"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-+".indexOf(f.charAt(k));drawPoint(360/f.length*k,l,f.charAt(k),c,h,g,d,"false")}b.constructor!==a&&null!=b.crtime&&g.fillText(b.crtime,2,e.height-2);"tiny"==d&&drawborderllines(e);
return e}}function drawborderllines(b){var a=b.getContext("2d");a.strokeStyle="#343434";a.beginPath();a.moveTo(0,b.height/10);a.lineTo(0,0);a.stroke();a.beginPath();a.moveTo(0,0);a.lineTo(b.width/5,0);a.stroke();a.beginPath();a.moveTo(b.width,4*b.height/5);a.lineTo(b.width,b.height);a.stroke();a.beginPath();a.moveTo(b.width,b.height);a.lineTo(9*b.width/10,b.height);a.stroke()}
function gettimedifference(b){var a=new Date,c=new Date(parseInt(b.split(" ")[0].split("-")[2]),parseInt(b.split(" ")[0].split("-")[0])-1,parseInt(b.split(" ")[0].split("-")[1]),parseInt(b.split(" ")[1].split(":")[0]),parseInt(b.split(" ")[1].split(":")[1]),parseInt(b.split(" ")[1].split(":")[2].split(".")[0]),parseInt(b.split(" ")[1].split(":")[2].split(".")[1])),d=a-c;a=Math.floor(d/864E5);c=Math.floor(d%864E5/36E5);var e=Math.floor(d%864E5%36E5/6E4);d=Math.floor(d%864E5%36E5%6E4/1E3);return 7<
a?b:1<=a?a+" days":1<=c?c+" hours":1<=e?e+" min":d+" sec"}
function drawPoint(b,a,c,d,e,f,h,g){var k=d/2;a+=.35;var l=d+k*Math.cos(-b*Math.PI/180)*a,m=e+k*Math.sin(-b*Math.PI/180)*a,n=5;"large"==h?(f.strokeStyle="#e3e3e3",f.fillStyle="#c3c3c3"):(f.strokeStyle="lightgrey",f.fillStyle="grey");"tiny"!=h?(f.moveTo(d,e),f.lineWidth=1,f.lineTo(l,m),f.stroke(),null!=g&&"true"==g&&(f.font="7px",f.fillText(c,d+k*Math.cos(-b*Math.PI/180)*(a+.08),e+k*Math.sin(-b*Math.PI/180)*(a+.08)))):n=2;f.beginPath();f.arc(l,m,n,0,2*Math.PI);f.fill()}
function PIXEL_RATIO(){let b=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1)}function createHiDPICanvas(b,a,c){c||(c=PIXEL_RATIO);let d=document.createElement("canvas");d.width=b*c;d.height=a*c;d.getContext("2d").setTransform(c,0,0,c,0,0);return d}
function verifyHostId(b){let a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var c=BASE_URL+"vn/init";a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){let c=JSON.parse(a.responseText);if("VALID"==c.deviceStatus.statuscode)flakesondevice=c.flakes,highusagedevice=c.devicedata.ishighusagedevice,hostsite=c.branddisplayname,!0===configurations.showButton&&showButton(),"postauth"==configurations.mode&&(authenticateduser=JSON.parse(c.flakejson)),nainitialized=
!0;else{console.warn("HostId: "+b+" is not recognized by Newauth. Please check.");let a=document.getElementById("via-newauth-button");null!=a&&(a.style.fontSize=10,a.style.color="red",a.appendChild(document.createTextNode(c.deviceStatus.desc)))}}};console.log("preparing to post to "+c);a.open("POST",c,!1);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");c=JSON.stringify({flake:b});"postauth"==configurations.mode&&(c=JSON.stringify({flake:b,usernameclear:"LOGGEDINUSER"}));
a.send(c)}function close(b){let a=setInterval(function(){if("0.2">overlay.getElementsByClassName("via-na-overlay")[0].style.opacity){for(clearInterval(a);0<elements.length;){let a=elements.pop();a.parentNode.removeChild(a)}document.body.removeEventListener("click",close);nainitialized=!1}else c-=5,overlay.getElementsByClassName("via-na-overlay")[0].style.opacity="0."+c},20),c=80;overlayloaded=!1}function show(b){console.log("in show"+b.display)}
function bindHostUser(b){if(isnewbrandusername(flakesondevice,authenticateduser,b.userId)){console.log("Binding "+b.userId+" to "+JSON.stringify(authenticateduser));let a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c=BASE_URL+"vn/addbranduser";a.onreadystatechange=function(){4==a.readyState&&200==a.status&&JSON.parse(a.responseText)};a.open("POST",c,!1);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");b=JSON.stringify({brand:configurations.hostId,
user:authenticateduser.flake,brandusername:b.userId});a.send(b)}else console.log("The site user "+b.userId+" already bound to logged in Newauth account "+authenticateduser.flake+" Skipping bind")}
function getauthenticateduser(){console.log("authenticated user "+JSON.stringify(authenticateduser));var b=document.getElementById("newauth-user");if(null!=b)for(b.value=encodeURIComponent(JSON.stringify(authenticateduser)),b=0;b<flakesondevice.length;b++){if(flakesondevice[b].flake==authenticateduser.flake&&null!=flakesondevice[b].extIds){let a=document.getElementById("local-ids");null!=a?(a.setAttribute("data-local-ids",flakesondevice[b].extIds),a.appendChild(document.createTextNode(flakesondevice[b].extIds))):
console.log("Please create an input element with id: local-ids. IDs of the user on this site will be set there.")}}else console.log("Please create an input element with id: newauth-user. Authenticated user data will be set there.");return authenticateduser}function isnewbrandusername(b,a,c){if(null==b||null==a)return!1;for(var d=0;d<b.length;d++)if(b[d].flake==a.flake&&null!=b[d].extIds&&0<=b[d].extIds.indexOf(c))return!1;return!0}
function registerauthsuccesshandler(b){nainitialized&&(b.callback&&"function"===typeof b.callback?(configurations.onAuthCallback=b.callback,console.log(" successhandler registered")):console.log(" successhandler could not be registered"))}function registerauthfailurehandler(b){nainitialized&&(b.callback&&"function"===typeof b.callback?(configurations.onAuthFailCallback=b.callback,console.log(" failurehandler registered")):console.log(" failurehandler could not be registered"))}
function logoutfromnewauth(){console.log("Log out of Newauth is not functional right now.")}
function setoverlaystyle(){overlay.getElementsByClassName("via-na-overlay")[0].style.color="#444";overlay.getElementsByClassName("via-na-overlay")[0].style.position="fixed";overlay.getElementsByClassName("via-na-overlay")[0].style.background="#888";overlay.getElementsByClassName("via-na-overlay")[0].style.width="80%";overlay.getElementsByClassName("via-na-overlay")[0].style.height="90%";overlay.getElementsByClassName("via-na-overlay")[0].style.top=.05*window.innerHeight+"px";overlay.getElementsByClassName("via-na-overlay")[0].style.left=
.1*window.innerWidth+"px";overlay.getElementsByClassName("via-na-overlay")[0].style.opacity="0.8";overlay.getElementsByClassName("via-na-overlay")[0].style.boxShadow="8px 8px 11px lightgray"}function hashUserForAuthentication(b){var a=sjcl.codec.base64.toBits("sugar");b=sjcl.misc.pbkdf2(b,a,1E3,256);b=sjcl.codec.base64.fromBits(b);sjcl.codec.base64.fromBits(a);console.log("Hashed username: "+b);return b}app(window);