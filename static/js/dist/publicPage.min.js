'use strict';var avatartoinvite,flaketoinvite,publicpagelinkclicked=!1,userGraph,sigma_ins,declinesenderid,declinesenderflake,tracktypingtimeoutid,notypingtime=1E4,nodeidflakemap={},nodeidnamemap={},nodeidconvmap={},convmsgtimemap={},convparticipants={},inviteout=0,invitein=0,conversations=0,entityMap={"\x26":"\x26amp;","\x3c":"\x26lt;","\x3e":"\x26gt;",'"':"\x26quot;","'":"\x26#39;","/":"\x26#x2F;","`":"\x26#x60;","\x3d":"\x26#x3D;"};
function escapeHtml(a){return String(a).replace(/[&<>"'`=\/]/g,function(a){return entityMap[a]})}function inviteOthers(){$("#inviteOthersModal").modal("show");return!1}
function searchnewauth(){var a=document.getElementById("searchresults");null!=a&&cleardiv(a);var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var a=d.responseText,c={};null!=a&&0<a.length&&(c=JSON.parse(a));if(0<c.length)for(a=0;a<c.length;a++)displaysearchresult(c[a]);else displayerror("No results matching search criteria.")}};d.open("POST","/newauth/api/search",!1);d.setRequestHeader("Content-Type","application/json");a=document.getElementById("search-text").value;
a=JSON.stringify({username:a});d.send(a);return!1}
function displaysearchresult(a){var d=document.getElementById("searchresults"),b="NAME HIDDEN",c="NO ALIAS",e="AVATAR UNKNOWN",f="UNKNOWN FLAKE";null!=a.firstname&&(b=a.firstname);null!=a.middleinitial&&(b+=" "+a.middleinitial);null!=a.lastname&&(b+=" "+a.lastname);null!=a.alias&&(c=a.alias);null!=a.currentavatar&&(e=a.currentavatar);null!=a.flake&&(f=a.flake);a=document.createElement("div");a.classList.add("panel-thin");a.classList.add("panel-body");a.classList.add("panel-word-wrap");var g=document.createElement("div");
g.classList.add("col-xs-12");g.classList.add("text-center");var h=document.createElement("div");h.classList.add("row");var l=document.createElement("div");l.classList.add("col-xs-3");var k=document.createElement("div");k.classList.add("col-xs-3");var n=document.createElement("div");n.classList.add("col-xs-3");var m=document.createElement("div");m.classList.add("col-xs-3");l.appendChild(getpanelfortext(b,"name"));k.appendChild(getpanelfortext(c,"alias"));h.appendChild(l);h.appendChild(k);h.appendChild(n);
h.appendChild(m);c=document.createElement("a");c.href="javascript:loadSearchDetailModal('"+e+"', '"+f+"');";e=document.createElement("p");e.classList.add("lead");b=document.createTextNode(b);e.appendChild(b);c.appendChild(e);m.appendChild(c);g.appendChild(h);a.appendChild(g);d.appendChild(a)}
function getpanelfortext(a,d){var b=document.createElement("div");b.classList.add("panel-thin");var c=document.createElement("div");c.classList.add("panel-body-thin");b.appendChild(c);var e=document.createElement("div");e.classList.add("row");var f=document.createElement("div");f.classList.add("col-xs-12");f.classList.add("center-block");f.setAttribute("align","center");e.appendChild(f);var g=document.createElement("p");g.classList.add("lead");g.classList.add("text-center");a=document.createTextNode(a);
d&&("name"==d&&c.classList.add("panel-semi-dark"),"alias"==d&&c.classList.add("panel-alias-display"),"avatar"==d&&(g.classList.remove("lead"),g.classList.add("text-muted")));g.appendChild(a);f.appendChild(g);c.appendChild(e);return b}
function displayerror(a){var d=document.getElementById("searchresults"),b=document.createElement("div");b.classList.add("panel");b.classList.add("panel-body");b.classList.add("panel-word-wrap");var c=document.createElement("div");c.classList.add("col-xs-12");var e=document.createElement("p");e.classList.add("lead");a=document.createTextNode(a);e.appendChild(a);c.appendChild(e);b.appendChild(c);d.appendChild(b)}
function loadSearchDetailModal(a,d){var b,c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=c.responseText;0<a.length&&(b=JSON.parse(a),null!=b.firstname&&(a=b.firstname,null!=b.middleinitial&&(a+=" "+b.middleinitial),null!=b.lastname&&(a+=" "+b.lastname),document.getElementById("searchedentityname").innerHTML=a),null!=b.alias&&(document.getElementById("searchedentityalias").innerHTML="\x3cem\x3e"+
b.alias+"\x3c/em\x3e"),null!=b.homepagesectiondata&&(document.getElementById("searched-entity-description").innerHTML=b.homepagesectiondata),flaketoinvite=d)}};c.open("POST","/newauth/api/searchbyflake",!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.send(JSON.stringify({currentavatar:a,flake:d}));$("#searchResultDetailModal").modal("show")}
function invitebyemailorphone(){var a=document.getElementById("inviteemailinput").value;if(0==a.length)return document.getElementById("emailinputerror").innerHTML="No email address or phone number provided",!1;ValidateEmail(a)?($("#inviteOthersModal").modal("hide"),sendInvite(a,"")):ValidatePhone(a)?(document.getElementById("emailinputerror").innerHTML="",$("#inviteOthersModal").modal("hide"),sendInvite("",a)):document.getElementById("emailinputerror").innerHTML="Does not appear to be a phone number or an email address";
return!1}
function sendInvite(a,d){var b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");b.onreadystatechange=function(){4==b.readyState&&200==b.status&&(userGraph=JSON.parse(atob(b.responseText)),clearexistinggraph(),convertanddrawgraphdata())};b.open("POST","/newauth/api/invite/externalbyphoneemail",!1);b.withCredentials=!0;b.setRequestHeader("Content-Type","application/json");var c=escapeHtml(document.getElementById("invitemessage").value),e;0<a.length&&(e={emails:a});0<d.length&&
(e={phones:'{"number":"'+d+'"}'});a=JSON.stringify({sender:{flake:loggedinuserflake},receiver:e,message:c});b.send(a)}
function sendInternalInvite(){if(null==flaketoinvite||0==flaketoinvite.length)return!1;var a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.onreadystatechange=function(){4==a.readyState&&200==a.status&&(userGraph=JSON.parse(atob(a.responseText)),clearexistinggraph(),convertanddrawgraphdata())};a.open("POST","/newauth/api/invite/internaluser",!1);a.withCredentials=!0;a.setRequestHeader("Content-Type","application/json");var d=JSON.stringify({sender:{flake:loggedinuserflake},
receiver:{currentavatar:avatartoinvite,flake:flaketoinvite}});a.send(d)}
function convertanddrawgraphdata(){nodeidflakemap={};nodeidnamemap={};nodeidconvmap={};convmsgtimemap={};convparticipants={};var a={nodes:[],edges:[]},d=conversations=invitein=inviteout=0;debugappui&&console.log(JSON.stringify(userGraph));for(var b=0;b<userGraph.length;b++)if(void 0===userGraph[b]["@type"]){if("user"==userGraph[b].label){var c=userGraph[b].id["@value"];if(void 0===nodeidnamemap[c]){var e="#eee";var f=userGraph[b];var g=getavatarname(f);var h=getusername(f);if(null!=g||null!=h)e="#090";
if(0==b){h=g=0;var l=8;f="You";var k=c}else g=Math.random(),h=Math.random(),l=2,f=getnamelabel(f);nodeidflakemap[c]=userGraph[b].flake[0];nodeidnamemap[c]=f;a.nodes.push({id:c,label:f,x:g,y:h,size:l,color:e});debugappui&&console.log("node added: "+c+" "+f)}}else debugappui&&console.log("nodeidnamemap contained "+c+" did not add");"conversation"==userGraph[b].label&&(c=userGraph[b].id["@value"],void 0===nodeidconvmap[c]&&(nodeidconvmap[c]=userGraph[b].convid["0"]["@value"]))}else-1!=userGraph[b]["@type"].indexOf("Edge")&&
(e=null,debugappui&&console.log("processing edge: "+JSON.stringify(userGraph[b])),"invited"==userGraph[b]["@value"].label&&(e=userGraph[b]["@value"].inV["@value"],userGraph[b]["@value"].inV["@value"]==k&&(invitein++,f=userGraph[b]["@value"].properties.message["@value"].value,g=userGraph[b]["@value"].outV["@value"],h=find_vertex_flake_in_JSON_graph(g),populateInvitationOnPanel(g,h,f)),userGraph[b]["@value"].outV["@value"]==k&&inviteout++),"joined"==userGraph[b]["@value"].label&&(userGraph[b]["@value"].outV["@value"]==
k&&conversations++,g=userGraph[b]["@value"].inV["@value"],f=userGraph[b]["@value"].outV["@value"],debugappui&&console.log("processing edge: "+JSON.stringify(userGraph[b])),f!=k&&(e=k,g=find_conv_id_in_JSON_graph(g),f=find_chat_name_in_JSON_graph(f),null==convparticipants?(convparticipants={},convparticipants[g]=[],convparticipants[g].push(f),populateConversationOnPanel(g,f)):void 0===convparticipants[g]?(convparticipants[g]=[],convparticipants[g].push(f),populateConversationOnPanel(g,f)):convparticipants[g].push(f))),
null!=e&&(debugappui&&console.log("adding edge "+d+" : "+userGraph[b]["@value"].id["@value"].relationId+" between "+e+" - "+userGraph[b]["@value"].outV["@value"]),a.edges.push({id:userGraph[b]["@value"].id["@value"].relationId,source:e,target:userGraph[b]["@value"].outV["@value"],size:Math.random(),color:"#ccc",type:"curve",count:d}),d++));sigma_ins=new sigma({graph:a,renderer:{container:document.getElementById("publicpageusergraph"),type:"canvas"},settings:{defaultNodeColor:"#ec5148"}});k="";0<inviteout&&
(k+="Sent invites: "+inviteout);0<invitein&&(displayInvitations(),0<k.length&&(k+="\x3cbr\x3e"),k+='\x3cbutton type\x3d"button" class\x3d"btn btn-sm btn-default" onclick\x3d"return displayInvitations();"\x3eInvitations:'+invitein+"\x3c/button\x3e");0<conversations&&(displayConversations(),0<k.length&&(k+="\x3cbr\x3e"),k+='\x3cbutton type\x3d"button" class\x3d"btn btn-sm btn-default" onclick\x3d"return displayConversations();"\x3eConversations:'+conversations+"\x3c/button\x3e");document.getElementById("graphsummary").innerHTML=
"\x3cp\x3e"+k+"\x3c/p\x3e";return a}function find_vertex_flake_in_JSON_graph(a){return nodeidflakemap[a]}function find_chat_name_in_JSON_graph(a){return nodeidnamemap[a]}function find_conv_id_in_JSON_graph(a){return nodeidconvmap[a]}function displayInvitations(){document.getElementById("invitations-panel").style.display="inline"}function displayConversations(){document.getElementById("conversations-panel").style.display="inline"}
function populateInvitationOnPanel(a,d,b){var c=document.createElement("div");c.classList.add("panel");c.classList.add("panel-thin");c.setAttribute("id","invite-"+a);var e=document.createElement("div");e.classList.add("panel-body");e.style.backgroundColor="#7283a7";var f=document.createElement("p");f.style.color="#fff";f.appendChild(document.createTextNode(b));e.appendChild(f);c.appendChild(e);b=document.createElement("div");b.classList.add("panel");b.classList.add("panel-thin");e=document.createElement("input");
e.classList.add("btn");e.classList.add("btn-primary");e.classList.add("btn-xs");e.type="button";e.value="Accept";e.addEventListener("click",acceptInvitation,!1);e.senderID=a;e.senderFlake=d;f=document.createElement("input");f.classList.add("btn");f.classList.add("btn-primary");f.classList.add("btn-xs");f.classList.add("pull-right");f.type="button";f.value="Decline";f.setAttribute("data-toggle","modal");f.setAttribute("data-target","#declineInviteModal");f.setAttribute("data-sendernodeid",a);f.setAttribute("data-senderflake",
d);b.appendChild(f);b.appendChild(e);e.style.marginRight="3px";c.appendChild(b);document.getElementById("invitations-panel-body").appendChild(c)}
function populateConversationOnPanel(a,d){if(null==document.getElementById("conversation-"+a)){var b=document.createElement("div");b.classList.add("panel");b.classList.add("panel-default");b.setAttribute("id","conversation-"+a);var c=document.createElement("div");c.classList.add("panel-heading");var e=document.createElement("h5");e.classList.add("panel-title");e.appendChild(document.createTextNode(d+" "));e.setAttribute("id","conv-header-"+a);d=document.createElement("img");d.classList.add("user-icon");
1==convparticipants[a].length&&(d.src="/static/icons/one-user-grey-16.png");1<convparticipants[a].length&&(d.src="/static/icons/multiple-users-grey-16.png");e.appendChild(d);c.appendChild(e);b.appendChild(c);c=document.createElement("div");c.classList.add("panel-body");c.classList.add("panel-word-wrap");c.classList.add("pre-scrollable");c.setAttribute("id","conv-data-"+a);c.style.backgroundColor="#cacaca";b.appendChild(c);document.getElementById("conversations-panel-body").appendChild(b);joinconversation(a);
loadconversation(a);e=document.createElement("div");e.classList.add("panel-body");e.classList.add("panel-word-wrap");e.style.backgroundColor="#c2c2c2";e.setAttribute("id","conv-message-"+a);d=document.createElement("div");d.classList.add("row");var f=document.createElement("div");f.classList.add("col-sm-9");d.appendChild(f);e.appendChild(d);var g=document.createElement("input");g.setAttribute("type","text");g.setAttribute("id","conv-message-input-"+a);g.classList.add("form-control");g.classList.add("input-md");
g.addEventListener("input",prepareSendButton,!1);g.addEventListener("change",trackTyping,!1);g.conversationID=a;g.style.color="#454545";g.size="50";var h=document.createElement("input");h.setAttribute("id","conv-send-button-"+a);h.classList.add("btn");h.classList.add("btn-primary");h.classList.add("btn-sm");h.classList.add("pull-right");h.conversationID="";h.changestarttime="";h.type="button";h.value="Send";h.addEventListener("click",sendConversationMessage,!1);a=document.createElement("div");a.classList.add("col-sm-3");
d.appendChild(a);f.appendChild(g);a.appendChild(h);e.appendChild(d);b.appendChild(e);c.scrollTop=c.scrollHeight}}function trackTyping(a){window.clearTimeout(tracktypingtimeoutid);startTrackTypingTimer(a.target.conversationID)}
function prepareSendButton(a){var d=new Date,b=document.getElementById("conv-send-button-"+a.target.conversationID);b.conversationID=a.target.conversationID;b.changestarttime=d.toUTCString();sendTypingEventForConversation(a.target.conversationID);a.target.removeEventListener("input",prepareSendButton,!1);startTrackTypingTimer(a.target.conversationID)}
function startTrackTypingTimer(a){debugappui&&console.log("in startTrackTypingTimer convid: "+a);tracktypingtimeoutid=window.setTimeout(sendNoTypingEventForConversation,notypingtime,a)}
function sendTypingEventForConversation(a){var d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.onreadystatechange=function(){};d.open("POST","/newauth/api/addtypingeventtoconversation",!1);d.withCredentials=!0;d.setRequestHeader("Content-Type","application/json");a=JSON.stringify({sender:{flake:loggedinuserflake},typing:"true",conversationID:a});d.send(a)}
function sendNoTypingEventForConversation(a){debugappui&&console.log("in sendNoTypingEventForConversation convid: "+a);var d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.onreadystatechange=function(){};d.open("POST","/newauth/api/addtypingeventtoconversation",!1);d.withCredentials=!0;d.setRequestHeader("Content-Type","application/json");var b=JSON.stringify({sender:{flake:loggedinuserflake},typing:"false",conversationID:a});d.send(b);window.clearTimeout(tracktypingtimeoutid);
document.getElementById("conv-message-input-"+a).addEventListener("input",prepareSendButton,!1)}
function sendConversationMessage(a){var d=a.target.conversationID;a=document.getElementById("conv-message-input-"+d).value;var b=document.getElementById("conv-send-button-"+d).changestarttime,c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=document.getElementById("conv-data-"+d);addconversationmessagetopanel(a,document.getElementById("conv-message-input-"+d).value,0,b,fullname);document.getElementById("conv-message-input-"+
d).value=""}};c.open("POST","/newauth/api/addmessagetoconversation",!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");a=JSON.stringify({message:a,messagecreatetime:b,conversationID:d,permanent:"false"});c.send(a)}
function acceptInvitation(a){var d=a.target.senderFlake,b=a.target.senderID;clearexistinggraph();if(null==d||0==d.length)return!1;var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){userGraph=JSON.parse(atob(c.responseText));convertanddrawgraphdata();var a=document.getElementById("invite-"+b);removediv(a);populateConversationOnPanel()}};c.open("POST","/newauth/api/acceptinvite",!1);c.withCredentials=
!0;c.setRequestHeader("Content-Type","application/json");a=JSON.stringify({sender:{flake:d},receiver:{flake:loggedinuserflake}});c.send(a)}
function declineInvitation(a){clearexistinggraph();a=document.getElementById("dontinviteagaincheck").checked;if(null==declinesenderflake||0==declinesenderflake.length)return!1;var d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){userGraph=JSON.parse(atob(d.responseText));convertanddrawgraphdata();var a=document.getElementById("invite-"+declinesenderid);removediv(a)}};d.open("POST","/newauth/api/declineinvite",
!1);d.withCredentials=!0;d.setRequestHeader("Content-Type","application/json");a=JSON.stringify({sender:{flake:declinesenderflake},receiver:{flake:loggedinuserflake},blocknewinvites:a});d.send(a)}function dismissInvitations(){document.getElementById("invitations-panel").style.display="none";return!1}function dismissConversations(){document.getElementById("conversations-panel").style.display="none";return!1}
function getnamelabel(a){if("fullName"in a)return a.fullName["0"];if("phone"in a)return a.phone["0"];if("email"in a)return a.email["0"]}function getavatarname(a){return"avatar"in a?a.avatar[0]:null}function getusername(a){return"userName"in a?a.userName[0]:null}function clearexistinggraph(){sigma_ins.graph.clear();sigma_ins.refresh()};