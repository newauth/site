'use strict';class StorageAdapter{constructor(){this.useClaudeStorage="undefined"!==typeof window&&window.storage;this.storagePrefix="schema_app_"}async get(a){if(this.useClaudeStorage)try{return await window.storage.get(a)}catch(b){return null}else{const b=localStorage.getItem(this.storagePrefix+a);return b?{key:a,value:b}:null}}async set(a,b){if(this.useClaudeStorage)return await window.storage.set(a,b);localStorage.setItem(this.storagePrefix+a,b);return{key:a,value:b}}}
class DatabaseService{constructor(a,b){this.apiBaseUrl=a||"/api";this.storage=new StorageAdapter;this.useLocalStorage=!0;this.useLocalStorage=void 0===b?!0:!!b;this.initStorage()}async initStorage(){try{const a=await this.storage.get("app_schemas"),b=await this.storage.get("native_entities");a||await this.storage.set("app_schemas",JSON.stringify(this.getDefaultAppSchemas()));b||await this.storage.set("native_entities",JSON.stringify(this.getDefaultNativeEntities()))}catch(a){console.error("Storage initialization error:",
a)}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){const b=16*Math.random()|0;return("x"===a?b:b&3|8).toString(16)})}hashUUID(a){var b=BigInt("0xcbf29ce484222325");const c=BigInt("0x100000001b3");for(let d=0;d<a.length;d++)b^=BigInt(a.charCodeAt(d)),b*=c;b&=BigInt("0xffffffffffffffff");return b.toString(36).toLowerCase()}createCustomSchema(a,b,c,d,e){const f={};d.forEach(function(a,b){const c=(b=b<d.length-1?d[b+1]:null)?b+"s":null,h=e[a]||{labelField:a+"_name",
idField:a+"_id"};f[a]={labelField:h.labelField,idField:h.idField,childEntity:b,childrenField:c};h.sortConfig?f[a].sortConfig=h.sortConfig:c&&(f[a].sortConfig={type:h.sortType||"count"},"aggregate"===h.sortType&&h.aggregateField&&(f[a].sortConfig.aggregateField=h.aggregateField,f[a].sortConfig.aggregateFunction=h.aggregateFunction||"sum"))});return{id:a,name:b,description:c,hierarchy:d,entityConfigs:f}}getDefaultAppSchemas(){return[this.createCustomSchema("custsupport","Customer Support","Customer support workflow management",
["tenant","subtenant","concern"],{tenant:{labelField:"orgname",idField:"ID",sortConfig:{type:"count"}},subtenant:{labelField:"orgname",idField:"ID",sortConfig:{type:"aggregate",aggregateField:"count",aggregateFunction:"sum"}},concern:{labelField:"concerntype",idField:"ID"}})]}getDefaultNativeEntities(){return{tenant:{name:"Tenant",description:"Top-level organization",fields:[{name:"ID",label:"Organization ID",type:"text",mandatory:!1},{name:"orgname",label:"Organization Name",type:"text",mandatory:!0},
{name:"orgshortname",label:"Short Name",type:"text",mandatory:!0},{name:"contactemail",label:"Contact Email",type:"email",mandatory:!0},{name:"hashed",label:"Use Hashed URL",type:"checkbox",mandatory:!1},{name:"count",label:"Count (for aggregation)",type:"number",mandatory:!1}]},subtenant:{name:"Sub-Tenant",description:"Sub-organization",fields:[{name:"ID",label:"Sub-Organization ID",type:"text",mandatory:!1},{name:"orgname",label:"Sub-Organization Name",type:"text",mandatory:!0},{name:"contactemail",
label:"Contact Email",type:"email",mandatory:!0},{name:"count",label:"Count (for aggregation)",type:"number",mandatory:!1}]},concern:{name:"Concern",description:"Customer concern",fields:[{name:"ID",label:"Concern ID",type:"text",mandatory:!1},{name:"concerntype",label:"Concern Type",type:"text",mandatory:!0},{name:"concerndesc",label:"Description",type:"textarea",mandatory:!0},{name:"count",label:"Count (for aggregation)",type:"number",mandatory:!1}]}}}async getAppSchemas(){if(this.useLocalStorage){var a=
await this.storage.get("app_schemas");return a?JSON.parse(a.value):this.getDefaultAppSchemas()}a=await fetch(this.apiBaseUrl+"/appschemas");if(!a.ok)throw Error("Failed to fetch schemas");return await a.json()}async saveAppSchema(a){if(this.useLocalStorage){const b=await this.getAppSchemas(),c=b.findIndex(function(b){return b.id===a.id});0<=c?b[c]=a:b.push(a);await this.storage.set("app_schemas",JSON.stringify(b));return!0}if(!(await fetch(this.apiBaseUrl+"/saveappschemas",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify(a)})).ok)throw Error("Failed to save schema");return!0}async deleteAppSchema(a){if(this.useLocalStorage){const b=await this.getAppSchemas();await this.storage.set("app_schemas",JSON.stringify(b.filter(function(b){return b.id!==a})));return!0}if(!(await fetch(this.apiBaseUrl+"/app-schemas/"+encodeURIComponent(a),{method:"DELETE"})).ok)throw Error("Failed to delete schema");return!0}async getNativeEntities(){if(this.useLocalStorage){var a=await this.storage.get("native_entities");
return a?JSON.parse(a.value):this.getDefaultNativeEntities()}a=await fetch(this.apiBaseUrl+"/native-entities");if(!a.ok)throw Error("Failed to fetch native entities");return await a.json()}async saveNativeEntity(a,b){if(this.useLocalStorage){const c=await this.getNativeEntities();c[a]=b;await this.storage.set("native_entities",JSON.stringify(c));return!0}if(!(await fetch(this.apiBaseUrl+"/native-entities/"+encodeURIComponent(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})).ok)throw Error("Failed to save native entity");
return!0}async deleteNativeEntity(a){if(this.useLocalStorage){const b=await this.getNativeEntities();delete b[a];await this.storage.set("native_entities",JSON.stringify(b));return!0}if(!(await fetch(this.apiBaseUrl+"/native-entities/"+encodeURIComponent(a),{method:"DELETE"})).ok)throw Error("Failed to delete native entity");return!0}async getAppData(a){if(this.useLocalStorage)return(a=await this.storage.get("app_data_"+a))?JSON.parse(a.value):{items:[]};a=await fetch(this.apiBaseUrl+"/app-data/"+
encodeURIComponent(a));if(!a.ok)throw Error("Failed to fetch app data");return await a.json()}async saveAppData(a,b){if(this.useLocalStorage)return await this.storage.set("app_data_"+a,JSON.stringify(b)),!0;if(!(await fetch(this.apiBaseUrl+"/app-data/"+encodeURIComponent(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})).ok)throw Error("Failed to save app data");return!0}}
class SchemaOrchestrator{constructor(a){a=a||{};this.db=new DatabaseService(a.apiBaseUrl,a.useLocalStorage);this.currentApp=null;this.currentPath=[];this.data={items:[]};this.centerZoneRadius=100;this.dotColors="#ff6b6b #4ecdc4 #45b7d1 #f9ca24 #6c5ce7 #fd79a8".split(" ");this.userLoggedIn=null;this.checkUserStatus();this.init()}async init(){await this.loadAppSelector();this.setupEventListeners()}checkUserStatus(){this.userLoggedIn=localStorage.getItem("userloggedin")||sessionStorage.getItem("userloggedin")||
this.getCookie("userloggedin")}getCookie(a){a=`; ${document.cookie}`.split(`; ${a}=`);return 2===a.length?a.pop().split(";").shift():null}setupEventListeners(){var a=this;document.getElementById("app-selector-btn").addEventListener("click",function(){a.openAppSelector()});document.getElementById("schema-btn").addEventListener("click",function(){a.openSchemaManager()});document.getElementById("close-app-selector").addEventListener("click",function(){document.getElementById("app-selector-modal").style.display=
"none"});document.getElementById("close-add-modal").addEventListener("click",function(){document.getElementById("add-modal").style.display="none"});document.getElementById("close-schema-modal").addEventListener("click",function(){document.getElementById("schema-modal").style.display="none"});document.getElementById("close-app-schema-editor").addEventListener("click",function(){document.getElementById("app-schema-editor-modal").style.display="none"});document.getElementById("close-entity-editor").addEventListener("click",
function(){document.getElementById("entity-editor-modal").style.display="none"});document.querySelectorAll(".tab").forEach(function(a){a.addEventListener("click",function(a){document.querySelectorAll(".tab").forEach(function(a){a.classList.remove("active")});document.querySelectorAll(".tab-content").forEach(function(a){a.classList.remove("active")});a.target.classList.add("active");document.getElementById(a.target.dataset.tab).classList.add("active")})})}async exportSchemasJSON(){var a=this;const b=
await this.db.getAppSchemas(),c=await this.db.getNativeEntities(),d={appSchemas:b,nativeEntities:c,exportDate:(new Date).toISOString(),version:"1.0"},e=JSON.stringify(d,null,2);document.getElementById("json-export").value=e;document.querySelectorAll(".tab").forEach(function(a){a.classList.remove("active")});document.querySelectorAll(".tab-content").forEach(function(a){a.classList.remove("active")});document.querySelector('[data-tab\x3d"json-view"]').classList.add("active");document.getElementById("json-view").classList.add("active");
document.getElementById("copy-json").onclick=function(){a.copyJSONToClipboard(e)};document.getElementById("download-json").onclick=function(){a.downloadJSON(d)}}copyJSONToClipboard(a){navigator.clipboard.writeText(a).then(function(){alert("JSON copied to clipboard!")}).catch(function(a){console.error("Failed to copy JSON:",a);document.getElementById("json-export").select();document.execCommand("copy");alert("JSON copied to clipboard!")})}downloadJSON(a){a=new Blob([JSON.stringify(a,null,2)],{type:"application/json"});
a=URL.createObjectURL(a);const b=document.createElement("a");b.href=a;b.download="schemas-export-"+(new Date).toISOString().slice(0,10)+".json";document.body.appendChild(b);b.click();document.body.removeChild(b);URL.revokeObjectURL(a)}async importSchemasJSON(a){try{if(a.appSchemas)for(const b of a.appSchemas)await this.db.saveAppSchema(b);if(a.nativeEntities)for(const b of Object.entries(a.nativeEntities))await this.db.saveNativeEntity(b[0],b[1]);alert("Schemas imported successfully!");await this.loadAppSchemas();
await this.loadNativeEntities()}catch(b){console.error("Import failed:",b),alert("Import failed: "+b.message)}}getChildCount(a,b){b=this.currentApp.entityConfigs[b];return b.childrenField?(a[b.childrenField]||[]).length:0}calculateDotSize(a,b,c){const d=this.currentApp.entityConfigs[b].sortConfig;return d?"count"===d.type?(a=this.getChildCount(a,b),this.getSizeFromCount(a,c)):"aggregate"===d.type&&d.aggregateField?(a=this.calculateAggregate(a,b,d),this.getSizeFromAggregate(a,c)):40:40}calculateAggregate(a,
b,c){b=this.currentApp.entityConfigs[b];if(!b.childrenField||!c.aggregateField)return 0;a=a[b.childrenField]||[];const d=c.aggregateField;c=c.aggregateFunction||"sum";if(0===a.length)return 0;a=a.map(function(a){return parseFloat(a[d])||0}).filter(function(a){return!isNaN(a)});switch(c){case "sum":return a.reduce(function(a,b){return a+b},0);case "avg":return 0<a.length?a.reduce(function(a,b){return a+b},0)/a.length:0;case "max":return 0<a.length?Math.max.apply(Math,a):0;case "min":return 0<a.length?
Math.min.apply(Math,a):0;default:return a.reduce(function(a,b){return a+b},0)}}getSizeFromCount(a,b){return 0===a?30:1===a?40:3>=a?50:5>=a?60:10>=a?70:80}getSizeFromAggregate(a,b){return 0===a?30:10>=a?40:50>=a?50:100>=a?60:500>=a?70:80}async loadAppSelector(){const a=await this.db.getAppSchemas();0<a.length&&await this.selectApp(a[0].id)}async openAppSelector(){var a=this;const b=document.getElementById("app-selector-modal"),c=document.getElementById("app-selector-content"),d=await this.db.getAppSchemas();
c.innerHTML='\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eSelect Application:\x3c/label\x3e\x3c/div\x3e';d.forEach(function(e){const d=document.createElement("div");d.className="schema-card";d.style.cursor="pointer";d.innerHTML="\x3ch3\x3e"+e.name+'\x3c/h3\x3e\x3cp style\x3d"color: #666; margin-top: 8px;"\x3e'+e.description+'\x3c/p\x3e\x3cp style\x3d"color: #999; font-size: 13px; margin-top: 8px;"\x3eHierarchy: '+e.hierarchy.join(" \u2192 ")+"\x3c/p\x3e";d.addEventListener("click",async function(){await a.selectApp(e.id);
b.style.display="none"});c.appendChild(d)});b.style.display="block"}async selectApp(a){if(this.currentApp=(await this.db.getAppSchemas()).find(function(b){return b.id===a}))this.data=await this.db.getAppData(a),this.currentPath=[],this.render(),this.updateBreadcrumb()}hash(a){let b=0;for(let c=0;c<a.length;c++){const d=a.charCodeAt(c);b=(b<<5)-b+d;b&=b}return Math.abs(b).toString(36)}getCurrentEntityType(){return this.currentApp?this.currentApp.hierarchy[this.currentPath.length]:null}getNextEntityType(){if(!this.currentApp)return null;
const a=this.currentPath.length;return a<this.currentApp.hierarchy.length?this.currentApp.hierarchy[a]:null}getCurrentData(){let a=this.data.items;for(let b=0;b<this.currentPath.length;b++){const c=this.currentPath[b],d=this.currentApp.entityConfigs[this.currentApp.hierarchy[b]];a=a.find(function(a){return a[d.idField]===c.id});if(!a)return[];const e=d.childrenField;a[e]||(a[e]=[]);a=a[e]}return a}async getEntityConfig(a){return(await this.db.getNativeEntities())[a]}getItemId(a,b){b=this.currentApp.entityConfigs[b].idField;
return a.hashed&&a.ID?a.displayID||this.db.hashUUID(a.ID):a[b]}getItemLabel(a,b){b=this.currentApp.entityConfigs[b].labelField;return a.ID?this.getUserLoginStatus()?a.ID:a.displayID||this.db.hashUUID(a.ID):a[b]}generateDotPositions(a){const b=[],c=window.innerWidth,d=window.innerHeight,e=c/2,f=d/2;for(let g=0;g<a;g++){let a,g,h,m=0;do{a=Math.random()*(c-100)+50;g=Math.random()*(d-100)+50;if(h=Math.sqrt(Math.pow(a-e,2)+Math.pow(g-f,2))>this.centerZoneRadius+50)for(let c of b)if(60>Math.sqrt(Math.pow(a-
c.x,2)+Math.pow(g-c.y,2))){h=!1;break}m++}while(!h&&100>m);h&&b.push({x:a,y:g})}return b}render(){var a=this;if(this.currentApp){var b=document.getElementById("canvas-area");b.innerHTML="";var c=document.createElement("div");c.className="center-zone";var d=document.createElement("button");d.className="plus-button";d.textContent="+";d.addEventListener("click",function(){a.openAddDialog()});c.appendChild(d);b.appendChild(c);c=this.getCurrentData();var e=this.generateDotPositions(c.length),f=this.getCurrentEntityType()||
this.currentApp.hierarchy[0];c.forEach(function(c,d){e[d]&&(c=a.createDot(c,e[d],d,f),b.appendChild(c))})}else document.getElementById("canvas-area").innerHTML='\x3cdiv class\x3d"loading"\x3ePlease select an application to continue\x3c/div\x3e'}createDot(a,b,c,d){var e=this;const f=document.createElement("div");f.className="dot";let g=this.calculateDotSize(a,d,c);var k=Date.now();k=a.timestamp?k-a.timestamp:Infinity;this.currentApp.entityConfigs[d].sortConfig||(864E5>k?g=70:6048E5>k&&(g=55));f.style.width=
g+"px";f.style.height=g+"px";f.style.left=b.x+"px";f.style.top=b.y+"px";f.style.fontSize=g/4+"px";f.style.backgroundColor=this.dotColors[c%this.dotColors.length];b=this.getItemLabel(a,d);f.textContent=10<b.length?b.substring(0,8)+"...":b;f.title=b;this.getNextEntityType()&&f.addEventListener("click",function(){e.navigateTo(a,d)});return f}navigateTo(a,b){this.currentPath.push({entityType:b,id:this.getItemId(a,b),label:this.getItemLabel(a,b),hashed:a.hashed||!1});this.render();this.updateBreadcrumb()}navigateToPath(a){this.currentPath=
this.currentPath.slice(0,a);this.render();this.updateBreadcrumb()}updateBreadcrumb(){var a=this;const b=document.getElementById("breadcrumb");let c='\x3ca href\x3d"#" data-index\x3d"0"\x3eHome\x3c/a\x3e';this.currentApp&&(c+=" / "+this.currentApp.name);this.currentPath.forEach(function(b,e){b=b.hashed?a.hash(b.id):b.label;c+=' / \x3ca href\x3d"#" data-index\x3d"'+(e+1)+'"\x3e'+b+"\x3c/a\x3e"});b.innerHTML=c;b.querySelectorAll("a").forEach(function(b){b.addEventListener("click",function(b){b.preventDefault();
b=parseInt(b.target.dataset.index);0===b?a.currentPath=[]:a.navigateToPath(b);a.render();a.updateBreadcrumb()})})}async openAddDialog(){var a=this;const b=this.getNextEntityType();if(b){var c=await this.getEntityConfig(b);if(c){var d=document.getElementById("add-modal"),e=document.getElementById("modal-title"),f=document.getElementById("add-form");e.textContent="Add "+c.name;f.innerHTML="";c.fields.forEach(function(a){const b=document.createElement("div");b.className="form-group";var c=document.createElement("label");
c.textContent=a.label+(a.mandatory?" *":"");b.appendChild(c);let d;if("ID"===a.name){d=document.createElement("input");d.type="text";d.value="Auto-generated";d.disabled=!0;d.style.backgroundColor="#e8f4f8";d.style.border="1px solid #b3d9e8";var e=document.createElement("span");e.textContent=" \ud83d\udd12 System Generated";e.style.color="#17a2b8";e.style.fontSize="12px";e.style.marginLeft="5px";c.appendChild(e);d.title="This ID will be automatically generated as a UUID"}else"textarea"===a.type?d=
document.createElement("textarea"):"checkbox"===a.type?(c=document.createElement("div"),c.className="checkbox-group",d=document.createElement("input"),d.type="checkbox",e=document.createElement("label"),e.textContent=a.label,c.appendChild(d),c.appendChild(e),b.innerHTML="",b.appendChild(c)):(d=document.createElement("input"),d.type=a.type);d.name=a.name;d.required=a.mandatory;"checkbox"!==a.type&&b.appendChild(d);f.appendChild(b)});e=document.createElement("div");e.style.marginTop="20px";var g=document.createElement("button");
g.type="submit";g.className="btn btn-primary";g.textContent="Add "+c.name;c=document.createElement("button");c.type="button";c.className="btn btn-secondary";c.textContent="Cancel";c.addEventListener("click",function(){d.style.display="none"});e.appendChild(g);e.appendChild(c);f.appendChild(e);f.onsubmit=async function(c){c.preventDefault();await a.addItem(b,f)};d.style.display="block"}else alert("Entity schema not found")}else alert("Maximum nesting level reached")}async addItem(a,b){var c=new FormData(b);
const d={timestamp:Date.now()};if((await this.getEntityConfig(a)).fields.some(a=>"ID"===a.name)){var e=this.db.generateUUID();d.ID=e;this.processItemID(d,a)}for(let [a,b]of c.entries())"ID"!==a&&(d[a]=b);b.querySelectorAll('input[type\x3d"checkbox"]').forEach(a=>d[a.name]=a.checked);this.processItemID(d,a);if(0===this.currentPath.length)this.data.items.push(d);else{e=this.data.items;b=a=null;for(c=0;c<this.currentPath.length;c++){const d=this.currentPath[c],g=this.currentApp.entityConfigs[this.currentApp.hierarchy[c]];
console.log(JSON.stringify(e));console.log("config.idField "+g.idField);console.log("pathItem.id "+d.id);a=e.find(a=>a[g.idField]===d.id);if(!a){console.error("Parent item not found");return}b=g;c<this.currentPath.length-1&&(e=g.childrenField,a[e]||(a[e]=[]),e=a[e])}this.getNextEntityType()&&a&&b&&(b=b.childrenField,a[b]||(a[b]=[]),a[b].push(d))}await this.db.saveAppData(this.currentApp.id,this.data);document.getElementById("add-modal").style.display="none";this.render()}processItemID(a,b){a.ID&&
(this.getUserLoginStatus()?(a.displayID=a.ID,a.hashed=!1):(b=this.db.hashUUID(a.ID),a.ID=b,a.displayID=b,a.hashed=!0))}getUserLoginStatus(){const a=localStorage.getItem("userloggedin");return a?JSON.parse(a):null}async openSchemaManager(){var a=this;document.getElementById("schema-modal").style.display="block";await this.loadAppSchemas();await this.loadNativeEntities();const b=document.querySelector("#schema-modal .modal-content");var c=b.querySelector(".modal-header");if(c&&!c.querySelector("#export-schemas-json")){var d=
document.createElement("div");d.style.cssText="display: flex; gap: 10px;";d.innerHTML='\x3cinput type\x3d"file" id\x3d"import-json-file" accept\x3d".json" style\x3d"display: none;" /\x3e\x3cbutton class\x3d"btn btn-secondary" id\x3d"import-schemas-json"\x3e\ud83d\udcc1 Import JSON\x3c/button\x3e\x3cbutton class\x3d"btn btn-primary" id\x3d"export-schemas-json"\x3e\ud83d\udce4 Export JSON\x3c/button\x3e';c.appendChild(d)}(c=b.querySelector(".tabs"))&&!c.querySelector('[data-tab\x3d"json-view"]')&&(d=
document.createElement("button"),d.className="tab",d.setAttribute("data-tab","json-view"),d.textContent="JSON View",c.appendChild(d));b&&!b.querySelector("#json-view")&&(c=document.createElement("div"),c.id="json-view",c.className="tab-content",c.innerHTML='\x3cdiv style\x3d"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 15px;"\x3e\x3ch3\x3eJSON Export/Import\x3c/h3\x3e\x3cdiv\x3e\x3cbutton class\x3d"btn btn-secondary" id\x3d"copy-json" style\x3d"margin-right: 10px;"\x3e\ud83d\udccb Copy\x3c/button\x3e\x3cbutton class\x3d"btn btn-primary" id\x3d"download-json"\x3e\ud83d\udcbe Download\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e\x3ctextarea id\x3d"json-export" style\x3d"width: 100%; height: 400px; font-family: monospace; font-size: 12px; padding: 10px;" readonly\x3e\x3c/textarea\x3e',
b.appendChild(c));document.getElementById("add-app-schema").onclick=function(){a.createAppSchema()};document.getElementById("add-native-entity").onclick=function(){a.createNativeEntity()};document.getElementById("export-schemas-json").onclick=function(){a.exportSchemasJSON()};document.getElementById("import-schemas-json").onclick=function(){document.getElementById("import-json-file").click()};document.getElementById("import-json-file").onchange=async function(b){if(b=b.target.files[0]){const c=new FileReader;
c.onload=async function(b){try{const c=JSON.parse(b.target.result);await a.importSchemasJSON(c)}catch(k){alert("Invalid JSON file: "+k.message)}};c.readAsText(b)}};document.getElementById("copy-json").onclick=function(){const a=document.getElementById("json-export").value;a&&navigator.clipboard.writeText(a).then(function(){alert("JSON copied to clipboard!")}).catch(function(a){console.error("Failed to copy JSON:",a);document.getElementById("json-export").select();document.execCommand("copy");alert("JSON copied to clipboard!")})};
document.getElementById("download-json").onclick=function(){const b=document.getElementById("json-export").value;if(b)try{const c=JSON.parse(b);a.downloadJSON(c)}catch(f){alert("No valid JSON to download")}};document.querySelectorAll(".tab").forEach(function(a){a.addEventListener("click",function(a){document.querySelectorAll(".tab").forEach(function(a){a.classList.remove("active")});document.querySelectorAll(".tab-content").forEach(function(a){a.classList.remove("active")});a.target.classList.add("active");
document.getElementById(a.target.dataset.tab).classList.add("active")})});document.getElementById("close-schema-modal").onclick=function(){document.getElementById("schema-modal").style.display="none"};await this.loadAppSchemas();await this.loadNativeEntities()}async loadAppSchemas(){var a=this;const b=document.getElementById("app-schemas-list"),c=await this.db.getAppSchemas();b.innerHTML="";c.forEach(function(c){const d=document.createElement("div");d.className="schema-card";d.innerHTML='\x3cdiv class\x3d"schema-card-header"\x3e\x3ch3\x3e'+
c.name+'\x3c/h3\x3e\x3cdiv\x3e\x3cbutton class\x3d"btn btn-primary" style\x3d"margin-right: 10px;"\x3eEdit\x3c/button\x3e\x3cbutton class\x3d"btn btn-danger"\x3eDelete\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e\x3cp style\x3d"color: #666; margin-bottom: 10px;"\x3e'+c.description+'\x3c/p\x3e\x3cp style\x3d"color: #999; font-size: 13px;"\x3e\x3cstrong\x3eHierarchy:\x3c/strong\x3e '+c.hierarchy.join(" \u2192 ")+"\x3c/p\x3e";d.querySelector(".btn-primary").onclick=function(){a.editAppSchema(c)};d.querySelector(".btn-danger").onclick=
async function(){confirm('Delete app schema "'+c.name+'"?')&&(await a.db.deleteAppSchema(c.id),await a.loadAppSchemas())};b.appendChild(d)})}async loadNativeEntities(){var a=this;const b=document.getElementById("native-entities-list"),c=await this.db.getNativeEntities();b.innerHTML="";Object.keys(c).forEach(function(d){const e=c[d],f=document.createElement("div");f.className="entity-item";f.innerHTML='\x3cdiv class\x3d"entity-header"\x3e\x3cdiv\x3e\x3ch4\x3e'+e.name+'\x3c/h4\x3e\x3cp style\x3d"color: #666; font-size: 13px;"\x3e'+
e.description+'\x3c/p\x3e\x3c/div\x3e\x3cdiv\x3e\x3cbutton class\x3d"btn btn-primary" style\x3d"margin-right: 10px;"\x3eEdit\x3c/button\x3e\x3cbutton class\x3d"btn btn-danger"\x3eDelete\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"field-list"\x3e\x3cstrong\x3eFields ('+e.fields.length+"):\x3c/strong\x3e "+e.fields.map(function(a){return a.label}).join(", ")+"\x3c/div\x3e";f.querySelector(".btn-primary").onclick=function(){a.editNativeEntity(d,e)};f.querySelector(".btn-danger").onclick=
async function(){confirm('Delete entity "'+e.name+'"?')&&(await a.db.deleteNativeEntity(d),await a.loadNativeEntities())};b.appendChild(f)})}createAppSchema(){this.editAppSchema({id:"new_"+Date.now(),name:"New App",description:"",hierarchy:[],entityConfigs:{}})}async editAppSchema(a){var b=this;const c=document.getElementById("app-schema-editor-modal");var d=document.getElementById("app-schema-editor-title");const e=document.getElementById("app-schema-editor-content");d.textContent=a.id.startsWith("new_")?
"Create App Schema":"Edit App Schema";const f=await this.db.getNativeEntities();d=Object.keys(f);e.innerHTML='\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eApp ID\x3c/label\x3e\x3cinput type\x3d"text" id\x3d"schema-id" value\x3d"'+a.id+'" '+(a.id.startsWith("new_")?"":"readonly")+'\x3e\x3c/div\x3e\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eApp Name\x3c/label\x3e\x3cinput type\x3d"text" id\x3d"schema-name" value\x3d"'+a.name+'"\x3e\x3c/div\x3e\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eDescription\x3c/label\x3e\x3ctextarea id\x3d"schema-description"\x3e'+
a.description+'\x3c/textarea\x3e\x3c/div\x3e\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eHierarchy (in order)\x3c/label\x3e\x3cdiv id\x3d"hierarchy-list"\x3e\x3c/div\x3e\x3cselect id\x3d"add-hierarchy-entity" style\x3d"margin-top: 10px;"\x3e\x3coption value\x3d""\x3e-- Add Entity --\x3c/option\x3e'+d.map(function(a){return'\x3coption value\x3d"'+a+'"\x3e'+f[a].name+"\x3c/option\x3e"}).join("")+'\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eSort Configuration\x3c/label\x3e\x3cdiv id\x3d"sort-config-list"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv style\x3d"margin-top: 20px;"\x3e\x3cbutton class\x3d"btn btn-primary" id\x3d"save-app-schema"\x3eSave\x3c/button\x3e\x3cbutton class\x3d"btn btn-secondary" id\x3d"cancel-app-schema"\x3eCancel\x3c/button\x3e\x3c/div\x3e';
const g=e.querySelector("#hierarchy-list"),k=function(){g.innerHTML="";a.hierarchy.forEach(function(b,c){const d=document.createElement("div");d.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; margin-bottom: 5px; border-radius: 4px;";d.innerHTML="\x3cspan\x3e"+(c+1)+". "+(f[b]?f[b].name:b)+"\x3c/span\x3e\x3cdiv\x3e"+(0<c?'\x3cbutton class\x3d"btn-secondary" style\x3d"padding: 4px 8px; margin-right: 5px;"\x3e\u2191\x3c/button\x3e':
"")+(c<a.hierarchy.length-1?'\x3cbutton class\x3d"btn-secondary" style\x3d"padding: 4px 8px; margin-right: 5px;"\x3e\u2193\x3c/button\x3e':"")+'\x3cbutton class\x3d"btn-danger" style\x3d"padding: 4px 8px;"\x3eRemove\x3c/button\x3e\x3c/div\x3e';b=d.querySelectorAll("button");let e=0;0<c&&(b[e++].onclick=function(){var b=a.hierarchy[c];a.hierarchy[c]=a.hierarchy[c-1];a.hierarchy[c-1]=b;k();l()});c<a.hierarchy.length-1&&(b[e++].onclick=function(){var b=a.hierarchy[c];a.hierarchy[c]=a.hierarchy[c+1];
a.hierarchy[c+1]=b;k();l()});b[e].onclick=function(){a.hierarchy.splice(c,1);k();l()};g.appendChild(d)})},l=function(){const b=e.querySelector("#sort-config-list");b.innerHTML="";a.hierarchy.forEach(function(c,d){if(d=d<a.hierarchy.length-1?a.hierarchy[d+1]:null){const e=(a.entityConfigs[c]||{}).sortConfig||{type:"count"},h=document.createElement("div");h.style.cssText="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;";h.innerHTML="\x3ch4\x3e"+(f[c]?f[c].name:c)+'\x3c/h4\x3e\x3cp style\x3d"color: #666; font-size: 12px; margin-bottom: 10px;"\x3eThis dot size is determined by: \x3cstrong\x3echildren in '+
(f[d]?f[d].name:d)+'s\x3c/strong\x3e\x3c/p\x3e\x3cdiv style\x3d"display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px;"\x3eSort Method\x3c/label\x3e\x3cselect data-entity\x3d"'+c+'" data-prop\x3d"type" style\x3d"width: 100%; padding: 6px;"\x3e\x3coption value\x3d"count" '+("count"===e.type?"selected":"")+"\x3eCount of "+d+'s\x3c/option\x3e\x3coption value\x3d"aggregate" '+("aggregate"===e.type?"selected":"")+"\x3eAggregate "+d+' data\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"aggregate-fields-'+
c+'" style\x3d"display: '+("aggregate"===e.type?"block":"none")+';"\x3e\x3clabel style\x3d"font-size: 12px;"\x3eFunction\x3c/label\x3e\x3cselect data-entity\x3d"'+c+'" data-prop\x3d"aggregateFunction" style\x3d"width: 100%; padding: 6px;"\x3e\x3coption value\x3d"sum" '+("sum"===e.aggregateFunction?"selected":"")+'\x3eSum\x3c/option\x3e\x3coption value\x3d"avg" '+("avg"===e.aggregateFunction?"selected":"")+'\x3eAverage\x3c/option\x3e\x3coption value\x3d"max" '+("max"===e.aggregateFunction?"selected":
"")+'\x3eMax\x3c/option\x3e\x3coption value\x3d"min" '+("min"===e.aggregateFunction?"selected":"")+'\x3eMin\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv class\x3d"aggregate-fields-'+c+'" style\x3d"grid-column: 1 / -1; display: '+("aggregate"===e.type?"block":"none")+';"\x3e\x3clabel style\x3d"font-size: 12px;"\x3eField to Aggregate (in '+d+')\x3c/label\x3e\x3cinput type\x3d"text" data-entity\x3d"'+c+'" data-prop\x3d"aggregateField" value\x3d"'+(e.aggregateField||"")+'" placeholder\x3d"e.g., count, amount, priority" style\x3d"width: 100%; padding: 6px;"\x3e\x3c/div\x3e\x3c/div\x3e';
h.querySelector('select[data-entity\x3d"'+c+'"][data-prop\x3d"type"]').addEventListener("change",function(a){h.querySelectorAll(".aggregate-fields-"+c).forEach(function(b){b.style.display="aggregate"===a.target.value?"block":"none"})});b.appendChild(h)}});b.querySelectorAll("select[data-entity], input[data-entity]").forEach(function(b){b.addEventListener("change",function(b){const c=b.target.dataset.entity,d=b.target.dataset.prop;b=b.target.value;a.entityConfigs[c]||(a.entityConfigs[c]={});a.entityConfigs[c].sortConfig||
(a.entityConfigs[c].sortConfig={});a.entityConfigs[c].sortConfig[d]=b})})};k();l();e.querySelector("#add-hierarchy-entity").onchange=function(b){if(b.target.value&&!a.hierarchy.includes(b.target.value)){a.hierarchy.push(b.target.value);if(!a.entityConfigs[b.target.value]){var c=f[b.target.value];const d=c.fields.find(function(a){return a.name.includes("name")})?c.fields.find(function(a){return a.name.includes("name")}).name:c.fields[0].name;c=c.fields.find(function(a){return a.name.includes("id")})?
c.fields.find(function(a){return a.name.includes("id")}).name:c.fields[0].name;a.entityConfigs[b.target.value]={labelField:d,idField:c,childEntity:null,childrenField:b.target.value+"s"}}k();l();b.target.value=""}};e.querySelector("#save-app-schema").onclick=async function(){a.id=e.querySelector("#schema-id").value;a.name=e.querySelector("#schema-name").value;a.description=e.querySelector("#schema-description").value;a.hierarchy.forEach(function(b,c){a.entityConfigs[b].childEntity=c<a.hierarchy.length-
1?a.hierarchy[c+1]:null});await b.db.saveAppSchema(a);c.style.display="none";await b.loadAppSchemas()};e.querySelector("#cancel-app-schema").onclick=function(){c.style.display="none"};c.style.display="block"}createNativeEntity(){this.editNativeEntity("new_entity_"+Date.now(),{name:"New Entity",description:"",fields:[]})}editNativeEntity(a,b){const c=document.getElementById("entity-editor-modal"),d=document.getElementById("entity-editor-title"),e=document.getElementById("entity-editor-content");d.textContent=
a.startsWith("new_")?"Create Native Entity":"Edit Native Entity";e.innerHTML='\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eEntity Key\x3c/label\x3e\x3cinput type\x3d"text" id\x3d"entity-key" value\x3d"'+a+'" '+(a.startsWith("new_")?"":"readonly")+'\x3e\x3c/div\x3e\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eEntity Name\x3c/label\x3e\x3cinput type\x3d"text" id\x3d"entity-name" value\x3d"'+b.name+'"\x3e\x3c/div\x3e\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eDescription\x3c/label\x3e\x3ctextarea id\x3d"entity-description"\x3e'+
b.description+'\x3c/textarea\x3e\x3c/div\x3e\x3cdiv class\x3d"form-group"\x3e\x3clabel\x3eFields\x3c/label\x3e\x3cdiv id\x3d"entity-fields-list"\x3e\x3c/div\x3e\x3cbutton class\x3d"btn btn-primary" id\x3d"add-entity-field" style\x3d"margin-top: 10px;"\x3e+ Add Field\x3c/button\x3e\x3c/div\x3e\x3cdiv style\x3d"margin-top: 20px;"\x3e\x3cbutton class\x3d"btn btn-primary" id\x3d"save-entity"\x3eSave\x3c/button\x3e\x3cbutton class\x3d"btn btn-secondary" id\x3d"cancel-entity"\x3eCancel\x3c/button\x3e\x3c/div\x3e';
const f=e.querySelector("#entity-fields-list"),g=function(){f.innerHTML="";b.fields.forEach(function(a,c){const d=document.createElement("div");d.className="field-item";d.innerHTML="ID"===a.name?'\x3cdiv style\x3d"display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 10px; align-items: end;"\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px;"\x3eName\x3c/label\x3e\x3cinput type\x3d"text" value\x3d"ID" readonly style\x3d"background-color: #e8f4f8; cursor: not-allowed;" data-index\x3d"'+
c+'" data-prop\x3d"name"\x3e\x3c/div\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px;"\x3eLabel\x3c/label\x3e\x3cinput type\x3d"text" value\x3d"ID" readonly style\x3d"background-color: #e8f4f8; cursor: not-allowed;" data-index\x3d"'+c+'" data-prop\x3d"label"\x3e\x3c/div\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px;"\x3eType\x3c/label\x3e\x3cselect data-index\x3d"'+c+'" data-prop\x3d"type" disabled style\x3d"background-color: #e8f4f8; cursor: not-allowed;"\x3e\x3coption value\x3d"text" selected\x3eText\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px; display: flex; align-items: center; gap: 5px;"\x3e\x3cinput type\x3d"checkbox" checked disabled\x3e Required\x3c/label\x3e\x3c/div\x3e\x3cbutton class\x3d"btn-danger" data-index\x3d"'+
c+'" style\x3d"padding: 6px 12px;" disabled\x3eSystem Field\x3c/button\x3e\x3c/div\x3e\x3cdiv style\x3d"margin-top: 5px; font-size: 11px; color: #17a2b8;"\x3e\ud83d\udd12 System-generated unique identifier\x3c/div\x3e':'\x3cdiv style\x3d"display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 10px; align-items: end;"\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px;"\x3eName\x3c/label\x3e\x3cinput type\x3d"text" value\x3d"'+a.name+'" data-index\x3d"'+c+'" data-prop\x3d"name" style\x3d"width: 100%; padding: 6px;"\x3e\x3c/div\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px;"\x3eLabel\x3c/label\x3e\x3cinput type\x3d"text" value\x3d"'+
a.label+'" data-index\x3d"'+c+'" data-prop\x3d"label" style\x3d"width: 100%; padding: 6px;"\x3e\x3c/div\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px;"\x3eType\x3c/label\x3e\x3cselect data-index\x3d"'+c+'" data-prop\x3d"type" style\x3d"width: 100%; padding: 6px;"\x3e\x3coption value\x3d"text" '+("text"===a.type?"selected":"")+'\x3eText\x3c/option\x3e\x3coption value\x3d"textarea" '+("textarea"===a.type?"selected":"")+'\x3eTextarea\x3c/option\x3e\x3coption value\x3d"email" '+("email"===a.type?
"selected":"")+'\x3eEmail\x3c/option\x3e\x3coption value\x3d"checkbox" '+("checkbox"===a.type?"selected":"")+'\x3eCheckbox\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3cdiv\x3e\x3clabel style\x3d"font-size: 12px; display: flex; align-items: center; gap: 5px;"\x3e\x3cinput type\x3d"checkbox" '+(a.mandatory?"checked":"")+' data-index\x3d"'+c+'" data-prop\x3d"mandatory"\x3eRequired\x3c/label\x3e\x3c/div\x3e\x3cbutton class\x3d"btn-danger" data-index\x3d"'+c+'" style\x3d"padding: 6px 12px;"\x3eRemove\x3c/button\x3e\x3c/div\x3e';
d.querySelectorAll("input[data-prop], select[data-prop]").forEach(function(a){a.onchange=function(a){var c=parseInt(a.target.dataset.index),d=a.target.dataset.prop;b.fields[c][d]="mandatory"===d?a.target.checked:a.target.value}});"ID"!==a.name&&(d.querySelector("button").onclick=function(){b.fields.splice(c,1);g()});f.appendChild(d)})};g();e.querySelector("#add-entity-field").onclick=function(){b.fields.push({name:"newfield",label:"New Field",type:"text",mandatory:!1});g()};e.querySelector("#save-entity").onclick=
async function(){const d=e.querySelector("#entity-key").value;b.name=e.querySelector("#entity-name").value;b.description=e.querySelector("#entity-description").value;d!==a&&await this.db.deleteNativeEntity(a);await this.db.saveNativeEntity(d,b);c.style.display="none";await this.loadNativeEntities()};e.querySelector("#cancel-entity").onclick=function(){c.style.display="none"};c.style.display="block"}}
"undefined"!==typeof window&&(window.SchemaOrchestrator=SchemaOrchestrator,window.DatabaseService=DatabaseService);