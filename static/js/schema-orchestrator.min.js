console.log=()=>{};class SeededRandom{constructor(t){this.a=1664525,this.c=1013904223,this.m=Math.pow(2,32),this.seed=t%this.m}random(){return this.seed=(this.a*this.seed+this.c)%this.m,this.seed/this.m}randomBetween(t,e){return t+this.random()*(e-t)}}class StorageAdapter{constructor(){this.storagePrefix="schema_app_"}async get(t){const e=localStorage.getItem(this.storagePrefix+t);return e?{key:t,value:e}:null}async set(t,e){return localStorage.setItem(this.storagePrefix+t,e),{key:t,value:e}}}class DatabaseService{constructor(t,e){this.apiBaseUrl=t||"/api",this.storage=new StorageAdapter,this.useLocalStorage=!0,this.useLocalStorage=void 0===e||Boolean(e),this._getAppSchemasPromise=null,this._appDataPromises=new Map}async initStorage(){try{if(this.useLocalStorage){const[t,e]=await Promise.all([this.storage.get("app_schemas"),this.storage.get("native_entities")]);t||await this.storage.set("app_schemas",JSON.stringify(this.getDefaultAppSchemas())),e||await this.storage.set("native_entities",JSON.stringify(this.getDefaultNativeEntities()))}else{const[t,e]=await Promise.all([this.getAppSchemas(),this.getNativeEntities()]);if(!t||0===t.length)for(const t of this.getDefaultAppSchemas())await this.saveAppSchema(t);if(!e||0===Object.keys(e).length){const t=this.getDefaultNativeEntities();for(const[e,n]of Object.entries(t))await this.saveNativeEntity(e,n)}this.nativeEntities=e,console.log("[initStorage] Stored nativeentities in db this.nativeEntities: ",this.nativeEntities)}}catch(t){console.error("Storage initialization error:",t)}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}hashUUID(t){if("string"!=typeof t||0===t.length)return console.warn("[hashUUID] Invalid input (expected UUID string):",t),"";if(!t.includes("-"))return t;const e=BigInt("0xcbf29ce484222325"),n=BigInt("0x100000001b3");let a=e;for(let e=0;e<t.length;e++)a^=BigInt(t.charCodeAt(e)),a*=n;return a&=BigInt("0xffffffffffffffff"),a.toString(36).toLowerCase()}createCustomSchema(t,e,n,a,i){const o={};return a.forEach((function(t,e){const n=e<a.length-1?a[e+1]:null,s=n?n+"s":null,r=i[t]||{labelField:t+"_name",idField:t+"_id"};o[t]={labelField:r.labelField,idField:r.idField,childEntity:n,childrenField:s},r.sortConfig?o[t].sortConfig=r.sortConfig:s&&(o[t].sortConfig={type:r.sortType||"count"},"aggregate"===r.sortType&&r.aggregateField&&(o[t].sortConfig.aggregateField=r.aggregateField,o[t].sortConfig.aggregateFunction=r.aggregateFunction||"sum"))})),{id:t,name:e,description:n,hierarchy:a,entityConfigs:o}}getDefaultAppSchemas(){return[this.createCustomSchema("custsupport","Customer Support","Customer support workflow management",["organization","customer","concern"],{organization:{labelField:"name",idField:"ID",childEntity:"customer",childrenField:"customers",disallowShareButton:!0,sortConfig:{type:"count"}},customer:{labelField:"name",idField:"ID",childEntity:"concern",childrenField:"concerns",sortConfig:{type:"aggregate",aggregateField:"count",aggregateFunction:"sum"}},concern:{labelField:"name",idField:"ID",childEntity:null,childrenField:null}})]}getDefaultNativeEntities(){return{tenant:{name:"Tenant",description:"Top-level organization",fields:[{name:"ID",label:"Organization ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"displayID",label:"Display ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"name",label:"Organization Name",type:"text",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"dotLabel",label:"Dot Label",type:"text",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"contactemail",label:"Contact Email",type:"email",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"image",label:"Logo/Image URL",type:"url",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"website",label:"Website URL",type:"url",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"hashed",label:"Use Hashed URL",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"count",label:"Count (for aggregation)",type:"number",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"timestamp",label:"Timestamp",type:"number",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"hidden",label:"Hidden",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"writeAccess",label:"Write Access",type:"select",mandatory:!1,writePermission:"root",dataSource:"manual",options:["owner","parent","ancestor","any"]},{name:"readAccess",label:"Read Access",type:"select",mandatory:!1,writePermission:"root",dataSource:"manual",options:["owner","parent","ancestor","any"]}]},customer:{name:"Customer",description:"Sub-organization",fields:[{name:"ID",label:"Sub-Organization ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"displayID",label:"Display ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"name",label:"Name",type:"text",mandatory:!0,writePermission:"parent",dataSource:"manual"},{name:"dotLabel",label:"Dot Label",type:"text",mandatory:!0,writePermission:"parent",dataSource:"manual"},{name:"contactemail",label:"Contact Email",type:"email",mandatory:!0,writePermission:"parent",dataSource:"manual"},{name:"image",label:"Logo/Image URL",type:"url",mandatory:!1,writePermission:"parent",dataSource:"manual"},{name:"website",label:"Website URL",type:"url",mandatory:!1,writePermission:"parent",dataSource:"manual"},{name:"timestamp",label:"Timestamp",type:"number",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"hidden",label:"Hidden",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"hashed",label:"Use Hashed URL",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"writeAccess",label:"Write Access",type:"select",mandatory:!1,writePermission:"parent",dataSource:"manual",options:["owner","parent","ancestor","any"]},{name:"readAccess",label:"Read Access",type:"select",mandatory:!1,writePermission:"parent",dataSource:"manual",options:["owner","parent","ancestor","any"]}]},concern:{name:"Concern",description:"Customer concern",fields:[{name:"ID",label:"Concern ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"displayID",label:"Display ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"name",label:"Concern",type:"text",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"dotLabel",label:"Dot Label",type:"text",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"description",label:"Concern details",type:"textarea",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"status",label:"Status",type:"select",mandatory:!1,writePermission:"ancestor",dataSource:"manual",options:["Open","In Progress","Resolved","Closed"]},{name:"image",label:"Image URL",type:"url",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"website",label:"Reference URL",type:"url",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"timestamp",label:"Timestamp",type:"number",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"hidden",label:"Hidden",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"hashed",label:"Use Hashed data",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"convid",label:"Conversation ID",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"writeAccess",label:"Write Access",type:"select",mandatory:!1,writePermission:"ancestor",dataSource:"manual",options:["owner","parent","ancestor","any"]},{name:"readAccess",label:"Read Access",type:"select",mandatory:!1,writePermission:"ancestor",dataSource:"manual",options:["owner","parent","ancestor","any"]}]}}}_invalidateSchemasCache(){this._getAppSchemasPromise=null}async getAppSchemas(){if(this.useLocalStorage){const t=await this.storage.get("app_schemas");return t?JSON.parse(t.value):this.getDefaultAppSchemas()}return this._getAppSchemasPromise||(this._getAppSchemasPromise=fetch(this.apiBaseUrl+"/appschemas").then((t=>{if(!t.ok)throw new Error("schemas");return t.json()}))),this._getAppSchemasPromise}async saveAppSchema(t){if(this.useLocalStorage){const e=await this.getAppSchemas(),n=e.findIndex((function(e){return e.id===t.id}));return n>=0?e[n]=t:e.push(t),await this.storage.set("app_schemas",JSON.stringify(e)),!0}if(!(await fetch(this.apiBaseUrl+"/saveappschemas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok)throw new Error("Failed to save schema");return this._invalidateSchemasCache(),!0}async deleteAppSchema(t){if(this.useLocalStorage){const e=await this.getAppSchemas();return await this.storage.set("app_schemas",JSON.stringify(e.filter((function(e){return e.id!==t})))),!0}if(!(await fetch(this.apiBaseUrl+"/removeappschema/"+encodeURIComponent(t),{method:"DELETE"})).ok)throw new Error("Failed to delete schema");return this._invalidateSchemasCache(),!0}async getNativeEntities(){if(console.log("=== GET NATIVE ENTITIES CALLED ==="),console.log("Call stack:",(new Error).stack),console.log("=== END CALL STACK ==="),this.useLocalStorage){const t=await this.storage.get("native_entities");return t?JSON.parse(t.value):this.getDefaultNativeEntities()}const t=await fetch(this.apiBaseUrl+"/getnativeentities");if(!t.ok)throw new Error("Failed to fetch native entities");return await t.json()}async saveNativeEntity(t,e){if(this.useLocalStorage){const n=await this.getNativeEntities();return n[t]=e,await this.storage.set("native_entities",JSON.stringify(n)),!0}if(!(await fetch(this.apiBaseUrl+"/savenativeentity/"+encodeURIComponent(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Failed to save native entity");return!0}async deleteNativeEntity(t){if(this.useLocalStorage){const e=await this.getNativeEntities();return delete e[t],await this.storage.set("native_entities",JSON.stringify(e)),!0}if(!(await fetch(this.apiBaseUrl+"/removenativeentity/"+encodeURIComponent(t),{method:"DELETE"})).ok)throw new Error("Failed to delete native entity");return!0}_invalidateAppDataCache(t){this._appDataPromises.delete(t)}async getAppData(t,e=null,n={}){if(this.useLocalStorage){const e=await this.storage.get("app_data_"+t);return e?JSON.parse(e.value):{items:[]}}const a=e?`${t}_${e.join("/")}`:t;if(n.bypassCache&&(console.log(`[getAppData] Bypassing cache for key: ${a}`),this._appDataPromises.delete(a)),!this._appDataPromises.has(a)){let i;if(console.log("[getAppData] isowner: ",isowner),console.log("[getAppData] forcePath: ",e),null!==e)0===e.length?(i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}`,console.log("[getAppData] Forced full hierarchy fetch")):1===e.length?(i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}/${encodeURIComponent(e[0])}`,console.log("[getAppData] Forced tenant fetch:",e[0])):e.length>=2&&(i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}/${encodeURIComponent(e[0])}/${encodeURIComponent(e[1])}`,console.log("[getAppData] Forced subtenant fetch:",e[1]));else{const e=window.app.parseUrlForDataFetch();if("undefined"!=typeof isowner&&isowner&&e&&!e.tenantId&&!e.subtenantId)i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}`,console.log("[getAppData] Owner at root ‚Äî fetching ALL tenants");else if(e&&e.subtenantId)i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}/${encodeURIComponent(e.tenantId)}/${encodeURIComponent(e.subtenantId)}`,console.log("[getAppData] Fetching subtenant data from URL:",e.subtenantId);else if(e&&e.tenantId)i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}/${encodeURIComponent(e.tenantId)}`,console.log("[getAppData] Fetching tenant data from URL:",e.tenantId);else{const e=app.getLastViewedContext(t);if(e&&e.pathIds&&e.pathIds.length>0){const n=e.pathIds.map((t=>t.includes("-")?this.hashUUID(t):t));1===n.length?(i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}/${encodeURIComponent(n[0])}`,console.log("[getAppData] Fetching tenant data from saved context:",n[0])):n.length>=2?(i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}/${encodeURIComponent(n[0])}/${encodeURIComponent(n[1])}`,console.log("[getAppData] Fetching subtenant data from saved context:",n[1])):(i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}`,console.log("[getAppData] Fallback to root from saved context"))}else i=`${this.apiBaseUrl}/getappdata/${encodeURIComponent(t)}/system`,console.log("[getAppData] Fallback to system tenant")}}if(n.bypassCache){const t=`_cb=${Date.now()}`;i=i.includes("?")?`${i}&${t}`:`${i}?${t}`,console.log(`[getAppData] Cache-buster URL: ${i}`)}const o=fetch(i).then((async e=>{if(404===e.status)return{items:[]};if(!e.ok)return console.error(`getAppData ${t} ‚Üí ${e.status}`),{items:[]};const n=await e.text();if(!n||'""'===n||"{}"===n)return{items:[]};try{const t=JSON.parse(n);return t&&"object"==typeof t?(Array.isArray(t.items)||(t.items=[]),t):{items:[]}}catch(t){return console.error("JSON parse fail",t,n),{items:[]}}})).catch((t=>(console.error("Network error in getAppData",t),{items:[]})));this._appDataPromises.set(a,o)}return this._appDataPromises.get(a)}async saveAppData(t,e){if(console.log("=== SENDING TO SERVER ==="),console.log("App Data being sent:",JSON.stringify(e,null,2)),console.log("Metadata being sent:",e.metaData),console.log("========================="),console.log("[DB] saveAppData ‚Äì useLocalStorage?",this.useLocalStorage),this.useLocalStorage)return await this.storage.set("app_data_"+t,JSON.stringify(e)),!0;if(!(await fetch(this.apiBaseUrl+"/saveappdata/"+encodeURIComponent(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Failed to save app data");return this._invalidateAppDataCache(t),console.log("[DB] saveAppData ‚Äì complete"),!0}async savePartialAppData(t,e,n){if(console.log("[savePartialAppData] Saving with metadata:",n),this.useLocalStorage){await this.getAppData(t);return await this.storage.set("app_data_"+t,JSON.stringify(e)),!0}const a={data:e,metadata:n};if(!(await fetch(this.apiBaseUrl+"/saveappdata/"+encodeURIComponent(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok)throw new Error("Failed to save partial app data");return this._invalidateAppDataCache(t),!0}}class SchemaOrchestrator{set currentPath(t){console.log("=== currentPath SET ==="),console.log("[currentPath] New value:",t),console.log("[currentPath]Stack trace:",(new Error).stack),this._currentPath=t}get currentPath(){return this._currentPath}constructor(t){this._currentPath=[],t=t||{},this.db=new DatabaseService(t.apiBaseUrl,t.useLocalStorage),this.currentApp=null,this.currentPath=[],this.data={items:[]},this.centerZoneRadius=100,this.dotColors=["#ff6b6b","#4ecdc4","#45b7d1","#f9ca24","#6c5ce7","#fd79a8"],this.searchTerm="",this.searchResults=null,this.versionPollInterval=null,this.lastKnownTimestamp=0,this.isPollingActive=!1,this.pollingSessionToken=null,this.init()}isOwner(){return this.isOwnerUser}_createGuestModeBanner(){if("true"===localStorage.getItem("guestModeBannerDismissed"))return void console.log("[GuestMode] Banner dismissed by user - not showing");const t=document.createElement("div");t.className="guest-mode-banner",t.innerHTML='\n\t\t\t    <div class="guest-mode-banner-content">\n\t\t\t        <div class="guest-mode-banner-text">\n\t\t\t            <strong>Guest Mode:</strong> You\'re using this app without an account.\n\t\t\t            <ul>\n\t\t\t                <li aria-label="Personal digital vault for your data"><strong>Personal digital vault</strong> for your data</li>\n\t\t\t                <li aria-label="One click access to all your .apps"><strong>One-click access</strong> to all .apps</li>\n\t\t\t                <li aria-label="Custom .apps for your workflows"><strong>Build custom .apps</strong> for your workflows</li>\n\t\t\t            </ul>\n\t\t\t            <a href="/signup" style="color: white; text-decoration: underline; font-weight: 600;">Create account</a>\n\t\t\t        </div>\n\t\t\t        <button class="guest-mode-banner-close" aria-label="Close guest mode banner">√ó</button>\n\t\t\t    </div>\n\t\t\t',document.body.appendChild(t),t.addEventListener("mouseenter",(()=>{t.classList.add("expanded")})),t.addEventListener("mouseleave",(e=>{t.contains(e.relatedTarget)||t.classList.remove("expanded")})),t.addEventListener("click",(e=>{e.target.classList.contains("guest-mode-banner-close")?(e.stopPropagation(),this._showDismissDialog(t)):t.classList.toggle("expanded")})),document.addEventListener("click",(e=>{!t.contains(e.target)&&t.classList.contains("expanded")&&t.classList.remove("expanded")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&t.classList.contains("expanded")&&t.classList.remove("expanded")})),console.log("[GuestMode] Banner initialized")}_showDismissDialog(t){const e=document.createElement("div");e.className="guest-mode-modal-overlay",e.setAttribute("aria-modal","true"),e.setAttribute("role","dialog"),e.setAttribute("aria-labelledby","guest-mode-modal-title"),e.innerHTML='\n\t\t\t    <div class="guest-mode-modal" role="document">\n\t\t\t        <button class="guest-mode-modal-close" aria-label="Close dialog">\n\t\t\t            <span class="sr-only">Close</span>\n\t\t\t            √ó\n\t\t\t        </button>\n\t\t\t        \n\t\t\t        <h3 id="guest-mode-modal-title">Guest Mode Benefits</h3>\n\t\t\t\t\t<div style="text-align: center; margin: 16px 0;">\n\t\t\t\t\t    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto;">\n\t\t\t\t\t        <circle cx="12" cy="12" r="10" stroke="#dc2626" stroke-width="2" fill="none"/>\n\t\t\t\t\t        <path d="M12 8V12M12 16H12.01" stroke="#dc2626" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t\t    </svg>\n\t\t\t\t\t</div>\n\t\t\t        \n\t\t\t        <p><strong>What you\'re missing in guest mode:</strong></p>\n\t\t\t        <ul>\n\t\t\t            <li>Personal digital vault for your data</li>\n\t\t\t            <li>One-click access to all .apps</li>\n\t\t\t            <li>Ability to build custom .apps</li>\n\t\t\t        </ul>\n\t\t\t        \n\t\t\t        <p>Would you like to:</p>\n\t\t\t        \n\t\t\t        <div class="guest-mode-modal-buttons">\n\t\t\t            <button class="guest-mode-modal-btn-secondary" id="guest-mode-dismiss-btn">\n\t\t\t                Please dismiss this banner, I am OK with using the app in guest mode\n\t\t\t            </button>\n\t\t\t            <button class="guest-mode-modal-btn-primary" id="guest-mode-create-account-btn">\n\t\t\t                I will create the free account now\n\t\t\t            </button>\n\t\t\t        </div>\n\t\t\t    </div>\n\t\t\t',document.body.appendChild(e);const n=e.querySelector(".guest-mode-modal"),a=e.querySelector(".guest-mode-modal-close"),i=e.querySelector("#guest-mode-dismiss-btn"),o=e.querySelector("#guest-mode-create-account-btn"),s=document.activeElement,r=n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),l=r[0],c=r[r.length-1];setTimeout((()=>l?.focus()),100);const d=t=>{"Tab"===t.key&&(t.shiftKey&&document.activeElement===l?(t.preventDefault(),c.focus()):t.shiftKey||document.activeElement!==c||(t.preventDefault(),l.focus()))};e.addEventListener("keydown",d);const p=()=>{document.removeEventListener("keydown",h),e.removeEventListener("keydown",d),a.removeEventListener("click",p),i.removeEventListener("click",m),o.removeEventListener("click",g),e.removeEventListener("click",u),e.parentNode&&document.body.removeChild(e),setTimeout((()=>s?.focus()),0)},h=t=>{"Escape"===t.key&&p()},u=t=>{t.target===e&&p()},m=()=>{localStorage.setItem("guestModeBannerDismissed","true"),t.style.display="none",p(),console.log("[GuestMode] Banner dismissed permanently")},g=()=>{p(),window.location.href="/signup"};document.addEventListener("keydown",h),e.addEventListener("click",u),a.addEventListener("click",p),i.addEventListener("click",m),o.addEventListener("click",g),console.log("[GuestMode] Dismiss dialog opened")}async init(){console.log("[init] START"),console.log("[init] Initial currentPath:",this.currentPath),await this.db.initStorage();try{this.nativeEntities=this.db.nativeEntities||this.db.getDefaultNativeEntities(),console.log("[init] Native entities read from db storage :",this.db.nativeEntities)}catch(t){console.error("[init] Failed to load native entities:",t),this.nativeEntities=this.getDefaultNativeEntities()}try{const t=this.parseUrlForDataFetch();if(!t||!t.appId)return isowner?(console.log("[init] At root level - loading app selector"),void await this.loadAppSelector()):void console.log("[init] No valid URL structure");console.log("[init] Parsed URL:",t),this.currentApp?.id!==t.appId&&await this.selectApp(t.appId);const e=t.pathIds?.length||0,n=isowner;if(console.log("[DEBUG] Global isowner variable:",isowner),console.log("[DEBUG] isAppOwner:",n),console.log("[DEBUG] pathDepth:",e),console.log("[DEBUG] urlInfo.pathIds:",t.pathIds),console.log("[DEBUG] Last viewed context:",this.getLastViewedContext(t.appId)),0===e){const e=window.history.state?.fromAppSelector,n=this.getLastViewedContext(t.appId),a=n?.[0];if(isowner)console.log("[init] App owner at root - loading ALL tenants"),await this.loadAppSelector(),this.data=await this.db.getAppData(this.currentApp.id),this.currentPath=[];else if(!e&&a&&a.path?.length>0){console.log("[init] Non-owner with saved context - redirecting to tenant"),this.currentPath=[];for(let t=0;t<a.path.length;t++){const e=a.path[t],n=this.currentApp.hierarchy[t];if(!n)break;this.currentPath.push({id:e,displayID:e.includes("-")?this.db.hashUUID(e):e,shortName:e.substring(0,8),entityType:n})}const t=this.getAppUrl(this.currentPath);window.history.replaceState({path:this.currentPath},"",t);const e=this.currentPath.map((t=>t.displayID));this.data=await this.db.getAppData(this.currentApp.id,e)}else console.log("[init] Non-owner without valid context - showing empty state"),await this.loadAppSelector(),this.data={items:[]},this.currentPath=[];console.log("Loaded data items:",this.data.items?.map?.((t=>({ID:t.ID,displayID:t.displayID,name:t.name}))))}else if(1===e){if(!isowner){const e=t.pathIds[0];if(this.isRealUuid(e))console.log("[init] üîë Real UUID in URL - GRANTING ACCESS (shared link)");else{const n=this.getLastViewedContext(t.appId),a=n?.[0];let i=!1;if(a){const t=a.path[0];if(t===e)i=!0;else if(t.includes("-")){i=this.db.hashUUID(t)===e}}if(!i)return console.log("[init] Cannot access tenant without matching context"),void this.showNotification("Access restricted: You cannot view this tenant.","error")}}await this.loadAppSelector();const e=t.pathIds[0];this.data=await this.db.getAppData(this.currentApp.id,[e]),console.log("[init] Loaded tenant data:",{items:this.data.items?.length,firstItem:this.data.items?.[0]?{ID:this.data.items[0].ID,displayID:this.data.items[0].displayID,customers:this.data.items[0].customers?.length||0,concerns:this.data.items[0].concerns?.length||0}:null});const n=this.currentApp.hierarchy[0],a=t.pathIds[0];let i=null;i=isowner?this.data.items.find((t=>t.ID===a||t.displayID===a||t.displayname&&t.displayname.includes(a))):this.data.items?.[0],i||(i=this.data.items.find((t=>{if(!t)return!1;if(t.displayname){const e=t.displayname.split("/");return e[e.length-1]===a}if(t.ID===a)return!0;if(t.displayID===a)return!0;if(t.ID&&!a.includes("-")&&t.ID.includes("-")){return this.db.hashUUID(t.ID)===a}return!1}))),this.currentPath=i?[{id:i.ID,displayID:i.displayID,shortName:this.getShortName(i,n),entityType:n}]:[{id:a,displayID:a,shortName:a.substring(0,8),entityType:n}]}else e>=2&&await this.handleIncomingDeepLink();t?.appId&&t?.pathIds?.length>0&&this.saveContextIfApplicable(t.appId,t.pathIds),this.updateCurrentPathWithRealNames(),this.currentApp&&(this.render(),this.updateBreadcrumb(),this.updateWatermark())}finally{try{console.log("[init] Setting up core event handlers"),this.setupEventListeners(),this.setupPopstateHandler(),this.setupSearch(),userloggedin||this._createGuestModeBanner()}catch(t){console.error("[init] CRITICAL: Event setup failed:",t),this.showNotification("UI controls disabled. Refresh page.","error")}}console.log("[init] COMPLETE - Final currentPath:",this.currentPath)}updateCurrentPathWithRealNames(){if(!this.data?.items||0===this.data.items.length||0===this.currentPath.length||!this.currentApp)return void console.log("[updateCurrentPathWithRealNames] No data or path - skipping");console.log("üîç updateCurrentPath START"),console.log("  Data items:",this.data.items.map((t=>({entityType:t.entityType,ID:t.ID,displayID:t.displayID,name:t.name,displayname:t.displayname})))),console.log("  Current path:",this.currentPath.map((t=>({id:t.id,displayID:t.displayID,shortName:t.shortName,entityType:t.entityType}))));const t=this.data.items[0],e=this.currentPath[0];if(!t||!e)return void console.warn("[updateCurrentPathWithRealNames] Missing first items - skipping");const n=t.entityType!==e.entityType||t.displayID&&e.displayID&&t.displayID!==e.displayID;console.log("  Is partial data:",n);let a=this.data.items,i=0,o=0;if(n){console.log("  ‚ö†Ô∏è Partial data detected - finding matching start level");for(let e=0;e<this.currentPath.length;e++){const n=this.currentPath[e],a=n?.id||n?.displayID||"",i=n?.displayID||a,s=t?.ID||(t?.displayname?t.displayname.split("/").pop():"")||t?.displayID||"";if(t.displayID===i||s===a||a&&!a.includes("-")&&s?.includes("-")&&this.db.hashUUID(s)===a){o=e,console.log(`  ‚úÖ Found match at path level ${e}:`,{pathItem:i,dataItem:s});break}}}for(let t=o;t<this.currentPath.length;t++){const e=this.currentPath[t],n=this.currentApp.hierarchy[t];if(!n){console.warn(`‚ö†Ô∏è No entityType at level ${t}`);break}console.log(`\nüîç Level ${t} (${n}):`),console.log("  Path item:",{id:e?.id,displayID:e?.displayID});const o=e?.id||e?.displayID||"",s=e?.displayID||o;console.log(`  Searching in ${a.length} items`);const r=a.find((t=>{if(!t)return!1;if(t.displayID===s)return!0;if(t.ID===o)return!0;if(o&&!o.includes("-")&&t.ID?.includes("-")){if(this.db.hashUUID(t.ID)===o)return!0}if(t.displayname){const e=t.displayname.split("/"),n=e[e.length-1];if(n===o||n===s)return!0}return!1}));if(r){const e=this.getShortName(r,n);console.log(`  Name from getShortName: "${e}"`),e&&"Unnamed"!==e?(this.currentPath[t].shortName=e,i++,console.log(`  ‚úÖ UPDATED shortName to: "${e}"`)):console.log("  ‚ö†Ô∏è No valid name found");const o=this.currentApp.entityConfigs[n];o?.childrenField?(a=r[o.childrenField]||[],console.log(`  ‚Üí Navigating to children via "${o.childrenField}"`),console.log(`  ‚Üí Next level will search in ${a.length} items`)):(console.log(`  ‚ö†Ô∏è No childrenField for ${n}`),a=[])}else console.error(`‚ùå NO MATCH at level ${t}`),console.error("  Path item:",e),console.error("  Available items:",a.map((t=>({ID:t.ID,displayID:t.displayID,displayname:t.displayname,name:t.name})))),a=[]}console.log(`\n‚úÖ updateCurrentPath COMPLETE: ${i}/${this.currentPath.length-o} names resolved`),console.log("Final currentPath:",this.currentPath.map((t=>({id:t.id?.substring(0,8)||"N/A",name:t.shortName}))))}showCreateTenantOption(){console.log("showCreateTenantOption called!");const t=document.getElementById("canvas-area");t?(t.innerHTML=`\n\t\t            <div style="\n\t\t                position: absolute;\n\t\t                top: 50%;\n\t\t                left: 50%;\n\t\t                transform: translate(-50%, -50%);\n\t\t                text-align: left;\n\t\t                padding: 30px;\n\t\t                background: white;\n\t\t                border-radius: 12px;\n\t\t                box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n\t\t                max-width: 400px;\n\t\t                width: 90%;\n\t\t                z-index: 1000;\n\t\t            ">\n\t\t                <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">\n\t\t                    Welcome to . Apps ${this.currentApp?.name||"the app"}!\n\t\t                </h2>\n\t\t                <p style="margin: 0 0 25px 0; color: #666; font-size: 16px;">\n\t\t                    You don't have an organization account yet.<br>\n\t\t                    Create one now to get started.\n\t\t                </p>\n\t\t                <button \n\t\t                    onclick="window.app.openAddDialog()" \n\t\t                    class="btn btn-primary"\n\t\t                    style="\n\t\t                        background: #667eea;\n\t\t                        color: white;\n\t\t                        border: none;\n\t\t                        padding: 12px 24px;\n\t\t                        border-radius: 6px;\n\t\t                        font-size: 16px;\n\t\t                        cursor: pointer;\n\t\t                        transition: background 0.2s;\n\t\t                    "\n\t\t                    onmouseover="this.style.background='#5a6fd8'"\n\t\t                    onmouseout="this.style.background='#667eea'"\n\t\t                >\n\t\t                    Create My Organization\n\t\t                </button>\n\t\t            </div>\n\t\t        `,console.log("Create tenant panel displayed")):console.error("Canvas area not found!"),this.updateWatermark()}getShortName(t,e){if(!t||!e)return"Unnamed";if(t.name)return t.name;if(t.title)return t.title;if(t.text)return t.text;const n=this.currentApp?.entityConfigs?.[e];return n&&n.labelField?t[n.labelField]||t.displayID||t.ID||"Unnamed":t.displayID||t.ID||"Unnamed"}hasSavedContextForApp(t){if(!t)return!1;try{const e=JSON.parse(localStorage.getItem(`savedContexts_${t}`)||"[]");return Array.isArray(e)&&e.length>0}catch(e){return console.error("[hasSavedContextForApp] Parse error for app:",t,e),!1}}canEditField(t,e){if(this.isDataOwner())return!0;switch(t.writePermission){case"any":return!0;case"parent":return this.hasParentAccess();case"ancestor":return this.hasAncestorAccess();default:return!1}}hasParentAccess(){return this.currentPath.length===this.getMaxAllowedDepth()}hasAncestorAccess(){return!!this.editingExistingItem&&this.checkAncestorRelationship()}getMaxAllowedDepth(){const t=this.getLastViewedContext(this.currentApp.id);return t&&t.pathIds?t.pathIds.length:0}checkAncestorRelationship(){const t=this.entityBeingEdited?.path||[],e=this.currentPath.map((t=>t.id));if(0===e.length)return!1;for(let n=0;n<e.length;n++)if(t[n]!==e[n])return!1;return!0}getLastViewedContext(t){try{return JSON.parse(localStorage.getItem(`savedContexts_${t}`)||"[]")}catch(t){return console.error("[Context] Parse error:",t),[]}}isDataOwner(){console.log("[isDataOwner] Checking ownership...");const t=this.parseUrlForDataFetch();if(!t||!t.appId)return!1;const e=t.pathIds?.[0];if(!e)return!1;const n=this.getLastViewedContext(t.appId);if(!n||!Array.isArray(n)||0===n.length)return!1;const a=this.isRealUuid(e)?this.db.hashUUID(e):e;return n.some((t=>{if(!t?.path?.[0]||!t.isOwnerAccess)return!1;const e=t.path[0],n=this.isRealUuid(e)?this.db.hashUUID(e):e;return a===n}))}isRealUuid(t){return!!t&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)}saveContextIfApplicable(t,e){if(!t||!e?.length)return;const n=this.isRealUuid(e[0]),a=e[0],i=this.isRealUuid(a)?this.db.hashUUID(a):a,o=JSON.parse(localStorage.getItem(`savedContexts_${t}`)||"[]"),s=o.find((t=>{const e=t.path[0];return(this.isRealUuid(e)?this.db.hashUUID(e):e)===i&&t.isOwnerAccess}));if(!s&&(!isowner||n)){const a=[{path:e,timestamp:Date.now(),isOwnerAccess:n},...o.slice(0,9)];localStorage.setItem(`savedContexts_${t}`,JSON.stringify(a)),console.log("[Context] ‚úÖ SAVED:",{appId:t,path:e,isOwnerAccess:n,total:a.length})}else s&&console.log("[Context] ‚ÑπÔ∏è SKIPPED - owner context exists")}async handleIncomingDeepLink(){const t=this.parseUrlForDataFetch();if(!t||!t.appId)return;this.currentApp?.id!==t.appId&&await this.selectApp(t.appId);const e=t.pathIds?.length||0,n=e>=1&&this.isRealUuid(t.pathIds[0]);n&&console.log("[DeepLink] üîë REAL UUID DETECTED - Granting owner-like access"),console.log("[DeepLink] Path depth:",e),console.log("[DeepLink] isDataOwner():",this.isDataOwner()),console.log("[DeepLink] isowner:",isowner),console.log("[DeepLink] Real UUID in URL:",n);let a=this.data;const i=e>=2&&this.isDataOwner()||n;if(i){console.log("[DeepLink] Loading FULL data (owner or real UUID detected)");try{const e=t.pathIds[0],n=await this.db.getAppData(this.currentApp.id,[e]);n?.items?.length>0?(a=n,console.log("[DeepLink] Full data loaded successfully")):console.warn("[DeepLink] Full data empty, using partial data")}catch(t){console.error("[DeepLink] Failed to load full data:",t)}}if(this.data=a,this.currentPath=[],i&&a?.items?.length>0){let n=a.items,i=!0;for(let a=0;a<e;a++){const e=t.pathIds[a],o=this.currentApp.hierarchy[a];if(!o||!n){i=!1;break}const s=n.find((t=>this.isRealUuid(e)?t.ID===e:t.displayID===e||!e.includes("-")&&t.ID.includes("-")&&this.db.hashUUID(t.ID)===e));if(!s){i=!1;break}{this.currentPath.push({id:s.ID,displayID:s.displayID,shortName:this.getShortName(s,o),entityType:o});const t=this.currentApp.entityConfigs[o];n=t?.childrenField&&s[t.childrenField]||[]}}i||(console.warn("[DeepLink] Full data path building failed, falling back to URL path"),this.currentPath=t.pathIds.map(((t,e)=>{const n=this.currentApp.hierarchy[e];return n?{id:t,displayID:t,shortName:t.substring(0,8),entityType:n}:null})).filter(Boolean))}else this.currentPath=t.pathIds.map(((t,n)=>{const i=this.currentApp.hierarchy[n];if(!i)return null;let o=t.substring(0,8);return n===e-1&&a?.items?.[0]&&(o=this.getShortName(a.items[0],i)),{id:t,displayID:t,shortName:o,entityType:i}})).filter(Boolean);console.log("[DeepLink] Path built successfully")}getViewingContext(){const t=this.parseUrlForDataFetch();let e=!1;if(!isowner&&this.currentApp?.id&&t?.appId===this.currentApp.id){const n=this.getLastViewedContext(this.currentApp.id),a=t?.tenantId||t?.pathIds?.[0];if(a&&n?.length>0){const t=this.isRealUuid(a)?this.db.hashUUID(a):a;e=n.some((e=>{const n=e.path[0];return(this.isRealUuid(n)?this.db.hashUUID(n):n)===t&&e.isOwnerAccess}))}}const n=isowner||e;return{isAppOwner:n,isLinkUser:!n,isTenantView:null!=t?.tenantId&&!t?.subtenantId,isSubtenantView:null!=t?.subtenantId,tenantId:t?.tenantId,subtenantId:t?.subtenantId}}updateWatermark(){const t=document.getElementById("watermark");if(!t)return;const e=0===this.currentPath.length,n=window.innerWidth<=768,a=window.innerWidth<=1024&&window.innerWidth>768;if(t.innerHTML="",this.cleanupWatermarkHover(),!this.currentApp)return void(t.style.display="none");t.style.display="block";const i=n?{base:12,increment:6,max:48}:a?{base:16,increment:8,max:64}:{base:20,increment:10,max:80};let o="\n\t        position: absolute;\n\t        top: 50%;\n\t        left: 50%;\n\t        transform: translate(-50%, -50%);\n\t        text-align: left;\n\t        pointer-events: none;\n\t        opacity: 0.15;\n\t        z-index: 1;\n\t        width: 100%;\n\t        padding: 0 20px;\n\t        box-sizing: border-box;\n\t    ";if(n){const t=document.getElementById("breadcrumb");o=`\n\t\t        position: absolute;\n\t\t        top: ${t?t.offsetHeight+20:100}px;\n\t\t        left: 50%;\n\t\t        transform: translateX(-50%);\n\t\t        text-align: center;\n\t\t        pointer-events: none;\n\t\t        opacity: 0.15;\n\t\t        z-index: 1;\n\t\t        width: 100%;\n\t\t        padding: 0 20px;\n\t\t        box-sizing: border-box;\n\t\t    `}if(e){const e=this.currentApp.hierarchy[0]||"items",n=this.getEntityDisplayName(e)||e;t.innerHTML=`\n\t            <div style="${o}">\n\t                <div style="\n\t                    font-size: ${i.base+4}px;\n\t                    font-weight: 300;\n\t                    color: #666;\n\t                    margin-bottom: 8px;\n\t                    letter-spacing: 1px;\n\t                    line-height: 1.2;\n\t                ">${this.currentApp.name}</div>\n\t                <div style="\n\t                    font-size: ${i.max}px;\n\t                    font-weight: 700;\n\t                    color: #999;\n\t                    text-transform: uppercase;\n\t                    letter-spacing: 2px;\n\t                    line-height: 1.1;\n\t                ">${n}</div>\n\t            </div>\n\t        `}else{const e=this.currentPath.length;let a=[];if(a.push({text:this.currentApp.name,level:0,isFocus:!1}),e<=4)for(let t=0;t<e;t++){const n=this.currentPath[t],i=this.currentApp.hierarchy[t]||`level_${t+1}`,o=n.shortName||n.displayID||this.getEntityDisplayName(i)||i;a.push({text:o,level:t+1,isFocus:t===e-1,id:n.id,entityType:i})}else{a.push({text:"...",level:1,isFocus:!1,isEllipsis:!0});for(let t=e-3;t<e;t++){const n=this.currentPath[t],i=this.currentApp.hierarchy[t]||`level_${t+1}`,o=n.shortName||n.displayID||this.getEntityDisplayName(i)||i;a.push({text:o,level:t+1,isFocus:t===e-1,id:n.id,entityType:i})}}let s=`<div style="${o}">`;a.forEach(((t,e)=>{let o;if(t.isFocus)o=i.max;else{const t=a.length-1-e;o=Math.max(i.base,i.max-t*i.increment)}const r=t.isFocus?800:300+100*e,l=t.isEllipsis?180:200-20*e,c=t.isFocus?"#bbb":`rgb(${l}, ${l}, ${l})`,d=t.isFocus?"3px":t.isEllipsis?"2px":"1px",p=t.isFocus?"uppercase":"none",h=t.isFocus?"0":"6px",u=t.isFocus?"90%":"80%",m=n?"overflow: hidden; text-overflow: ellipsis; white-space: nowrap;":"",g=t.isFocus?"pointer-events: auto; cursor: default;":"",y=t.isFocus;s+=`\n\t                <div class='${y?"watermark-last-item":""}' style="\n\t                    font-size: ${o}px;\n\t                    font-weight: ${r};\n\t                    color: ${c};\n\t                    margin-bottom: ${h};\n\t                    letter-spacing: ${d};\n\t                    line-height: 1.2;\n\t                    max-width: ${u};\n\t                    margin-left: auto;\n\t                    margin-right: auto;\n\t                    text-transform: ${p};\n\t                    ${m}\n\t                    ${g}\n\t                "\n\t                ${t.isFocus?`data-hover-entity="${t.id}" data-entity-type="${t.entityType}"`:""}>\n\t                    ${t.text}\n\t                </div>\n\t            `})),s+="</div>",t.innerHTML=s,this.setupWatermarkEntityHover(a)}this.watermarkResizeHandler&&window.removeEventListener("resize",this.watermarkResizeHandler),this.watermarkResizeHandler=()=>{this.updateWatermark()},window.addEventListener("resize",this.watermarkResizeHandler)}setupWatermarkEntityHover(t){const e=document.getElementById("watermark");if(!e)return;const n=t[t.length-1];if(!n||!n.isFocus)return;const a=e.querySelector(`[data-hover-entity="${n.id}"]`);if(!a)return;let i=null,o=null;const s=t=>{if(i)return;const e=this.getEntityDataForPathItem(n);if(!e)return;i=document.createElement("div"),i.style.cssText=`\n\t            position: absolute;\n\t            top: ${a.offsetTop+a.offsetHeight+8}px;\n\t            left: ${a.offsetLeft}px;\n\t            background: rgba(255, 255, 255, 0.95);\n\t            backdrop-filter: blur(10px);\n\t            border: 1px solid rgba(0, 0, 0, 0.05);\n\t            border-radius: 6px;\n\t\t\t\tpadding: 12px 16px;          \n\t\t\t\tmin-width: 220px;          \n\t\t\t\tmax-width: 320px;          \n\t\t\t\tfont-size: 14px;           \n\t            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);\n\t            z-index: 1000;\n\t            color: #333;\n\t            pointer-events: none;\n\t            opacity: 0.9;\n\t        `;const o=this.formatEntityDataForHover(e,n.text,n.entityType);i.innerHTML=o,a.parentElement.appendChild(i)},r=()=>{i&&(i.remove(),i=null),o&&(clearTimeout(o),o=null)};a.addEventListener("mouseenter",(t=>{o=setTimeout((()=>{s()}),300)})),a.addEventListener("mousemove",(t=>{a.contains(t.target)?i&&(i.style.top=`${a.offsetTop+a.offsetHeight+8}px`,i.style.left=`${a.offsetLeft}px`):r()})),a.addEventListener("mouseleave",r),this.watermarkHoverCleanup=r}cleanupWatermarkHover(){this.watermarkHoverCleanup&&(this.watermarkHoverCleanup(),this.watermarkHoverCleanup=null)}getEntityDataForPathItem(t){try{let t=this.data.items;for(let e=0;e<this.currentPath.length;e++){const n=this.currentPath[e];if(e===this.currentPath.length-1)return t.find((t=>t.ID===n.id))||null;{const a=t.find((t=>t.ID===n.id));if(!a)return null;const i=this.currentApp.hierarchy[e],o=this.currentApp.entityConfigs[i],s=o?.childrenField;if(!s||!a[s])return null;t=a[s]}}return null}catch(t){return console.warn("Failed to get entity data for hover:",t),null}}formatEntityDataForHover(t,e,n){if(!t)return"<div>No data available</div>";let a=`<div style="font-weight: bold; margin-bottom: 6px; font-size: 15px; color: #222;">${e}</div>`;const i=this.nativeEntities?.[n];if(i){const e=i.fields.filter((e=>"system"!==e.writePermission&&"ID"!==e.name&&"displayID"!==e.name&&"dotLabel"!==e.name&&"timestamp"!==e.name&&"count"!==e.name&&"hidden"!==e.name&&"hashed"!==e.name&&void 0!==t[e.name]&&null!==t[e.name]&&""!==t[e.name])).slice(0,3);e.length>0?e.forEach((e=>{const n=t[e.name];if(null!=n&&""!==n){let t=n;"checkbox"===e.type&&(t=n?"Yes":"No"),a+=`<div style="margin: 3px 0; font-size: 13px; color: #555;">\n\t\t\t\t\t\t    <span style="font-weight: 500;">${e.label}:</span> \n\t\t\t\t\t\t    <span style="color: #333;">${t}</span>\n\t\t\t\t\t\t</div>`}})):a+='<div style="font-size: 11px; color: #888; margin-top: 4px;">No additional data</div>'}return a}getEntityDisplayName(t){if(console.log("=== DEBUG getEntityDisplayName ==="),console.log("Input entityType:",t),console.log("Current app:",this.currentApp?.id),console.log("Native entities available:",!!this.nativeEntities),this.nativeEntities){if(console.log("Native entities keys:",Object.keys(this.nativeEntities)),this.nativeEntities[t]){console.log("Found native entity:",this.nativeEntities[t]),console.log("Native entity name:",this.nativeEntities[t].name);const e=this.nativeEntities[t].name;return console.log("Returning native entity name:",e),console.log("=== END DEBUG ==="),e}console.log(`Native entity "${t}" not found`)}else console.log("this.nativeEntities is undefined or null");if(console.log("Checking app schema..."),this.currentApp?.entityConfigs?.[t]){const e=this.currentApp.entityConfigs[t];console.log("App schema config for",t,":",e),console.log("App schema config.name:",e.name);const n=e.name||t;return console.log("Returning app schema name:",n),console.log("=== END DEBUG ==="),n}return console.log("No app schema config found for",t),console.log("Returning fallback:",t),console.log("=== END DEBUG ==="),t}updatePageTitle(){this.currentApp&&(document.title=". Apps - "+this.currentApp.name)}parseUrlForDataFetch(){const t=window.location.pathname.split("/").filter((t=>t));if("t"!==t[0]||"apps"!==t[1]||!t[2])return null;const e={appId:t[2]},n=t.slice(3);return n.length>0&&(e.tenantId=n[0]),n.length>1&&(e.subtenantId=n[1]),e.pathIds=n,e}hideAppSelectorButton(){const t=document.getElementById("app-selector-btn");t&&(t.style.display="none")}showAppSelectorButton(){const t=document.getElementById("app-selector-btn");t&&(t.style.display="")}hideSchemaButton(){const t=document.getElementById("schema-btn");t&&(t.style.display="none")}showSchemaButton(){const t=document.getElementById("schema-btn");t&&(t.style.display="")}showSharePopup(t){this.closeSharePopup();const e=window.location.href,n=this.getShareGuidanceText(),a=document.createElement("div");a.className="share-popup",a.style.display="block",a.innerHTML=`\n\t        <button class="share-close">&times;</button>\n\t        <h4>Share this link</h4>\n\t        <p>${n}</p>\n\t        <input type="text" class="share-link-input" value="${e}" readonly>\n\t        <div class="share-actions">\n\t            <button class="share-action-btn email" data-action="email">\n\t                <span>üìß</span> Email\n\t            </button>\n\t            <button class="share-action-btn whatsapp" data-action="whatsapp">\n\t                <span>üí¨</span> WhatsApp\n\t            </button>\n\t            <button class="share-action-btn telegram" data-action="telegram">\n\t                <span>‚úàÔ∏è</span> Telegram\n\t            </button>\n\t            <button class="share-action-btn copy" data-action="copy">\n\t                <span>üìã</span> Copy\n\t            </button>\n\t        </div>\n\t    `,document.body.appendChild(a),this.currentSharePopup=a,this.positionSharePopup(t,a),a.querySelector(".share-close").addEventListener("click",(()=>{this.closeSharePopup()}));const i=a.querySelector(".share-link-input");i.addEventListener("click",(()=>{i.select(),this.copyToClipboard(e)}));a.querySelectorAll(".share-action-btn").forEach((t=>{t.addEventListener("click",(t=>{const n=t.currentTarget.dataset.action;this.handleShareAction(n,e)}))})),setTimeout((()=>{document.addEventListener("click",this.closeSharePopupOnClickOutside)}),100)}positionSharePopup(t,e){if(!t)return;if(window.innerWidth<=768){e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.width="90%",e.style.maxWidth="350px";const t=document.createElement("div");t.className="share-popup-backdrop",t.addEventListener("click",(()=>this.closeSharePopup())),document.body.appendChild(t),this.currentShareBackdrop=t}else{const n=t.getBoundingClientRect(),a=e.getBoundingClientRect();e.style.position="fixed",e.style.transform="none";let i=n.bottom+8,o=n.left;o+a.width>window.innerWidth&&(o=n.right-a.width),i+a.height>window.innerHeight&&(i=n.top-a.height-8),o<10&&(o=10),i<10&&(i=10),e.style.top=`${i}px`,e.style.left=`${o}px`}}copyToClipboard(t){if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(t).then((()=>{this.showCopyFeedback()}));else{const e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.opacity="0",document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this.showCopyFeedback()}}showCopyFeedback(){const t=this.currentSharePopup?.querySelector(".share-action-btn.copy");if(t){const e=t.innerHTML;t.innerHTML="<span>‚úì</span> Copied!",t.style.background="#4CAF50",t.style.color="white",setTimeout((()=>{t.innerHTML=e,t.style.background="",t.style.color=""}),2e3)}}getShareMessage(){return"Check this out!"}copyShareLink(){const t=this.getAppUrl(this.currentPath);navigator.clipboard.writeText(t).then((()=>alert("Link copied:\n"+t)))}getShareGuidanceText(){const t=this.currentPath.length;if(console.log("[getShareGuidanceText] currentpath: "+JSON.stringify(this.currentPath)),0===t)return"This is your organization's main dashboard. Share this link with team members who need full access to manage all customers and concerns.";if(1===t){return`Share this link with people in ${this.currentPath[0]?.shortName||"your organization"} who would be handling customer support functions. They'll be able to manage all customers and concerns for this organization.`}if(2===t){return`Share this link with ${this.currentPath[1]?.shortName||"your customer"} or their team members who need to report and track support concerns. They'll only see their own concerns and won't have access to other customers.`}return t>=3?"Share this link with specific stakeholders who need to collaborate on this particular concern. They'll have focused access to this issue only.":"Share this secure link with authorized collaborators."}handleShareAction(t,e){switch(t){case"email":const t=encodeURIComponent("Shared Support Link"),n=encodeURIComponent(`Hi,\n\nI'm sharing this support link with you: ${e}\n\nBest regards`);window.location.href=`mailto:?subject=${t}&body=${n}`;break;case"whatsapp":const a=`https://wa.me/?text=${encodeURIComponent(e)}`;window.open(a,"_blank");break;case"telegram":const i=`https://t.me/share/url?url=${encodeURIComponent(e)}`;window.open(i,"_blank");break;case"copy":navigator.clipboard.writeText(e).then((()=>{const t=this.currentSharePopup.querySelector(".share-link-input"),e=t.value;t.value="‚úì Copied to clipboard!",setTimeout((()=>{t.value=e}),2e3)})).catch((t=>{console.error("Failed to copy: ",t);this.currentSharePopup.querySelector(".share-link-input").select(),document.execCommand("copy")}))}"copy"!==t&&this.closeSharePopup()}closeSharePopup(){if(this.currentSharePopup){const t=document.querySelector(".share-popup-backdrop");t&&(t.classList.remove("show"),t.style.display="none"),this.currentSharePopup.remove(),this.currentSharePopup=null,document.removeEventListener("click",this.closeSharePopupOnClickOutside)}}closeSharePopupOnClickOutside=t=>{this.currentSharePopup&&!this.currentSharePopup.contains(t.target)&&this.closeSharePopup()};saveLastViewedContext(t,e){if(t&&e&&0!==e.length)try{const n=e.some((t=>this.isRealUuid(t))),a={path:e,timestamp:Date.now(),isOwnerAccess:n},i=JSON.parse(localStorage.getItem(`savedContexts_${t}`)||"[]"),o=e[0],s=this.isRealUuid(o)?this.db.hashUUID(o):o;if(i.find((t=>{const e=t.path[0];return(this.isRealUuid(e)?this.db.hashUUID(e):e)===s&&t.isOwnerAccess})))console.log("[saveLastViewedContext] ‚ÑπÔ∏è Skipped - owner context already exists for this tenant");else{const o=[a,...i.slice(0,9)];localStorage.setItem(`savedContexts_${t}`,JSON.stringify(o)),console.log("[saveLastViewedContext] ‚úÖ Context saved:",{appId:t,path:e,isOwnerAccess:n,total:o.length})}}catch(t){console.error("[saveLastViewedContext] Error:",t)}}redirectToLastViewedContext(t){if(isowner)return;const e=this.getLastViewedContext(t);if(e&&e.pathIds?.length>0){const n=`/t/apps/${t}/${e.pathIds.map((t=>t&&t.includes("-")?this.db.hashUUID(t):t)).join("/")}`;window.location.href=n}}async showWelcomeForm(t,e){var n=this;const a=await this.getEntityConfig(e),i=document.getElementById("add-modal"),o=document.getElementById("modal-title"),s=document.getElementById("add-form");o.textContent="üéâ Welcome! Create Your Profile",s.innerHTML="";const r=document.createElement("div");r.style.cssText="background: #e8f4f8; padding: 12px; border-radius: 6px; margin-bottom: 20px; color: #2c3e50;",r.innerHTML="<strong>Welcome to . Apps!</strong><br>Please enter your organization details to get started.",s.appendChild(r),a.fields.forEach((function(e){if("ID"===e.name)return;const n=document.createElement("div");n.className="form-group";const a=document.createElement("label");let i;if(a.textContent=e.label+(e.mandatory?" *":""),n.appendChild(a),"textarea"===e.type)i=document.createElement("textarea");else if("checkbox"===e.type){const a=document.createElement("div");a.className="checkbox-group",i=document.createElement("input"),i.type="checkbox";const o=document.createElement("label");o.textContent=e.label,a.appendChild(i),a.appendChild(o),n.innerHTML="",n.appendChild(a),i.checked=t[e.name]||!1}else i=document.createElement("input"),i.type=e.type;i.name=e.name,i.required=e.mandatory,"checkbox"!==e.type&&t[e.name]&&(i.value=t[e.name]),"checkbox"!==e.type&&n.appendChild(i),s.appendChild(n)}));const l=document.createElement("div");l.style.marginTop="20px";const c=document.createElement("button");c.type="submit",c.className="btn btn-primary",c.textContent="Complete Setup & Continue",l.appendChild(c),s.appendChild(l),s.onsubmit=async function(a){a.preventDefault(),await n.updateTenantProfile(t,e,s)},i.style.display="block"}async updateTenantProfile(t,e,n){const a=new FormData(n);for(let[e,n]of a.entries())"ID"!==e&&(t[e]=n);n.querySelectorAll('input[type="checkbox"]').forEach((e=>t[e.name]=e.checked)),this.data.items||(this.data.items=[]),this.data.items.push(t),await this.db.saveAppData(this.currentApp.id,this.data),localStorage.removeItem("pendingTenant"),document.getElementById("add-modal").style.display="none",this.navigateTo(t,e)}getCookie(t){const e=`; ${document.cookie}`.split(`; ${t}=`);return 2===e.length?e.pop().split(";").shift():null}_updateShareButtonVisibility(){const t=document.getElementById("header-share-btn");if(!t)return void console.error("[CRITICAL] Share button MISSING from DOM!");const e=this._getCurrentEntityType();if((this.currentApp?.entityConfigs?.[e]||{}).disallowShareButton)t.classList.add("share-hidden"),t.setAttribute("aria-hidden","true"),console.log(`[ShareBtn] HIDDEN via CLASS for ${e}`);else{t.classList.remove("share-hidden"),t.removeAttribute("aria-hidden"),console.log(`[ShareBtn] VISIBLE via CLASS for ${e}`);const n=window.getComputedStyle(t);console.log(`[ShareBtn] Computed display: "${n.display}" (should be "inline-block" or "flex")`)}}setupEventListeners(){console.log("setupEventListeners: Starting");const t=this;function e(t,e,n){const a=document.getElementById(t);a?a.addEventListener(e,n):console.warn(`setupEventListeners: Element #${t} not found`)}function n(t){const e=document.getElementById(t);e?e.style.display="none":console.warn(`setupEventListeners: Element #${t} not found for hide()`)}e("close-app-selector","click",(()=>n("app-selector-modal"))),e("close-add-modal","click",(()=>n("add-modal"))),e("close-schema-modal","click",(()=>n("schema-modal"))),e("close-app-schema-editor","click",(()=>n("app-schema-editor-modal"))),e("close-entity-editor","click",(()=>n("entity-editor-modal")));const a=document.querySelectorAll(".tab"),i=document.querySelectorAll(".tab-content");0===a.length&&console.warn("setupEventListeners: No .tab elements found"),a.forEach((e=>{e.addEventListener("click",(e=>{a.forEach((t=>t.classList.remove("active"))),i.forEach((t=>t.classList.remove("active")));const n=e.currentTarget;n.classList.add("active");const o=n.dataset.tab;if(!o)return void console.warn("Tab clicked but no data-tab attribute found",n);const s=document.getElementById(o);if(!s)return void console.warn(`No tab-content found with id #${o}`);s.classList.add("active"),"json-view"!==o||s.dataset.wired||(t.exportSchemasJSON(),s.dataset.populated="true",document.getElementById("export-schemas-json").onclick=()=>t.exportSchemasJSON(),document.getElementById("import-schemas-json").onclick=()=>document.getElementById("import-json-file").click(),document.getElementById("import-json-file").onchange=async e=>{const n=e.target.files[0];if(n)try{const a=await n.text(),i=JSON.parse(a);await t.importSchemasJSON(i),e.target.value=""}catch(t){console.error("Failed to parse JSON file:",t),alert("Invalid JSON file: "+t.message)}},document.getElementById("copy-json").onclick=()=>t.copyJSONToClipboard(document.getElementById("json-export").value),s.dataset.wired="true");const r=document.getElementById("json-buttons");r&&(r.style.display="json-view"===o?"flex":"none")}))})),window.addEventListener("beforeunload",(()=>{this.stopVersionPolling()})),function(){if(document.querySelector(".header-reorganized"))return void console.log("‚è≠Ô∏è Header already reorganized, skipping");const e=document.querySelector(".header-actions");if(e){e.classList.add("header-reorganized");try{e.querySelectorAll(".header-btn, .share-btn").forEach((t=>t.remove()));const n=document.createElement("button");n.className="share-btn header-btn",n.id="header-share-btn",n.title="Share",n.style.display="inline-flex",n.innerHTML='\n\t\t            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t                <circle cx="18" cy="5" r="3"/>\n\t\t                <circle cx="6" cy="12" r="3"/>\n\t\t                <circle cx="18" cy="19" r="3"/>\n\t\t                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>\n\t\t                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>\n\t\t            </svg>\n\t\t        ',n.addEventListener("click",(t=>{t.stopPropagation(),window.app?.showSharePopup?window.app.showSharePopup(t.currentTarget):window.app?.copyShareLink&&window.app.copyShareLink()}));const a=document.createElement("button");a.className="header-btn",a.id="app-selector-btn",a.textContent="Switch App",a.style.display="inline-flex",a.addEventListener("click",(()=>{window.app?.openAppSelector&&window.app.openAppSelector()}));let i=null;"undefined"!=typeof isowner&&isowner&&(i=document.createElement("button"),i.className="header-btn",i.id="schema-btn",i.textContent="Settings",i.style.display="inline-flex",i.addEventListener("click",(()=>{window.app?.openSchemaManager&&window.app.openSchemaManager()}))),e.insertBefore(a,e.firstChild),i&&e.insertBefore(i,a.nextSibling);const o=t._getCurrentEntityType();(t.currentApp?.entityConfigs?.[o]||{}).disallowShareButton&&(n.classList.add("share-hidden"),n.setAttribute("aria-hidden","true")),e.insertBefore(n,e.firstChild),console.log("‚úÖ Desktop buttons reorganized successfully"),console.log("üîß Setting up mobile menu...");const s=function(){const t=document.getElementById("mobile-menu-btn"),e=document.getElementById("mobileDropdown");return t&&e?(t.addEventListener("click",(t=>{t.stopPropagation(),e.classList.toggle("show")})),document.addEventListener("click",(n=>{e.contains(n.target)||t.contains(n.target)||e.classList.remove("show")})),e.querySelectorAll(".mobile-dropdown-item").forEach((t=>{t.addEventListener("click",(n=>{n.stopPropagation();const a=t.dataset.action;e.classList.remove("show"),"share"===a?window.app.showSharePopup(n.currentTarget):"switch"===a?window.app?.openAppSelector?.():"settings"===a&&window.app?.openSchemaManager?.()}))})),window.addEventListener("resize",(()=>{window.innerWidth>768&&e.classList.remove("show")})),console.log("‚úÖ Mobile menu event handlers attached"),!0):(console.error("‚ùå Mobile menu elements not found"),!1)}(),r=function(){const t=document.getElementById("mobileDropdown");if(!t)return console.error("‚ùå Mobile dropdown not found"),!1;const e=document.getElementById("app-selector-btn"),n=document.getElementById("schema-btn");let a='\n\t\t        <button class="mobile-dropdown-item" data-action="share">\n\t\t            <span>üì§</span> Share\n\t\t        </button>\n\t\t    ';return!e||"none"===e.style.display&&"none"===getComputedStyle(e).display||(a+='\n\t\t            <button class="mobile-dropdown-item" data-action="switch">\n\t\t                <span>üîÑ</span> Switch App\n\t\t            </button>\n\t\t        '),!n||"none"===n.style.display&&"none"===getComputedStyle(n).display||(a+='\n\t\t            <button class="mobile-dropdown-item" data-action="settings">\n\t\t                <span>‚öôÔ∏è</span> Settings\n\t\t            </button>\n\t\t        '),t.innerHTML=a,t.querySelectorAll(".mobile-dropdown-item").forEach((e=>{e.onclick=n=>{n.stopPropagation();const a=e.dataset.action;t.classList.remove("show"),"share"===a?window.app.showSharePopup(n.currentTarget):"switch"===a?window.app?.openAppSelector?.():"settings"===a&&window.app?.openSchemaManager?.()}})),console.log("‚úÖ Mobile dropdown updated successfully"),!0}();s&&r&&console.log("üéâ Header fully initialized and ready")}catch(t){console.error("‚ùå Error in reorganizeHeaderButtons:",t),e.classList.remove("header-reorganized")}}else console.error("‚ùå .header-actions container not found")}()}async exportSchemasJSON(){var t=this;const e={appSchemas:await this.db.getAppSchemas(),nativeEntities:await this.db.getNativeEntities(),exportDate:(new Date).toISOString(),version:"1.0"},n=JSON.stringify(e,null,2);document.getElementById("json-export").value=n,document.querySelectorAll(".tab").forEach((function(t){t.classList.remove("active")})),document.querySelectorAll(".tab-content").forEach((function(t){t.classList.remove("active")})),document.querySelector('[data-tab="json-view"]').classList.add("active"),document.getElementById("json-view").classList.add("active"),document.getElementById("copy-json").onclick=function(){t.copyJSONToClipboard(n)},document.getElementById("download-json").onclick=function(){t.downloadJSON(e)}}async sendTenantWelcomeEmail(t,e){console.log("[EMAIL] sendTenantWelcomeEmail - tenantData",t);const n={to:t.contactemail,subject:`Welcome to . Apps [${this.currentApp.name}] - Your Feedback Management Portal`,htmlBody:this.getTenantEmailTemplate(t,e),textBody:this.getTenantEmailText(t,e)},a=this.currentApp.hierarchy[0];return await this.sendEmail(n,this.currentApp.id,a)}async sendSubtenantNotificationEmail(t,e,n){const a={to:t.contactemail,subject:`${e} has created a feedback page for you`,htmlBody:this.getSubtenantEmailTemplate(t,e,n),textBody:this.getSubtenantEmailText(t,e,n)},i=this.currentApp.hierarchy[1];return await this.sendEmail(a,this.currentApp.id,i)}getTenantEmailTemplate(t,e){return`\n\t<!DOCTYPE html>\n\t<html>\n\t<head>\n\t    <meta charset="UTF-8">\n\t    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t</head>\n\t<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: #f4f4f5;">\n\t    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f5; padding: 40px 20px;">\n\t        <tr>\n\t            <td align="center">\n\t                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">\n\t                    \n\t                    \x3c!-- Header --\x3e\n\t                    <tr>\n\t                        <td style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center;">\n\t                            <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: 600;">\n\t                                Welcome to newauth<span style="color: #ffd700;">.</span>apps\n\t                            </h1>\n\t                            <p style="margin: 10px 0 0 0; color: rgba(255, 255, 255, 0.9); font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">\n\t                                Visual Data Navigation\n\t                            </p>\n\t                        </td>\n\t                    </tr>\n\t                    \n\t                    \x3c!-- Body --\x3e\n\t                    <tr>\n\t                        <td style="padding: 40px 30px;">\n\t                            <h2 style="margin: 0 0 20px 0; color: #1f2937; font-size: 22px; font-weight: 600;">\n\t                                üéâ Your ${this.currentApp.name} Portal is Ready!\n\t                            </h2>\n\t                            \n\t                            <p style="margin: 0 0 16px 0; color: #4b5563; font-size: 16px; line-height: 1.6;">\n\t                                Hello <strong>${t.name}</strong>,\n\t                            </p>\n\t                            \n\t                            <p style="margin: 0 0 16px 0; color: #4b5563; font-size: 16px; line-height: 1.6;">\n\t                                Thank you for setting up your account! We've created a personalized feedback management portal for your organization.\n\t                            </p>\n\t                            \n\t                            <div style="background: linear-gradient(135deg, #f0f4ff 0%, #f5f3ff 100%); border-left: 4px solid #667eea; padding: 20px; margin: 24px 0; border-radius: 6px;">\n\t                                <p style="margin: 0 0 12px 0; color: #1f2937; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">\n\t                                    Your Portal URL\n\t                                </p>\n\t                                <a href="${e}" style="color: #667eea; font-size: 16px; font-weight: 600; text-decoration: none; word-break: break-all;">\n\t                                    ${e}\n\t                                </a>\n\t                            </div>\n\t                            \n\t                            <h3 style="margin: 30px 0 16px 0; color: #1f2937; font-size: 18px; font-weight: 600;">\n\t                                What you can do:\n\t                            </h3>\n\t                            \n\t                            <ul style="margin: 0 0 24px 0; padding-left: 20px; color: #4b5563; font-size: 15px; line-height: 1.8;">\n\t                                <li style="margin-bottom: 10px;">üìä Manage and organize feedback hierarchically</li>\n\t                                <li style="margin-bottom: 10px;">üë• Create customers and track their concerns</li>\n\t                                <li style="margin-bottom: 10px;">üîó Share custom links with your team members</li>\n\t                                <li style="margin-bottom: 10px;">üìà Visualize data with interactive dot-based interface</li>\n\t                            </ul>\n\n\t                            \x3c!-- üîí SECURITY NOTICE --\x3e\n\t                            <div style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-left: 4px solid #f59e0b; padding: 24px; margin: 30px 0; border-radius: 6px; position: relative;">\n\t                                <div style="position: absolute; top: -12px; left: -12px; background: #f59e0b; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">\n\t                                    üîí\n\t                                </div>\n\t                                <h3 style="margin: 0 0 12px 28px; color: #92400e; font-size: 16px; font-weight: 700; display: flex; align-items: center;">\n\t                                    <span style="margin-right: 8px;">Security Notice</span>\n\t                                </h3>\n\t                                <p style="margin: 0 0 16px 28px; color: #78350f; font-size: 14px; line-height: 1.6;">\n\t                                    This URL grants full administrative access to your organization's feedback portal. To protect your data:\n\t                                </p>\n\t                                <ul style="margin: 0 0 0 28px; padding-left: 20px; color: #78350f; font-size: 14px; line-height: 1.8;">\n\t                                    <li style="margin-bottom: 8px;"><strong style="color: #92400e;">‚úì Do share</strong> with authorized team members within your organization</li>\n\t                                    <li style="margin-bottom: 8px;"><strong style="color: #92400e;">‚úó Do not forward</strong> to external parties, contractors, or public channels</li>\n\t                                    <li style="margin-bottom: 8px;"><strong style="color: #92400e;">üí° Need external access?</strong> Use the portal's built-in <strong>"Share"</strong> feature to generate limited-access links for specific customers </li>\n\t                                </ul>\n\t                                <p style="margin: 16px 0 0 28px; color: #92400e; font-size: 13px; font-style: italic; line-height: 1.5;">\n\t                                    Your vigilance ensures the integrity and privacy of your organization's data.\n\t                                </p>\n\t                            </div>\n\t                            \n\t                            <table width="100%" cellpadding="0" cellspacing="0" style="margin: 30px 0;">\n\t                                <tr>\n\t                                    <td align="center">\n\t                                        <a href="${e}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">\n\t                                            Access Your Portal\n\t                                        </a>\n\t                                    </td>\n\t                                </tr>\n\t                            </table>\n\t                            \n\t                            <p style="margin: 24px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.6;">\n\t                                If you have any questions or need assistance, feel free to reach out to our support team.\n\t                            </p>\n\t                        </td>\n\t                    </tr>\n\t                    \n\t                    \x3c!-- Footer --\x3e\n\t                    <tr>\n\t                        <td style="background-color: #f9fafb; padding: 24px 30px; border-top: 1px solid #e5e7eb;">\n\t                            <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px; text-align: center;">\n\t                                This is an automated message from newauth . apps\n\t                            </p>\n\t                            <p style="margin: 0; color: #9ca3af; font-size: 12px; text-align: center;">\n\t                                ¬© ${(new Date).getFullYear()} Newauth. All rights reserved.\n\t                            </p>\n\t                        </td>\n\t                    </tr>\n\t                    \n\t                </table>\n\t            </td>\n\t        </tr>\n\t    </table>\n\t</body>\n\t</html>\n\t    `.trim()}getTenantEmailText(t,e){return`\n\tWelcome to newauth . apps - ${this.currentApp.name}\n\n\tHello ${t.name},\n\n\tThank you for setting up your account! We've created a personalized feedback management portal for your organization.\n\n\tYOUR PORTAL URL:\n\t${e}\n\n\tWHAT YOU CAN DO:\n\t‚Ä¢ Manage and organize feedback hierarchically\n\t‚Ä¢ Create customers and track their concerns\n\t‚Ä¢ Share custom links with your team members\n\t‚Ä¢ Visualize data with interactive dot-based interface\n\n\tAccess your portal: ${e}\n\n\tIf you have any questions or need assistance, feel free to reach out to our support team.\n\n\t---\n\tThis is an automated message from newauth . apps\n\t¬© ${(new Date).getFullYear()} Newauth. All rights reserved.\n\t    `.trim()}getSubtenantEmailTemplate(t,e,n){return`\n\t<!DOCTYPE html>\n\t<html>\n\t<head>\n\t    <meta charset="UTF-8">\n\t    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t</head>\n\t<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: #f4f4f5;">\n\t    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f5; padding: 40px 20px;">\n\t        <tr>\n\t            <td align="center">\n\t                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">\n\t                    \n\t                    \x3c!-- Header --\x3e\n\t                    <tr>\n\t                        <td style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center;">\n\t                            <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: 600;">\n\t                                newauth<span style="color: #ffd700;">.</span>apps\n\t                            </h1>\n\t                            <p style="margin: 10px 0 0 0; color: rgba(255, 255, 255, 0.9); font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">\n\t                                ${this.currentApp.name}\n\t                            </p>\n\t                        </td>\n\t                    </tr>\n\t                    \n\t                    \x3c!-- Body --\x3e\n\t                    <tr>\n\t                        <td style="padding: 40px 30px;">\n\t                            <h2 style="margin: 0 0 20px 0; color: #1f2937; font-size: 22px; font-weight: 600;">\n\t                                üìã Your Feedback Page Has Been Created\n\t                            </h2>\n\t                            \n\t                            <p style="margin: 0 0 16px 0; color: #4b5563; font-size: 16px; line-height: 1.6;">\n\t                                Hello <strong>${t.name}</strong>,\n\t                            </p>\n\t                            \n\t                            <p style="margin: 0 0 16px 0; color: #4b5563; font-size: 16px; line-height: 1.6;">\n\t                                <strong>${e}</strong> has created a dedicated feedback management page for your organization on newauth . apps.\n\t                            </p>\n\t                            \n\t                            <div style="background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 100%); border-left: 4px solid #f59e0b; padding: 20px; margin: 24px 0; border-radius: 6px;">\n\t                                <p style="margin: 0 0 8px 0; color: #92400e; font-size: 14px; font-weight: 600;">\n\t                                    ‚ÑπÔ∏è Important Note\n\t                                </p>\n\t                                <p style="margin: 0; color: #78350f; font-size: 14px; line-height: 1.6;">\n\t                                    This page has been set up by ${e} to help manage and track feedback for your organization.\n\t                                </p>\n\t                            </div>\n\t                            \n\t                            <div style="background: linear-gradient(135deg, #f0f4ff 0%, #f5f3ff 100%); border-left: 4px solid #667eea; padding: 20px; margin: 24px 0; border-radius: 6px;">\n\t                                <p style="margin: 0 0 12px 0; color: #1f2937; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">\n\t                                    Your Feedback Page URL\n\t                                </p>\n\t                                <a href="${n}" style="color: #667eea; font-size: 16px; font-weight: 600; text-decoration: none; word-break: break-all;">\n\t                                    ${n}\n\t                                </a>\n\t                            </div>\n\t                            \n\t                            <h3 style="margin: 30px 0 16px 0; color: #1f2937; font-size: 18px; font-weight: 600;">\n\t                                What's next:\n\t                            </h3>\n\t                            \n\t                            <ul style="margin: 0 0 24px 0; padding-left: 20px; color: #4b5563; font-size: 15px; line-height: 1.8;">\n\t                                <li style="margin-bottom: 10px;">üîç View and manage feedback items assigned to your organization</li>\n\t                                <li style="margin-bottom: 10px;">üìä Track concerns and their status</li>\n\t                                <li style="margin-bottom: 10px;">ü§ù Collaborate with ${e} on feedback resolution</li>\n\t                                <li style="margin-bottom: 10px;">üìà Monitor trends and patterns in your feedback data</li>\n\t                            </ul>\n\t                            \n\t                            <table width="100%" cellpadding="0" cellspacing="0" style="margin: 30px 0;">\n\t                                <tr>\n\t                                    <td align="center">\n\t                                        <a href="${n}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">\n\t                                            View Your Page\n\t                                        </a>\n\t                                    </td>\n\t                                </tr>\n\t                            </table>\n\t                            \n\t                            <p style="margin: 24px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.6;">\n\t                                If you have questions about this page or need assistance, please contact ${e} or our support team.\n\t                            </p>\n\t                        </td>\n\t                    </tr>\n\t                    \n\t                    \x3c!-- Footer --\x3e\n\t                    <tr>\n\t                        <td style="background-color: #f9fafb; padding: 24px 30px; border-top: 1px solid #e5e7eb;">\n\t                            <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px; text-align: center;">\n\t                                This is an automated message from newauth . apps\n\t                            </p>\n\t                            <p style="margin: 0; color: #9ca3af; font-size: 12px; text-align: center;">\n\t                                ¬© ${(new Date).getFullYear()} Newauth. All rights reserved.\n\t                            </p>\n\t                        </td>\n\t                    </tr>\n\t                    \n\t                </table>\n\t            </td>\n\t        </tr>\n\t    </table>\n\t</body>\n\t</html>\n\t    `.trim()}getSubtenantEmailText(t,e,n){return`\n\tnewauth . apps - ${this.currentApp.name}\n\n\tHello ${t.name},\n\n\t${e} has created a dedicated feedback management page for your organization on newauth . apps.\n\n\tIMPORTANT NOTE:\n\tThis page has been set up by ${e} to help manage and track feedback for your organization.\n\n\tYOUR FEEDBACK PAGE URL:\n\t${n}\n\n\tWHAT'S NEXT:\n\t‚Ä¢ View and manage feedback items assigned to your organization\n\t‚Ä¢ Track concerns and their status\n\t‚Ä¢ Collaborate with ${e} on feedback resolution\n\t‚Ä¢ Monitor trends and patterns in your feedback data\n\n\tView your page: ${n}\n\n\tIf you have questions about this page or need assistance, please contact ${e} or our support team.\n\n\t---\n\tThis is an automated message from newauth . apps\n\t¬© ${(new Date).getFullYear()} Newauth. All rights reserved.\n\t    `.trim()}async sendEmail(t,e,n){try{const a=`/newauth/api/sendappemail/${encodeURIComponent(e)}/${encodeURIComponent(n)}`,i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok)throw new Error("Failed to send email: "+i.statusText);const o=await i.json();return console.log("Email sent successfully:",o),o}catch(t){throw console.error("Error sending email:",t),t}}getAppUrl(t){const e=window.location.origin;if(!t||0===t.length)return`${e}/t/apps/${this.currentApp.id}`;const n=t.map((t=>t.asuuid?t.id:t.displayID||this.db.hashUUID(t.id)));return`${e}/t/apps/${this.currentApp.id}/${n.join("/")}`}copyJSONToClipboard(t){navigator.clipboard.writeText(t).then((function(){alert("JSON copied to clipboard!")})).catch((function(t){console.error("Failed to copy JSON:",t);document.getElementById("json-export").select(),document.execCommand("copy"),alert("JSON copied to clipboard!")}))}downloadJSON(t){const e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download="schemas-export-"+(new Date).toISOString().slice(0,10)+".json",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}async importSchemasJSON(t){try{let e=!1;if(t.appSchemas){for(const e of t.appSchemas)await this.db.saveAppSchema(e);e=!0}const n=t.nativeEntities||(t.appSchemas||"object"!=typeof t||Array.isArray(t)?null:t);if(n){for(const[t,e]of Object.entries(n))await this.db.saveNativeEntity(t,e);e=!0}e?(alert("Schemas imported successfully!"),await this.loadAppSchemas(),await this.loadNativeEntities()):alert("No valid data found. Please select an app schema file or native entities file.")}catch(t){console.error("Import failed:",t),alert("Import failed: "+t.message)}}getChildCount(t,e){const n=this.currentApp.entityConfigs[e];if(!n?.childrenField)return 0;const a=t[n.childrenField];return Array.isArray(a)?a.length:0}calculateDotSize(t,e,n){const a=this.currentApp.entityConfigs[e],i=a?.sortConfig,o=this.getItemsForCurrentLevel();if(!i)return"concern"===e&&t.timestamp?this.calculateSizeByTimestamp(t.timestamp,o,16,40):24;if("count"===i.type){const n=this.getChildCount(t,e);return this.calculateSizeByValue(n,o,e,16,40)}if("aggregate"===i.type&&i.aggregateField){const n=this.calculateAggregate(t,e,i);return this.calculateSizeByValue(n,o,e,16,40)}return 24}calculateSizeByTimestamp(t,e,n,a){if(!e.length||!t)return n;const i=e.filter((t=>t.timestamp)).map((t=>t.timestamp));if(0===i.length)return n;const o=Math.min(...i),s=Math.max(...i)-o;if(0===s)return a;const r=(t-o)/s;return n+Math.pow(r,.3)*(a-n)}calculateSizeByValue(t,e,n,a,i){if(!e.length||null==t)return a;let o;const s=this.currentApp.entityConfigs[n],r=s?.sortConfig;if("count"===r?.type)o=e.map((t=>this.getChildCount(t,n)));else{if("aggregate"!==r?.type)return a;o=e.map((t=>this.calculateAggregate(t,n,r)))}const l=Math.min(...o),c=Math.max(...o)-l;if(0===c)return i;return a+(t-l)/c*(i-a)}calculateAggregate(t,e,n){const a=this.currentApp.entityConfigs[e];if(!a?.childrenField)return 0;const i=t[a.childrenField]||[];return Array.isArray(i)?"sum"===n.aggregateFunction?i.reduce(((t,e)=>{const a=e[n.aggregateField]||0;return t+("number"==typeof a?a:0)}),0):i.length:0}async loadAppSelector(){const t=await this.db.getAppSchemas();if(0===t.length)return;const e=this.parseUrlForDataFetch();if(!e||!e.appId)return this.currentApp=null,this.currentPath=[],this.data={items:t.map((t=>({ID:t.id,displayID:t.id,name:t.name,entityType:"app"})))},this.render(),this.breadcrumb&&this.updateBreadcrumb(),void(this.watermark&&this.updateWatermark());await this.selectApp(e.appId),!isowner&&t.length<2&&window.app.hideAppSelectorButton()}async openAppSelector(){var t=this;const e=document.getElementById("app-selector-modal"),n=document.getElementById("app-selector-content"),a=await this.db.getAppSchemas();n.innerHTML='<div class="form-group"><label>Select Application:</label></div>',a.forEach((function(a){const i=document.createElement("div");i.className="schema-card",i.style.cursor="pointer",i.innerHTML="<h3>"+a.name+'</h3><p style="color: #666; margin-top: 8px;">'+a.description+'</p><p style="color: #999; font-size: 13px; margin-top: 8px;">Hierarchy: '+a.hierarchy.join(" ‚Üí ")+"</p>",i.addEventListener("click",(async function(){window.history.pushState({},"",`/t/apps/${a.id}`),await t.selectApp(a.id),t.render(),t.updateBreadcrumb(),t.updateWatermark(),e.style.display="none"})),n.appendChild(i)})),e.style.display="block"}async selectApp(t){if(!t||!t.trim())return void console.log("No Appid, returning from selectApp");const e=await this.db.getAppSchemas();this.currentApp=e.find((function(e){return e.id===t})),this.currentApp&&(this.data=await this.db.getAppData(this.currentApp.id),console.log("[selectApp] Loaded data for app:",t,"items:",this.data.items?.length),this.updateWatermark(),this.updatePageTitle())}hash(t){let e=0;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}return Math.abs(e).toString(36)}_getCurrentEntityType(){if(!this.currentPath||0===this.currentPath.length)return this.currentApp?.type||"app";const t=this.currentPath[this.currentPath.length-1];return t?.entityType||"unknown"}getNextEntityType(){if(!this.currentApp)return null;const t=this.currentPath.length;return t<this.currentApp.hierarchy.length?this.currentApp.hierarchy[t]:null}setupPopstateHandler(){window.addEventListener("popstate",(t=>{const e=t.state;if(!e)return void this.handleInitialState();e.depth;const n=e.path||[];this.currentPath=n.map((t=>({id:t.id,displayID:t.displayID||t.id,hashed:t.hashed||!1,entityType:t.entityType,shortName:t.shortName||t.id.substring(0,8)}))),this.render(),this.updateBreadcrumb(),this.updateWatermark()})),this.handleInitialState()}handleInitialState(){if(this.currentPath?.length>0)return void console.log("[handleInitialState] Path already initialized - skipping reset");const t=this.parseUrlForDataFetch();if(t&&t.appId&&(this.currentPath=[],t.pathIds&&t.pathIds.length>0))for(let e=0;e<t.pathIds.length&&e<this.currentApp.hierarchy.length;e++){const n=t.pathIds[e],a=this.currentApp.hierarchy[e];this.currentPath.push({id:n,displayID:n,hashed:!0,shortName:n.substring(0,8),entityType:a})}}getCurrentData(){let t=this.data.items;for(let e=0;e<this.currentPath.length;e++){const n=this.currentPath[e],a=this.currentApp.hierarchy[e],i=this.currentApp.entityConfigs[a],o=this;if(t=t.find((function(t){return o.getItemId(t,a)===n.id})),!t)return[];const s=i.childrenField;t[s]||(t[s]=[]),t=t[s]}return t}_hasFullDataStructure(){if(!this.data?.items||0===this.data.items.length)return!1;const t=this.currentApp?.hierarchy?.[0];if(!t)return!1;return this.data.items[0].entityType===t}_hasFullDataStructure(){return this.data?.items?.length>1||this.data?.items?.[0]?.entityType&&this.currentPath.length>0}_mergePartialIntoFullData(t,e){if(0===e.length)return void(this.data.items=t.items);let n=this.data.items;for(let t=0;t<e.length-1;t++){const a=this.currentApp.hierarchy[t],i=this.currentApp.entityConfigs[a]?.childrenField,o=e[t],s=n.find((t=>t.displayID===o||t.ID===o));if(!s||!s[i])return;n=s[i]}const a=e[e.length-1],i=n.findIndex((t=>t.displayID===a||t.ID===a));-1!==i&&t.items?.[0]&&(n[i]={...t.items[0]},console.log(`[Merge] Updated entity at path: ${e.join("/")}`))}getItemsForCurrentLevel(){const t=this.currentPath.length;if(console.log("=== DEBUG getItemsForCurrentLevel ==="),console.log("currentDepth:",t),console.log("isDataOwner():",this.isDataOwner()),console.log("isFilteredView:",!this.isDataOwner()),0===t)return console.log("Returning root level items:",this.data.items?.length||0),console.log("====================================="),this.data.items||[];if(!this.data?.items||0===this.data.items.length)return console.log("No data items available"),console.log("====================================="),[];if(!this.isDataOwner()){if(!this.currentApp.hierarchy[t])return this.data.items;const e=this.currentApp.hierarchy[t-1],n=this.currentApp.entityConfigs[e].childrenField;if(!n)return this.data.items;const a=this.data.items[0];return a&&a[n]?a[n]:this.data.items}console.log("Browser 1 - navigating nested hierarchy"),console.log("Hierarchy:",this.currentApp.hierarchy),console.log("Current path:",this.currentPath.map((t=>({id:t.id,displayID:t.displayID}))));let e=this.data.items,n=0;for(console.log("Initial currentItems count:",e.length),e.length>0&&console.log("Initial currentItems first item ID/displayID:",{ID:e[0].ID,displayID:e[0].displayID,entityType:e[0].entityType});n<t-1&&e.length>0;){const t=this.currentApp.hierarchy[n],a=this.currentApp.entityConfigs[t].childrenField;console.log(`Navigating level ${n}:`),console.log(`  entityType: ${t}`),console.log(`  childrenField: ${a}`);const i=this.currentPath[n];console.log(`  Looking for pathItem id: ${i.id}, displayID: ${i.displayID}`),console.log(`  Current items count: ${e.length}`),e.forEach(((t,e)=>{console.log(`    Item ${e}: ID=${t.ID}, displayID=${t.displayID}`)}));const o=e.find((t=>t.ID===i.id||t.displayID===i.id));if(!o)return console.log("‚ùå Item NOT FOUND at level",n),console.log("====================================="),[];if(console.log("‚úÖ Found item at level",n,":",{ID:o.ID,displayID:o.displayID}),!o[a])return console.log(`‚ùå No children field "${a}" on found item`),console.log("Available fields:",Object.keys(o)),console.log("====================================="),[];e=o[a]||[],n++,console.log(`Moved to next level - new currentItems count: ${e.length}`)}console.log("Reached parent level navigation complete"),console.log("Parent level currentItems count:",e.length);const a=this.currentApp.hierarchy[t-1],i=this.currentApp.entityConfigs[a].childrenField;console.log("Looking for parent:"),console.log("  parentEntityType:",a),console.log("  childrenField:",i);const o=this.currentPath[t-1];console.log("  parentPathItem id:",o.id),console.log("  parentPathItem displayID:",o.displayID),e.length>0&&(console.log("Parent level items:"),e.forEach(((t,e)=>{console.log(`  Item ${e}: ID=${t.ID}, displayID=${t.displayID}`)})));const s=e.find((t=>t.ID===o.id||t.displayID===o.id));return s?(console.log("‚úÖ Parent found:",{ID:s.ID,displayID:s.displayID}),s[i]?(console.log("‚úÖ Returning children:",s[i].length,"items"),s[i].length>0&&console.log("First child:",s[i][0]),console.log("====================================="),s[i]):(console.log(`‚ùå Parent has no children field "${i}"`),console.log("Parent fields:",Object.keys(s)),console.log("====================================="),[])):(console.log("‚ùå PARENT NOT FOUND in parent level items"),console.log("====================================="),[])}navigateHierarchy(){console.log("  [navigateHierarchy] START"),console.log("  [navigateHierarchy] Data items count:",this.data.items.length),console.log("  [navigateHierarchy] Path length to navigate:",this.currentPath.length);let t=this.data.items;for(let e=0;e<this.currentPath.length;e++){const n=this.currentPath[e],a=this.currentApp.hierarchy[e],i=this.currentApp.entityConfigs[a];console.log(`  [navigateHierarchy] Level ${e}: Looking for ${a} with ID:`,n.id),console.log(`  [navigateHierarchy] Level ${e}: Current level has ${t.length} items`),console.log(`  [navigateHierarchy] Level ${e}: Path item ID:`,n.id),console.log("  [navigateHierarchy] Path item displayID:",n.displayID),console.log("  [navigateHierarchy] Current level items:"),t.forEach(((t,e)=>{console.log(`    Item ${e}: ID=${t.ID}, displayID=${t.displayID}`)}));const o=t.find((t=>{const e=this.getItemId(t,a),i=t.displayID,o=e===n.id,s=i===n.id,r=o||s;return console.log("    [navigateHierarchy] Checking item:"),console.log(`     [navigateHierarchy] Real ID: ${e} === ${n.id}? ${o}`),console.log(`     [navigateHierarchy] Display ID: ${i} === ${n.id}? ${s}`),console.log(`    [navigateHierarchy]  Match: ${r}`),r}));if(!o)return console.error(`  [navigateHierarchy] ‚ùå Item NOT FOUND at level ${e} for ID:`,n.id),console.log("  [navigateHierarchy] Available items:",t.map((t=>({realId:this.getItemId(t,a),displayId:t.displayID})))),null;if(console.log(`  [navigateHierarchy] ‚úÖ Found item at level ${e}:`,{ID:o.ID,displayID:o.displayID,keys:Object.keys(o)}),e===this.currentPath.length-1){const t=i.childrenField;if(console.log("  [navigateHierarchy] FINAL LEVEL - Looking for children in field:",t),!t)return console.error("  [navigateHierarchy] ‚ùå No children field at final level"),[];const e=o[t]||[];return console.log(`  [navigateHierarchy] ‚úÖ FINAL RESULT: Found ${e.length} children`),e.length>0&&console.log("  [navigateHierarchy] First child:",e[0]),e}const s=i.childrenField;if(console.log("  [navigateHierarchy] Moving to next level via field:",s),!o[s])return console.error(`  [navigateHierarchy] ‚ùå No children field "${s}" at level ${e}`),console.log("  [navigateHierarchy] Available fields:",Object.keys(o)),null;t=o[s],console.log(`  [navigateHierarchy] Next level has ${t.length} items`)}return console.warn("  [navigateHierarchy] ‚ö†Ô∏è Unexpected: Loop completed without returning"),null}async getEntityConfig(t){return(await this.db.getNativeEntities())[t]}getItemId(t,e){const n=this.currentApp.entityConfigs[e];return t.hashed&&t.ID?t.ID:t[n.idField]}getItemLabel(t,e){const n=this.currentApp.entityConfigs[e].labelField;if(t.ID){return this.getUserLoginStatus()?t.ID:t.displayID||this.db.hashUUID(t.ID)}return t[n]}hashCode(t){let e=0;if(!t||0===t.length)return e;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}return Math.abs(e)}generateDotPositions(t,e,n){if(console.log("Generating positions for",t,"items, items array:",e),!e||!Array.isArray(e)||0===e.length)return console.warn("No items provided to generateDotPositions"),[];const a=document.getElementById("canvas-area");if(!a)return console.error("Canvas element not found"),[];const i=a.getBoundingClientRect(),o=Math.max(i.width-160,200),s=Math.max(i.height-160,200),r=i.width/2,l=i.height/2,c=(this.centerZoneRadius||0)+50,d=Math.min(o,s)/2-50,p=Math.max(c+50,d/1.3-20),h=c+50;console.log(`[Positions] Canvas: ${i.width}x${i.height}, Available radius: ${d.toFixed(0)}px, Max distance: ${p.toFixed(0)}px`);const u=[];for(let a=0;a<t;a++){const t=e[a];if(!t){console.warn(`Item at index ${a} is undefined`);continue}const o=this.getItemLabel(t,n),s=this.getItemId(t,n)||o||`item_${a}`;if(!s){console.warn(`No itemId found for item at index ${a}, using fallback`);continue}const c=this.hashCode(s);console.log(`Item ${a} "${o}" (ID: ${s}): seed=${c}`);const d=new SeededRandom(c);let m,g,y=0,f=!1;do{const e=d.randomBetween(0,2*Math.PI),s=d.randomBetween(h,p);m=r+Math.cos(e)*s,g=l+Math.sin(e)*s;const c=80+this.calculateDotSize(t,n,a)+30;if(f=m>=c&&m<=i.width-c&&g>=c&&g<=i.height-c,y++,y>50){console.warn(`[Positions] Spiral fallback for "${o}" after ${y} attempts`);const t=2.4*a,e=100+40*a;m=r+Math.cos(t)*e,g=l+Math.sin(t)*e,f=!0}}while(!f&&y<100);console.log(`  ‚Üí Position: (${Math.round(m)}, ${Math.round(g)})`),u.push({x:m,y:g})}return console.log(`[Positions] Generated ${u.length} valid positions`),u}render(){var t=this;console.log("=== RENDER DEBUG START ==="),console.log("[Render] Current path:",this.currentPath),console.log("[Render] Current path length:",this.currentPath.length),console.log("[Render] Data items:",this.data?.items),console.log("[Render] Data items[0]:",this.data?.items?.[0]),console.log("[Render] Data items[0] concerns:",this.data?.items?.[0]?.concerns),console.log("[render] Data items structure:",this.data.items.map((t=>({ID:t.ID,displayID:t.displayID,hasName:!!t.name,hasCustomers:!!t.customers,customersCount:t.customers?.length}))));const e=document.getElementById("canvas-area");if(!e)return void console.error("[Render] Canvas element not found!");const n=e.getBoundingClientRect();if(console.log("[Render] Canvas dimensions:",{width:n.width,height:n.height,valid:n.width>0&&n.height>0}),0===n.width||0===n.height)return void console.error("[Render] Canvas has zero dimensions - aborting");if(!this.currentApp&&this.data?.items?.some?.((t=>"app"===t.entityType))||this.currentApp&&0===this.currentPath.length&&this.data?.items?.length>0&&!this.data.items[0].entityType)return console.log("[render] Entity selector mode"),void this.renderEntitySelector();if(!this.currentApp)return void(document.getElementById("canvas-area").innerHTML='<div class="loading">Please select an application to continue</div>');const a=this.parseUrlForDataFetch(),i=a&&!a.tenantId&&!a.subtenantId,o=!isowner&&i&&this.hasSavedContextForApp(a?.appId);if(!isowner&&i&&!o&&0===this.data.items.length)return void this.showCreateTenantOption();const s=document.getElementById("canvas-area");console.log("Canvas element:",s),s.innerHTML="",console.log("Canvas cleared");const r=this.getNextEntityType();console.log("Next entity type:",r);const l=document.createElement("div");if(l.className="center-zone",r){const e=document.createElement("button");let n;e.className="add-item-btn",e.textContent="+";const a=this.currentPath.length;if(0===a)if(this.currentApp.hierarchy&&this.currentApp.hierarchy.length>0){const t=this.currentApp.hierarchy[0];n=`Create new ${t.charAt(0).toUpperCase()+t.slice(1)}`}else n="Create new item";else if(a<this.currentApp.hierarchy.length){const t=this.currentApp.hierarchy[a];n=`Add new ${t.charAt(0).toUpperCase()+t.slice(1)}`}else n="Add new item";e.title=n,e.addEventListener("click",(function(){t.openAddDialog()})),l.appendChild(e)}else{const t=document.createElement("div");t.style.cssText="font-size: 14px; color: #999; text-align: center;",t.textContent="Maximum nesting level reached",l.appendChild(t)}s.appendChild(l),console.log("Center zone added");const c=this.getViewingContext();console.log("[render] Context:",c),console.log("[render] this.data.items:",this.data.items),console.log("[render] this.data.items length:",this.data.items?.length);let d=[];const p=this.currentPath.length;if(0===p)d=this.data?.items||[];else if(p>=1&&this.data?.items?.length>0){const t=this.data.items[0],e=this.currentPath[p-1];if(t.entityType===e.entityType&&t.displayID===e.displayID){const e=this.currentApp.hierarchy[p-1],n=this.currentApp.entityConfigs[e];n&&n.childrenField&&(d=t[n.childrenField]||[])}else{let t=this.data.items,e=null;for(let n=0;n<p;n++){const a=this.currentPath[n],i=this.currentApp.hierarchy[n];if(e=t.find((t=>t.ID===a.id||t.displayID===a.displayID||!a.id.includes("-")&&t.ID.includes("-")&&this.db.hashUUID(t.ID)===a.id)),!e)break;if(n<p-1){t=e[this.currentApp.entityConfigs[i].childrenField]||[]}}if(e){const t=this.currentApp.hierarchy[p-1],n=this.currentApp.entityConfigs[t];n&&n.childrenField&&(d=e[n.childrenField]||[])}}}if(console.log("[render] Final items array:",d),console.log("[render] Items array types:",d.map((t=>typeof t))),console.log("[render] Items to display:",d?.length||0),d=this.searchResults?d.filter((t=>"hide"!==this.shouldShowItemInSearch(t))):d,console.log("[render] Items to display after search filter:",d?.length||0),!Array.isArray(d)||0===d.length){console.log("No items found, showing no data message. Items:",d);const t=document.createElement("div");return t.style.cssText="\n\t\t            position: absolute;\n\t\t            left: 50%;\n\t\t            bottom: 40px;\n\t\t            transform: translateX(-50%);\n\t\t            text-align: center;\n\t\t            color: #999;\n\t\t            font-size: 16px;\n\t\t        ",t.innerHTML=`\n\t\t            <div style="margin-bottom: 8px;">üìä No ${r?r.replace(/_/g," "):"item"} to track yet.</div>\n\t\t            <div style="font-size: 14px;">\n\t\t                Use the + button to add ${r?r.replace(/_/g," "):"item"}s\n\t\t            </div>\n\t\t        `,s.appendChild(t),void console.log("No data message displayed")}console.log("Items to render:",d.length,"items"),null!=this.currentApp&&(console.log("[render] Entity hierarchy:",this.currentApp.hierarchy),console.log("[render] Customer entity config:",this.currentApp.entityConfigs.customer),console.log("[render] Concern entity config:",this.currentApp.entityConfigs.concern)),d.length>0&&console.log("First item structure:",JSON.stringify(d[0],null,2));const h=this._getCurrentEntityType()||this.currentApp.hierarchy[0];let u;console.log("Entity type for rendering:",h);try{u=this.generateDotPositions(d.length,d,h),console.log("Generated positions:",u.length,"positions")}catch(t){return void console.error("Error generating positions:",t)}if(!u||0===u.length)return void console.log("No positions generated");const m=this.calculateVisualScores(d,h);console.log("[VisualScores]",m.stats);const g=this._getDispersionDirection(),y=2*g.centerX,f=2*g.centerY,b=(t,e,n)=>{const a=n[e],i=a.ID||a.displayname||`clamp_${e}`,o=new SeededRandom(this._stringToSeed(i));let s=t.x,r=t.y;return s<100&&(s=100+o.randomBetween(0,30)),s>y-100&&(s=y-100-o.randomBetween(0,30)),r<100&&(r=100+o.randomBetween(5,40)),r>f-100&&(r=f-100-o.randomBetween(0,30)),{x:s,y:r}},v=u.map(((t,e)=>{const n=d[e],a=n.ID||n.displayname||n.displayID||`item_${e}`,i=this._stringToSeed(a),o=new SeededRandom(i),s=t.x-g.centerX,r=t.y-g.centerY,l=Math.sqrt(s*s+r*r),c=Math.atan2(r,s),p=o.randomBetween(g.aspectRatio<1.2?-.52:-.26,g.aspectRatio<1.2?.52:.26),h=l*(1+(g.aspectRatio>=1.5?o.randomBetween(-.2,.8):o.randomBetween(-.3,.3))),u=c+p;let m=g.centerX+Math.cos(u)*h,y=g.centerY+Math.sin(u)*h;if(g.aspectRatio<1.2){m+=o.randomBetween(-.1,.1)*l}return{x:m,y:y}})),w=v.map(((t,e)=>b(t,e,d))),x=1.2*m.dotSizes.reduce(((t,e)=>Math.max(t,e)),0);for(let t=0;t<w.length;t++)for(let e=0;e<t;e++){const n=w[t].x-w[e].x,a=w[t].y-w[e].y,i=Math.sqrt(n*n+a*a);if(i<x){const e=Math.atan2(a,n),o=.5*(x-i);w[t].x+=Math.cos(e)*o,w[t].y+=Math.sin(e)*o,w[t]=b(w[t],t,d)}}console.log(`[Dispersion] Aspect ratio: ${g.aspectRatio.toFixed(2)} | Horizontal: ${g.horizontal} | Vertical: ${g.vertical}`);const I=[...m.engagementScores].sort(((t,e)=>t-e)),D=I[Math.floor(.8*I.length)]||0,S=d.length>=5;let C=0;if(S){const t=.2,e=Math.floor(I.length*t);C=I[e]||0}if(d.forEach(((t,e)=>{if(v[e])try{const{dotSizes:n,agesInMs:a,safeHits:i,recencyPercentiles:o,hitPercentiles:r,timeContext:l}=m,c=n[e],d=a[e];let p,u="#ffffff";S&&m.engagementScores[e]<=C?(p="#d3d3d3",u="#333333"):p=this.getDotColor(t,h);const g=m.engagementScores[e];let y=g>=D?1:D>0?.3+g/D*.55:.3;const f=this.searchResults?this.shouldShowItemInSearch(t):null;let b=y,w="";"match"===f?(b=1,w="brightness(1.2)"):"ancestor"===f&&(b=.4,w="grayscale(100%) brightness(0.8)",p="#b0b0b0",u="#555555");const x=["dot"];m.agesInMs[e]<3e4&&x.push("dot-pulse");const I={position:"absolute",left:v[e].x-c/2+"px",top:v[e].y-c/2+"px",width:`${c}px`,height:`${c}px`,borderRadius:"50%",backgroundColor:p,color:u,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:`${Math.max(14,.6*c)}px`,fontWeight:"bold",textAlign:"center",zIndex:100,opacity:b.toString(),filter:w,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},E=document.createElement("div");E.className=x.join(" "),Object.assign(E.style,I),t.ID?E.dataset.id=t.ID:t.displayname?E.dataset.id=t.displayname.split("/").pop():t.displayID&&(E.dataset.id=t.displayID);const A=(t[this.currentApp.entityConfigs[h]?.labelField||"name"]||"?").substring(0,3);if(3===A.length){const t=A.split("");E.innerHTML=`<span class="dot-label"><span>${t[0]}</span><span>${t[1]}</span><span>${t[2]}</span></span>`}else E.textContent=A;E.itemData=t,E.entityType=h,E.itemIndex=e,this.attachDotInteractionHandlers(E,t,h),s.appendChild(E),e<5&&console.log(`DATA Dot ${e}: hit=${i[e]}, age=${(d/36e5).toFixed(1)}h, size=${c.toFixed(1)}px`)}catch(n){console.error(`Error creating dot ${e}:`,n,t)}})),this._isRefreshing)return console.log("[Render] SKIPPED polling management (_isRefreshing=true)"),void console.log("=== RENDER COMPLETED ===");console.log("[Render] Managing polling - currentPath.length:",this.currentPath.length),0===this.currentPath.length&&console.warn("[Render] PATH IS EMPTY! Stack:",(new Error).stack.split("\n").slice(1,4).join("\n"),"| currentApp:",!!this.currentApp,"| isPollingActive:",this.isPollingActive),0===this.currentPath.length?this.isPollingActive&&(console.log("[Render] Stopping polling (root level)"),this.stopVersionPolling()):(console.log("[Render] Starting/restarting polling"),this.startVersionPolling()),console.log("=== RENDER COMPLETED ===")}_stringToSeed(t){let e=0;if(!t)return e;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}return Math.abs(e)||1}calculateVisualScores(t,e){const n=Date.now(),a=this.currentApp?.entityConfigs?.[e]?.childrenField,i=t.length,o=document.getElementById("canvas-area"),s=o?.offsetWidth||1920,r=o?.offsetHeight||1080,l=s*r,c=new Array(i),d=new Array(i),p=[];for(let e=0;e<i;e++){const i=t[e];c[e]=this._extractHitCount(i,a),d[e]=this._extractAgeInMs(i,n);const o=i.lastupdatetime||i.crTime;o&&"number"==typeof o&&!isNaN(o)&&p.push(o)}const h=this._calculatePercentiles(d,!0),u=this._calculatePercentiles(c,!1),m=new Array(i);for(let t=0;t<i;t++)m[t]=.6*h[t]+.4*u[t];const g=Math.sqrt(l/Math.max(1,i)),y=.3*g,f=Math.min(60,Math.max(12,y)),b=Math.max(4,.3*f),v=m.map((t=>b+(f-b)*t));return{recencyPercentiles:h,hitPercentiles:u,engagementScores:m,dotSizes:v,agesInMs:d,safeHits:c,timeContext:p.length>0?{minTime:Math.min(...p),maxTime:Math.max(...p),timeSpan:Math.max(1,Math.max(...p)-Math.min(...p))}:{minTime:n,maxTime:n,timeSpan:1},stats:{itemCount:i,canvasDimensions:{width:s,height:r},canvasArea:Math.round(l),charLength:g.toFixed(1),spacePerItem:(l/i).toFixed(0),maxHit:Math.max(...c,0),minAge:Math.min(...d),maxAge:Math.max(...d),sizeRange:{min:b.toFixed(1),max:f.toFixed(1),ratio:(b/f).toFixed(2),formula:`15% of sqrt(canvasArea/${i})`}}}}_getDispersionDirection(){const t=document.getElementById("canvas-area"),e=t?.offsetWidth||1920,n=t?.offsetHeight||1080,a=e/n;return{horizontal:a>=1.5?1.8:1.2,vertical:a<1.2?2:1.2,centerX:e/2,centerY:n/2,aspectRatio:a}}_extractHitCount(t,e){if(null!=t.hit&&"number"==typeof t.hit&&!isNaN(t.hit)&&t.hit>0)return t.hit;if(e&&t[e]&&Array.isArray(t[e]))return t[e].length;const n=["customers","concerns","children","items","subtenants"];for(const e of n)if(t[e]&&Array.isArray(t[e]))return t[e].length;const a=Object.values(t).filter((t=>Array.isArray(t))).map((t=>t.length));return a.length>0?Math.max(...a):0}_extractAgeInMs(t,e){if(null!=t.lastupdatetime&&"number"==typeof t.lastupdatetime&&!isNaN(t.lastupdatetime))return e-t.lastupdatetime;if(null!=t.crTime&&"number"==typeof t.crTime&&!isNaN(t.crTime))return e-t.crTime;const n=["created","timestamp","createdAt","updated"];for(const a of n){const n=t[a];if(null!=n&&"number"==typeof n&&!isNaN(n))return e-n}return 0}_calculatePercentiles(t,e){if(t.length<=1)return[1];const n=t.map(((t,e)=>({val:t,idx:e})));n.sort(((t,n)=>e?t.val-n.val:n.val-t.val));const a=new Array(t.length);for(let t=0;t<n.length;t++){const{idx:e}=n[t];a[e]=1-t/(n.length-1)}return a}_calculateTimeContext(t){const e=Date.now(),n=t.filter((t=>null!=t.lastupdatetime&&"number"==typeof t.lastupdatetime&&!isNaN(t.lastupdatetime)||null!=t.crTime&&"number"==typeof t.crTime&&!isNaN(t.crTime)));if(0===n.length)return{minTime:e,maxTime:e,timeSpan:1};const a=n.map((t=>t.lastupdatetime||t.crTime||e)),i=Math.min(...a),o=Math.max(...a);return{minTime:i,maxTime:o,timeSpan:Math.max(1,o-i)}}renderEntitySelector(){const t=document.getElementById("canvas-area");if(!t||!this.data?.items?.length)return;const e=this.calculateVisualScores(this.data.items,"entity-selector"),{dotSizes:n,engagementScores:a,agesInMs:i}=e,o=[...a].sort(((t,e)=>t-e)),s=o[Math.floor(.8*o.length)]||0,r=this.data.items.length>=5;let l=0;if(r){const t=.2,e=Math.floor(o.length*t);l=o[e]||0}t.innerHTML="";const c=document.createElement("div");c.style.cssText="position: absolute; top: 30px; left: 50%; transform: translateX(-50%); font-size: 20px; font-weight: bold; color: #333; z-index: 200;",c.textContent=this.getEntitySelectorTitle(),t.appendChild(c);const d=t.getBoundingClientRect(),p=this.data.items,h=p.some((t=>void 0!==t.crTime));let u=1/0,m=-1/0;h&&p.forEach((t=>{t.crTime<u&&(u=t.crTime),t.crTime>m&&(m=t.crTime)}));const g=60,y=d.width-60,f=100,b=d.height-60;p.forEach(((e,o)=>{const c=n[o],d=a[o],p=i[o];let h=this.getEntityDotColor(e,!this.currentApp),u="white";r&&d<=l&&(h="#d3d3d3",u="#333333");let m=d>=s?1:.3+d/s*.7,v=e.displayname||e.ID||e.name||`entity_${o}`;e.displayname&&e.displayname.includes("/")?v=e.displayname.split("/").pop():e.ID&&e.ID.includes("-")&&(v=this.db.hashUUID(e.ID));const{xRatio:w,yRatio:x}=(t=>{let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e=16777619*e>>>0;return{xRatio:(65535&e)/65535,yRatio:(e>>16&65535)/65535,hash:e}})(v),I=g+w*(y-g),D=f+x*(b-f),S=["dot","entity-selector-dot"];p<3e4&&S.push("dot-pulse");const C=document.createElement("div");let E,A,P;C.className=S.join(" "),E=e.ID?e.ID:e.displayname?e.displayname.split("/").pop():e.displayID||`entity_${o}`,C.dataset.id=E,Object.assign(C.style,{position:"absolute",left:I-c/2+"px",top:D-c/2+"px",width:`${c}px`,height:`${c}px`,backgroundColor:h,color:u,borderRadius:"50%",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",fontWeight:"bold",boxShadow:"0 4px 15px rgba(0,0,0,0.2)",border:"3px solid rgba(255,255,255,0.4)",zIndex:100,opacity:m.toString(),transition:"transform 0.2s ease, box-shadow 0.2s ease"});const k=!this.currentApp,T=this.currentApp&&0===this.currentPath.length;if(k)A=e.name?.substring(0,3).toUpperCase()||"APP",P=e.name;else if(T){const t=e.displayname||e.ID||"",n=t.split("/"),a=n[n.length-1]||t;A=a.substring(0,3).toUpperCase(),P=a}else A=(e.name||e.ID||"").substring(0,3).toUpperCase()||"???",P=e.name||e.ID;if(C.innerHTML=`\n\t\t\t        <div style="font-size: ${Math.max(14,.35*c)}px; margin-bottom: ${P?"2px":"0"}; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">\n\t\t\t            ${A}\n\t\t\t        </div>\n\t\t\t        ${P?`<div style="font-size: ${Math.max(8,.16*c)}px; opacity: 0.9; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${P}</div>`:""}\n\t\t\t    `,C.addEventListener("mouseenter",(()=>{C.style.transform="scale(1.1) translateY(-5px)",C.style.boxShadow="0 8px 25px rgba(0,0,0,0.35)",C.style.zIndex="150"})),C.addEventListener("mouseleave",(()=>{C.style.transform="scale(1) translateY(0)",C.style.boxShadow="0 4px 15px rgba(0,0,0,0.2)",C.style.zIndex="100"})),C.addEventListener("click",(t=>{t.stopPropagation(),this.handleEntitySelectorClick(e,k,T)})),e.crTime){const t=new Date(e.crTime).toLocaleDateString();C.title=`Created: ${t}`}t.appendChild(C)})),console.log(`[renderEntitySelector] Rendered ${p.length} entities with bit-split positioning`)}getEntitySelectorTitle(){return this.currentApp?0===this.currentPath.length?"Select a Tenant":"Select an Item":"Select an Application"}getEntityDotColor(t,e){const n=t.name||t.displayname||t.ID||"";let a=0;for(let t=0;t<n.length;t++)a=n.charCodeAt(t)+((a<<5)-a);return`hsl(${Math.abs(a)%360}, ${e?70:60}%, 50%)`}handleEntitySelectorClick(t,e,n){if(console.log("[handleEntitySelectorClick] START"),console.log("[handleEntitySelectorClick] item:",t),console.log("[handleEntitySelectorClick] isAppSelector:",e),console.log("[handleEntitySelectorClick] isTenantSelector:",n),e){console.log("[handleEntitySelectorClick] APP SELECTOR - navigating to app");const e=t.ID||t.id;console.log("[handleEntitySelectorClick] App ID:",e);const n=`/t/apps/${e}`;console.log("[handleEntitySelectorClick] New URL:",n),window.history.pushState({appId:e,fromAppSelector:!0},"",n),console.log("[handleEntitySelectorClick] History state set"),console.log("[handleEntitySelectorClick] Calling init()..."),this.init(),console.log("[handleEntitySelectorClick] init() called")}else if(n){console.log("[handleEntitySelectorClick] TENANT SELECTOR - navigating to tenant");const e=t.displayname||t.ID||"";console.log("[handleEntitySelectorClick] Display name:",e);const n=e.split("/"),a=n[n.length-1]||e;console.log("[handleEntitySelectorClick] Extracted tenant ID:",a);const i=[{id:a,displayID:a,shortName:a.substring(0,8),entityType:this.currentApp?.hierarchy?.[0]||"tenant"}];console.log("[handleEntitySelectorClick] New path:",i);const o=this.getAppUrl(i);console.log("[handleEntitySelectorClick] New URL:",o),window.history.pushState({path:i},"",o),console.log("[handleEntitySelectorClick] History state set"),console.log("[handleEntitySelectorClick] Calling init()..."),this.init(),console.log("[handleEntitySelectorClick] init() called")}else console.log("[handleEntitySelectorClick] Neither app nor tenant selector - no action")}setupSearch(){const t=document.getElementById("entity-search"),e=document.getElementById("search-clear");t&&(t.addEventListener("input",(t=>{const n=t.target.value.trim();e&&(e.style.display=n.length>0?"block":"none"),n.length>=3?this.handleSearch(n):0===n.length&&this.handleSearch("")})),t.addEventListener("keypress",(e=>{if("Enter"===e.key){e.preventDefault();const n=t.value.trim();this.handleSearch(n)}})),t.addEventListener("keydown",(n=>{"Escape"===n.key&&(t.value="",e&&(e.style.display="none"),this.handleSearch(""),t.blur())})),e&&e.addEventListener("click",(n=>{n.stopPropagation(),t.value="",e.style.display="none",this.handleSearch(""),t.focus()})))}handleSearch(t){document.getElementById("entity-search");const e=document.getElementById("search-clear");if(e&&(e.style.display=t?"block":"none"),this.searchTerm=t,t.length<3)return this.searchResults=null,void this.render();this.searchResults=this.performSearch(t.toLowerCase()),this.render()}performSearch(t){const e={matches:new Set,ancestors:new Set,matchPaths:[]};return this.searchRecursive(this.data.items,[],t,e),e}searchRecursive(t,e,n,a){t&&Array.isArray(t)&&t.forEach((t=>{const i=[...e,t],o=i.length-1,s=this.currentApp.hierarchy[o]||`level_${o}`;if(this.itemMatchesSearch(t,n,s)){a.matches.add(t.ID),a.matchPaths.push([...i]);for(let t=0;t<e.length;t++)a.ancestors.add(e[t].ID)}const r=this.currentApp.entityConfigs[s];r&&r.childrenField&&t[r.childrenField]&&this.searchRecursive(t[r.childrenField],i,n,a)}))}itemMatchesSearch(t,e,n){if(!t)return!1;const a=this.nativeEntities?.[n],i=a?.fields?.filter((t=>"system"!==t.writePermission&&"ID"!==t.name&&"displayID"!==t.name&&"dotLabel"!==t.name&&"timestamp"!==t.name&&"count"!==t.name&&"hidden"!==t.name&&"hashed"!==t.name))||[];for(const n of i){const a=t[n.name];if(null!=a){if(String(a).toLowerCase().includes(e))return!0}}return!(!t.name||!String(t.name).toLowerCase().includes(e))||!(!t.dotLabel||!String(t.dotLabel).toLowerCase().includes(e))}shouldShowItemInSearch(t){if(!this.searchResults)return!0;const e=this.currentPath.length;return!(this.getEntityDepth(t)===e)||(this.searchResults.matches.has(t.ID)?"match":this.searchResults.ancestors.has(t.ID)?"ancestor":"hide")}getEntityDepth(t){return this.currentPath.length}getItemLabel(t,e){const n=this.currentApp.entityConfigs[e];if(null!=t.name)return String(t.name);if(n?.labelField&&null!=t[n.labelField])return String(t[n.labelField]);const a=Object.keys(t).find((e=>e.toLowerCase().includes("name")&&"string"==typeof t[e]));if(a)return String(t[a]);const i=Object.keys(t).find((e=>e.toLowerCase().includes("text")&&"string"==typeof t[e]));if(i)return String(t[i]);if(t.ID){return this.getUserLoginStatus()?t.ID:t.displayID||this.db.hashUUID(t.ID)}return"Un Named"}generateAppColor(t){let e=0;for(let n=0;n<t.length;n++)e=t.charCodeAt(n)+((e<<5)-e);return`hsl(${Math.abs(e)%360}, 70%, 50%)`}getDotColor(t,e){const n=this.getItemId(t,e)||this.getItemLabel(t,e)||`item_${Math.random()}`,a=this.hashCode(n),i=new SeededRandom(a);let o=Math.floor(i.randomBetween(0,255)),s=Math.floor(i.randomBetween(0,255)),r=Math.floor(i.randomBetween(0,255));const l=(299*o+587*s+114*r)/1e3;if(l<120){const t=120/l;o=Math.min(255,Math.floor(o*t)),s=Math.min(255,Math.floor(s*t)),r=Math.min(255,Math.floor(r*t))}if(l>220){const t=220/l;o=Math.floor(o*t),s=Math.floor(s*t),r=Math.floor(r*t)}return`rgb(${o}, ${s}, ${r})`}getFieldLabel(t,e){const n=this.currentApp.entityConfigs[e];if(n&&n.fields){const e=n.fields.find((e=>e.name===t));return e?.label||t}return t.charAt(0).toUpperCase()+t.slice(1)}truncateText(t,e){return!t||t.length<=e?t:t.substring(0,e-3)+"..."}attachDotInteractionHandlers(t,e,n){const a=this,i=window.innerWidth<=768;if(!i){let i=null,o=!1;t.addEventListener("mouseenter",(s=>{i&&clearTimeout(i),i=setTimeout((()=>{o||(a.transformDotToCard(t,e,n),o=!0)}),600)})),t.addEventListener("mouseleave",(e=>{i&&(clearTimeout(i),i=null),o&&(a.transformCardToDot(t),o=!1)})),t.addEventListener("click",(async e=>{if(!o){const e=t.itemData,n=e.entityType;if(!this.currentApp.entityConfigs[n].childrenField)return console.log("Leaf node clicked - no navigation:",n),void(e.convid&&"string"==typeof e.convid&&e.convid.trim()&&(console.log("[Dot Click] Opening chat with convid:",e.convid),this.openChatView(e.convid,n,e)));this.navigateTo(e,n)}}))}if(i){let i=null,o=!1,s=0,r=0;t.addEventListener("touchstart",(l=>{l.preventDefault(),o=!1;const c=l.touches[0];s=c.clientX,r=c.clientY,i=setTimeout((()=>{o=!0,a.transformDotToCard(t,e,n)}),600)})),t.addEventListener("touchmove",(t=>{const e=t.touches[0],n=Math.abs(e.clientX-s),a=Math.abs(e.clientY-r);(n>10||a>10)&&clearTimeout(i)})),t.addEventListener("touchend",(s=>{if(clearTimeout(i),!o)if(e.convid&&"string"==typeof e.convid&&e.convid.trim())console.log("[Mobile Tap] Opening chat with convid:",e.convid),a.openChatView(e.convid,n,e);else{const i=a.currentApp.entityConfigs[n];i&&i.childrenField?a.navigateTo(e,n):a.transformDotToCard(t,e,n)}})),t.addEventListener("touchcancel",(()=>{clearTimeout(i)}))}}openChatView(t,e,n){console.log("Opening chat view for",e,"with convid:",t);let a=document.getElementById("chat-container");a||(a=document.createElement("div"),a.id="chat-container",document.body.appendChild(a));const i=window.innerWidth<=768;if(i)Object.assign(a.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0, 0, 0, 0.3)",backdropFilter:"blur(2px)",zIndex:"1000",display:"flex",alignItems:"center",justifyContent:"center"}),this.loadChatInterface(t,e,n,i),setTimeout((()=>a.classList.add("loaded")),10);else{Object.assign(a.style,{position:"fixed",top:"0",right:"0",width:"400px",height:"100%",background:"white",zIndex:"1001",boxShadow:"-4px 0 20px rgba(0, 0, 0, 0.15)",display:"flex",flexDirection:"column",transform:"translateX(400px)",opacity:"0",transition:"transform 0.3s ease, opacity 0.3s ease"});const o=document.getElementById("canvas-area");o&&o.classList.add("chat-open"),this.loadChatInterface(t,e,n,i),setTimeout((()=>{a.style.transform="translateX(0)",a.style.opacity="1"}),10)}}closeChatView(){const t=document.getElementById("chat-container");t&&(t.style.transform="translateX(400px)",t.style.opacity="0",setTimeout((()=>{t.remove();const e=document.getElementById("canvas-area");e&&e.classList.remove("chat-open")}),300))}loadChatInterface(t,e,n,a){const i=document.getElementById("chat-container");if(a){let t=`\n\t            <div id="chat-content" style="\n\t                background: white;\n\t                border-radius: 16px;\n\t                width: 95%;\n\t                max-width: 500px;\n\t                max-height: 90vh;\n\t                display: flex;\n\t                flex-direction: column;\n\t                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\n\t            ">\n\t                <div style="padding: 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">\n\t                    <h3 style="margin: 0; font-size: 18px;">Chat: ${n.name||n.orgname||e}</h3>\n\t                    <button id="close-chat" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">\n\t                        ‚úï\n\t                    </button>\n\t                </div>\n\t                <div id="chat-messages" style="padding: 16px; flex: 1; overflow-y: auto; min-height: 300px;">\n\t                    \x3c!-- Chat messages will load here --\x3e\n\t                </div>\n\t                <div style="padding: 16px; border-top: 1px solid #eee;">\n\t                    <div style="display: flex; gap: 8px;">\n\t                        <input type="text" id="chat-input" placeholder="Type a message..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">\n\t                        <button id="send-chat" style="background: #667eea; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">\n\t                            Send\n\t                        </button>\n\t                    </div>\n\t                </div>\n\t            </div>\n\t        `;i.innerHTML=t}else{let t=`\n\t            <div style="padding: 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">\n\t                <h3 style="margin: 0;">Chat: ${n.name||n.orgname||e}</h3>\n\t                <button id="close-chat" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">\n\t                    ‚úï\n\t                </button>\n\t            </div>\n\t            <div id="chat-messages" style="padding: 16px; flex: 1; overflow-y: auto;">\n\t                \x3c!-- Chat messages will load here --\x3e\n\t            </div>\n\t            <div style="padding: 16px; border-top: 1px solid #eee;">\n\t                <input type="text" id="chat-input" placeholder="Type a message..." style="width: 100%; padding: 8px; margin-right: 8px; margin-bottom: 8px;">\n\t                <button id="send-chat" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%;">\n\t                    Send\n\t                </button>\n\t            </div>\n\t        `;i.innerHTML=t}this.loadChatMessages(t),document.getElementById("close-chat").addEventListener("click",(()=>{this.closeChatView()})),document.getElementById("send-chat").addEventListener("click",(()=>{this.sendChatMessage(t)}));const o=document.getElementById("chat-input");o.addEventListener("keypress",(e=>{"Enter"===e.key&&this.sendChatMessage(t)})),setTimeout((()=>{o.focus()}),100)}async loadChatMessages(t){const e=document.getElementById("chat-messages");if(e)try{const n=await fetch(`/newauth/api/appschat/${t}/messages`),a=await n.json();let i="";a.forEach((t=>{i+=`<div style="margin-bottom: 12px;">\n\t                <strong>${t.author}:</strong> ${t.message}\n\t            </div>`})),e.innerHTML=i}catch(t){console.error("Failed to load chat messages:",t),e.innerHTML="<div>No messages yet.</div>"}}_getChatAuthorName(){if(this.currentPath.length<2)return console.warn("[Chat] Path too short for author:",this.currentPath),this.currentApp?.name||"Unknown";let t="unknown";return t=this.isDataOwner()?this.currentPath[this.currentPath.length-2]:this.currentPath[this.currentPath.length-1],t.shortName||t.displayname||t.displayID||t.name||this.getEntityDisplayName(t.entityType)||"Unknown"}async sendChatMessage(t){const e=document.getElementById("chat-input"),n=e.value.trim();if(!n)return;const a=this._getChatAuthorName();let i=this.currentPath.map((t=>t.displayID)).filter(Boolean);i=i.length?`apps/${this.currentApp.id}/${i.join("/")}`:`apps/${this.currentApp.id}`,console.log("message:"+n+" author "+a+" topicName "+i);try{await fetch(`/newauth/api/appschat/${t}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n,author:a,topicname:i})}),e.value="",this.loadChatMessages(t)}catch(t){console.error("Failed to send message:",t),alert("Failed to send message")}}transformDotToCard(t,e,n){console.log("=== transformDotToCard called - VERSION 2.0 ==="),console.log("Window inner width:",window.innerWidth);const a=this;if(t._isTransforming||t.classList.contains("transformed-card"))return void console.log("Already transforming or transformed, exiting");t._isTransforming=!0;const i=window.innerWidth<=768;if(console.log("Is mobile?",i),t.dataset.originalContent||(t.dataset.originalContent=t.innerHTML,t.dataset.originalBgColor=t.style.backgroundColor||"",t.dataset.originalBorder=t.style.border||"",t.dataset.originalWidth=t.style.width||"20px",t.dataset.originalHeight=t.style.height||"20px"),!t.originalState){const e=window.getComputedStyle(t);t.originalState={width:e.width,height:e.height,backgroundColor:e.backgroundColor,borderRadius:e.borderRadius,cursor:e.cursor,display:e.display,alignItems:e.alignItems,justifyContent:e.justifyContent,fontSize:e.fontSize,fontWeight:e.fontWeight,color:e.color,textAlign:e.textAlign,overflow:e.overflow,textOverflow:e.textOverflow,whiteSpace:e.whiteSpace}}if(!t.originalPosition){const e=t.getBoundingClientRect(),n=document.getElementById("canvas-area");if(!n)return void console.error("Canvas not found");const a=n.getBoundingClientRect();t.originalPosition={left:e.left-a.left+n.scrollLeft,top:e.top-a.top+n.scrollTop,centerX:e.left+e.width/2,centerY:e.top+e.height/2}}const o=window.innerWidth,s=window.innerHeight,r=t.originalPosition.centerX,l=t.originalPosition.centerY,c=i?Math.min(300,o-40):280;let d,p,h;if(i){const e=r>o/2,n=l>s/2;e&&n?(d=Math.max(20,t.originalPosition.left-c+20),p=t.originalPosition.top,h="bottom right"):e&&!n?(d=Math.max(20,t.originalPosition.left-c+20),p=t.originalPosition.top,h="top right"):!e&&n?(d=Math.min(o-c-20,t.originalPosition.left),p=t.originalPosition.top,h="bottom left"):(d=Math.min(o-c-20,t.originalPosition.left),p=t.originalPosition.top,h="top left"),console.log("Mobile card positioning:",{viewportWidth:o,viewportHeight:s,cardWidth:c,dotCenterX:r,dotCenterY:l,isRightSide:e,isBottomSide:n,cardLeft:d,cardTop:p,transformOrigin:h})}else{const e=r>o/2,n=l>s/2;e&&n?(d=t.originalPosition.left-c+20,p=t.originalPosition.top,h="bottom right"):e&&!n?(d=t.originalPosition.left-c+20,p=t.originalPosition.top,h="top right"):!e&&n?(d=t.originalPosition.left,p=t.originalPosition.top,h="bottom left"):(d=t.originalPosition.left,p=t.originalPosition.top,h="top left")}const u=i?this.createMobileDotCardContent(e,n):this.createDotCardContent(e,n);t.innerHTML=u,t.classList.add("transformed-card");const m=t.querySelector(".expand-image-btn");if(m&&e.image){const n=n=>{console.log(`[EXPAND] üéØ EVENT: ${n.type} | target: ${n.target.className} | timestamp: ${Date.now()}`),console.log(`[EXPAND] Before stopPropagation - eventPhase: ${n.eventPhase}`),n.stopPropagation(),n.preventDefault(),t._preventCardClose=!0,console.log(`[EXPAND] ‚úÖ SET _preventCardClose = true | dot id: ${t.id||"no-id"}`),setTimeout((()=>{console.log("[EXPAND] üîÅ RESET _preventCardClose to false"),t._preventCardClose=!1}),500),this.showImageOverlay(e.image)};["click","touchstart","mousedown"].forEach((t=>{m.addEventListener(t,n,{passive:!1})}));const a=t.querySelector(".entity-image-container");if(a){const n=n=>{n.target.closest(".expand-image-btn")||(console.log(`[IMAGE] üñºÔ∏è EVENT: ${n.type} | target: ${n.target.tagName} | timestamp: ${Date.now()}`),n.stopPropagation(),n.preventDefault(),t._preventCardClose=!0,console.log("[IMAGE] ‚úÖ SET _preventCardClose = true"),setTimeout((()=>t._preventCardClose=!1),500),this.showImageOverlay(e.image))};["click","touchstart","mousedown"].forEach((t=>{a.addEventListener(t,n,{passive:!1})}))}}Object.assign(t.style,{position:"absolute",left:`${d}px`,top:`${p}px`,width:`${c}px`,maxWidth:i?"calc(100vw - 40px)":"none",height:"auto",maxHeight:"none",minWidth:"unset",padding:i?"14px":"16px",backgroundColor:"white",border:"none",borderRadius:i?"10px":"12px",boxShadow:i?"0 4px 20px rgba(0,0,0,0.25)":"0 8px 24px rgba(0,0,0,0.2)",zIndex:"1001",cursor:"default",fontSize:i?"13px":"14px",color:"#333",fontWeight:"normal",textAlign:"left",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",transform:"scale(1)",transformOrigin:h,overflow:"visible",display:"block",alignItems:"unset",justifyContent:"unset",whiteSpace:"normal",opacity:"1",pointerEvents:"auto"}),setTimeout((()=>{t._isTransforming=!1}),100);if(l>s/2&&setTimeout((()=>{const e=t.getBoundingClientRect().height,n=t.originalPosition.top-e+20;t.style.top=`${Math.max(10,n)}px`}),10),i){const e=n=>{const i=Date.now();if(console.log(`\n[CLOSE] üì± MOBILE EVENT: ${n.type} | target: ${n.target.tagName}.${n.target.className} | time: ${i}`),!n.target.closest("#image-overlay")&&"image-overlay"!==n.target.id)return t._preventCardClose?(console.log("[CLOSE] üõë FLAG SET - ABORTING CLOSE (resetting flag)"),void(t._preventCardClose=!1)):void(n.target.closest(".expand-image-btn")||n.target.closest(".entity-image-container")?console.log("[CLOSE] üõë TARGET IS EXPAND ELEMENT - ABORTING CLOSE"):t.contains(n.target)?console.log("[CLOSE] ‚ÑπÔ∏è TARGET INSIDE CARD - NOT CLOSING"):(console.log("[CLOSE] ‚úÖ TARGET OUTSIDE CARD - CLOSING CARD"),a.transformCardToDot(t),document.removeEventListener("touchstart",e),document.removeEventListener("click",e)));console.log("[CLOSE] üõë CLICK ON IMAGE OVERLAY - IGNORING")};setTimeout((()=>{document.addEventListener("touchstart",e,{passive:!0}),document.addEventListener("click",e,{passive:!0}),t._closeHandler=e,console.log("[INIT] üì≤ Mobile close handlers attached")}),100)}else{let e;const n=n=>{console.log(`[MOUSE] üñ±Ô∏è mouseleave event | flag: ${t._preventCardClose}`),t._preventCardClose?console.log("[MOUSE] üõë FLAG SET - IGNORING mouseleave"):(e&&clearTimeout(e),e=setTimeout((()=>{const e=t.getBoundingClientRect(),i=n.clientX,o=n.clientY,s=i<e.left||i>e.right||o<e.top||o>e.bottom;console.log(`[MOUSE] Checking position: (${i},${o}) | Card: ${e.left},${e.top},${e.right},${e.bottom} | Outside: ${s}`),s&&(console.log("[MOUSE] ‚úÖ MOUSE OUTSIDE CARD - CLOSING"),a.transformCardToDot(t))}),50))};t.addEventListener("mouseleave",n),t._mouseLeaveHandler=n,console.log("[INIT] üíª Desktop mouse handlers attached")}const g=t.querySelector(".dot-action-btn.edit"),y=t.querySelector(".dot-action-btn.copy"),f=t.querySelector(".dot-action-btn.delete");if(g){const a=a=>{a.stopPropagation(),a.preventDefault(),this.editItem(e,n),this.transformCardToDot(t)};g.addEventListener("click",a),i&&g.addEventListener("touchend",a)}if(y){const a=a=>{a.stopPropagation(),a.preventDefault(),this.duplicateItem(e,n),this.transformCardToDot(t)};y.addEventListener("click",a),i&&y.addEventListener("touchend",a)}if(f){const a=a=>{a.stopPropagation(),a.preventDefault(),confirm(`Are you sure you want to delete this ${n}?`)&&this.deleteItem(e,n),this.transformCardToDot(t)};f.addEventListener("click",a),i&&f.addEventListener("touchend",a)}}transformCardToDot(t){if(!t.originalPosition||!t.originalState)return void console.warn("Missing original state or position");t._isTransforming=!1;window.innerWidth;t._mouseLeaveHandler&&(t.removeEventListener("mouseleave",t._mouseLeaveHandler),delete t._mouseLeaveHandler),t._closeHandler&&(document.removeEventListener("touchstart",t._closeHandler),document.removeEventListener("click",t._closeHandler),delete t._closeHandler);const e=t.itemData,n=t.entityType,a=(this.getItemLabel(e,n)||"Unnamed").substring(0,3).toLowerCase();t.classList.remove("transformed-card"),t.classList.remove("safe-mobile-position"),t.innerHTML=`\n\t        <span class="dot-label">\n\t            <span>${a[0]||""}</span>\n\t            <span>${a[1]||""}</span>\n\t            <span>${a[2]||""}</span>\n\t        </span>\n\t    `,Object.assign(t.style,{position:"absolute",left:`${t.originalPosition.left}px`,top:`${t.originalPosition.top}px`,width:t.originalState.width,height:t.originalState.height,padding:"0",backgroundColor:t.originalState.backgroundColor,border:"none",borderRadius:t.originalState.borderRadius,boxShadow:"0 2px 4px rgba(0,0,0,0.2)",zIndex:"1000",cursor:t.originalState.cursor,fontSize:t.originalState.fontSize,color:t.originalState.color,fontWeight:t.originalState.fontWeight,textAlign:t.originalState.textAlign,transition:"all 0.3s ease",transform:"scale(1)",transformOrigin:"center",overflow:t.originalState.overflow,display:t.originalState.display,alignItems:t.originalState.alignItems,justifyContent:t.originalState.justifyContent,whiteSpace:t.originalState.whiteSpace,minWidth:"unset",maxWidth:"unset",opacity:"1",pointerEvents:"auto"}),setTimeout((()=>{t.style.transition&&(t.style.transition="")}),300)}createDotCardContent(t,e){const n=t.image?`<div class="entity-image-container">\n\t\t        <img src="${t.image}" alt="${t.name||"Entity"}" class="entity-image-thumbnail">\n\t\t        <button class="expand-image-btn" title="View full size">\n\t\t            \x3c!-- Standard fullscreen icon (four arrows) --\x3e\n\t\t\t\t\t<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n\t\t\t\t\t    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>\n\t\t\t\t\t</svg>\n\t\t        </button>\n\t\t      </div>`:"",a=this.getEntityTypeColor(e),i=this.nativeEntities?.[e];let o="";(i?.fields||[]).forEach((e=>{if("system"===e.writePermission||["ID","displayID","dotLabel","timestamp","count","hidden","hashed","parentId","path","image"].includes(e.name))return;const n=t[e.name];if(null==n||""===n)return;const a="name"===e.name||"title"===e.name,i="description"===e.name,s=a?"primary":i?"description":"";let r=String(n);"boolean"===e.type?r=n?"‚úì Yes":"‚úó No":"number"===e.type&&(r=Number(n).toLocaleString()),o+=`\n\t            <div class="field-value ${s}" title="${e.label||e.name}">\n\t                ${r}\n\t            </div>\n\t        `}));let s="";const r=this.currentApp.entityConfigs[e];if(r?.childrenField&&t[r.childrenField]){const n=t[r.childrenField].length;s=`\n\t            <div class="dot-info-child-count">\n\t                <span class="child-count-icon">üîó</span>\n\t                <span>${n} ${this.currentApp.hierarchy[this.currentApp.hierarchy.indexOf(e)+1]||"item"}${1!==n?"s":""}</span>\n\t            </div>\n\t        `}return`\n\t        <div class="dot-info-card">\n\t            <div class="dot-info-header">\n\t                <span class="entity-type-badge" \n\t                      style="background: ${a.bg}; color: ${a.color};">\n\t                    ${a.label}\n\t                </span>\n\t                \n\t        <div class="dot-info-actions">\n\t            <button class="dot-action-btn edit" title="Edit">\n\t                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t                    <path d="M12 20h9v-9l-9 9-9 9v-9"/>\n\t                    <path d="M12 20v-9l-9 9"/>\n\t                </svg>\n\t            </button>\n\t            <button class="dot-action-btn copy" title="Duplicate">\n\t                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t                    <rect x="9" y="9" width="13" height="13" rx="2"/>\n\t                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>\n\t                </svg>\n\t            </button>\n\t            <button class="dot-action-btn delete" title="Delete">\n\t                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n\t                </svg>\n\t            </button>\n\t        </div>\n\t    \n\t            </div>\n\t\t\t\t${n}\n\t            <div class="dot-info-fields">\n\t                ${o}\n\t            </div>\n\t            \n\t            ${s}\n\t        </div>\n\t    `}createMobileDotCardContent(t,e){const n=t.image?`<div class="entity-image-container">\n\t\t        <img src="${t.image}" alt="${t.name||"Entity"}" class="entity-image-thumbnail">\n\t\t        <button class="expand-image-btn" title="View full size">\n\t\t            \x3c!-- Standard fullscreen icon (four arrows) --\x3e\n\t\t\t\t\t<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n\t\t\t\t\t    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>\n\t\t\t\t\t</svg>\n\t\t        </button>\n\t\t      </div>`:"",a=this.getEntityTypeColor(e),i=this.nativeEntities?.[e];let o="";(i?.fields||[]).forEach((e=>{if("system"===e.writePermission||["ID","displayID","dotLabel","timestamp","count","hidden","hashed","parentId","path","image"].includes(e.name))return;const n=t[e.name];if(null==n||""===n)return;const a="name"===e.name||"title"===e.name,i="description"===e.name,s=a?"primary":i?"description":"";let r=String(n);"boolean"===e.type?r=n?"‚úì Yes":"‚úó No":"number"===e.type&&(r=Number(n).toLocaleString()),o+=`\n\t            <div class="field-value ${s}" title="${e.label||e.name}">\n\t                ${r}\n\t            </div>\n\t        `}));let s="";const r=this.currentApp.entityConfigs[e];if(r?.childrenField&&t[r.childrenField]){const n=t[r.childrenField].length;s=`\n\t            <div class="dot-info-child-count">\n\t                <span class="child-count-icon">üîó</span>\n\t                <span>${n} ${this.currentApp.hierarchy[this.currentApp.hierarchy.indexOf(e)+1]||"item"}${1!==n?"s":""}</span>\n\t            </div>\n\t        `}return`\n\t        <div class="dot-info-card mobile-card">\n\t            <div class="dot-info-header">\n\t                <span class="entity-type-badge" \n\t                      style="background: ${a.bg}; color: ${a.color};">\n\t                    ${a.label}\n\t                </span>\n\t                \n\t        <div class="dot-info-actions mobile-actions">\n\t            <button class="dot-action-btn edit" title="Edit">\n\t                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t                    <path d="M12 20h9v-9l-9 9-9 9v-9"/>\n\t                    <path d="M12 20v-9l-9 9"/>\n\t                </svg>\n\t            </button>\n\t            <button class="dot-action-btn copy" title="Duplicate">\n\t                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t                    <rect x="9" y="9" width="13" height="13" rx="2"/>\n\t                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>\n\t                </svg>\n\t            </button>\n\t            <button class="dot-action-btn delete" title="Delete">\n\t                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n\t                </svg>\n\t            </button>\n\t        </div>\n\t    \n\t            </div>\n\t\t\t\t${n}\n\t            <div class="dot-info-fields">\n\t                ${o}\n\t            </div>\n\t            \n\t            ${s}\n\t        </div>\n\t    `}showImageOverlay(t){const e=document.getElementById("image-overlay");e&&e.remove();const n=document.createElement("div");n.id="image-overlay",Object.assign(n.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0, 0, 0, 0.92)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"2000",opacity:"0",transition:"opacity 0.3s ease",cursor:"pointer",outline:"none",tabIndex:"0"});const a=document.createElement("div");Object.assign(a.style,{position:"relative",maxWidth:"95%",maxHeight:"95%"});const i=document.createElement("button");i.innerHTML="&times;",Object.assign(i.style,{position:"absolute",top:"15px",right:"15px",background:"rgba(0, 0, 0, 0.5)",border:"none",color:"white",width:"36px",height:"36px",borderRadius:"50%",fontSize:"24px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"10",transition:"all 0.2s",border:"2px solid rgba(255, 255, 255, 0.3)",WebkitTapHighlightColor:"transparent"}),i.addEventListener("mouseenter",(()=>{i.style.background="rgba(255, 255, 255, 0.2)",i.style.transform="scale(1.1)"})),i.addEventListener("mouseleave",(()=>{i.style.background="rgba(0, 0, 0, 0.5)",i.style.transform="scale(1)"}));const o=document.createElement("img");o.src=t,Object.assign(o.style,{maxWidth:"90%",maxHeight:"90%",objectFit:"contain",borderRadius:"8px",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.6)",cursor:"default",transition:"transform 0.3s",userSelect:"none"}),o.addEventListener("dragstart",(t=>t.preventDefault())),a.appendChild(i),a.appendChild(o),n.appendChild(a),document.body.appendChild(n),n.focus(),setTimeout((()=>{n.style.opacity="1"}),10);const s=()=>{n.style.opacity="0",setTimeout((()=>{n.parentNode&&n.remove()}),300)};i.addEventListener("click",(t=>{t.stopPropagation(),s()})),n.addEventListener("click",(t=>{t.target===n&&s()})),n.addEventListener("keydown",(t=>{"Escape"!==t.key&&" "!==t.key||(t.preventDefault(),s())})),o.addEventListener("click",(t=>t.stopPropagation())),document.body.style.overflow="hidden";const r=document.body.style.overflow,l=()=>{document.body.style.overflow=r,n.removeEventListener("transitionend",l)};n.addEventListener("transitionend",l)}resizeImage(t,e=800,n=600){return new Promise(((a,i)=>{const o=new FileReader;o.onload=t=>{const o=new Image;o.onload=()=>{let t=o.width,i=o.height;t>i?t>e&&(i=Math.round(i*e/t),t=e):i>n&&(t=Math.round(t*n/i),i=n);const s=document.createElement("canvas");s.width=t,s.height=i;s.getContext("2d").drawImage(o,0,0,t,i);const r=s.toDataURL("image/jpeg",.85);a(r)},o.onerror=i,o.src=t.target.result},o.onerror=i,o.readAsDataURL(t)}))}getEntityTypeColor(t){const e=t.split("").reduce(((t,e)=>t+e.charCodeAt(0)),0),n=e%360,a=60+e%20,i=92+e%5;return{bg:`hsl(${n}, ${a}%, ${i}%)`,color:`hsl(${(n+180)%360}, 70%, 30%)`,accent:`hsl(${n}, ${a+10}%, ${i-30}%)`,label:t.toUpperCase()}}getEntityFields(t){const e=this.currentApp.entityConfigs[t];if(e&&e.fields)return e.fields.filter((t=>"system"!==t.type&&"children"!==t.name)).map((t=>t.name));switch(t){case"tenant":case"customer":return["name","contactemail"];case"concern":return["name","description"];default:return[]}}getChildCountInfo(t,e){const n=this.currentApp.hierarchy,a=n.indexOf(e);if(-1===a||a>=n.length-1)return null;const i=n[a+1],o=this.currentApp.entityConfigs[e],s=o?.childrenField||"children";if(t[s]&&Array.isArray(t[s])){const e=t[s].length,n=i.charAt(0).toUpperCase()+i.slice(1);return`${e} ${1===e?n:`${n}s`}`}if(void 0!==t.count){const e=parseInt(t.count)||0,n=i.charAt(0).toUpperCase()+i.slice(1);return`${e} ${1===e?n:`${n}s`}`}return null}addCardActionHandlers(t,e,n){const a=this,i=t.querySelector(".dot-action-btn.edit"),o=t.querySelector(".dot-action-btn.copy"),s=t.querySelector(".dot-action-btn.delete");i&&i.addEventListener("click",(t=>{t.stopPropagation(),a.hideMobileDotCard(),a.editItem(e,n)})),o&&o.addEventListener("click",(t=>{t.stopPropagation(),a.hideMobileDotCard(),a.duplicateItem(e,n)})),s&&s.addEventListener("click",(t=>{t.stopPropagation(),confirm(`Are you sure you want to delete this ${n}?`)&&(a.hideMobileDotCard(),a.deleteItem(e,n))}))}hideMobileDotCard(){this.currentMobileCard&&(this.currentMobileCard.style.animation="slideDown 0.3s ease",setTimeout((()=>{this.currentMobileCard&&(this.currentMobileCard.remove(),this.currentMobileCard=null)}),300)),this.currentMobileCardOverlay&&(this.currentMobileCardOverlay.style.animation="fadeOut 0.3s ease",setTimeout((()=>{this.currentMobileCardOverlay&&(this.currentMobileCardOverlay.remove(),this.currentMobileCardOverlay=null)}),300)),this.isShowingMobileCard=!1}deleteItem(t,e){confirm(`Are you sure you want to delete this ${e}?`)&&this.hideDotInfoCard()}duplicateItem(t,e){if(!this.canAddItemsAtCurrentLevel())return void alert("You do not have permission to create items here.");const n={...t};delete n.ID,delete n.displayID,delete n.hashed,delete n.timestamp,delete n.count,delete n.childrenRef,delete n.parentId,delete n.path,n.timestamp=Date.now(),n.dotLabel=this.generateUniqueDotLabel(n.name,e),n.name=`${n.name} (copy)`,this.addItem(e,n).then((()=>{this.hideDotInfoCard(),console.log(`${e} duplicated successfully`)})).catch((t=>{console.error("Failed to duplicate item:",t),alert("Failed to duplicate item. Please try again.")}))}canAddItemsAtCurrentLevel(){const t=this.currentPath.length;if(this.isDataOwner())return!0;if(0===t)return!1;const e=this.getParentEntity();if(!e)return!1;switch(e.writeAccess||"owner"){case"any":return!0;case"parent":return this.hasAccessToEntity(e);case"ancestor":return this.hasAncestorAccess();default:return!1}}getParentEntity(){if(0===this.currentPath.length)return null;const t=this.currentPath.length-1;return this.getEntityAtDepth(t)}navigateTo(t,e){this.stopVersionPolling();const n=this.currentPath.length+1,a=[...this.currentPath,{id:t.ID,displayID:t.displayID,hashed:t.hashed,shortName:this.getShortName(t,e),entityType:e}];console.log("After navigation - newPath:",a),this.currentPath=a,this._updateShareButtonVisibility(),this.render(),this.updateBreadcrumb(),this.updateWatermark();const i={depth:n,path:a.map((t=>({id:t.id,entityType:t.entityType})))};if(n<=2){const t=this.getAppUrl(this.currentPath);window.history.pushState(i,"",t)}else{const t=window.location.pathname+window.location.search;window.history.pushState(i,"",t)}console.log("After navigation - currentPath:",this.currentPath),console.log("After navigation - data.items:",this.data.items)}updateUrl(){const t="/t/apps/",e=this.currentApp?.id||"custsupport";if(0===this.currentPath.length)window.history.pushState({},"",`${t}${e}`);else{const n=this.currentPath.map((t=>t.displayID)).join("/");window.history.pushState({},"",`${t}${e}/${n}`)}}updateBreadcrumb(){if(!this.currentApp)return void(this.breadcrumb.innerHTML='<span style="color: #666;">Apps</span>');this.getViewingContext();const t=window.innerWidth<=768;console.log("updateBreadcrumb - currentPath length:",this.currentPath.length),console.log("Breadcrumb currentPath:",this.currentPath.map((t=>({id:t.id,displayID:t.displayID,shortName:t.shortName,entityType:t.entityType}))));const e=(t,e)=>!t||t.length<=e?t:t.substring(0,e-3)+"...";let n='<a href="#" data-index="0">Home</a>';if(this.currentApp){const t=e(this.currentApp.name,15);isowner?n+=` / <a href="#" data-index="1" title="${this.currentApp.name}">${t}</a>`:n+=` / <span title="${this.currentApp.name}">${t}</span>`}console.log("Current path data for breadcrumb:"),this.currentPath.forEach(((t,e)=>{console.log(`  Path[${e}]:`,{shortName:t.shortName,displayID:t.displayID,id:t.id,entityType:t.entityType})}));const a=this.isDataOwner();this.currentPath.forEach(((i,o)=>{const s=i.displayID||this.db.hashUUID(i.id),r=i.shortName||s;let l=!0;l=!!a||!(this.currentPath.length<=1)&&(o>0&&o<=this.currentPath.length-1),n+=" / "+((n,a,i,o)=>{const s=t?4:8,r=e(n,t?6:10),l=e(a,s);if(t)return`\n\t                <${i?"a":"span"} \n\t                    ${i?`href="#" data-index="${o}"`:""}\n\t                    title="${n} (${a})"\n\t                    style="display:inline-flex;align-items:center;max-width:70px;${i?"color:#667eea;text-decoration:none;":"color:#999;cursor:not-allowed;"}font-size:11px;white-space:nowrap;">\n\t                    <span style="font-weight:500;overflow:hidden;text-overflow:ellipsis;">${r}</span>\n\t                    <span style="font-size:9px;color:${i?"#999":"#bbb"};margin-left:2px;overflow:hidden;text-overflow:ellipsis;">${l}</span>\n\t                </${i?"a":"span"}>\n\t            `;{const t=`${r} (${l})`;return i?`<a href="#" data-index="${o}" title="${n} (${a})">${t}</a>`:`<span style="color:#999;cursor:not-allowed;" title="${n} (${a})">${t}</span>`}})(r,s,l,o+2)}));const i=document.getElementById("breadcrumb");i.innerHTML=n,t&&(Object.assign(i.style,{padding:"6px 10px",fontSize:"10px",gap:"1px",maxWidth:"calc(100vw - 20px)",overflowX:"auto",whiteSpace:"nowrap",display:"flex",alignItems:"center",lineHeight:"1"}),i.querySelectorAll("a, span").forEach((t=>{Object.assign(t.style,{display:"inline-flex",alignItems:"center",whiteSpace:"nowrap"})}))),i.querySelectorAll("a").forEach((t=>{t.addEventListener("click",(async t=>{t.preventDefault();const e=parseInt(t.currentTarget.dataset.index,10);this.isDataOwner(),this.currentPath.length;if(0!==e){if(1===e&&isowner&&0===this.currentPath.length)return this.currentPath=[],this.updateUrl(),this.render(),this.updateBreadcrumb(),void this.updateWatermark();if(e>=2){const t=e-1;if(t>=this.currentApp.hierarchy.length)return void console.log("Cannot navigate beyond hierarchy depth");if(t>0&&t<=this.currentPath.length){this.currentPath=this.currentPath.slice(0,t);const e={depth:t,path:this.currentPath.map((t=>({id:t.id,entityType:t.entityType,displayID:t.displayID,hashed:t.hashed})))};if(t<=2){const t=this.getAppUrl(this.currentPath);window.history.pushState(e,"",t)}else{const t=window.location.pathname+window.location.search;window.history.pushState(e,"",t)}this.render(),this.updateBreadcrumb(),this.updateWatermark()}}}else{if(!this.currentApp)return void console.log("[Breadcrumb] Already at root");if(isowner)return console.log("[Breadcrumb] App owner clicked Home ‚Üí Navigating to /t/apps"),void(window.location.href="/t/apps");const t=this.parseUrlForDataFetch(),e=this.getLastViewedContext(t?.appId),n=e?.[0];if(n&&n.path?.length>0){this.currentPath=[];for(let t=0;t<n.path.length;t++){const e=n.path[t];let a=e;a.includes("-")&&(a=this.db.hashUUID(e));const i=this.currentApp.hierarchy[t];this.currentPath.push({id:e,displayID:a,shortName:this.getShortName({ID:e,displayID:a},i)||e.substring(0,8),entityType:i})}this.updateUrl();const t=this.currentPath.map((t=>t.displayID));this.db.getAppData(this.currentApp.id,t).then((t=>{this.data=t,console.log("[Breadcrumb] Tenant owner - loaded data for tenant:",n.path[0]),this.render(),this.updateBreadcrumb(),this.updateWatermark()})).catch((t=>{console.error("[Breadcrumb] Error fetching tenant data:",t),this.render(),this.updateBreadcrumb(),this.updateWatermark()}))}else this.currentPath=[],this.updateUrl(),await this.loadAppSelector(),this.data={items:[]},this.render(),this.updateBreadcrumb(),this.updateWatermark()}}))}))}getDisplayIdForItem(t,e){this.data.items;for(let n=0;n<this.currentPath.length;n++){const a=this.currentPath[n];if(a.id===t&&a.entityType===e)return a.displayID||t}return t}isItemHashed(t,e){return!1}openAddDialogForTenant(){this.currentPath=[],this.openAddDialog()}async openAddDialog(){var t=this;const e=this.getNextEntityType();if(!e)return void alert("Maximum nesting level reached");const n=await this.getEntityConfig(e);if(!n)return void alert("Entity schema not found");const a=document.getElementById("add-modal"),i=document.getElementById("modal-title"),o=document.getElementById("add-form");i.textContent="Add "+n.name,o.innerHTML="",n.fields.forEach((function(e){if("system"===e.writePermission)return;if("image"===e.name){const n=document.createElement("div");n.className="form-group image-upload-group";const a=document.createElement("input");a.type="hidden",a.name="image",n.appendChild(a);const i=document.createElement("label");i.textContent=e.label+(e.mandatory?" *":""),n.appendChild(i);const s=document.createElement("div");s.className="image-control-row";const r=document.createElement("input");r.type="url",r.className="form-control image-url-input",r.placeholder="Paste image URL or click üìÅ to upload",r.style.flex="1",r.style.minWidth="0";const l=document.createElement("button");l.type="button",l.className="btn btn-secondary image-upload-btn",l.innerHTML="üìÅ",l.title="Upload image file",l.style.padding="0 10px",l.style.minWidth="36px";const c=document.createElement("button");c.type="button",c.className="btn btn-danger image-remove-btn",c.innerHTML="&times;",c.title="Remove image",c.style.padding="0 8px",c.style.minWidth="28px",c.style.display="none",s.appendChild(r),s.appendChild(l),s.appendChild(c);const d=document.createElement("div");d.className="image-preview",d.style.marginTop="8px",d.style.display="none";const p=document.createElement("img");return p.style.maxWidth="100%",p.style.maxHeight="100px",p.style.borderRadius="4px",p.style.border="1px solid #ddd",d.appendChild(p),l.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",window.innerWidth<=768&&e.setAttribute("capture","environment"),e.onchange=async e=>{const n=e.target.files[0];if(n)try{const e=await t.resizeImage(n,800,600);a.value=e,r.value="",p.src=e,d.style.display="block",c.style.display="inline-flex"}catch(t){console.error("Image resize failed:",t),alert("Failed to process image. Please try again.")}},e.click()})),r.addEventListener("input",(t=>{const e=t.target.value.trim();e&&(e.startsWith("http://")||e.startsWith("https://"))?(a.value=e,p.src=e,d.style.display="block",c.style.display="inline-flex"):e||(a.value="",d.style.display="none",c.style.display="none")})),c.addEventListener("click",(t=>{t.preventDefault(),a.value="",r.value="",d.style.display="none",c.style.display="none",p.src=""})),n.appendChild(s),n.appendChild(d),void o.appendChild(n)}const n=t.getViewingContext(),a=t.canEditField(e,n),i=document.createElement("div");i.className="form-group";const s=document.createElement("label");if(s.textContent=e.label+(e.mandatory?" *":""),"any"!==e.writePermission){const t=document.createElement("span");t.textContent=" üîí",t.title=`Write permission: ${e.writePermission}`,t.style.cursor="help",s.appendChild(t)}let r;if(i.appendChild(s),"ID"===e.name){r=document.createElement("input"),r.type="text",r.value="Auto-generated",r.disabled=!0,r.style.backgroundColor="#e8f4f8",r.style.border="1px solid #b3d9e8";const t=document.createElement("span");t.textContent=" üîí System Generated",t.style.color="#17a2b8",t.style.fontSize="12px",t.style.marginLeft="5px",s.appendChild(t),r.title="This ID will be automatically generated as a UUID"}else if("select"===e.type){if(r=document.createElement("select"),!e.mandatory){const t=document.createElement("option");t.value="",t.textContent="-- Select --",r.appendChild(t)}e.options&&Array.isArray(e.options)&&e.options.forEach((t=>{const e=document.createElement("option");e.value=t,e.textContent=t,r.appendChild(e)})),a||(r.disabled=!0,r.style.backgroundColor="#f5f5f5")}else if("textarea"===e.type)r=document.createElement("textarea"),a||(r.disabled=!0,r.style.backgroundColor="#f5f5f5");else{if("checkbox"===e.type){const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="8px",r=document.createElement("input"),r.type="checkbox",r.id="field-"+e.name;const n=document.createElement("label");return n.htmlFor="field-"+e.name,n.textContent=e.label,t.appendChild(r),t.appendChild(n),i.appendChild(t),a||(r.disabled=!0,n.style.color="#999"),void o.appendChild(i)}r=document.createElement("input"),r.type=e.type,a||(r.disabled=!0,r.style.backgroundColor="#f5f5f5")}"ID"!==e.name&&(r.name=e.name,r.required=e.mandatory&&a),"checkbox"!==e.type&&(i.appendChild(r),o.appendChild(i))}));const s=o.querySelector('input[name="name"]'),r=o.querySelector('input[name="dotLabel"]');if(s&&r){const t=document.createElement("button");t.type="button",t.textContent="‚Ü∫",t.title="Reset to auto-generated from name",t.className="dotlabel-reset-btn",t.style.cssText="margin-left: 5px; padding: 2px 6px; font-size: 12px; cursor: pointer; background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px;";const e=o.querySelector('.form-group input[name="dotLabel"]').parentElement;e.style.display="flex",e.style.alignItems="center",e.style.gap="5px",e.appendChild(t),s.addEventListener("input",(function(t){if(!r.dataset.userModified){let e=t.target.value.substring(0,3).toUpperCase();e.length<3&&(e=e.padEnd(3,"X")),r.value=e}})),r.addEventListener("focus",(function(){r.dataset.userModified="true"})),t.addEventListener("click",(function(t){t.preventDefault(),r.dataset.userModified="false";let e=s.value.substring(0,3).toUpperCase();e.length<3&&(e=e.padEnd(3,"X")),r.value=e}))}const l=document.createElement("div");l.style.marginTop="20px";const c=document.createElement("button");c.id="add-submit-btn",c.type="submit",c.className="btn btn-primary",c.textContent="Add "+n.name;const d=document.createElement("button");d.type="button",d.className="btn btn-secondary",d.textContent="Cancel",d.addEventListener("click",(function(){a.style.display="none"})),l.appendChild(c),l.appendChild(d),o.appendChild(l),o.onsubmit=async function(i){i.preventDefault(),c.disabled=!0,c.style.opacity="0.6",c.textContent="Saving...";try{await t.addItem(e,o),a.style.display="none",c.disabled=!1,c.style.opacity="1",c.textContent="Add "+n.name}catch(t){console.error("Error during add:",t),alert("Failed to add item: "+(t.message||"Unknown error")),c.disabled=!1,c.style.opacity="1",c.textContent="Add "+n.name}},a.style.display="block"}async addItem(t,e){console.log("=== ADD ITEM DEBUG ==="),console.log("isowner:",isowner),console.log("currentPath:",this.currentPath),console.log("currentApp:",this.currentApp?.id);const n=this.getViewingContext();console.log("getViewingContext result:",n);const a=0===this.currentPath.length,i=!this.isDataOwner()&&(n.isTenantView||n.isSubtenantView);if(console.log("isRootLevel:",a),console.log("isFilteredView:",i),console.log("======================="),!this.currentApp)throw new Error("App not initialized - cannot add items");const o=new FormData(e),s={timestamp:Date.now(),entityType:t};let r=null;const l=await this.getEntityConfig(t);if(!l)throw new Error(`Entity config not found for: ${t}`);if(l.fields.some((t=>"ID"===t.name))){const t=this.db.generateUUID();s.ID=t,s.displayID=this.db.hashUUID(t),s.timestamp=Date.now(),s.hidden=!1,s.hashed=!1,s.writeAccess="owner",s.readAccess="owner"}const c=this.getViewingContext();for(let[t,e]of o.entries())if("ID"!==t){const n=l.fields.find((e=>e.name===t));n&&this.canEditField(n,c)&&(s[t]=e)}e.querySelectorAll('input[type="checkbox"]').forEach((t=>{const e=l.fields.find((e=>e.name===t.name));e&&this.canEditField(e,c)&&(s[t.name]=t.checked)})),this.ensureBaseEntityFields(s,t,l);const d=this.getShortName(s,t);this.processItemID(s,t);const p=l.name||t,h=0===this.currentPath.length,u=this.isDataOwner(),m=!isowner&&!u;if(l.fields.some((t=>"convid"===t.name))){const e=this.db.generateUUID();s.convid=e;try{await fetch(`/newauth/api/createappschat?convid=${e}`,{headers:{"Content-Type":"application/json"}}),console.log("Chat created for",t,"with convid:",e)}catch(t){console.error("Failed to create chat:",t)}}if(h)this.data.items.push(s);else{const t=this.currentPath.length-1,e=this.currentApp.hierarchy[t],n=this.currentApp.entityConfigs[e].childrenField;if(!n)throw new Error(`No children field configured for ${e}`);const a=this.data?.items?.[0],i=this.currentPath[this.currentPath.length-1];if(a?.entityType===i.entityType&&a.displayID===i.displayID){const e=this.data.items[0],n=this.currentApp.hierarchy[t],a=this.currentApp.entityConfigs[n].childrenField;if(!a)throw new Error(`No children field configured for ${n}`);e[a]||(e[a]=[]),e[a].push(s),r=e}else{let a=this.data.items,i=0;for(;i<t&&a;){const t=this.currentApp.hierarchy[i],e=this.currentApp.entityConfigs[t].childrenField,n=this.currentPath[i],o=a.find((t=>t.ID===n.id||t.displayID===n.id));if(!o)throw new Error(`Could not find ${t} with ID ${n.id} in hierarchy`);a=o[e]||[],i++}const o=this.currentPath[t],l=a.find((t=>t.ID===o.id||t.displayID===o.id));if(!l)throw new Error(`Could not find parent ${e} with ID ${o.id}`);l[n]||(l[n]=[]),l[n].push(s),r=l}parent[n]||(parent[n]=[]),parent[n].push(s),r=parent}this.render(),this.updateBreadcrumb(),h||this.updateWatermark(),this.markDotAsPending(s.ID),document.getElementById("add-modal").style.display="none";try{let e=!1;if(h){try{const t=this.getAppUrl([{id:s.ID,asuuid:!0,hashed:s.hashed,displayID:s.displayID}]);await this.sendTenantWelcomeEmail(s,t),console.log("Welcome email sent to tenant:",s.contactemail)}catch(t){console.error("Failed to send tenant welcome email:",t)}await this.db.saveAppData(this.currentApp.id,this.data),isowner||(this.saveLastViewedContext(this.currentApp.id,[s.ID]),console.log("Saved last viewed context for new tenant:",s.ID)),this.confirmDot(s.ID);const n=document.querySelector(`.dot[data-id="${s.ID}"]`);n&&(console.log("dot expand animation"),await new Promise((t=>setTimeout(t,700))),n.style.transform="scale(1.5)",n.style.boxShadow="0 12px 35px rgba(102, 126, 234, 0.6)",n.style.transition="all 0.4s cubic-bezier(0.4, 0, 0.2, 1)",await new Promise((t=>setTimeout(t,500))),n.style.boxShadow="0 12px 35px rgba(102, 126, 234, 0.3)",await new Promise((t=>setTimeout(t,250))),n.style.boxShadow="0 12px 35px rgba(102, 126, 234, 0.6)",await new Promise((t=>setTimeout(t,150))),await new Promise((t=>setTimeout(t,200)))),this.currentPath=[{id:s.ID,displayID:s.displayID,shortName:s.name||s.orgname||"New "+p,hashed:s.hashed,entityType:t}];const a=this.getAppUrl(this.currentPath);window.history.pushState({},"",a);try{const t=this.currentPath[0].displayID,e=await this.db.getAppData(this.currentApp.id,[t]);this.data=e}catch(t){console.warn("Failed to fetch fresh tenant data, using optimistic data:",t)}return this.render(),this.updateBreadcrumb(),this.updateWatermark(),this.showNotification(`‚úÖ ${p} "${s.name||"New Tenant"}" created! Welcome email sent to ${s.contactemail}`,"success"),void(e=!0)}if(m){console.log("[addItem] Filtered view - constructing partial data structure");const e=[];for(let n=0;n<=this.currentPath.length;n++)n<this.currentPath.length?e.push({entityType:this.currentApp.hierarchy[n],id:this.currentPath[n].id}):e.push({entityType:t,item:s});let n=s;for(let t=e.length-2;t>=0;t--){const a=e[t],i=this.currentApp.entityConfigs[a.entityType].childrenField,o={};o.ID=a.id,o[i]=Array.isArray(n)?n:[n],n=o}const a={items:[n]},i={isPartial:!0,operation:"add",entityType:t,appId:this.currentApp.id,path:this.currentPath.map((t=>t.displayID))};c.tenantId&&(i.tenantId=c.tenantId),c.subtenantId&&(i.subtenantId=c.subtenantId),c.subtenantId?i.scope="subtenant":c.tenantId&&(i.scope="tenant"),await this.db.savePartialAppData(this.currentApp.id,a,i);if(1===this.currentPath.length&&s.contactemail)try{const t=[...this.currentPath,{id:s.ID,hashed:s.hashed,displayID:s.displayID,shortName:d}],e=this.getAppUrl(t),n=this.currentPath[0].name||"Organization";await this.sendSubtenantNotificationEmail(s,n,e),console.log("Notification email sent to customer:",s.contactemail)}catch(t){console.error("Failed to send customer notification email:",t)}}else{const e={path:this.currentPath.map((t=>t.displayID)),operation:"add",entityType:t,appId:this.currentApp.id,isPartial:!0},n={items:[s]};await this.db.savePartialAppData(this.currentApp.id,n,e);if(1===this.currentPath.length&&s.contactemail)try{const t=[...this.currentPath,{id:s.ID,hashed:s.hashed,displayID:s.displayID,shortName:d}],e=this.getAppUrl(t),n=this.currentPath[0].shortName||"Organization";await this.sendSubtenantNotificationEmail(s,n,e),console.log("Notification email sent:",s.contactemail)}catch(t){console.error("Failed to send notification email:",t)}}if(!e){let t;if(h)t=`‚úÖ ${p} created! Welcome email sent to ${s.contactemail}`;else if(m){t=1===this.currentPath.length&&s.contactemail?`‚úÖ ${p} added successfully! Notification email sent to ${s.contactemail}`:`‚úÖ ${p} added successfully!`}else{const e=r&&(r.name||r.shortName)||"Parent";t=1===this.currentPath.length&&s.contactemail?`‚úÖ ${p} added to ${e}! Notification email sent to ${s.contactemail}`:`‚úÖ ${p} added to ${e}!`}this.showNotification(t),setTimeout((()=>{this.confirmDot(s.ID)}),100)}}catch(t){console.error("Error during add:",t),this.rollbackDot(s.ID),this.render(),this.updateBreadcrumb(),this.updateWatermark(),this.showNotification(`‚ùå Failed to save item: ${t.message||"Unknown error"}`,"error")}}markDotAsPending(t){setTimeout((()=>{const e=document.querySelectorAll(".dot"),n=Array.from(e).find((e=>{const n=e.itemData;return!!n&&(n.ID===t||n.displayID===t)}));n&&n.classList.add("dot-pending")}),100)}confirmDot(t){const e=document.querySelectorAll(".dot"),n=Array.from(e).find((e=>{const n=e.itemData;return!!n&&(n.ID===t||n.displayID===t)}));n&&(n.classList.remove("dot-pending"),n.style.animation="",n.style.boxShadow="0 0 12px rgba(102, 126, 234, 0.6)",setTimeout((()=>{n.style.boxShadow=""}),1e3))}rollbackDot(t){const e=n=>{for(let a=n.length-1;a>=0;a--){const i=n[a].ID===t,o=n[a].displayID===t;if(i||o)return n.splice(a,1),!0;const s=this.currentApp.entityConfigs;for(const t in s){const i=s[t].childrenField;if(n[a][i]&&e(n[a][i]))return!0}}return!1};e(this.data.items)}ensureBaseEntityFields(t,e,n){t.dotLabel||(t.dotLabel=this.generateUniqueDotLabel(t.name,e)),void 0===t.hidden&&(t.hidden=!1),void 0===t.hashed&&(t.hashed=!1),void 0===t.writeAccess&&(t.writeAccess="owner"),void 0===t.readAccess&&(t.readAccess="owner"),t.timestamp||(t.timestamp=Date.now()),this.ensureMetadataFields(t,e,n),this.ensureRelationshipFields(t,e)}ensureMetadataFields(t,e,n){if(t.metadata||(t.metadata={}),!t.metadata.aggregation){const e=n.sortConfig;e&&"aggregate"===e.type?t.metadata.aggregation={fields:[e.aggregateField],operations:[e.aggregateFunction]}:t.metadata.aggregation={fields:["count"],operations:["sum"]}}t.metadata.displayConfig||(t.metadata.displayConfig={priority:1},t.metadata.displayConfig.color||(t.metadata.displayConfig.color=this.getDotColor(t,e)))}ensureRelationshipFields(t,e){const n=this.currentPath.length;if(n>0){const e=this.currentPath[n-1];e&&e.id&&(t.parentId=e.id)}else t.parentId=null;const a=[];this.currentPath.forEach((t=>{t.id&&a.push(t.id)})),t.ID&&a.push(t.ID),t.path=a}generateUniqueDotLabel(t,e){let n=t.substring(0,3).toUpperCase(),a=1;const i=this.getExistingDotLabelsAtCurrentLevel();for(;i.has(n);)if(n=a<=26?t.substring(0,2).toUpperCase()+String.fromCharCode(64+a):t.substring(0,2).toUpperCase()+(a-26),a++,a>100){n=Math.random().toString(36).substr(2,3).toUpperCase();break}return n}getExistingDotLabelsAtCurrentLevel(){const t=new Set;if(this.data&&this.data.items){const e=this.currentPath.length;this.getItemsAtDepth(e).forEach((e=>{e.dotLabel&&t.add(e.dotLabel)}))}return t}getItemsAtDepth(t){if(0===t)return this.data.items||[];let e=this.data.items;for(let n=0;n<t;n++){if(!e||0===e.length)return[];const t=this.currentApp.hierarchy[n],a=this.currentApp.entityConfigs[t].childrenField,i=[];e.forEach((t=>{t[a]&&Array.isArray(t[a])&&i.push(...t[a])})),e=i}return e}startVersionPolling(){const t=`${Date.now()}-${Math.random().toString(36).substr(2,5)}`;this.pollingSessionToken=t,this.stopVersionPolling(),this.lastPollTime=Date.now();const e=async()=>{if(this.pollingSessionToken!==t||!this.isPollingActive)return;const n=Date.now(),a=n-this.lastPollTime;a>3e4&&console.log(`[VersionPoll] üí§ Wake detected after ${Math.round(a/1e3)}s sleep`),this.lastPollTime=n;try{const t=this.currentPath.map((t=>t.displayID)).join("/"),e=t?`?path=${encodeURIComponent(t)}`:"",n=`/newauth/api/getappdataversion/${encodeURIComponent(this.currentApp.id)}${e}&_=${Date.now()}`,a=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const i=parseInt(await a.text());if(isNaN(i))throw new Error("Invalid timestamp");console.log(`[VersionPoll] path=${t} | server=${i} | client=${this.lastKnownTimestamp}`),0===this.lastKnownTimestamp&&i>0?(this.lastKnownTimestamp=i,console.log("[VersionPoll] Baseline set:",i)):i>this.lastKnownTimestamp&&(console.log(`[VersionPoll] ‚úÖ CHANGE: ${this.lastKnownTimestamp} ‚Üí ${i}`),await this.refreshCurrentView(!1)&&(this.lastKnownTimestamp=i))}catch(t){console.warn("[VersionPoll] Error:",t.message)}finally{this.pollingSessionToken===t&&this.isPollingActive&&!document.hidden&&(this.versionPollTimeout=setTimeout(e,4e3))}};this.handleVisibilityChange=()=>{document.hidden?(this.versionPollTimeout&&(clearTimeout(this.versionPollTimeout),this.versionPollTimeout=null),console.log("[VersionPoll] ‚è∏Ô∏è Paused (tab hidden)")):this.isPollingActive&&(console.log("[VersionPoll] ‚ñ∂Ô∏è Resumed (tab visible)"),this.versionPollTimeout=setTimeout(e,0))},document.addEventListener("visibilitychange",this.handleVisibilityChange),this.isPollingActive=!0,this.versionPollTimeout=setTimeout(e,0),console.log("[VersionPoll] Started session",t)}stopVersionPolling(){this.versionPollTimeout&&(clearTimeout(this.versionPollTimeout),this.versionPollTimeout=null),this.handleVisibilityChange&&(document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.handleVisibilityChange=null),this.isPollingActive=!1,this.lastKnownTimestamp=0,console.log("[VersionPoll] Stopped")}async refreshCurrentView(t=!0){if(console.log("[Refresh] CALLED - _isRefreshing:",this._isRefreshing),this._isRefreshing)return console.warn("[Refresh] Skipped - already in progress"),!1;this._isRefreshing=!0,console.log("[Refresh] STARTED - _isRefreshing set to true");try{const e=this.currentPath.map((t=>t.displayID)),n=await this.db.getAppData(this.currentApp.id,e,{bypassCache:!0});console.log("[Refresh] Fresh data received - items:",n?.items?.length),this.isDataOwner()&&this._hasFullDataStructure()?(this._mergePartialIntoFullData(n,e),console.log("[Refresh] Merged update")):(this.data=n,console.log("[Refresh] Replaced data"));const a=document.getElementById("canvas-area");return a&&a.offsetWidth,console.log("[Refresh] Calling render()"),this.render(),console.log("[Refresh] render() completed"),this.updateBreadcrumb(),this.updateWatermark(),t&&this.showNotification("üïó View updated","info",1200),this.currentPath.length>0&&!this.isPollingActive&&(console.log("[Refresh] Polling was stopped - restarting"),this.startVersionPolling()),console.log("[Refresh] SUCCESS - returning true"),!0}catch(e){return console.error("[refreshCurrentView] Failed:",e),t&&this.showNotification("Update failed. Refresh manually.","error"),console.log("[Refresh] FAILED - returning false"),!1}finally{this._isRefreshing=!1,console.log("[Refresh] FINALLY - _isRefreshing reset to false")}}showNotification(t,e="success",n=3e3){const a=document.getElementById("notification-toast");a&&a.remove();const i=document.createElement("div");i.id="notification-toast",i.style.cssText="\n\t        position: fixed;\n\t        bottom: 30px;\n\t        left: 50%;\n\t        transform: translateX(-50%);\n\t        color: white;\n\t        padding: 16px 24px;\n\t        border-radius: 8px;\n\t        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n\t        font-size: 15px;\n\t        font-weight: 500;\n\t        z-index: 10000;\n\t        animation: slideUp 0.3s ease;\n\t    ",i.style.background="error"===e?"linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)":"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",i.textContent=t;const o=document.createElement("style");o.textContent="\n\t        @keyframes slideUp {\n\t            from { transform: translateX(-50%) translateY(20px); opacity: 0; }\n\t            to { transform: translateX(-50%) translateY(0); opacity: 1; }\n\t        }\n\t    ",document.head.appendChild(o),document.body.appendChild(i),setTimeout((()=>{i.style.animation="slideUp 0.3s ease reverse",setTimeout((()=>i.remove()),300)}),n)}processItemID(t,e){if(!t.ID)return;const n=36===t.ID.length&&t.ID.includes("-");t.displayID?t.hashed=!n:n?(t.displayID=this.db.hashUUID(t.ID),t.hashed=!1):(t.displayID=t.ID,t.hashed=!0),console.log("ProcessItemId complete - ID:",t.ID,"displayID:",t.displayID,"hashed:",t.hashed)}getUserLoginStatus(){const t=localStorage.getItem("userloggedin");return t?JSON.parse(t):null}async openSchemaManager(){var t=this;document.getElementById("schema-modal").style.display="block",await this.loadAppSchemas(),await this.loadNativeEntities(),document.getElementById("add-app-schema").onclick=function(){t.createAppSchema()},document.getElementById("add-native-entity").onclick=function(){t.createNativeEntity()},document.querySelectorAll(".tab").forEach((function(t){t.addEventListener("click",(function(t){document.querySelectorAll(".tab").forEach((function(t){t.classList.remove("active")})),document.querySelectorAll(".tab-content").forEach((function(t){t.classList.remove("active")})),t.target.classList.add("active"),document.getElementById(t.target.dataset.tab).classList.add("active")}))})),document.getElementById("close-schema-modal").onclick=function(){document.getElementById("schema-modal").style.display="none"},await this.loadAppSchemas(),await this.loadNativeEntities()}async loadAppSchemas(){var t=this;const e=document.getElementById("app-schemas-list"),n=await this.db.getAppSchemas();e.innerHTML="",n.forEach((function(n){const a=document.createElement("div");a.className="schema-card",a.innerHTML='<div class="schema-card-header"><h3>'+n.name+'</h3><div><button class="btn btn-primary" style="margin-right: 10px;">Edit</button><button class="btn btn-danger">Delete</button></div></div><p style="color: #666; margin-bottom: 10px;">'+n.description+'</p><p style="color: #999; font-size: 13px;"><strong>Hierarchy:</strong> '+n.hierarchy.join(" ‚Üí ")+"</p>",a.querySelector(".btn-primary").onclick=function(){t.editAppSchema(n)},a.querySelector(".btn-danger").onclick=async function(){confirm('Delete app schema "'+n.name+'"?')&&(await t.db.deleteAppSchema(n.id),await t.loadAppSchemas())},e.appendChild(a)}))}async loadNativeEntities(){var t=this;const e=document.getElementById("native-entities-list"),n=await this.db.getNativeEntities();e.innerHTML="",Object.keys(n).forEach((function(a){const i=n[a],o=document.createElement("div");o.className="entity-item",o.innerHTML='<div class="entity-header"><div><h4>'+i.name+'</h4><p style="color: #666; font-size: 13px;">'+i.description+'</p></div><div><button class="btn btn-primary" style="margin-right: 10px;">Edit</button><button class="btn btn-danger">Delete</button></div></div><div class="field-list"><strong>Fields ('+i.fields.length+"):</strong> "+i.fields.map((function(t){return t.label})).join(", ")+"</div>",o.querySelector(".btn-primary").onclick=function(){t.editNativeEntity(a,i)},o.querySelector(".btn-danger").onclick=async function(){confirm('Delete entity "'+i.name+'"?')&&(await t.db.deleteNativeEntity(a),await t.loadNativeEntities())},e.appendChild(o)}))}createAppSchema(){this.editAppSchema({id:"new_"+Date.now(),name:"New App",description:"",hierarchy:[],entityConfigs:{}})}async editAppSchema(t){var e=this;const n=document.getElementById("app-schema-editor-modal"),a=document.getElementById("app-schema-editor-title"),i=document.getElementById("app-schema-editor-content");a.textContent=t.id.startsWith("new_")?"Create App Schema":"Edit App Schema";const o=await this.db.getNativeEntities(),s=Object.keys(o);i.innerHTML='<div class="form-group"><label>App ID</label><input type="text" id="schema-id" required placeholder="e.g. hr-support"></div><div class="form-group"><label>App Name</label><input type="text" id="schema-name" value="'+t.name+'"></div><div class="form-group"><label>Description</label><textarea id="schema-description">'+t.description+'</textarea></div><div class="form-group"><label>Hierarchy (in order)</label><div id="hierarchy-list"></div><select id="add-hierarchy-entity" style="margin-top: 10px;"><option value="">-- Add Entity --</option>'+s.map((function(t){return'<option value="'+t+'">'+o[t].name+"</option>"})).join("")+'</select></div><div class="form-group"><label>Sort Configuration</label><div id="sort-config-list"></div></div><div style="margin-top: 20px;"><button class="btn btn-primary" id="save-app-schema">Save</button><button class="btn btn-secondary" id="cancel-app-schema">Cancel</button></div>';const r=i.querySelector("#hierarchy-list"),l=function(){r.innerHTML="",t.hierarchy.forEach((function(e,n){const a=document.createElement("div");a.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; margin-bottom: 5px; border-radius: 4px;",a.innerHTML="<span>"+(n+1)+". "+(o[e]?o[e].name:e)+"</span><div>"+(n>0?'<button class="btn-secondary" style="padding: 4px 8px; margin-right: 5px;">‚Üë</button>':"")+(n<t.hierarchy.length-1?'<button class="btn-secondary" style="padding: 4px 8px; margin-right: 5px;">‚Üì</button>':"")+'<button class="btn-danger" style="padding: 4px 8px;">Remove</button></div>';const i=a.querySelectorAll("button");let s=0;n>0&&(i[s++].onclick=function(){var e=t.hierarchy[n];t.hierarchy[n]=t.hierarchy[n-1],t.hierarchy[n-1]=e,l(),c()}),n<t.hierarchy.length-1&&(i[s++].onclick=function(){var e=t.hierarchy[n];t.hierarchy[n]=t.hierarchy[n+1],t.hierarchy[n+1]=e,l(),c()}),i[s].onclick=function(){t.hierarchy.splice(n,1),l(),c()},r.appendChild(a)}))},c=function(){const e=i.querySelector("#sort-config-list");e.innerHTML="",t.hierarchy.forEach((function(n,a){const i=a<t.hierarchy.length-1?t.hierarchy[a+1]:null;if(i){const a=(t.entityConfigs[n]||{}).sortConfig||{type:"count"},s=document.createElement("div");s.style.cssText="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;",s.innerHTML="<h4>"+(o[n]?o[n].name:n)+'</h4><p style="color: #666; font-size: 12px; margin-bottom: 10px;">This dot size is determined by: <strong>children in '+(o[i]?o[i].name:i)+'s</strong></p><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div><label style="font-size: 12px;">Sort Method</label><select data-entity="'+n+'" data-prop="type" style="width: 100%; padding: 6px;"><option value="count" '+("count"===a.type?"selected":"")+">Count of "+i+'s</option><option value="aggregate" '+("aggregate"===a.type?"selected":"")+">Aggregate "+i+' data</option></select></div><div class="aggregate-fields-'+n+'" style="display: '+("aggregate"===a.type?"block":"none")+';"><label style="font-size: 12px;">Function</label><select data-entity="'+n+'" data-prop="aggregateFunction" style="width: 100%; padding: 6px;"><option value="sum" '+("sum"===a.aggregateFunction?"selected":"")+'>Sum</option><option value="avg" '+("avg"===a.aggregateFunction?"selected":"")+'>Average</option><option value="max" '+("max"===a.aggregateFunction?"selected":"")+'>Max</option><option value="min" '+("min"===a.aggregateFunction?"selected":"")+'>Min</option></select></div><div class="aggregate-fields-'+n+'" style="grid-column: 1 / -1; display: '+("aggregate"===a.type?"block":"none")+';"><label style="font-size: 12px;">Field to Aggregate (in '+i+')</label><input type="text" data-entity="'+n+'" data-prop="aggregateField" value="'+(a.aggregateField||"")+'" placeholder="e.g., count, amount, priority" style="width: 100%; padding: 6px;"></div></div>';s.querySelector('select[data-entity="'+n+'"][data-prop="type"]').addEventListener("change",(function(t){s.querySelectorAll(".aggregate-fields-"+n).forEach((function(e){e.style.display="aggregate"===t.target.value?"block":"none"}))})),e.appendChild(s)}})),e.querySelectorAll("select[data-entity], input[data-entity]").forEach((function(e){e.addEventListener("change",(function(e){const n=e.target.dataset.entity,a=e.target.dataset.prop,i=e.target.value;t.entityConfigs[n]||(t.entityConfigs[n]={}),t.entityConfigs[n].sortConfig||(t.entityConfigs[n].sortConfig={}),t.entityConfigs[n].sortConfig[a]=i}))}))};l(),c(),i.querySelector("#add-hierarchy-entity").onchange=function(e){if(e.target.value&&!t.hierarchy.includes(e.target.value)){if(t.hierarchy.push(e.target.value),!t.entityConfigs[e.target.value]){const n=o[e.target.value],a=n.fields.find((function(t){return t.name.includes("name")}))?n.fields.find((function(t){return t.name.includes("name")})).name:n.fields[0].name,i=n.fields.find((function(t){return t.name.includes("id")}))?n.fields.find((function(t){return t.name.includes("id")})).name:n.fields[0].name;t.entityConfigs[e.target.value]={labelField:a,idField:i,childEntity:null,childrenField:e.target.value+"s"}}l(),c(),e.target.value=""}},i.querySelector("#save-app-schema").onclick=async function(){const a=i.querySelector("#schema-id"),o=i.querySelector("#schema-name");let s=!0;[a,o].forEach((t=>t.classList.remove("input-error"))),a.value.trim()||(a.classList.add("input-error"),s=!1),o.value.trim()||(o.classList.add("input-error"),s=!1),s&&(t.id=a.value.trim(),t.name=o.value.trim(),t.description=i.querySelector("#schema-description").value.trim(),t.hierarchy.forEach((function(e,n){const a=n<t.hierarchy.length-1?t.hierarchy[n+1]:null;t.entityConfigs[e]||(t.entityConfigs[e]={}),t.entityConfigs[e].childrenField=a?a.toLowerCase()+"s":null})),await e.db.saveAppSchema(t),n.style.display="none",await e.loadAppSchemas())},i.querySelector("#cancel-app-schema").onclick=function(){n.style.display="none"},n.style.display="block"}getBaseEntityFields(){return[{name:"ID",label:"ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"displayID",label:"Display ID",type:"text",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"name",label:"Name",type:"text",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"dotLabel",label:"Dot Label",type:"text",mandatory:!0,writePermission:"any",dataSource:"manual"},{name:"timestamp",label:"Timestamp",type:"number",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"count",label:"Count",type:"number",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"hidden",label:"Hidden",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"hashed",label:"Hashed",type:"checkbox",mandatory:!1,writePermission:"system",dataSource:"manual"},{name:"image",label:"Image URL",type:"url",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"website",label:"Website URL",type:"url",mandatory:!1,writePermission:"any",dataSource:"manual"},{name:"writeAccess",label:"Write Access",type:"select",mandatory:!1,writePermission:"root",dataSource:"manual",options:["owner","parent","ancestor","any"]},{name:"readAccess",label:"Read Access",type:"select",mandatory:!1,writePermission:"root",dataSource:"manual",options:["owner","parent","ancestor","any"]}]}createNativeEntity(){const t={name:"New Entity",description:"",fields:this.getBaseEntityFields()};this.editNativeEntity("new_entity_"+Date.now(),t)}editNativeEntity(t,e){const n=document.getElementById("entity-editor-modal"),a=document.getElementById("entity-editor-title"),i=document.getElementById("entity-editor-content");a.textContent=t.startsWith("new_")?"Create Native Entity":"Edit Native Entity",i.innerHTML='<div class="form-group"><label>Entity Key</label><input type="text" id="entity-key" value="'+t+'" '+(t.startsWith("new_")?"":"readonly")+'></div><div class="form-group"><label>Entity Name</label><input type="text" id="entity-name" value="'+e.name+'"></div><div class="form-group"><label>Description</label><textarea id="entity-description">'+e.description+'</textarea></div><div class="form-group"><label>Fields</label><div id="entity-fields-list"></div><button class="btn btn-primary" id="add-entity-field" style="margin-top: 10px;">+ Add Field</button></div><div style="margin-top: 20px;"><button class="btn btn-primary" id="save-entity">Save</button><button class="btn btn-secondary" id="cancel-entity">Cancel</button></div>';const o=i.querySelector("#entity-fields-list"),s=function(){o.innerHTML="",e.fields.forEach((function(t,n){const a=document.createElement("div");if(a.className="field-item","ID"===t.name)a.innerHTML='\n\t\t                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">\n\t\t                    <div><label style="font-size: 12px;">Name</label>\n\t\t                        <input type="text" value="ID" readonly style="background-color: #e8f4f8;"></div>\n\t\t                    <div><label style="font-size: 12px;">Label</label>\n\t\t                        <input type="text" value="ID" readonly style="background-color: #e8f4f8;"></div>\n\t\t                    <div><label style="font-size: 12px;">Type</label>\n\t\t                        <select disabled style="background-color: #e8f4f8;"><option>Text</option></select></div>\n\t\t                    <div><label style="font-size: 12px;">Write Permission</label>\n\t\t                        <select disabled style="background-color: #e8f4f8;"><option>system</option></select></div>\n\t\t                    <div><label style="font-size: 12px;">Data Source</label>\n\t\t                        <select disabled style="background-color: #e8f4f8;"><option>manual</option></select></div>\n\t\t                    <button class="btn-danger" disabled>System Field</button>\n\t\t                </div>\n\t\t                <div style="margin-top: 5px; font-size: 11px; color: #17a2b8;">üîí System-generated unique identifier</div>\n\t\t            ';else{const i=`\n\t\t                <option value="any" ${"any"===t.writePermission?"selected":""}>Any User</option>\n\t\t                <option value="parent" ${"parent"===t.writePermission?"selected":""}>Parent Only</option>\n\t\t                <option value="root" ${"root"===t.writePermission?"selected":""}>Root Tenant</option>\n\t\t                <option value="owner" ${"owner"===t.writePermission?"selected":""}>App Owner</option>\n\t\t                <option value="system" ${"system"===t.writePermission?"selected":""}>System Only</option>\n\t\t            `,o=`\n\t\t                <option value="manual" ${"manual"===t.dataSource?"selected":""}>Manual Input</option>\n\t\t                <option value="web" ${"web"===t.dataSource?"selected":""}>Web API</option>\n\t\t                <option value="api" ${"api"===t.dataSource?"selected":""}>Internal API</option>\n\t\t            `;a.innerHTML=`\n\t\t                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">\n\t\t                    <div><label style="font-size: 12px;">Name</label>\n\t\t                        <input type="text" value="${t.name}" data-index="${n}" data-prop="name"></div>\n\t\t                    <div><label style="font-size: 12px;">Label</label>\n\t\t                        <input type="text" value="${t.label}" data-index="${n}" data-prop="label"></div>\n\t\t                    <div><label style="font-size: 12px;">Type</label>\n\t\t                        <select data-index="${n}" data-prop="type">\n\t\t                            <option value="text" ${"text"===t.type?"selected":""}>Text</option>\n\t\t                            <option value="textarea" ${"textarea"===t.type?"selected":""}>Textarea</option>\n\t\t                            <option value="email" ${"email"===t.type?"selected":""}>Email</option>\n\t\t                            <option value="checkbox" ${"checkbox"===t.type?"selected":""}>Checkbox</option>\n\t\t                            <option value="select" ${"select"===t.type?"selected":""}>Select</option>\n\t\t                        </select></div>\n\t\t                    <div><label style="font-size: 12px;">Write Permission</label>\n\t\t                        <select data-index="${n}" data-prop="writePermission">${i}</select></div>\n\t\t                    <div><label style="font-size: 12px;">Data Source</label>\n\t\t                        <select data-index="${n}" data-prop="dataSource">${o}</select></div>\n\t\t                    <button class="btn-danger" data-index="${n}">Remove</button>\n\t\t                </div>\n\t\t                ${"select"===t.type?`\n\t\t                <div style="margin-top: 5px;">\n\t\t                    <label style="font-size: 12px;">Options (comma-separated)</label>\n\t\t                    <input type="text" value="${t.options?t.options.join(", "):""}" \n\t\t                           data-index="${n}" data-prop="optionsStr" placeholder="Option1, Option2, Option3"\n\t\t                           style="width: 100%; padding: 4px; margin-top: 2px;">\n\t\t                </div>`:""}\n\t\t                <div style="margin-top: 5px; display: flex; gap: 10px; align-items: center;">\n\t\t                    <label style="font-size: 12px; display: flex; align-items: center; gap: 5px;">\n\t\t                        <input type="checkbox" ${t.mandatory?"checked":""} data-index="${n}" data-prop="mandatory">\n\t\t                        Required\n\t\t                    </label>\n\t\t                </div>\n\t\t            `;const s=a.querySelector('[data-prop="optionsStr"]');s&&(s.onchange=function(t){const n=parseInt(t.target.dataset.index),a=t.target.value.split(",").map((t=>t.trim())).filter((t=>t));e.fields[n].options=a})}"ID"!==t.name&&(a.querySelectorAll("input[data-prop], select[data-prop]").forEach((function(t){t.onchange=function(t){const n=parseInt(t.target.dataset.index),a=t.target.dataset.prop;"mandatory"===a?e.fields[n][a]=t.target.checked:"optionsStr"===a||(e.fields[n][a]=t.target.value)}})),a.querySelector("button").onclick=function(){e.fields.splice(n,1),s()}),o.appendChild(a)}))};s(),i.querySelector("#add-entity-field").onclick=()=>{e.fields.push({name:"newfield",label:"New Field",type:"text",mandatory:!1}),s()},i.querySelector("#save-entity").onclick=async()=>{const a=i.querySelector("#entity-key").value;e.name=i.querySelector("#entity-name").value,e.description=i.querySelector("#entity-description").value,a!==t&&await this.db.deleteNativeEntity(t),await this.db.saveNativeEntity(a,e),n.style.display="none",await this.loadNativeEntities()},i.querySelector("#cancel-entity").onclick=function(){n.style.display="none"},n.style.display="block"}}function displayapprootaccesssmessage(){var t=document.createElement("div");t.id="notification-div",t.style.position="fixed",t.style.bottom="25px",t.style.width="80%",t.style.left="10%",t.style.right="10%",t.style.backgroundColor="#fafafa",t.style.color="#787878",t.style.textAlign="center",t.style.fontSize="18px",t.style.padding="10px",t.style.border="1px solid #ccc",t.style.borderRadius="20px",t.innerHTML="Access to this page is retricted.",document.body.appendChild(t)}function updateCanvasHeight(){const t=document.querySelector(".app-header"),e=document.getElementById("breadcrumb"),n=(t?t.offsetHeight:0)+(e?e.offsetHeight:0),a=document.getElementById("canvas-area");a&&(a.style.height=`calc(100vh - ${n}px)`,a.style.height=`calc(var(--vh, 1vh) * 100 - ${n}px)`)}if("undefined"!=typeof window){window.SchemaOrchestrator=SchemaOrchestrator,window.DatabaseService=DatabaseService,console.log("schema orchestrator loaded");let t=SchemaOrchestrator.prototype.render;SchemaOrchestrator.prototype.render=function(){return console.log("RENDER CALLED FROM:",(new Error).stack.split("\n")[2]),t.call(this)}}