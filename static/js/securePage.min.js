'use strict';var userdatainsystem,filenametodownload,ftypetodownload,datatodownload,filedatamap={},copytimer,settimeoutid,lastfileseq=101,filecontentobject=[],selectedfiles={},copyclickmap={},handleFileSelect=function(a){var d=a.target.files;for(a=0;a<d.length;a++){var c=d[a];if(d&&c){var b=new FileReader;b.onload=function(a){return function(c){populateFileContent(c,a);Object.keys(selectedfiles).length===d.length&&(document.getElementById("vault-file-upload-button").disabled=!1)}}(c);0==c.type.length?
b.readAsText(c):b.readAsBinaryString(c)}}},handleImportFileSelect=function(a){a=a.target.files;var d=a[0];a&&d&&(a=new FileReader,a.onload=function(a){1>d.size/1024/1024?(loadcredcsvfile(a,d.name),document.getElementById("vault-file-import-button").disabled=!1):(document.getElementById("csvfiledisplay").appendChild(document.createTextNode("Files larger than 1 MB not allowed")),console.log("Too large a file. More than 1 MB"))},a.readAsText(d))};
function loadcredcsvfile(a,d){var c=document.getElementById("cred-csv-data").value;a=a.target.result.split(/\r?\n/);var b=null;if(0<a.length){b=document.getElementById("csvfiledisplay");b.innerHTML="";b.style.height=100;b.style.overflowY="scroll";b.style.overflowX="hidden";var f=document.createElement("div");f.classList.add("row");f.style.borderBottom="solid 1px grey";var e=document.createElement("div");e.classList.add("col-xs-3");e.innerHTML="\x3cstrong\x3eSite\x3c/strong\x3e";f.appendChild(e);e=
document.createElement("div");e.classList.add("col-xs-3");e.innerHTML="\x3cstrong\x3eUsername\x3c/strong\x3e";f.appendChild(e);e=document.createElement("div");e.classList.add("col-xs-3");e.innerHTML="\x3cstrong\x3ePassword\x3c/strong\x3e";f.appendChild(e);e=document.createElement("div");e.classList.add("col-xs-3");e.innerHTML="\x3cstrong\x3eDescription\x3c/strong\x3e";f.appendChild(e);b.appendChild(f);document.getElementById("remove-header-id").classList.remove("hidden");document.getElementById("remove-header").addEventListener("change",
function(){if(1==document.getElementById("remove-header").checked){if(null!=document.getElementById("header-possible")){document.getElementById("header-possible").style.display="none";var a=JSON.parse(document.getElementById("cred-csv-data").value);a.splice(0,1);document.getElementById("cred-csv-data").value=JSON.stringify(a);document.getElementById("remove-header").disabled=!0}}else null!=document.getElementById("header-possible")&&(document.getElementById("header-possible").style.display="block")})}for(var g=
0;g<a.length;g++){var h=a[g].split(",");4==h.length&&(f={siteUrl:h[0],sitedesc:h[3],siteuser:h[1],sitepwd:h[2],source:d},c=0==c.length?JSON.stringify(f):c+(","+JSON.stringify(f)),f=document.createElement("div"),f.classList.add("row"),0==g&&f.setAttribute("id","header-possible"),e=document.createElement("div"),e.classList.add("col-xs-3"),e.appendChild(document.createTextNode(h[0])),e.style.overflowX="hidden",f.appendChild(e),e=document.createElement("div"),e.classList.add("col-xs-3"),e.appendChild(document.createTextNode(h[1])),
e.style.overflowX="hidden",f.appendChild(e),e=document.createElement("div"),e.classList.add("col-xs-3"),e.appendChild(document.createTextNode(h[2])),e.style.overflowX="hidden",f.appendChild(e),e=document.createElement("div"),e.classList.add("col-xs-3"),e.appendChild(document.createTextNode(h[3])),e.style.overflowX="hidden",f.appendChild(e),b.appendChild(f),console.log("added one row"))}0==c.length?b.appendChild(document.createTextNode("No valid credential data found. Please check the file you selected")):
document.getElementById("cred-csv-data").value="["+c+"]"}function populateFileContent(a,d){selectedfiles[d.name+":"+d.type+":"+d.size]=btoa(a.target.result)}function unblur(){this.getAttribute("id");this.classList.remove("blur")}function blur(){this.getAttribute("id");this.classList.add("blur")}function registereventhandlers(){for(var a=document.getElementsByClassName("blur"),d=0;d<a.length;d++)a[d].addEventListener("mouseenter",unblur,!1),a[d].addEventListener("mouseleave",blur,!1)}
function checkKey(){var a=document.getElementById("keybox").value;if(0==a.length)return alert("Invalid key."),!1;vaultkey=a;displayUserDataClear();return!1}function displaykeyalert(a){$("#key-input-div").fadeIn(600);$("#no-key-alert-holder").fadeIn(600)}function processvaultsearch(){null!=settimeoutid&&clearTimeout(settimeoutid);settimeoutid=setTimeout(function(){displayUserDataClear(document.getElementById("vault-search-input").value)},200)}
function changevaultkey(){var a=document.getElementById("newvaultkey").value;if(vaultkey==a)document.getElementById("vault-key-update-notification").innerHTML="This key is identical to your current key",document.getElementById("newvaultkey").value="";else if(6>a.length)document.getElementById("vault-key-update-notification").innerHTML="Please choose a vault key longer than 6 characters",document.getElementById("newvaultkey").value="";else{var d="",c=0;if(0<JSON.parse(userdatainsystem).length){document.getElementById("vault-key-update-notification").innerHTML=
"Update in progress...";for(var b=JSON.parse(userdatainsystem),f=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),e=0;e<b.length;e++)if(0===b[e].sequence){var g=sjcl.decrypt(vaultkey,b[e].data);g=encryptdatawithstretchedkey(g,a,"",0);f.open("POST","/secure/adduserdata",!1);f.withCredentials=!0;f.setRequestHeader("Content-Type","application/json");f.send(JSON.stringify({salt:b[e].salt,iterations:b[e].iterations,data:g,sequence:b[e].sequence,createdate:b[e].createdate}))}else if(encruptanduploaddatawithdiffvaultkey(b[e],
vaultkey,a),"3"==b[e].sequence){d=b[e].salt;c=b[e].iterations;var h=b[e].createdate;g=decryptwithstretchedkey("oth",vaultkey,b[e].data);g=JSON.parse(g);for(var k=g[0].fileseq,l=0;l<g.length;l++)f.open("POST","/secure/getuserdata",!1),f.withCredentials=!0,f.setRequestHeader("Content-Type","application/json"),f.onreadystatechange=function(b){return function(e){if(4==f.readyState&&200==f.status&&(e=JSON.parse(f.responseText),null!=e)){e=decryptwithstretchedkey("oth",vaultkey,e.data);e=encryptdatawithstretchedkey(e,
a,d,c);var g=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");g.open("POST","/secure/adduserdata",!1);g.withCredentials=!0;g.setRequestHeader("Content-Type","application/json");g.onreadystatechange=function(a){return function(d){4==g.readyState&&200==g.status&&k==a&&(console.log("File content "+a+" saved with new vault key"),document.getElementById("vault-key-update-notification").innerHTML="Your Vault Key has been updated successfully. Please make a note of it, if you need to.")}}(b);
g.send(JSON.stringify({salt:d,iterations:c,data:e,sequence:b,createdate:h}))}}}(g[l].fileseq),f.send(JSON.stringify({sequence:g[l].fileseq,createdate:h}));filedatamap={}}else parseInt(b[e].sequence)==b.length-1&&(document.getElementById("vault-key-update-notification").innerHTML="Your Vault Key has been updated successfully. Please make a note of it, if you need to.");vaultkey=a}}}
function encruptanduploaddatawithdiffvaultkey(a,d,c){var b="";"1"==a.sequence&&(b="sites");"2"==a.sequence&&(b="fin");"3"==a.sequence&&(b="oth");try{var f=decryptwithstretchedkey(b,d,a.data),e=encryptdatawithstretchedkey(f,c,a.salt,a.iterations),g=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");g.open("POST","/secure/adduserdata",!1);g.withCredentials=!0;g.setRequestHeader("Content-Type","application/json");g.send(JSON.stringify({salt:a.salt,iterations:a.iterations,
data:e,sequence:a.sequence,createdate:a.createdate}))}catch(h){return vaultkey="",displaykeyalert("Could not decrypt existing data with your old Vault key. Please come back to this page and provide you original vault key before updating it. "),!1}}
function displayUserDataClear(a){var d=0,c=0,b=document.getElementById("securedata-sites");b.removeEventListener("mouseenter",unblur,!1);b.removeEventListener("mouseleave",blur,!1);b.classList.remove("blur");b=document.getElementById("securedata-fin");b.removeEventListener("mouseenter",unblur,!1);b.removeEventListener("mouseleave",blur,!1);b.classList.remove("blur");b=document.getElementById("securedata-oth");b.removeEventListener("mouseenter",unblur,!1);b.removeEventListener("mouseleave",blur,!1);
b.classList.remove("blur");if(0<JSON.parse(userdatainsystem).length){document.getElementById("vault-intro").style.display="none";b=JSON.parse(userdatainsystem);for(var f=0;f<b.length;f++){0===b[f].sequence&&b[f].lastupdatedate!=b[f].createdate&&(document.getElementById("vault-key-last-change-info").innerText="You changed your vault key on "+b[f].lastupdatedate);if(1===b[f].sequence){document.getElementById("clear-sites-btn").style.display="inline-block";if("undefined"!=typeof b[f].copies&&0<b[f].copies.length){document.getElementById("revert-sites-btn").setAttribute("data-current",
b[f].lastupdatedate);for(var e=0;e<b[f].copies.length;e++)b[f].lastupdatedate==b[f].copies[e]&&(document.getElementById("revert-sites-btn").style.display="inline-block",e==b[f].copies.length-1?document.getElementById("revert-sites-btn").setAttribute("data-next",b[f].copies[0]):document.getElementById("revert-sites-btn").setAttribute("data-next",b[f].copies[e+1]))}e=document.getElementById("securedata-sites").innerHTML;document.getElementById("securedata-sites").innerHTML="";try{var g=decryptwithstretchedkey("sites",
vaultkey,b[f].data);b[f].data=g}catch(m){return document.getElementById("securedata-sites").innerHTML=e,vaultkey="",displaykeyalert("The key you entered is incorrect. Most users use their username as the key here. You need to provide the same key you entered while adding data here. "),!1}}if(2===b[f].sequence){document.getElementById("clear-fin-btn").style.display="inline-block";e=document.getElementById("securedata-fin").innerHTML;document.getElementById("securedata-fin").innerHTML="";try{var h=
decryptwithstretchedkey("fin",vaultkey,b[f].data);b[f].data=h}catch(m){return document.getElementById("securedata-fin").innerHTML=e,vaultkey="",displaykeyalert("The key you entered is incorrect. Most users use their username as the key here. You need to provide the same key you entered while adding data here."),!1}}if(3===b[f].sequence){document.getElementById("clear-oth-btn").style.display="inline-block";e=document.getElementById("securedata-oth").innerHTML;document.getElementById("securedata-oth").innerHTML=
"";try{h=decryptwithstretchedkey("oth",vaultkey,b[f].data),b[f].data=h}catch(m){return document.getElementById("securedata-oth").innerHTML=e,vaultkey="",displaykeyalert("The key you entered is incorrect. Most users use their username as the key here. You need to provide the same key you entered while adding data here."),!1}}removeKeyboxAndAlert();e=JSON.parse(b[f].data);for(var k=0;k<e.length;k++){if(1===b[f].sequence){document.getElementById("sites-siteUrl").value=e[k].siteUrl;document.getElementById("sites-siteuser").value=
e[k].siteuser;document.getElementById("sites-sitepwd").value=e[k].sitepwd;document.getElementById("sites-sitedesc").value=e[k].sitedesc;document.getElementById("sites-sitename").value=e[k].sitename;"undefined"!=typeof e[k].sharedwith?document.getElementById("sites-sharedwith").value=JSON.stringify(e[k].sharedwith):document.getElementById("sites-sharedwith").value="";document.getElementById("sites-seq").value=b[f].sequence;document.getElementById("sites-slt").value=b[f].salt;document.getElementById("sites-itns").value=
b[f].iterations;document.getElementById("sites-crdate").value=b[f].createdate;document.getElementById("sites-upddate").value=b[f].lastupdatedate;document.getElementById("sites-accdate").value=b[f].lastaccessdate;0==document.getElementById("sites-last-update-display").innerText.length&&(document.getElementById("sites-last-update-display").innerText=gettimedifference(b[f].lastupdatedate,!0),document.getElementById("sites-last-access-display").innerText=gettimedifference(b[f].lastaccessdate,!0));var l=
parseInt(k+1);document.getElementById("vault-site-count").innerText=" ("+l+")";if("undefined"==typeof a||0<=e[k].siteUrl.toLowerCase().indexOf(a.toLowerCase())||0<=e[k].siteuser.toLowerCase().indexOf(a.toLowerCase())||0<=e[k].sitepwd.indexOf(a))d++,addWebsiteToSecurePage(),"undefined"!=typeof a&&(document.getElementById("vault-filteredsite-count").innerText=d+" of");"undefined"===typeof a&&(document.getElementById("vault-filteredsite-count").innerText="");0==d&&(document.getElementById("vault-filteredsite-count").innerText=
" 0 of")}2===b[f].sequence&&(document.getElementById("fin-institution").value=e[k].institution,document.getElementById("fin-accType").value=e[k].accType,document.getElementById("fin-acctNum").value=e[k].acctNum,document.getElementById("fin-seq").value=b[f].sequence,document.getElementById("fin-slt").value=b[f].salt,document.getElementById("fin-itns").value=b[f].iterations,document.getElementById("fin-crdate").value=b[f].createdate,document.getElementById("fin-upddate").value=b[f].lastupdatedate,addFinDataToSecurePage());
if(3===b[f].sequence){document.getElementById("oth-seq").value=b[f].sequence;document.getElementById("oth-slt").value=b[f].salt;document.getElementById("oth-itns").value=b[f].iterations;document.getElementById("oth-crdate").value=b[f].createdate;document.getElementById("oth-upddate").value=b[f].lastupdatedate;document.getElementById("oth-accdate").value=b[f].lastaccessdate;if("undefined"==typeof a||0<=e[k].filename.toLowerCase().indexOf(a.toLowerCase())||0<=e[k].filetype.toLowerCase().indexOf(a.toLowerCase()))addFileDataToSecurePage(e[k]),
c++,"undefined"!=typeof a&&(document.getElementById("vault-filteredfile-count").innerText=c+" of");0==k&&(lastfileseq=e[k].fileseq);l=parseInt(k+1);document.getElementById("vault-file-count").innerText=" "+l;"undefined"===typeof a&&(document.getElementById("vault-filteredfile-count").innerText="");0==c&&(document.getElementById("vault-filteredfile-count").innerText=" 0 of")}}}document.getElementById("sites-siteUrl").value="";document.getElementById("sites-siteuser").value="";document.getElementById("sites-sitepwd").value=
"";document.getElementById("sites-sitedesc").value="";document.getElementById("sites-sitename").value="";document.getElementById("sites-sharedwith").value="";document.getElementById("fin-institution").value="";document.getElementById("fin-accType").value="";document.getElementById("fin-acctNum").value="";document.getElementById("vault-search-input").style.display="block";document.getElementById("vaultkeychangebutton").classList.remove("hidden")}}
function revertvaultdata(a){if(confirm("Do you want to restore the previous version of your vault content?")&&"1"==a){document.getElementById("revert-sites-btn").getAttribute("data-current");a=document.getElementById("revert-sites-btn").getAttribute("data-next");var d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");d.open("POST","/secure/revertuserdata",!1);d.withCredentials=!0;d.setRequestHeader("Content-Type","application/json");d.onreadystatechange=function(){4==
d.readyState&&200==d.status&&showPrivateDataPage()};d.send(JSON.stringify({sequence:1,createdate:document.getElementById("sites-crdate").value,lastupdatedate:a}))}}function removeKeyboxAndAlert(){$("#key-input-div").hide("slow");$("#no-key-alert-holder").hide("slow")}
function displayUserData(){if(0<JSON.parse(userdatainsystem).length){document.getElementById("vault-intro").style.display="none";for(var a=JSON.parse(userdatainsystem),d=1;d<a.length;d++){var c=JSON.parse(a[d].data),b=document.createElement("div");b.classList.add("row");var f=document.createElement("div");f.classList.add("col-xs-12");var e=document.createElement("p");e.style.wordWrap="break-word";e.style.maxWidth="90%";e.style.display="inline-block";e.style.fontSize="16px";c=300<c.ct.length?c.ct.substr(0,
300)+"...":c.ct;c=document.createTextNode(c);e.appendChild(c);addinfolabel(f);f.appendChild(e);b.appendChild(f);1===a[d].sequence&&(document.getElementById("securedata-sites").innerHTML="",document.getElementById("securedata-sites").appendChild(b));2===a[d].sequence&&(document.getElementById("securedata-fin").innerHTML="",document.getElementById("securedata-fin").appendChild(b));3===a[d].sequence&&(document.getElementById("securedata-oth").innerHTML="",document.getElementById("securedata-oth").appendChild(b))}}}
function addinfolabel(a){var d=document.createElement("p");d.style.wordWrap="break-word";d.style.maxWidth="90%";d.style.display="inline-block";d.classList.add("lead");var c=document.createTextNode("You can decrypt this data only with the key you used to add this data");d.appendChild(c);a.appendChild(d)}
function submitencuserdata(a,d){if(0==vaultkey.length)return createvaultpagekeyoverlay(),!1;if(d){if("sites"===a&&0==document.getElementById("sites-sitepwd").value.length||"fin"===a&&0==document.getElementById("fin-institution").value.length)return!1;if(!createUserData(a))return $("#"+a+"Modal").modal("hide"),!1}"sites"===a&&(document.getElementById(a+"-seq").value="1");"fin"===a&&(document.getElementById(a+"-seq").value="2");"oth"===a&&(document.getElementById(a+"-seq").value="3");document.getElementById(a+
"-data");d=encryptwithstretchedkey(a,vaultkey);var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("POST","/secure/adduserdata",!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){4==c.readyState&&200==c.status&&"oth"!=a&&($("#"+a+"Modal").hasClass("in")&&$("#"+a+"Modal").modal("hide"),showPrivateDataPage())};c.send(JSON.stringify({group:a,salt:document.getElementById(a+"-slt").value,iterations:document.getElementById(a+
"-itns").value,data:d,sequence:document.getElementById(a+"-seq").value,createdate:document.getElementById(a+"-crdate").value,lastupdatedate:document.getElementById(a+"-upddate").value}));if("oth"===a)for(var b=0;b<filecontentobject.length;b++)document.getElementById(a+"-data").value=JSON.stringify(filecontentobject[b]),document.getElementById(a+"-data"),d=encryptwithstretchedkey(a,vaultkey),c.open("POST","/secure/adduserdata",!1),c.withCredentials=!0,c.setRequestHeader("Content-Type","application/json"),
c.onreadystatechange=function(){4==c.readyState&&200==c.status&&($("#"+a+"Modal").modal("hide"),showPrivateDataPage())},c.send(JSON.stringify({group:a,salt:document.getElementById(a+"-slt").value,iterations:document.getElementById(a+"-itns").value,data:d,sequence:filecontentobject[b].fileseq,createdate:document.getElementById(a+"-crdate").value,lastupdatedate:document.getElementById(a+"-upddate").value}));return!1}
function addimportedcredentialsfromfile(){if(0==vaultkey.length)return createvaultpagekeyoverlay(),!1;var a=JSON.parse(userdatainsystem);if(0<a.length){for(var d="",c=0;c<a.length;c++)if(1===a[c].sequence)for(var b=JSON.parse(decryptwithstretchedkey("sites",vaultkey,a[c].data)),f=0;f<b.length;f++)d+=JSON.stringify(b[f]),f<b.length&&(d+=", ");document.getElementById("cred-csv-data").value=document.getElementById("cred-csv-data").value.replace("[","");document.getElementById("cred-csv-data").value=
document.getElementById("cred-csv-data").value.replace("]","");document.getElementById("sites-data").value="["+d+document.getElementById("cred-csv-data").value+"]"}else document.getElementById("sites-data").value="["+document.getElementById("cred-csv-data").value+"]";submitencuserdata("sites",!1);$("#importfilemodal").modal("hide")}
function createUserData(a){var d="";"sites"===a&&(d='"siteUrl":"'+document.getElementById("sites-siteUrl").value+'", "siteuser":"'+document.getElementById("sites-siteuser").value+'", "sitepwd":"'+document.getElementById("sites-sitepwd").value+'", "sitedesc":"'+document.getElementById("sites-sitedesc").value+'", "sitename":"'+document.getElementById("sites-sitename").value+'", ',addWebsiteToSecurePage());"fin"===a&&(d='"institution":"'+document.getElementById("fin-institution").value+'", "accType":"'+
document.getElementById("fin-accType").value+'", "acctNum":"'+document.getElementById("fin-acctNum").value+'", ',addFinDataToSecurePage());if("oth"===a){for(var c=document.getElementById("secure-file").files,b=0;b<c.length;b++){var f=c[b];if(1<f.size/1024/1024)return alert("Files greater than 1 MB not supported right now."),!1;var e={filename:f.name,filetype:f.type,filesize:f.size,fileseq:lastfileseq+1,createtime:Date.now()};filecontentobject.push({filename:f.name,filetype:f.type,filesize:f.size,
fileseq:lastfileseq+1,content:selectedfiles[f.name+":"+f.type+":"+f.size]});d+=JSON.stringify(e);b<c.length-1&&(d+=", ");lastfileseq+=1;addFileDataToSecurePage(e)}selectedfiles={}}c=JSON.parse(userdatainsystem);if(0<c.length){if("sites"===a){var g="";for(f=0;f<c.length;f++)if(1===c[f].sequence)for(e=JSON.parse(decryptwithstretchedkey("sites",vaultkey,c[f].data)),b=0;b<e.length;b++)g+=JSON.stringify(e[b]),b<e.length&&(g+=", ");document.getElementById("sites-data").value="["+g+"{"+d.substring(0,d.length-
2)+"}]"}if("fin"===a){g="";for(f=0;f<c.length;f++)if(2===c[f].sequence)for(e=JSON.parse(decryptwithstretchedkey("fin",vaultkey,c[f].data)),b=0;b<e.length;b++)g+=JSON.stringify(e[b]),b<e.length&&(g+=", ");document.getElementById("fin-data").value="["+g+"{"+d.substring(0,d.length-2)+"}]"}if("oth"===a){a=d;for(f=0;f<c.length;f++)if(3===c[f].sequence)for(e=JSON.parse(decryptwithstretchedkey("oth",vaultkey,c[f].data)),b=0;b<e.length;b++)a+=", "+JSON.stringify(e[b]),lastfileseq=e[b].fileseq;document.getElementById("oth-data").value=
"["+a+"]"}}else"oth"===a?document.getElementById(a+"-data").value="["+d+"]":document.getElementById(a+"-data").value="[{"+d.substring(0,d.length-2)+"}]";return!0}function getHostName(a){const d=document.createElement("a");-1==a.indexOf("http")&&(a="http://"+a);d.setAttribute("href",a);return d.hostname}function getDomain(a){return(a=a.match(/^(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)+)(?:\/.*)?$/))?a[1]:null}
function addWebsiteToSecurePage(){var a;var d=document.getElementById("sites-siteUrl").value;var c=document.getElementById("sites-siteuser").value;var b=document.getElementById("sites-sitepwd").value;var f=document.getElementById("sites-sharedwith").value;document.getElementById("sites-sitedesc");var e=document.getElementById("sites-sitename").value;var g=null;if("undefined"!==d){g=getDomain(d);null!=g?a=g.split(".")[0]:null!=e&&(a=e);var h=document.createElement("div");h.classList.add("col-md-2");
h.classList.add("col-xs-4");h.classList.add("website-cred-display");h.style.height="100px";e=document.createElement("div");e.classList.add("center-block");e.classList.add("text-center");e.style.height="80px";var k=null;null!=g?(k=document.createElement("img"),k.setAttribute("src","https://www.google.com/s2/favicons?domain\x3d"+g),k.setAttribute("height","24"),k.setAttribute("width","24"),k.setAttribute("alt",d),k.classList.add("center-block")):(k=document.createElement("p"),k.style.fontWeight="bold",
k.setAttribute("height","24"),k.setAttribute("width","24"),k.setAttribute("alt",d),k.classList.add("center-block"),k.appendChild(document.createTextNode(d.substring(0,15))));g=document.createElement("div");g.style.textAlign="center";var l=document.createElement("p");l.classList.add("font-weight-bold");l.style.maxWidth="100px";l.style.margin="auto";var m=document.createTextNode(c);l.appendChild(m);g.appendChild(l);l=document.createElement("p");l.style.maxWidth="100px";l.style.margin="auto";"undefined"!=
a&&null!=a&&0<a.length&&(m=a.charAt(0).toUpperCase()+a.substring(1,15),a=document.createTextNode(m),0<f.length&&(a=document.createTextNode(m+"*")),m=document.createElement("strong"),m.appendChild(a),l.appendChild(m),e.appendChild(l),e.appendChild(document.createElement("br")));e.appendChild(k);e.appendChild(g);h.addEventListener("mouseover",function(a){h.style.border="1px solid #828282"},!1);h.addEventListener("mouseout",function(a){h.style.border="none";clearTimeout(copytimer)},!1);h.addEventListener("click",
function(a){var e=document.getElementsByClassName("website-cred-display"),g;for(g=0;g<e.length;g++)e[g].style.background="transparent",makeallchildrentransparent(e[g]);if(a.target.classList.contains("website-cred-display"))a.target.style.background="#e2e2e2";else{for(e=a.target;!e.classList.contains("website-cred-display");)e=e.parentElement;e.classList.contains("website-cred-display")&&(e.style.background="#e2e2e2")}copyInfoToClipboard(a,d,c,b,f)},!1);k=document.getElementById("securedata-sites");
h.appendChild(e);createcardlayout(k,h)}}function makeallchildrentransparent(a){for(var d=0;d<a.childNodes.length;d++){var c=a.childNodes[d];makeallchildrentransparent(c);c.style&&(c.style.background="transparent")}}
function copyInfoToClipboard(a,d,c,b,f){a.target.style.background="#e2e2e2";var e;null==document.getElementById("securedata-sites")&&(e="Org");if(null==copyclickmap[d+c]){for(var g in copyclickmap)delete copyclickmap[g];copyclickmap[d+c]=1;$("#sitessettingfootercollapse").collapse("show");g=document.createElement("input");document.body.appendChild(g);g.setAttribute("value",c);g.select();document.execCommand("copy");document.body.removeChild(g);g=document.getElementById("sitessettingfootercontent");
if(null!=g){var h=document.createElement("p");h.setAttribute("id","sitesettingnotification");h.appendChild(document.createTextNode("Username "+c+" for "+d+" copied to clipboard. Click once more to open the site in a different window"));g.innerHTML="";h=d;15<h.length&&(h=d.substring(0,15));displaybuttonbehavior(a,"Username copied to clipboard. Click again to open "+h);h=document.createElement("BUTTON");h.classList.add("btn");h.classList.add("btn-xs");h.classList.add("pull-right");h.style.marginRight=
"10px";h.classList.add("btn-default");h.onclick=function(a){deletesiteinfo(d,c,e)};h.innerHTML="Delete Credential";var k=document.createElement("BUTTON");k.classList.add("btn");k.classList.add("btn-xs");k.classList.add("pull-right");k.style.marginRight="10px";k.classList.add("btn-default");k.onclick=function(a){changepasswordmodal(d,c,e)};k.innerHTML="Change password";a=document.createElement("BUTTON");a.classList.add("btn");a.classList.add("btn-xs");a.classList.add("pull-right");a.style.marginRight=
"10px";a.classList.add("btn-default");a.onclick=function(a){sharesiteinfomodal(d,c,b,e)};a.innerHTML="Share Credential";var l=document.createElement("BUTTON");l.classList.add("btn");l.classList.add("btn-xs");l.classList.add("pull-right");l.style.marginRight="10px";l.classList.add("btn-default");l.onclick=function(a){viewsiteinfo(d,c)};l.innerHTML="View Credential";var m=document.createElement("BUTTON");m.classList.add("btn");m.classList.add("btn-xs");m.classList.add("btn-default");m.style.marginLeft=
"10px";m.onclick=function(a){copyusernametocb(d,c,b,e)};m.innerHTML="Copy Password";g.appendChild(m);g.appendChild(l);g.appendChild(h);g.appendChild(k);if(null!=document.getElementsByClassName("user-org")){h=document.getElementsByClassName("user-org");k=[];for(l=0;l<h.length;l++)k.push(h[l].getAttribute("data-orgid"));if(null!=k&&0<k.length&&(g.appendChild(a),a="","undefined"!==typeof f&&0<f.length&&(a=JSON.parse(f)),0<a.length)){f="";for(h=0;h<a.length;h++)if(4>h)f+=a[h],h<a.length-1&&(f+=", ");
else if(4==h)f+="...";else break;a=document.createElement("p");a.setAttribute("id","siteshareinfo");a.classList.add("text-muted");a.classList.add("pull-right");a.style.padding="3px";a.style.paddingRight="5px";a.appendChild(document.createTextNode("Shared with "+f));g.appendChild(a)}}}}else if(1==copyclickmap[d+c]){for(g in copyclickmap)delete copyclickmap[g];a.target.style.background="#e2e2e2";loadExtUrl(d,c,b);copyclickmap[d+c]++}}
function viewsiteinfo(a,d){if(0<JSON.parse(userdatainsystem).length)for(var c=JSON.parse(userdatainsystem),b=0;b<c.length;b++)if(1==c[b].sequence){for(var f=JSON.parse(decryptwithstretchedkey("sites",vaultkey,c[b].data)),e=0;e<f.length;e++)if(a==f[e].siteUrl&&d==f[e].siteuser){document.getElementById("sites-view-siteUrl").value=f[e].siteUrl;document.getElementById("sites-view-siteuser").value=f[e].siteuser;document.getElementById("sites-view-sitepwd").value=f[e].sitepwd;document.getElementById("sites-view-sitedesc").value=
f[e].sitedesc;document.getElementById("sites-view-sitename").value=f[e].sitename;if("undefined"!=typeof f[e].oldpwds&&0<f[e].oldpwds.length){document.getElementById("sites-view-siteoldpass").style.display="block";document.getElementById("sites-view-siteoldpass-tbl").innerHTML="";a=document.createElement("tr");d=document.createElement("th");var g=document.createElement("th");d.style.fontSize="11px";g.style.fontSize="11px";d.textContent="Password";g.textContent="Changed";a.appendChild(d);a.appendChild(g);
document.getElementById("sites-view-siteoldpass-tbl").appendChild(a);for(d=f[e].oldpwds.length-1;0<=d;d--){g=f[e].oldpwds[d];a=document.createElement("tr");const c=document.createElement("td"),b=document.createElement("td");c.textContent=g.password;b.textContent=gettimedifference(g.changed,!0)+" ago";c.style.fontSize="10px";b.style.fontSize="10px";a.appendChild(c);a.appendChild(b);document.getElementById("sites-view-siteoldpass-tbl").appendChild(a)}}else document.getElementById("sites-view-siteoldpass").style.display=
"none",document.getElementById("sites-view-siteoldpass-tbl").innerHTML="";"undefined"!=typeof f[e].sharedwith&&0<f[e].sharedwith.length?(document.getElementById("sites-view-sharedwith-div").style.display="block",document.getElementById("sites-view-sharedwith").value=JSON.stringify(f[e].sharedwith),f=f[e].sharedwith.join("\x3cbr\x3e"),document.getElementById("sites-view-sharedwith-disp").innerHTML=f):(document.getElementById("sites-view-sharedwith").value="",document.getElementById("sites-view-sharedwith-div").style.display=
"none",document.getElementById("sites-view-sharedwith-disp").innerHTML="");document.getElementById("sites-view-seq").value=c[b].sequence;document.getElementById("sites-view-slt").value=c[b].salt;document.getElementById("sites-view-itns").value=c[b].iterations;document.getElementById("sites-view-crdate").value=c[b].createdate;document.getElementById("sites-view-upddate").value=c[b].lastupdatedate;document.getElementById("sites-view-accdate").value=c[b].lastaccessdate;document.getElementById("cred-ctrl-data").innerHTML=
"Salt:"+c[b].salt+"| Iter:"+c[b].iterations+"| Created:"+(new Date(c[b].createdate)).toLocaleDateString()+"| Updated:"+gettimedifference(c[b].lastupdatedate,!0)+" ago| Accessed:"+gettimedifference(c[b].lastaccessdate,!0)+" ago";break}break}$("#sitesviewModal").modal("show")}
function sharesiteinfomodal(a,d,c,b,f,e){delete copyclickmap[a+d];document.getElementById("orgsharemodal-orgcheckboxes").innerHTML="";document.getElementById("orgsharemodal-sites-siteurl-disp").innerHTML="";$("#sitessettingfootercollapse").collapse("hide");document.getElementById("orgsharemodal-sites-siteurl-disp").appendChild(document.createTextNode(d+" at "+a));document.getElementById("orgsharemodal-sites-siteurl").value=a;document.getElementById("orgsharemodal-sites-siteuser").value=d;document.getElementById("orgsharemodal-sites-sitepwd").value=
c;document.getElementById("orgsharemodal-sites-sitedesc").value=f;document.getElementById("orgsharemodal-sites-sitename").value=e;a=document.getElementsByClassName("user-org");for(d=0;d<a.length;d++)c=document.createElement("DIV"),c.classList.add("form-check"),b=document.createElement("label"),b.classList.add("form-check-label"),f=document.createElement("input"),f.classList.add("form-check-input"),f.setAttribute("type","checkbox"),f.setAttribute("name","orgsharemodal-selected-orgs-checkbox"),f.value=
a[d].getAttribute("data-orgid"),b.appendChild(f),b.appendChild(document.createTextNode(" "+a[d].getAttribute("data-orgname"))),c.appendChild(b),document.getElementById("orgsharemodal-orgcheckboxes").appendChild(c);$("#datetimepickerst").datetimepicker();$("#datetimepickeren").datetimepicker({useCurrent:!1});$("#datetimepickerst").on("dp.change",function(a){$("#datetimepickeren").data("DateTimePicker").minDate(a.date)});$("#datetimepickeren").on("dp.change",function(a){$("#datetimepickerst").data("DateTimePicker").maxDate(a.date)});
$("#orgsharemodal").modal("show")}
function sharecredentialwithorgs(){for(var a=document.getElementsByName("orgsharemodal-selected-orgs-checkbox"),d=[],c=0;c<a.length;c++)if(a[c].checked){d.push(a[c].value);for(var b=document.getElementsByClassName("user-org"),f=0;f<b.length;f++)if(b[f].getAttribute("data-orgid")==a[c].value){orgownerflake=b[f].getAttribute("data-orgownerflake");break}extractorgkeyandaddsite(a[c].value,orgownerflake,function(a,c,b){for(var d=document.getElementsByName("infoshareoption"),e=0,f=d.length;e<f;e++)if(d[e].checked)if("R"==
d[e].value)readcurrentcredetialsinorg(a,c,b,0,null);else if("T"==d[e].value){console.log("Time fenced share.. will add it as fresh data");var g=document.getElementById("datetimepickerst").getElementsByTagName("INPUT")[0].value;readcurrentcredetialsinorg(a,c,b,1,g)}})}0==d.length&&(document.getElementById("share-credential-update-notification").innerHTML="Please select an org. ")}
function extractorgkeyandaddsite(a,d,c){orgID=a;orgownerflake=d;orgkey=null;if(null==otherkeys||0==otherkeys.length)console.log("No org keys found.. will see if it has arrived in secured data"),getsecureuserdatafromdb("ORGKEY",function(b){extractOrgKeysFromsecuredata(b);c(a,d,orgkey)});else{for(var b=0;b<otherkeys.length;b++)if(otherkeys[b].org&&orgownerflake==otherkeys[b].org.split(":\x3d")[0]&&a==otherkeys[b].org.split(":\x3d")[1]){orgkey=otherkeys[b].privkey;c(a,d,orgkey);break}if(null==orgkey||
0==orgkey.length)console.log("No org key found in otherkeys object.. will see if it has arrived in secured data"),getsecureuserdatafromdb("ORGKEY",function(b){extractOrgKeysFromsecuredata(b);c(a,d,orgkey)})}}
function readcurrentcredetialsinorg(a,d,c,b,f){var e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");e.open("POST","/secure/readorgcredentials",!0);e.withCredentials=!0;e.setRequestHeader("Content-Type","application/json");e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var b=e.responseText;null!=b&&0<b.length&&(b=JSON.parse(b),addsitetoorgcredentials(a,d,c,b))}};e.send(JSON.stringify({ownerflake:d,section:"org-credentials",orgid:a,seq:b,startdate:f}))}
function addsitetoorgcredentials(a,d,c,b){var f={key:"publickey of the user",credential:{siteUrl:document.getElementById("orgsharemodal-sites-siteurl").value,sitedesc:" Shared Credential ",siteuser:document.getElementById("orgsharemodal-sites-siteuser").value,sitepwd:document.getElementById("orgsharemodal-sites-sitepwd").value,sitename:document.getElementById("orgsharemodal-sites-sitename").value}};d=1;var e=[];if(null!=b){console.log("There are existing credentials. Need to add to them.");c=new sjcl.ecc.elGamal.secretKey(sjcl.ecc.curves.c384,
sjcl.ecc.curves.c384.field.fromBits(sjcl.codec.base64.toBits(c)));for(var g=0;g<b.length;g++)if(null!=b[g].data&&0==b[g].seq){e=JSON.parse(sjcl.decrypt(c,b[g].data));e.push(f);d=0;break}}else console.log("There are no existing credentials. Need to create them."),e=[],e.push(f);0==e.length&&e.push(f);f=getEncMessageUsingPublickey(JSON.stringify(e),b[0].publicKey);var h=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");h.open("POST","/secure/addorgdata",!1);h.withCredentials=
!0;h.setRequestHeader("Content-Type","application/json");h.onreadystatechange=function(){4==h.readyState&&200==h.status&&(addsharenoticetocred(a,orgownerflake),document.getElementById("share-credential-update-notification").innerHTML="Credential has been shared successfully with the Org. It will be available in the Org page. ")};e=document.getElementById("datetimepickerst").getElementsByTagName("INPUT")[0].value;c=document.getElementById("datetimepickeren").getElementsByTagName("INPUT")[0].value;
g=document.getElementById("inform-receiver").checked;e=e.replace(/\//g,"-");c=c.replace(/\//g,"-");e=e.replace(/ AM| PM/,":00.000");c=c.replace(/ AM| PM/,":00.000");console.log("going to addorgdata inform-receiver "+g+" start "+e+" end "+c);h.send(JSON.stringify({group:"org-secure",section:"org-credentials",data:f,ownerflake:orgownerflake,orgid:a,createdate:b.createdate,startdate:e,enddate:c,seq:d,dononotify:!g}))}
function addsharenoticetocred(a,d){for(var c=document.getElementById("orgsharemodal-sites-siteurl").value,b=document.getElementById("orgsharemodal-sites-siteuser").value,f="",e=document.getElementsByClassName("user-org"),g=0;g<e.length;g++)if(e[g].getAttribute("data-orgid")==a&&e[g].getAttribute("data-orgownerflake")==d){f=e[g].getAttribute("data-orgname");break}a=JSON.parse(userdatainsystem);for(d=0;d<a.length;d++)if(1===a[d].sequence){e=document.getElementById("securedata-sites").innerHTML;try{var h=
decryptwithstretchedkey("sites",vaultkey,a[d].data);a[d].data=h;var k=JSON.parse(a[d].data);for(g=0;g<k.length;g++)k[g].siteUrl==c&&k[g].siteuser==b&&("undefined"==typeof k[g].sharedwith&&(k[g].sharedwith=[]),k[g].sharedwith.push(f),console.log("Orgname "+f+" tagged with the credential"));0<k.length&&(document.getElementById("sites-data").value=JSON.stringify(k),a[d].data=JSON.stringify(k),submitencuserdata("sites",!1),$("#orgsharemodal").modal("hide"))}catch(l){document.getElementById("securedata-sites").innerHTML=
e;vaultkey="";displaykeyalert("The key you entered is incorrect. Most users use their username as the key here. You need to provide the same key you entered while adding data here. ");$("#changesitepwdmodal").modal("hide");break}}return!1}function changepasswordmodal(a,d,c){document.getElementById("chgmodal-sites-siteUrl").value=a;document.getElementById("chgmodal-sites-siteuser").value=d;$("#changesitepwdmodal").modal("show")}
function copyusernametocb(a,d,c,b){b=document.createElement("input");document.body.appendChild(b);b.setAttribute("value",c);b.select();document.execCommand("copy");document.body.removeChild(b);c=document.getElementById("sitesettingnotification");cleardiv(c);copyclickmap[a+d]=2;c.appendChild(document.createTextNode("Password for user "+d+" @ "+a+" copied to clipboard."));console.log("Copied password to Clipboard")}
function changesitepassword(){for(var a=document.getElementById("chgmodal-sites-siteUrl").value,d=document.getElementById("chgmodal-sites-siteuser").value,c=document.getElementById("chgmodal-sites-sitepwd").value,b=JSON.parse(userdatainsystem),f=0;f<b.length;f++)if(1===b[f].sequence){var e=document.getElementById("securedata-sites").innerHTML;try{var g=decryptwithstretchedkey("sites",vaultkey,b[f].data);b[f].data=g;for(var h=JSON.parse(b[f].data),k=0;k<h.length;k++)if(h[k].siteUrl==a&&h[k].siteuser==
d){if(0==c.length||c==h[k].sitepwd)return alert("Invalid new password. It is either blank or same as old password."),$("#changesitepwdmodal").modal("hide"),!1;var l="Do you want to change the password for "+d+" @ "+a;"undefined"!=typeof h[k].source&&0<h[k].source.length&&(l="This credential was imported from "+h[k].source+". You may want to update this password in the file first. Click OK to update the password in the vault first.");if(confirm(l)&&("undefined"==typeof h[k].oldpwds&&(h[k].oldpwds=
[]),h[k].oldpwds.push({password:h[k].sitepwd,changed:new Date}),h[k].sitepwd=c,1==copyclickmap[a+d]))for(var m in copyclickmap)delete copyclickmap[m]}0<h.length&&(document.getElementById("sites-data").value=JSON.stringify(h),b[f].data=JSON.stringify(h),submitencuserdata("sites",!1));$("#changesitepwdmodal").modal("hide")}catch(n){document.getElementById("securedata-sites").innerHTML=e;vaultkey="";displaykeyalert("The key you entered is incorrect. Most users use their username as the key here. You need to provide the same key you entered while adding data here. ");
$("#changesitepwdmodal").modal("hide");break}}$("#changesitepwdmodal").modal("hide");return!1}
function deletesiteinfo(a,d,c){if(confirm("Do you want to delete credentials stored for "+d+" @ "+a)){var b={};b="undefined"==typeof c?JSON.parse(userdatainsystem):JSON.parse(orgdatainsystem);for(var f=0;f<b.length;f++)if(1===b[f].sequence){var e="";"undefined"==typeof c||null==c?e=document.getElementById("securedata-sites").innerHTML:"Org"==c&&(e=document.getElementById("org-credentials").innerHTML);try{var g=decryptwithstretchedkey("sites",vaultkey,b[f].data);b[f].data=g;for(var h=JSON.parse(b[f].data),
k=0;k<h.length;k++)h[k].siteUrl==a&&h[k].siteuser==d&&delete h[k];var l=h.filter(function(a){return null!=a});0<l.length?(document.getElementById("sites-data").value=JSON.stringify(l),b[f].data=JSON.stringify(l),submitencuserdata("sites",!1)):clearAll("sites")}catch(m){null!=document.getElementById("securedata-sites")?document.getElementById("securedata-sites").innerHTML=e:document.getElementById("org-credentials").innerHTML=e;vaultkey="";displaykeyalert("The key you entered is incorrect. Most users use their username as the key here. You need to provide the same key you entered while adding data here. ");
break}}}}function findnumberofchidrennodes(a,d){for(var c=0,b=0;b<a.children.length;b++)a.children[b].className==d&&c++;return c}
function createcardlayout(a,d){if(0==a.children.length){var c=document.createElement("div");c.classList.add("row");c.appendChild(d);a.appendChild(c)}else for(var b=0;b<a.children.length;b++)"row"==a.children[b].className&&(c=a.children[b],6>findnumberofchidrennodes(c,"col-xs-2")?c.appendChild(d):b==a.children.length-1&&(c=document.createElement("div"),c.classList.add("row"),c.appendChild(d),a.appendChild(c)))}
function addFinDataToSecurePage(){var a=document.getElementById("fin-institution").value;var d=document.getElementById("fin-acctNum").value;var c=document.getElementById("fin-accType").value;var b=document.createElement("div");b.classList.add("col-xs-2");var f=document.createElement("div");f.classList.add("text-center");var e=document.createElement("p");e.classList.add("lead");e.style.wordWrap="break-word";e.style.maxWidth="80%";e.style.display="inline-block";a=document.createTextNode(a);e.appendChild(a);
f.appendChild(e);e=document.createElement("br");f.appendChild(e);e=document.createElement("p");e.style.wordWrap="break-word";e.style.maxWidth="80%";e.style.display="inline-block";a=document.createTextNode(c);e.appendChild(a);f.appendChild(e);e=document.createElement("br");f.appendChild(e);e=document.createElement("p");e.style.wordWrap="break-word";e.style.maxWidth="50%";e.style.display="inline-block";a=document.createTextNode(d);e.appendChild(a);f.appendChild(e);b.appendChild(f);createcardlayout(document.getElementById("securedata-fin"),
b)}
function addFileDataToSecurePage(a){var d=a.filename,c=a.filetype,b=a.filesize,f=a.fileseq,e=a.createtime;filedatamap[d+f]=a;a=document.createElement("div");a.classList.add("row");var g=document.createElement("div");g.classList.add("col-xs-4");var h=document.createElement("a");h.classList.add("filecontentlink");0==c.length&&(c="text");c.startsWith("image");h.href="javascript:loadfilecontentonmodal('"+d+"','"+f+"');";h.innerHTML=d;g.appendChild(h);a.appendChild(g);g=document.createElement("div");g.classList.add("col-xs-4");
d=document.createElement("p");d.style.wordWrap="break-word";d.style.maxWidth="50%";d.style.display="inline-block";b=document.createTextNode(getReadableFileSizeString(b));d.appendChild(b);g.appendChild(d);a.appendChild(g);g=document.createElement("div");g.classList.add("col-xs-4");d=document.createElement("p");d.style.wordWrap="break-word";d.style.maxWidth="50%";d.style.display="inline-block";b=document.createTextNode((new Date(e)).toLocaleString());d.appendChild(b);g.appendChild(d);a.appendChild(g);
document.getElementById("securedata-oth").insertBefore(a,document.getElementById("securedata-oth").firstChild)}
function getuserdatafromdb(a,d){var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("POST","/secure/getuserdata",!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){if(4==c.readyState&&200==c.status)if(null!=c.responseText&&0<c.responseText.length){var a=JSON.parse(c.responseText),f="ERROR";try{f=sjcl.decrypt(vaultkey,a.data)}catch(e){console.log("Could not decrypt payload based on vault key. Error \x3e "+
e)}d(f)}else console.log("There was NO key data in DB for this User, generating fresh userkey"),generatenewuserkey(),d("ERROR")};c.send(JSON.stringify({sequence:a}))}
function getsecureuserdatafromdb(a,d){null==userkey||0==userkey.length?getuserdatafromdb(0,function(c){if("ERROR"!=c){if("string"===typeof c&&0>c.indexOf('"'))userkey=c;else{c=JSON.parse(c);userkey=c[0];for(var b=1;b<c.length;b++)c[b].org&&otherkeys.push(c[b])}null!=userkey&&0<userkey.length&&readsecuredataforuserbytag(a,d)}else console.log("Invalid Keydata received for user "+c)}):readsecuredataforuserbytag(a,d)}
function readsecuredataforuserbytag(a,d){if(null==userkey||0==userkey.length)console.log("No user key found. Can not read secure data");else{var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("POST","/secure/getsecureuserdata",!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){if(4==c.readyState&&200==c.status)if(null!=c.responseText&&0<c.responseText.length){var a=JSON.parse(c.responseText),f="ERROR";
try{var e=new sjcl.ecc.elGamal.secretKey(sjcl.ecc.curves.c384,sjcl.ecc.curves.c384.field.fromBits(sjcl.codec.base64.toBits(userkey)));f=JSON.parse(sjcl.decrypt(e,a.data))}catch(g){console.log("Could not decrypt payload based on user key. Error \x3e "+g)}d(f)}else console.log("There was NO secure message with that tag for this User")};c.send(JSON.stringify({tag:a}))}}
function generatenewuserkey(){var a=sjcl.ecc.elGamal.generateKeys(384),d=a.pub.get();a=a.sec.get();d=sjcl.codec.base64.fromBits(d.x.concat(d.y));a=sjcl.codec.base64.fromBits(a);a=encryptdatawithstretchedkey(a,vaultkey,"",0);var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("POST","/secure/rotateuserkeys",!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){};c.send(JSON.stringify({publicKey:d,encprivatekey:a}))}
function getfilecontentfromdb(a,d){var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("POST","/secure/getuserdata",!1);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var b=JSON.parse(c.responseText);null!=b&&(b=decryptwithstretchedkey("oth",vaultkey,b.data),document.getElementById("secure-file-content").value=JSON.parse(b).content,filedatamap[a+d].content=JSON.parse(b).content,
updatefilecontentmodal(a,d))}};c.send(JSON.stringify({sequence:d,createdate:document.getElementById("oth-crdate").value}))}
function updatefilecontentmodal(a,d){var c=filedatamap[a+d].filetype,b=filedatamap[a+d].filesize;d=filedatamap[a+d].fileseq;d=filedatamap[a+d].content;filenametodownload=a;document.getElementById("file-header").innerHTML=a+" Size:["+getReadableFileSizeString(b)+"] Created:[ "+document.getElementById("oth-crdate").value+"]";a="data:"+c+";base64,"+d;c.startsWith("image")?document.getElementById("filedisplayarea").innerHTML='\x3cimg src\x3d"'+a+'" class\x3d"modal-image-display"/\x3e':document.getElementById("filedisplayarea").innerHTML=
'\x3cobject width\x3d"100%" data\x3d"'+a+'"\x3e';$("#fileContentModal").modal("show")}function loadfilecontentonmodal(a,d){document.getElementById("filedisplayarea").innerHTML="";var c=null;"undefined"!=typeof filedatamap[a+d]&&(c=filedatamap[a+d].content);"undefined"===typeof c||null==c||0==c.length?getfilecontentfromdb(a,d):updatefilecontentmodal(a,d)}
function decryptwithstretchedkey(a,d,c){var b=""==document.getElementById(a+"-slt").value?sjcl.codec.hex.toBits("cf7488cd1e48e84990f51b3f121e161318ba2098aa6c993ded1012c955d5a3e8"):sjcl.codec.hex.toBits(document.getElementById(a+"-slt").value);"0"==document.getElementById(a+"-itns").value?(document.getElementById(a+"-itns").value=1E4,sjcl.misc.pbkdf2(d,b,100,256)):sjcl.misc.pbkdf2(d,b,document.getElementById(a+"-itns").value,256);try{var f=sjcl.decrypt(d,c)}catch(e){throw e;}return f}
function encryptwithstretchedkey(a,d){""==document.getElementById(a+"-slt").value&&(document.getElementById(a+"-slt").value="cf7488cd1e48e84990f51b3f121e161318ba2098aa6c993ded1012c955d5a3e8");var c=sjcl.codec.hex.toBits(document.getElementById(a+"-slt").value);0==document.getElementById(a+"-itns").value?(document.getElementById(a+"-itns").value=1E4,sjcl.misc.pbkdf2(d,c,1E4,256)):sjcl.misc.pbkdf2(d,c,document.getElementById(a+"-itns").value,256);return encryptdatawithstretchedkey(document.getElementById(a+
"-data").value,d,document.getElementById(a+"-slt").value,document.getElementById(a+"-itns").value)}
function fileUpload(){var a=document.getElementById("secure-file"),d="";if("files"in a)if(0==a.files.length)d="Select one or more files.";else for(var c=0;c<a.files.length;c++){d+="\x3cbr\x3e\x3cstrong\x3e"+(c+1)+". file\x3c/strong\x3e\x3cbr\x3e";var b=a.files[c];"name"in b&&(d+="name: "+b.name+"\x3cbr\x3e");"size"in b&&(d+="size: "+b.size+" bytes \x3cbr\x3e")}else d=""==a.value?d+"Select one or more files.":d+"The files property is not supported by your browser!\x3cbr\x3eThe path of the selected file: "+
a.value;document.getElementById("filedisplay").innerHTML=d}
function fileImport(){var a=document.getElementById("import-file"),d="";if("files"in a)if(0==a.files.length)d="Select a file";else for(var c=0;c<a.files.length;c++){d+="\x3cbr\x3e\x3cstrong\x3e"+(c+1)+". file\x3c/strong\x3e\x3cbr\x3e";var b=a.files[c];"name"in b&&(d+="name: "+b.name+"\x3cbr\x3e");"size"in b&&(d+="size: "+b.size+" bytes \x3cbr\x3e")}else d=""==a.value?d+"Select a file":d+"The files property is not supported by your browser!\x3cbr\x3eThe path of the selected file: "+a.value;document.getElementById("csvfiledisplay").innerHTML=
d}function downloadfile(){datatodownload=document.getElementById("secure-file-content").value;var a=b64toBlob(datatodownload,ftypetodownload);if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(a,filenametodownload);else{var d=window.document.createElement("a");d.href=window.URL.createObjectURL(a);d.download=filenametodownload;document.body.appendChild(d);d.click();document.body.removeChild(d)}$("#fileContentModal").modal("hide");clearFilecontent();return!1}
function clearFilecontent(){document.getElementById("secure-file-content").value=null;document.getElementById("filedisplayarea").innerHTML="";filenametodownload=null}function b64toBlob(a,d,c){d=d||"";c=c||512;a=atob(a);for(var b=[],f=0;f<a.length;f+=c){for(var e=a.slice(f,f+c),g=Array(e.length),h=0;h<e.length;h++)g[h]=e.charCodeAt(h);e=new Uint8Array(g);b.push(e)}return new Blob(b,{type:d})}
function clearAll(a){0==vaultkey.length&&createvaultkeyoverlay();var d="";"sites"===a&&(d="Websites");"fin"===a&&(d="Accounts");"oth"===a&&(d="Files");if(confirm("Do you want to remove all "+d+" in this view?. Click OK to continue.")){var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");c.open("POST","/secure/clearuserdata",!0);c.withCredentials=!0;c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){4==c.readyState&&200==c.status&&
(showPrivateDataPage(),lastfileseq=100)};c.send(JSON.stringify({sequence:document.getElementById(a+"-seq").value,createdate:document.getElementById(a+"-crdate").value}))}return!1}
function createvaultpagekeyoverlay(a){var d=document.getElementById("vault-page-key-overlay");if(null==d){d=document.createElement("div");d.setAttribute("id","vault-page-key-overlay");document.body.appendChild(d);var c=document.createElement("div");c.classList.add("container");c.classList.add("v-center");var b=document.createElement("div");b.classList.add("row");var f=document.createElement("div");f.classList.add("col-md-8");f.classList.add("col-md-offset-2");var e=document.createElement("div");e.classList.add("panel");
e.classList.add("panel-default");var g=document.createElement("h3");g.appendChild(document.createTextNode(""));g.style.color="#737373";g.style.fontWeight="900";e.appendChild(g);g=document.createElement("span");g.innerHTML="\x26times;";g.style.float="right";g.style.padding="2px 7px";g.style.fontSize="2em";g.style.top="0px";g.style.display="inline-block";g.style.color="#a2a2a2";g.style.cursor="default";g.addEventListener("mouseover",function(a){a.target.style.color="#d3d3d3"});g.addEventListener("mouseout",
function(a){a.target.style.color="#a2a2a2"});g.addEventListener("click",function(){$("#vault-page-key-overlay").fadeOut(500)});f.appendChild(g);g=document.createElement("p");g.classList.add("lead");g.setAttribute("id","createuser-flake-text-header");var h="";h=null==userdatainsystem?"Please enter a Vault Key":"Please enter your Vault Key";g.appendChild(document.createTextNode(h));g.style.color="#737373";g.style.fontWeight="700";e.appendChild(g);g=document.createElement("div");g.classList.add("row");
h=document.createElement("div");h.classList.add("col-sm-8");h.classList.add("col-sm-offset-2");var k=document.createElement("p");k.classList.add("text-muted");k.setAttribute("id","createuser-flake-text");k.appendChild(document.createTextNode("Enter your secret username as your vault key."));k.style.color="#878787";k.style.fontWeight="600";h.appendChild(k);g.appendChild(h);e.appendChild(g);g=document.createElement("div");g.classList.add("panel-body");g.classList.add("panel-word-wrap");h=document.createElement("div");
h.classList.add("row");k=document.createElement("div");k.classList.add("col-sm-8");k.classList.add("col-sm-offset-2");h.appendChild(k);g.appendChild(h);var l=document.createElement("input");l.setAttribute("type","password");l.setAttribute("id","vault-page-key-input");l.setAttribute("autofocus","true");l.classList.add("form-control");l.classList.add("input-md");l.addEventListener("input",function(a){6<=document.getElementById("vault-page-key-input").value.length?$("#page-cde-send-button").fadeIn("slow"):
document.getElementById("page-cde-send-button").style.display="none"},!1);l.addEventListener("keyup",function(b){13===b.keyCode&&(vaultkey=document.getElementById("vault-page-key-input").value,getuserdatafromdb(0,function(b){if("ERROR"!=b){if("string"===typeof b&&0>b.indexOf('"'))userkey=b;else{b=JSON.parse(b);userkey=b[0];for(var c=1;c<b.length;c++)otherkeys.push(b[c])}a&&a();$("#vault-page-key-overlay").fadeOut("slow")}else document.getElementById("vault-page-key-input").style.borderColor="red",
vaultkey=""}))});l.style.color="#646464";var m=document.createElement("input");m.setAttribute("id","page-cde-send-button");m.classList.add("btn");m.classList.add("btn-primary");m.classList.add("btn-md");m.conversationID="";m.changestarttime="";m.type="button";m.value="Submit";m.style.display="none";m.addEventListener("click",function(){vaultkey=document.getElementById("vault-page-key-input").value;getuserdatafromdb(0,function(b){if("ERROR"!=b){if("string"===typeof b&&0>b.indexOf('"'))userkey=b;else{b=
JSON.parse(b);userkey=b[0];for(var c=1;c<b.length;c++)otherkeys.push(b[c])}a&&a();$("#vault-page-key-overlay").fadeOut("slow")}else document.getElementById("vault-page-key-input").style.borderColor="red",vaultkey=""})},!1);var n=document.createElement("div");n.classList.add("col-sm-2");h.appendChild(n);k.appendChild(l);n.appendChild(m);g.appendChild(h);e.appendChild(g);f.appendChild(e);b.appendChild(f);c.appendChild(b);d.appendChild(c);$("#vault-page-key-input").focus()}settimeoutid=setTimeout(function(){$("#vault-page-key-overlay").fadeIn("slow")},
500)};