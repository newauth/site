// Storage adapter that works with localStorage or DB storage // Seeded random number generator // Seeded random number generator - just the random functionality class SeededRandom{constructor(seed){this.seed = seed;}// Generate seeded random number between 0 and 1 random(){const x = Math.sin(this.seed++)* 10000;return x - Math.floor(x);}// Generate random number between min and max randomBetween(min,max){return min + this.random()*(max - min);}}class StorageAdapter{constructor(){this.storagePrefix = 'schema_app_';}async get(key){const value = localStorage.getItem(this.storagePrefix + key);return value ?{key:key,value:value}:null;}async set(key,value){localStorage.setItem(this.storagePrefix + key,value);return{key:key,value:value};}}class DatabaseService{constructor(apiBaseUrl,useLocalStorage){this.apiBaseUrl = apiBaseUrl || '/api';this.storage = new StorageAdapter();this.useLocalStorage = true;// Set to FALSE when using real API this.useLocalStorage =(useLocalStorage === undefined)? true:Boolean(useLocalStorage);// this.initStorage();this._getAppSchemasPromise = null;this._getAppSchemasPromise = null;}async initStorage(){try{if(this.useLocalStorage){// ----- localStorage branch ----- const [rawSchemas,rawEntities] = await Promise.all([ this.storage.get('app_schemas'),this.storage.get('native_entities')]);if(!rawSchemas){await this.storage.set('app_schemas',JSON.stringify(this.getDefaultAppSchemas()));}if(!rawEntities){await this.storage.set('native_entities',JSON.stringify(this.getDefaultNativeEntities()));}}else{// ----- server branch ----- const [schemas,entities] = await Promise.all([ this.getAppSchemas(),this.getNativeEntities()]);if(!schemas || schemas.length === 0){for(const s of this.getDefaultAppSchemas())await this.saveAppSchema(s);}if(!entities || Object.keys(entities).length === 0){const defs = this.getDefaultNativeEntities();for(const [key,ent] of Object.entries(defs))await this.saveNativeEntity(key,ent);}this.nativeEntities = entities;}}catch(err){console.error('Storage initialization error:',err);}}generateUUID(){// Simple UUID v4 generator return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){const r = Math.random()* 16 | 0;const v = c === 'x' ? r:(r & 0x3 | 0x8);return v.toString(16);});}hashUUID(uuid){// ✅ CRITICAL FIX:Guard against non-string/undefined inputs if(typeof uuid !== 'string' || uuid.length === 0){console.warn('[hashUUID] Invalid input(expected UUID string):',uuid);return '';// Safe fallback - won't match anything,but won't crash}// ✅ OPTIMIZATION:Skip hashing if already hashed(no dashes)if(!uuid.includes('-')){// Already a hashed ID - return as-is return uuid;}// Original hashing logic(only runs on actual UUIDs)const FNV_OFFSET = BigInt("0xcbf29ce484222325");const FNV_PRIME = BigInt("0x100000001b3");let hash = FNV_OFFSET;for(let i = 0;i < uuid.length;i++){hash ^= BigInt(uuid.charCodeAt(i));hash *= FNV_PRIME;}hash &= BigInt("0xffffffffffffffff");return hash.toString(36).toLowerCase();}createCustomSchema(id,name,description,hierarchy,fieldMappings){const entityConfigs ={};hierarchy.forEach(function(entityType,index){const nextEntity = index < hierarchy.length - 1 ? hierarchy[index + 1]:null;const childrenField = nextEntity ? nextEntity + 's':null;const mapping = fieldMappings[entityType] ||{labelField:entityType + '_name',idField:entityType + '_id'};// Build the base config entityConfigs[entityType] ={labelField:mapping.labelField,idField:mapping.idField,childEntity:nextEntity,childrenField:childrenField};// Add sort configuration if provided in fieldMappings if(mapping.sortConfig){entityConfigs[entityType].sortConfig = mapping.sortConfig;}else if(childrenField){// Only add sort config for entities that have children // For count type,no aggregate function needed entityConfigs[entityType].sortConfig ={type:mapping.sortType || 'count'};// Only add aggregate fields if explicitly specified if(mapping.sortType === 'aggregate' && mapping.aggregateField){entityConfigs[entityType].sortConfig.aggregateField = mapping.aggregateField;entityConfigs[entityType].sortConfig.aggregateFunction = mapping.aggregateFunction || 'sum';}}});return{id:id,name:name,description:description,hierarchy:hierarchy,entityConfigs:entityConfigs};}getDefaultAppSchemas(){return [this.createCustomSchema('custsupport','Customer Support','Customer support workflow management',['tenant','customer','concern'],{tenant:{labelField:'name',// ✅ Changed from 'orgname' to 'name' idField:'ID',childEntity:'customer',childrenField:'customers',sortConfig:{type:'count' // Tenant dots sized by number of customers}},customer:{labelField:'name',// ✅ Changed from 'orgname' to 'name' idField:'ID',childEntity:'concern',childrenField:'concerns',sortConfig:{type:'aggregate',aggregateField:'count',aggregateFunction:'sum'}},concern:{labelField:'name',// ✅ Changed from 'concerntype' to 'name' idField:'ID',childEntity:null,childrenField:null // No sortConfig - concerns are leaf nodes}})];}getDefaultNativeEntities(){return{tenant:{name:'Tenant',description:'Top-level organization',fields:[ // ✅ BASE ENTITY FIELDS(mandatory){name:'ID',label:'Organization ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'displayID',label:'Display ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'name',label:'Organization Name',type:'text',mandatory:true,writePermission:'any',dataSource:'manual'},{name:'dotLabel',label:'Dot Label',type:'text',mandatory:true,writePermission:'any',dataSource:'manual'},// ✅ EXISTING CUSTOM FIELDS{name:'contactemail',label:'Contact Email',type:'email',mandatory:true,writePermission:'any',dataSource:'manual'},// ✅ ADDITIONAL OPTIONAL FIELDS{name:'image',label:'Logo/Image URL',type:'url',mandatory:false,writePermission:'any',dataSource:'manual'},{name:'website',label:'Website URL',type:'url',mandatory:false,writePermission:'any',dataSource:'manual'},// ✅ SYSTEM FIELDS{name:'hashed',label:'Use Hashed URL',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'count',label:'Count(for aggregation)',type:'number',mandatory:false,writePermission:'any',dataSource:'manual'},{name:'timestamp',label:'Timestamp',type:'number',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'hidden',label:'Hidden',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},// ✅ PERMISSION & METADATA FIELDS{name:'writeAccess',label:'Write Access',type:'select',mandatory:false,writePermission:'root',dataSource:'manual',options:['owner','parent','ancestor','any']},{name:'readAccess',label:'Read Access',type:'select',mandatory:false,writePermission:'root',dataSource:'manual',options:['owner','parent','ancestor','any']}]},customer:{name:'Customer',description:'Sub-organization',fields:[ // ✅ BASE ENTITY FIELDS(mandatory){name:'ID',label:'Sub-Organization ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'displayID',label:'Display ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'name',label:'Name',type:'text',mandatory:true,writePermission:'parent',dataSource:'manual'},{name:'dotLabel',label:'Dot Label',type:'text',mandatory:true,writePermission:'parent',dataSource:'manual'},// ✅ EXISTING CUSTOM FIELDS{name:'contactemail',label:'Contact Email',type:'email',mandatory:true,writePermission:'parent',dataSource:'manual'},// ✅ ADDITIONAL OPTIONAL FIELDS{name:'image',label:'Logo/Image URL',type:'url',mandatory:false,writePermission:'parent',dataSource:'manual'},{name:'website',label:'Website URL',type:'url',mandatory:false,writePermission:'parent',dataSource:'manual'},// ✅ SYSTEM FIELDS{name:'timestamp',label:'Timestamp',type:'number',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'hidden',label:'Hidden',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'hashed',label:'Use Hashed URL',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},// ✅ PERMISSION & METADATA FIELDS{name:'writeAccess',label:'Write Access',type:'select',mandatory:false,writePermission:'parent',dataSource:'manual',options:['owner','parent','ancestor','any']},{name:'readAccess',label:'Read Access',type:'select',mandatory:false,writePermission:'parent',dataSource:'manual',options:['owner','parent','ancestor','any']}]},concern:{name:'Concern',description:'Customer concern',fields:[ // ✅ BASE ENTITY FIELDS(mandatory){name:'ID',label:'Concern ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'displayID',label:'Display ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'name',label:'Concern',type:'text',mandatory:true,writePermission:'any',dataSource:'manual'},{name:'dotLabel',label:'Dot Label',type:'text',mandatory:true,writePermission:'any',dataSource:'manual'},// ✅ EXISTING CUSTOM FIELDS{name:'description',label:'Concern details',type:'textarea',mandatory:true,writePermission:'any',dataSource:'manual'},{name:'status',label:'Status',type:'select',mandatory:false,writePermission:'ancestor',dataSource:'manual',options:['Open','In Progress','Resolved','Closed']},// ✅ ADDITIONAL OPTIONAL FIELDS{name:'image',label:'Image URL',type:'url',mandatory:false,writePermission:'any',dataSource:'manual'},{name:'website',label:'Reference URL',type:'url',mandatory:false,writePermission:'any',dataSource:'manual'},// ✅ SYSTEM FIELDS{name:'timestamp',label:'Timestamp',type:'number',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'hidden',label:'Hidden',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'hashed',label:'Use Hashed data',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'convid',label:'Conversation ID',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},// ✅ PERMISSION & METADATA FIELDS{name:'writeAccess',label:'Write Access',type:'select',mandatory:false,writePermission:'ancestor',dataSource:'manual',options:['owner','parent','ancestor','any']},{name:'readAccess',label:'Read Access',type:'select',mandatory:false,writePermission:'ancestor',dataSource:'manual',options:['owner','parent','ancestor','any']}]}};}// API INTEGRATION POINT #1 _invalidateSchemasCache(){this._getAppSchemasPromise = null;}async getAppSchemas(){if(this.useLocalStorage){const result = await this.storage.get('app_schemas');return result ? JSON.parse(result.value):this.getDefaultAppSchemas();}if(!this._getAppSchemasPromise){this._getAppSchemasPromise = fetch(this.apiBaseUrl + "/appschemas").then(r =>{if(!r.ok)throw new Error("schemas");return r.json();});}return this._getAppSchemasPromise;}// API INTEGRATION POINT #2 async saveAppSchema(schema){if(this.useLocalStorage){const schemas = await this.getAppSchemas();const index = schemas.findIndex(function(s){return s.id === schema.id;});index >= 0 ? schemas[index] = schema:schemas.push(schema);await this.storage.set('app_schemas',JSON.stringify(schemas));return true;}const res = await fetch(this.apiBaseUrl + "/saveappschemas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(schema)});if(!res.ok)throw new Error("Failed to save schema");this._invalidateSchemasCache();return true;}// API INTEGRATION POINT #3 async deleteAppSchema(id){if(this.useLocalStorage){const schemas = await this.getAppSchemas();await this.storage.set('app_schemas',JSON.stringify(schemas.filter(function(s){return s.id !== id;})));return true;}const res = await fetch(this.apiBaseUrl + "/removeappschema/" + encodeURIComponent(id),{method:"DELETE"});if(!res.ok)throw new Error("Failed to delete schema");this._invalidateSchemasCache();return true;}// API INTEGRATION POINT #4 async getNativeEntities(){.stack);if(this.useLocalStorage){const result = await this.storage.get('native_entities');return result ? JSON.parse(result.value):this.getDefaultNativeEntities();}const res = await fetch(this.apiBaseUrl + "/getnativeentities");if(!res.ok)throw new Error("Failed to fetch native entities");return await res.json();}// API INTEGRATION POINT #5 async saveNativeEntity(entityKey,entity){if(this.useLocalStorage){const entities = await this.getNativeEntities();entities[entityKey] = entity;await this.storage.set('native_entities',JSON.stringify(entities));return true;}const res = await fetch(this.apiBaseUrl + "/savenativeentity/" + encodeURIComponent(entityKey),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(entity)});if(!res.ok)throw new Error("Failed to save native entity");return true;}// API INTEGRATION POINT #6 async deleteNativeEntity(entityKey){if(this.useLocalStorage){const entities = await this.getNativeEntities();delete entities[entityKey];await this.storage.set('native_entities',JSON.stringify(entities));return true;}const res = await fetch(this.apiBaseUrl + "/removenativeentity/" + encodeURIComponent(entityKey),{method:"DELETE"});if(!res.ok)throw new Error("Failed to delete native entity");return true;}// API INTEGRATION POINT #7 _invalidateAppDataCache(appId){this._appDataPromises.delete(appId);}async getAppData(appId,forcePath = null){if(this.useLocalStorage){const res = await this.storage.get('app_data_' + appId);return res ? JSON.parse(res.value):{items:[]};}// Create cache key that includes forcePath const cacheKey = forcePath ? `${appId}_${forcePath.join('/')}`:appId;if(!this._appDataPromises.has(cacheKey)){let url;if(forcePath !== null){// Use forced path instead of URL context if(forcePath.length === 0){// Full hierarchy - no path url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}`;}else if(forcePath.length === 1){// Tenant level url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}/${encodeURIComponent(forcePath[0])}`;}else if(forcePath.length >= 2){// Subtenant level url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}/${encodeURIComponent(forcePath[0])}/${encodeURIComponent(forcePath[1])}`;}}// ---- Original logic for when forcePath is null ---- else{const urlInfo = window.app.parseUrlForDataFetch();// NEW LOGIC:If owner and at root app URL → fetch ALL tenants if(typeof isowner !== 'undefined' && isowner && urlInfo && !urlInfo.tenantId && !urlInfo.subtenantId){// Fetch full data for owner at root url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}`;}// Subtenant view:3-segment URL(from direct URL)else if(urlInfo && urlInfo.subtenantId){url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}/${encodeURIComponent(urlInfo.tenantId)}/${encodeURIComponent(urlInfo.subtenantId)}`;}// Tenant view:2-segment URL(from direct URL)else if(urlInfo && urlInfo.tenantId){url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}/${encodeURIComponent(urlInfo.tenantId)}`;}// Check saved context from lastViewedContexts(for returning users)else{const savedContext = app.getLastViewedContext(appId);if(savedContext && savedContext.pathIds && savedContext.pathIds.length > 0){// Use saved context - convert to hashed IDs if needed const pathIds = savedContext.pathIds.map(id =>{// If it's a real UUID,hash it for server if(id.includes('-')){return this.hashUUID(id);}// If it's already hashed,use as-is return id;});if(pathIds.length === 1){// Tenant level context url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}/${encodeURIComponent(pathIds[0])}`;}else if(pathIds.length >= 2){// Subtenant level context url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}/${encodeURIComponent(pathIds[0])}/${encodeURIComponent(pathIds[1])}`;}else{// Fallback to root url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}`;}}// Final fallback else{url = `${this.apiBaseUrl}/getappdata/${encodeURIComponent(appId)}/system`;}}}const p = fetch(url).then(async res =>{if(res.status === 404)return{items:[]};if(!res.ok){console.error(`getAppData ${appId}→ ${res.status}`);return{items:[]};}const text = await res.text();if(!text || text === '""' || text === '{}')return{items:[]};try{const parsed = JSON.parse(text);if(!parsed || typeof parsed !== 'object')return{items:[]};if(!Array.isArray(parsed.items))parsed.items = [];return parsed;}catch(e){console.error('JSON parse fail',e,text);return{items:[]};}}).catch(err =>{console.error('Network error in getAppData',err);return{items:[]};});this._appDataPromises.set(cacheKey,p);}return this._appDataPromises.get(cacheKey);}// API INTEGRATION POINT #8 async saveAppData(appId,data){);if(this.useLocalStorage){await this.storage.set('app_data_' + appId,JSON.stringify(data));return true;}const res = await fetch(this.apiBaseUrl + "/saveappdata/" + encodeURIComponent(appId),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});if(!res.ok)throw new Error("Failed to save app data");this._invalidateAppDataCache(appId);return true;}async savePartialAppData(appId,partialData,metadata){if(this.useLocalStorage){// For localStorage,merge with existing data const fullData = await this.getAppData(appId);// Merge logic would go here - for now just save as is await this.storage.set('app_data_' + appId,JSON.stringify(partialData));return true;}// Server API call with metadata const payload ={data:partialData,metadata:metadata};const res = await fetch(this.apiBaseUrl + "/saveappdata/" + encodeURIComponent(appId),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!res.ok)throw new Error("Failed to save partial app data");this._invalidateAppDataCache(appId);return true;}}// Main Orchestrator Class class SchemaOrchestrator{// Add setter to track changes set currentPath(value){.stack);this._currentPath = value;}get currentPath(){return this._currentPath;}constructor(config){this._currentPath = [];config = config ||{};this.db = new DatabaseService(config.apiBaseUrl,config.useLocalStorage);this.currentApp = null;this.currentPath = [];this.data ={items:[]};this.centerZoneRadius = 100;this.dotColors = ['#ff6b6b','#4ecdc4','#45b7d1','#f9ca24','#6c5ce7','#fd79a8'];// In constructor this.searchTerm = '';this.searchResults = null;// Will store search results structure // ✅ VERSION POLLING STATE this.versionPollInterval = null;this.lastKnownTimestamp = 0;this.isPollingActive = false;this.init();}isOwner(){return this.isOwnerUser;}async init(){await this.db.initStorage();// ✅ LOAD NATIVE ENTITIES FIRST(before any URL handling)try{this.nativeEntities = this.db.nativeEntities || this.db.getDefaultNativeEntities();}catch(error){console.error('[init] Failed to load native entities:',error);this.nativeEntities = this.getDefaultNativeEntities();}const urlInfo = this.parseUrlForDataFetch();if(!urlInfo || !urlInfo.appId){if(isowner){await this.loadAppSelector();return;}else{return;}}// Select the app first if(this.currentApp?.id !== urlInfo.appId){await this.selectApp(urlInfo.appId);}const pathDepth = urlInfo.pathIds?.length || 0;const isAppOwner = isowner;// ✅ Use global isowner from JSP);// ✅ Handle root access // ✅ Handle root access - SEPARATE LOGIC FOR OWNER vs NON-OWNER if(pathDepth === 0){const fromAppSelector = window.history.state?.fromAppSelector;const savedContexts = this.getLastViewedContext(urlInfo.appId);const savedContext = savedContexts?.[0];if(isowner){// ✅ APP OWNER:ALWAYS show all tenants at root(ignore context)await this.loadAppSelector();this.data = await this.db.getAppData(this.currentApp.id);this.currentPath = [];// Root level = tenant list}else{// ✅ NON-OWNER:Redirect to saved context tenant(if valid)if(!fromAppSelector && savedContext && savedContext.path?.length > 0){// Build path DIRECTLY from context(no data.items dependency)this.currentPath = [];for(let i = 0;i < savedContext.path.length;i++){const id = savedContext.path[i];const entityType = this.currentApp.hierarchy[i];if(!entityType)break;this.currentPath.push({id:id,displayID:id.includes('-')? this.db.hashUUID(id):id,shortName:id.substring(0,8),// Updated later with real name entityType:entityType});}// Update URL to tenant level const newUrl = this.getAppUrl(this.currentPath);window.history.replaceState({path:this.currentPath},'',newUrl);// Load data FOR THE TENANT(not root)const pathContext = this.currentPath.map(item => item.displayID);this.data = await this.db.getAppData(this.currentApp.id,pathContext);}else{// No valid context - show empty state await this.loadAppSelector();this.data ={items:[]};this.currentPath = [];}}));}// ✅ SECURITY:Rule 2 - Tenant-level access validation else if(pathDepth === 1){if(!isowner){// Only non-app-owners need validation const currentRootId = urlInfo.pathIds[0];const hasRealUuidInUrl = this.isRealUuid(currentRootId);// ✅ CRITICAL FIX:Real UUID in URL = VALID ACCESS TICKET // This is the "shared link" that grants owner-like access if(hasRealUuidInUrl){');// NO further validation needed - real UUID is the access token}else{// For hashed IDs,validate against saved context const savedContexts = this.getLastViewedContext(urlInfo.appId);const savedContext = savedContexts?.[0];let canAccess = false;if(savedContext){const savedTenantId = savedContext.path[0];// Check direct match(both hashed or both real)if(savedTenantId === currentRootId){canAccess = true;}// Check if saved real UUID hashes to URL hash else if(savedTenantId.includes('-')){const hashedSavedId = this.db.hashUUID(savedTenantId);canAccess = hashedSavedId === currentRootId;}}if(!canAccess){this.showNotification('Access restricted:You cannot view this tenant.','error');return;}}}await this.loadAppSelector();const tenantId = urlInfo.pathIds[0];// ✅ EXTRACT ONCE this.data = await this.db.getAppData(this.currentApp.id,[tenantId]);// ✅ FORCE SPECIFIC TENANT FETCH // ✅ Generic path building - find real entity and use its name const entityType = this.currentApp.hierarchy[0];const targetId = urlInfo.pathIds[0];let foundItem = null;if(isowner){// Search in full hierarchy data foundItem = this.data.items.find(item => item.ID === targetId || item.displayID === targetId ||(item.displayname && item.displayname.includes(targetId)));}else{// Browser 2 - first item is the tenant foundItem = this.data.items?.[0];}if(!foundItem){// Try to find by displayname(tenant data structure)foundItem = this.data.items.find(item =>{if(!item)return false;// Check displayname field(tenant structure)if(item.displayname){const parts = item.displayname.split('/');const tenantIdFromDisplayname = parts[parts.length - 1];return tenantIdFromDisplayname === targetId;}// Check ID field(schema structure)if(item.ID === targetId)return true;if(item.displayID === targetId)return true;// Handle case where targetId is hashed but item has real UUID if(item.ID && !targetId.includes('-')&& item.ID.includes('-')){const hashedRealId = this.db.hashUUID(item.ID);return hashedRealId === targetId;}return false;});}this.currentPath = foundItem ? [{id:foundItem.ID,displayID:foundItem.displayID,shortName:this.getShortName(foundItem,entityType),entityType:entityType}]:[{id:targetId,displayID:targetId,shortName:targetId.substring(0,8),entityType:entityType}];}// ✅ Handle deep links else if(pathDepth >= 2){await this.handleIncomingDeepLink();}if(urlInfo?.appId && urlInfo?.pathIds?.length > 0){this.saveContextIfApplicable(urlInfo.appId,urlInfo.pathIds);}this.updateCurrentPathWithRealNames();// ✅ SINGLE RENDER CALL - after all data is loaded if(this.currentApp){this.render();this.updateBreadcrumb();this.updateWatermark();}this.setupEventListeners();this.setupPopstateHandler();this.setupSearch();}updateCurrentPathWithRealNames(){// ✅ CRITICAL FIX:Guard against undefined/empty data if(!this.data?.items || this.data.items.length === 0 || this.currentPath.length === 0 || !this.currentApp){return;}));));// ✅ CRITICAL FIX:Guard firstDataItem access const firstDataItem = this.data.items[0];const firstPathItem = this.currentPath[0];if(!firstDataItem || !firstPathItem){console.warn('[updateCurrentPathWithRealNames] Missing first items - skipping');return;}// ✅ DETECT PARTIAL DATA(Browser 2)const isPartialData =(firstDataItem.entityType !== firstPathItem.entityType ||(firstDataItem.displayID && firstPathItem.displayID && firstDataItem.displayID !== firstPathItem.displayID));let currentItems = this.data.items;let updates = 0;let startIndex = 0;// ✅ SKIP LEVELS THAT DON'T EXIST IN PARTIAL DATA if(isPartialData){// Find which path level matches the first data item for(let i = 0;i < this.currentPath.length;i++){const pathItem = this.currentPath[i];// ✅ CRITICAL FIX:Safe pathItem ID extraction with guards const pathItemId = pathItem?.id || pathItem?.displayID || '';const pathItemDisplayId = pathItem?.displayID || pathItemId;// ✅ CRITICAL FIX:Handle tenant data structure safely const firstDataItemId = firstDataItem?.ID ||(firstDataItem?.displayname ? firstDataItem.displayname.split('/').pop():'')|| firstDataItem?.displayID || '';const matches =(firstDataItem.displayID === pathItemDisplayId || firstDataItemId === pathItemId || // Guarded hashed match check(pathItemId && !pathItemId.includes('-')&& firstDataItemId?.includes('-')&& this.db.hashUUID(firstDataItemId)=== pathItemId));if(matches){startIndex = i;break;}}}// ✅ PROCESS PATH FROM START INDEX for(let i = startIndex;i < this.currentPath.length;i++){const pathItem = this.currentPath[i];const entityType = this.currentApp.hierarchy[i];if(!entityType){console.warn(`⚠️ No entityType at level ${i}`);break;}:`);// ✅ CRITICAL FIX:Safe pathItem ID extraction const pathItemId = pathItem?.id || pathItem?.displayID || '';const pathItemDisplayId = pathItem?.displayID || pathItemId;// ✅ CRITICAL FIX:Enhanced matching with tenant data support and guards const foundItem = currentItems.find(item =>{if(!item)return false;// Match by displayID(most reliable)if(item.displayID === pathItemDisplayId)return true;if(item.ID === pathItemId)return true;// Handle hashed ID matching(guarded)if(pathItemId && !pathItemId.includes('-')&& item.ID?.includes('-')){const hashedRealId = this.db.hashUUID(item.ID);if(hashedRealId === pathItemId)return true;}// ✅ HANDLE TENANT DATA STRUCTURE(displayname field)if(item.displayname){const parts = item.displayname.split('/');const tenantIdFromDisplayname = parts[parts.length - 1];if(tenantIdFromDisplayname === pathItemId || tenantIdFromDisplayname === pathItemDisplayId){return true;}}return false;});if(foundItem){const newName = this.getShortName(foundItem,entityType);if(newName && newName !== 'Unnamed'){this.currentPath[i].shortName = newName;updates++;}else{}// Navigate to children for next level const config = this.currentApp.entityConfigs[entityType];if(config?.childrenField){currentItems = foundItem[config.childrenField] || [];}else{currentItems = [];}}else{console.error(`❌ NO MATCH at level ${i}`);console.error(` Path item:`,pathItem);console.error(` Available items:`,currentItems.map(item =>({ID:item.ID,displayID:item.displayID,displayname:item.displayname,name:item.name})));currentItems = [];// Prevent deeper levels from matching}}|| 'N/A',name:p.shortName})));}showCreateTenantOption(){const container = document.getElementById('canvas-area');if(container){container.innerHTML = ` <div style=" position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:left;padding:30px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);max-width:400px;width:90%;z-index:1000;"> <h2 style="margin:0 0 20px 0;color:#333;font-size:24px;"> Welcome to . Apps ${this.currentApp?.name || 'the app'}! </h2> <p style="margin:0 0 25px 0;color:#666;font-size:16px;"> You don't have an organization account yet.<br> Create one now to get started. </p> <button onclick="window.app.openAddDialog()" class="btn btn-primary" style=" background:#667eea;color:white;border:none;padding:12px 24px;border-radius:6px;font-size:16px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#5a6fd8'" onmouseout="this.style.background='#667eea'" > Create My Organization </button> </div> `;}else{console.error('Canvas area not found!');}// Also update the watermark separately this.updateWatermark();}getShortName(item,entityType){if(!item || !entityType){return 'Unnamed';}// try common fields if(item.name)return item.name;if(item.title)return item.title;if(item.text)return item.text;// Get the entity configuration const config = this.currentApp?.entityConfigs?.[entityType];if(config && config.labelField){// Return the label field value,or fallback to displayID/ID return item[config.labelField] || item.displayID || item.ID || 'Unnamed';}// Final fallback return item.displayID || item.ID || 'Unnamed';}// ✅ REPLACE ENTIRE METHOD - Works with NEW context structure hasSavedContextForApp(appId){if(!appId)return false;try{// ✅ NEW FORMAT:Check savedContexts_{appId}array const contexts = JSON.parse(localStorage.getItem(`savedContexts_${appId}`)|| '[]');// Return true if ANY context exists for this app return Array.isArray(contexts)&& contexts.length > 0;}catch(e){console.error('[hasSavedContextForApp] Parse error for app:',appId,e);return false;}}canEditField(fieldConfig,context){const isDataOwner = this.isDataOwner();// Browser 1 user // Data owners(Browser 1)can always edit everything if(isDataOwner){return true;}// Browser 2 users - check permissions based on their access level switch(fieldConfig.writePermission){case 'any':return true;// Anyone can edit case 'parent':// Can edit if we're at the direct parent level return this.hasParentAccess();case 'ancestor':// Can edit if we have ancestor access(created this entity or are above it)return this.hasAncestorAccess();case 'owner':// Only app owner(rarely used)return false;case 'system':return false;// Never editable default:return false;}}// Check if current user has parent-level access hasParentAccess(){// Browser 2 users have parent access if they're viewing at the level // directly above where this entity would be created const creatingAtDepth = this.currentPath.length;const maxAllowedDepth = this.getMaxAllowedDepth();// If we're at the maximum depth we can access,we can create children return creatingAtDepth === maxAllowedDepth;}// Check if current user has ancestor access hasAncestorAccess(){// Browser 2 users have ancestor access only if they created this specific entity // OR if they have access to an ancestor level // For creation:Browser 2 never has ancestor access(they didn't create ancestors)// For editing:Check if this specific entity was created by current user const isCreating = !this.editingExistingItem;// You'll need to track this if(isCreating){return false;// Browser 2 can't create with ancestor permission}// For editing existing items,check if user has ancestor relationship return this.checkAncestorRelationship();}// Get maximum depth Browser 2 user can access getMaxAllowedDepth(){const savedContext = this.getLastViewedContext(this.currentApp.id);if(!savedContext || !savedContext.pathIds){return 0;}return savedContext.pathIds.length;}// Check if current user has ancestor relationship to specific entity checkAncestorRelationship(){// This would check if the current user's context path is a prefix // of the entity's path,indicating ancestor relationship const entityPath = this.entityBeingEdited?.path || [];const userContextPath = this.currentPath.map(item => item.id);// User is ancestor if their path is a prefix of entity path if(userContextPath.length === 0)return false;for(let i = 0;i < userContextPath.length;i++){if(entityPath[i] !== userContextPath[i]){return false;}}return true;}// ✅ ADD THESE METHODS TO YOUR CLASS(NO MIGRATION LOGIC)// Get ALL contexts for an app(array of context objects)getLastViewedContext(appId){try{return JSON.parse(localStorage.getItem(`savedContexts_${appId}`)|| '[]');}catch(e){console.error('[Context] Parse error:',e);return [];}}isDataOwner(){const urlInfo = this.parseUrlForDataFetch();if(!urlInfo || !urlInfo.appId)return false;// ✅ Get current root entity ID from URL path(first segment)const currentRootId = urlInfo.pathIds?.[0];if(!currentRootId)return false;// Not at tenant level or deeper // ✅ Get ALL saved contexts for this app(array of contexts)const savedContexts = this.getLastViewedContext(urlInfo.appId);if(!savedContexts || !Array.isArray(savedContexts)|| savedContexts.length === 0){return false;}// ✅ Normalize current root ID(UUID → hash,or keep as-is)const currentNormalized = this.isRealUuid(currentRootId)? this.db.hashUUID(currentRootId):currentRootId;// ✅ Check if ANY context grants owner access for this root entity return savedContexts.some(ctx =>{// Skip invalid contexts if(!ctx?.path?.[0] || !ctx.isOwnerAccess)return false;// Normalize context's root ID const ctxRootId = ctx.path[0];const ctxNormalized = this.isRealUuid(ctxRootId)? this.db.hashUUID(ctxRootId):ctxRootId;// Match if normalized IDs are equal return currentNormalized === ctxNormalized;});}// ✅ HELPER:Detect real UUID(not hashed ID)isRealUuid(id){if(!id)return false;// Standard UUID format:8-4-4-4-12 hex digits return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);}// ✅ ADD THIS NEW METHOD(handles context saving for ANY depth)saveContextIfApplicable(appId,pathIds){if(!appId || !pathIds?.length)return;// Detect real UUID in FIRST path segment(root entity)const hasRealUuidInUrl = this.isRealUuid(pathIds[0]);const currentRootId = pathIds[0];const currentNormalized = this.isRealUuid(currentRootId)? this.db.hashUUID(currentRootId):currentRootId;// Get existing contexts const existingContexts = JSON.parse(localStorage.getItem(`savedContexts_${appId}`)|| '[]');// Check for existing owner context for this root entity const existingOwnerContext = existingContexts.find(ctx =>{const ctxRoot = ctx.path[0];const ctxNormalized = this.isRealUuid(ctxRoot)? this.db.hashUUID(ctxRoot):ctxRoot;return ctxNormalized === currentNormalized && ctx.isOwnerAccess;});// Save ONLY if:no existing owner context AND(non-owner OR real UUID detected)const shouldSave = !existingOwnerContext &&(!isowner || hasRealUuidInUrl);if(shouldSave){const newContext ={path:pathIds,timestamp:Date.now(),isOwnerAccess:hasRealUuidInUrl};const updated = [newContext,...existingContexts.slice(0,9)];localStorage.setItem(`savedContexts_${appId}`,JSON.stringify(updated));}else if(existingOwnerContext){}}async handleIncomingDeepLink(){const urlInfo = this.parseUrlForDataFetch();if(!urlInfo || !urlInfo.appId){return;}if(this.currentApp?.id !== urlInfo.appId){await this.selectApp(urlInfo.appId);}const pathDepth = urlInfo.pathIds?.length || 0;// ✅ DETECT REAL UUID IN URL(critical for owner access)const hasRealUuidInUrl = pathDepth >= 1 && this.isRealUuid(urlInfo.pathIds[0]);if(hasRealUuidInUrl){}:',this.isDataOwner());// ✅ DETERMINE DATA STRATEGY let finalData = this.data;const shouldLoadFullData =(pathDepth >= 2 && this.isDataOwner())|| hasRealUuidInUrl;if(shouldLoadFullData){');try{const tenantId = urlInfo.pathIds[0];// Use first path ID(real UUID or hashed)const fullData = await this.db.getAppData(this.currentApp.id,[tenantId]);if(fullData?.items?.length > 0){finalData = fullData;}else{console.warn('[DeepLink] Full data empty,using partial data');}}catch(error){console.error('[DeepLink] Failed to load full data:',error);}}// ✅ BUILD PATH WITH FINAL DATA this.data = finalData;this.currentPath = [];if(shouldLoadFullData && finalData?.items?.length > 0){let currentItems = finalData.items;let pathBuiltSuccessfully = true;for(let i = 0;i < pathDepth;i++){const urlId = urlInfo.pathIds[i];const entityType = this.currentApp.hierarchy[i];if(!entityType || !currentItems){pathBuiltSuccessfully = false;break;}// ✅ MATCH BY REAL UUID WHEN APPLICABLE const foundItem = currentItems.find(item =>{if(this.isRealUuid(urlId)){return item.ID === urlId;// Match real UUID directly}// Standard matching for hashed IDs return item.displayID === urlId ||(!urlId.includes('-')&& item.ID.includes('-')&& this.db.hashUUID(item.ID)=== urlId);});if(foundItem){this.currentPath.push({id:foundItem.ID,displayID:foundItem.displayID,shortName:this.getShortName(foundItem,entityType),entityType:entityType});const config = this.currentApp.entityConfigs[entityType];currentItems =(config?.childrenField && foundItem[config.childrenField])|| [];}else{pathBuiltSuccessfully = false;break;}}if(!pathBuiltSuccessfully){console.warn('[DeepLink] Full data path building failed,falling back to URL path');this.currentPath = urlInfo.pathIds.map((urlId,i)=>{const entityType = this.currentApp.hierarchy[i];if(!entityType)return null;return{id:urlId,displayID:urlId,shortName:urlId.substring(0,8),entityType:entityType};}).filter(Boolean);}}else{// Build path from URL info(partial data)this.currentPath = urlInfo.pathIds.map((urlId,i)=>{const entityType = this.currentApp.hierarchy[i];if(!entityType)return null;// Use real name if available at final level let shortName = urlId.substring(0,8);if(i === pathDepth - 1 && finalData?.items?.[0]){shortName = this.getShortName(finalData.items[0],entityType);}return{id:urlId,displayID:urlId,shortName:shortName,entityType:entityType};}).filter(Boolean);}}getViewingContext(){const urlInfo = this.parseUrlForDataFetch();// ✅ CRITICAL FIX:Check if saved context grants owner access let hasContextOwnerAccess = false;// Only check context if NOT app owner(app owner always has full access)if(!isowner && this.currentApp?.id && urlInfo?.appId === this.currentApp.id){const savedContexts = this.getLastViewedContext(this.currentApp.id);const currentRootId = urlInfo?.tenantId || urlInfo?.pathIds?.[0];if(currentRootId && savedContexts?.length > 0){// Normalize current root ID(UUID → hash,or keep as-is)const currentNormalized = this.isRealUuid(currentRootId)? this.db.hashUUID(currentRootId):currentRootId;// Check if ANY context grants owner access for this tenant hasContextOwnerAccess = savedContexts.some(ctx =>{const ctxRoot = ctx.path[0];const ctxNormalized = this.isRealUuid(ctxRoot)? this.db.hashUUID(ctxRoot):ctxRoot;return ctxNormalized === currentNormalized && ctx.isOwnerAccess;});}}// ✅ Determine final owner status(app owner OR context owner)const isOwnerAccess = isowner || hasContextOwnerAccess;return{isAppOwner:isOwnerAccess,// ✅ TRUE if context grants owner access isLinkUser:!isOwnerAccess,// ✅ FALSE if context grants owner access isTenantView:urlInfo?.tenantId != null && !urlInfo?.subtenantId,isSubtenantView:urlInfo?.subtenantId != null,tenantId:urlInfo?.tenantId,subtenantId:urlInfo?.subtenantId};}// Add this method to your SchemaOrchestrator class updateWatermark(){const watermark = document.getElementById('watermark');if(!watermark)return;const isAtRoot =(this.currentPath.length === 0);const isMobile = window.innerWidth <= 768;const isTablet = window.innerWidth <= 1024 && window.innerWidth > 768;// Clear existing content and cleanup previous hover handlers watermark.innerHTML = '';this.cleanupWatermarkHover();if(!this.currentApp){watermark.style.display = 'none';return;}watermark.style.display = 'block';// Get responsive font sizes const getFontSizes =()=>{if(isMobile){return{base:12,increment:6,max:48};}else if(isTablet){return{base:16,increment:8,max:64};}else{return{base:20,increment:10,max:80};}};const sizes = getFontSizes();// ✅ MOBILE-SPECIFIC POSITIONING let watermarkPositionStyle = ` position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:left;pointer-events:none;opacity:0.15;z-index:1;width:100%;padding:0 20px;box-sizing:border-box;`;if(isMobile){const breadcrumb = document.getElementById('breadcrumb');const topOffset = breadcrumb ?(breadcrumb.offsetHeight + 20):100;watermarkPositionStyle = ` position:absolute;top:${topOffset}px;left:50%;transform:translateX(-50%);text-align:center;pointer-events:none;opacity:0.15;z-index:1;width:100%;padding:0 20px;box-sizing:border-box;`;}if(isAtRoot){// Root level:App name + "items"(generic term)const entityName = this.currentApp.hierarchy[0] || 'items';const displayName = this.getEntityDisplayName(entityName)|| entityName;watermark.innerHTML = ` <div style="${watermarkPositionStyle}"> <div style=" font-size:${sizes.base + 4}px;font-weight:300;color:#666;margin-bottom:8px;letter-spacing:1px;line-height:1.2;">${this.currentApp.name}</div> <div style=" font-size:${sizes.max}px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:2px;line-height:1.1;">${displayName}</div> </div> `;}else{// Dynamic hierarchy levels with smart capping const pathLength = this.currentPath.length;let hierarchyItems = [];// Always show app name hierarchyItems.push({text:this.currentApp.name,level:0,isFocus:false});if(pathLength <= 4){// Show all levels(max 5 total including app)for(let i = 0;i < pathLength;i++){const pathItem = this.currentPath[i];const entityType = this.currentApp.hierarchy[i] || `level_${i + 1}`;const displayName = pathItem.shortName || pathItem.displayID || this.getEntityDisplayName(entityType)|| entityType;hierarchyItems.push({text:displayName,level:i + 1,isFocus:(i === pathLength - 1),id:pathItem.id,entityType:entityType});}}else{// Deep hierarchy(>4 levels):Show app + ... + last 3 levels hierarchyItems.push({text:'...',level:1,isFocus:false,isEllipsis:true});// Show last 3 levels(second-to-last,last-1,focus)const startIdx = pathLength - 3;for(let i = startIdx;i < pathLength;i++){const pathItem = this.currentPath[i];const entityType = this.currentApp.hierarchy[i] || `level_${i + 1}`;const displayName = pathItem.shortName || pathItem.displayID || this.getEntityDisplayName(entityType)|| entityType;hierarchyItems.push({text:displayName,level:i + 1,isFocus:(i === pathLength - 1),id:pathItem.id,entityType:entityType});}}// Calculate font sizes with dramatic scaling let html = `<div style="${watermarkPositionStyle}">`;hierarchyItems.forEach((item,index)=>{let fontSize;if(item.isFocus){fontSize = sizes.max;}else{// Scale down based on distance from focus const distanceFromEnd = hierarchyItems.length - 1 - index;fontSize = Math.max(sizes.base,sizes.max -(distanceFromEnd * sizes.increment));}const fontWeight = item.isFocus ? 800:(300 +(index * 100));const colorBrightness = item.isEllipsis ? 180:(200 -(index * 20));const color = item.isFocus ? '#bbb':`rgb(${colorBrightness},${colorBrightness},${colorBrightness})`;const letterSpacing = item.isFocus ? '3px':(item.isEllipsis ? '2px':'1px');const textTransform = item.isFocus ? 'uppercase':'none';const marginBottom = item.isFocus ? '0':'6px';const maxWidth = item.isFocus ? '90%':'80%';// Truncate long names on mobile const overflowStyle = isMobile ? 'overflow:hidden;text-overflow:ellipsis;white-space:nowrap;':'';// Only focused items should have pointer events for hover const pointerEvents = item.isFocus ? 'pointer-events:auto;cursor:default;':'';// ✅ DETERMINE IF THIS IS THE LAST/FOCUSED ITEM const isLastItem = item.isFocus;// or however you determine the last item // Add animation class if it's the last item const animationClass = isLastItem ? 'watermark-last-item':'';html += ` <div class='${animationClass}' style=" font-size:${fontSize}px;font-weight:${fontWeight};color:${color};margin-bottom:${marginBottom};letter-spacing:${letterSpacing};line-height:1.2;max-width:${maxWidth};margin-left:auto;margin-right:auto;text-transform:${textTransform};${overflowStyle}${pointerEvents}" ${item.isFocus ? `data-hover-entity="${item.id}" data-entity-type="${item.entityType}"`:''}> ${item.text}</div> `;});html += '</div>';watermark.innerHTML = html;// ✅ SETUP HOVER FOR FOCUSED ENTITY this.setupWatermarkEntityHover(hierarchyItems);}// Handle window resize const handleResize =()=>{this.updateWatermark();};if(this.watermarkResizeHandler){window.removeEventListener('resize',this.watermarkResizeHandler);}this.watermarkResizeHandler = handleResize;window.addEventListener('resize',this.watermarkResizeHandler);}// ✅ NEW METHOD:Setup subtle hover for focused entity setupWatermarkEntityHover(hierarchyItems){const watermark = document.getElementById('watermark');if(!watermark)return;// Find the focused item(last item in hierarchy)const focusedItem = hierarchyItems[hierarchyItems.length - 1];if(!focusedItem || !focusedItem.isFocus)return;const focusedElement = watermark.querySelector(`[data-hover-entity="${focusedItem.id}"]`);if(!focusedElement)return;let hoverCard = null;let hoverTimeout = null;const showHoverCard =(e)=>{if(hoverCard)return;// Get entity data const entityData = this.getEntityDataForPathItem(focusedItem);if(!entityData)return;// Create hover card styled like background hoverCard = document.createElement('div');hoverCard.style.cssText = ` position:absolute;top:${focusedElement.offsetTop + focusedElement.offsetHeight + 8}px;left:${focusedElement.offsetLeft}px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border:1px solid rgba(0,0,0,0.05);border-radius:6px;padding:12px 16px;min-width:220px;max-width:320px;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.05);z-index:1000;color:#333;pointer-events:none;opacity:0.9;`;const entityDataHtml = this.formatEntityDataForHover(entityData,focusedItem.text,focusedItem.entityType);hoverCard.innerHTML = entityDataHtml;// Append to the same container as the watermark text focusedElement.parentElement.appendChild(hoverCard);};const hideHoverCard =()=>{if(hoverCard){hoverCard.remove();hoverCard = null;}if(hoverTimeout){clearTimeout(hoverTimeout);hoverTimeout = null;}};const handleMouseMove =(e)=>{if(!focusedElement.contains(e.target)){hideHoverCard();return;}if(hoverCard){// Position below the focused element hoverCard.style.top = `${focusedElement.offsetTop + focusedElement.offsetHeight + 8}px`;hoverCard.style.left = `${focusedElement.offsetLeft}px`;}};focusedElement.addEventListener('mouseenter',(e)=>{hoverTimeout = setTimeout(()=>{showHoverCard(e);},300);});focusedElement.addEventListener('mousemove',handleMouseMove);focusedElement.addEventListener('mouseleave',hideHoverCard);// Store cleanup function this.watermarkHoverCleanup = hideHoverCard;}// ✅ NEW METHOD:Cleanup hover cleanupWatermarkHover(){if(this.watermarkHoverCleanup){this.watermarkHoverCleanup();this.watermarkHoverCleanup = null;}}// ✅ NEW METHOD:Get entity data for path item getEntityDataForPathItem(pathItem){try{let currentItems = this.data.items;// Navigate through the hierarchy to find the specific entity for(let i = 0;i < this.currentPath.length;i++){const currentPathItem = this.currentPath[i];if(i === this.currentPath.length - 1){// This is our target entity return currentItems.find(item => item.ID === currentPathItem.id)|| null;}else{// Navigate to children const parent = currentItems.find(item => item.ID === currentPathItem.id);if(!parent)return null;const entityType = this.currentApp.hierarchy[i];const config = this.currentApp.entityConfigs[entityType];const childrenField = config?.childrenField;if(!childrenField || !parent[childrenField])return null;currentItems = parent[childrenField];}}return null;}catch(error){console.warn('Failed to get entity data for hover:',error);return null;}}// ✅ NEW METHOD:Format entity data for hover display(minimalist style)formatEntityDataForHover(entityData,displayName,entityType){if(!entityData)return '<div>No data available</div>';let html = `<div style="font-weight:bold;margin-bottom:6px;font-size:15px;color:#222;">${displayName}</div>`;// Get entity configuration to know which fields to show const entityConfig = this.nativeEntities?.[entityType];if(entityConfig){// Filter fields to show(skip system fields and empty values)const fieldsToShow = entityConfig.fields .filter(field => field.writePermission !== 'system' && field.name !== 'ID' && field.name !== 'displayID' && field.name !== 'dotLabel' && field.name !== 'timestamp' && field.name !== 'count' && field.name !== 'hidden' && field.name !== 'hashed' && entityData[field.name] !== undefined && entityData[field.name] !== null && entityData[field.name] !== '').slice(0,3);// Limit to 3 key fields if(fieldsToShow.length > 0){fieldsToShow.forEach(field =>{const value = entityData[field.name];if(value !== undefined && value !== null && value !== ''){// Handle different field types let displayValue = value;if(field.type === 'checkbox'){displayValue = value ? 'Yes':'No';}html += `<div style="margin:3px 0;font-size:13px;color:#555;"> <span style="font-weight:500;">${field.label}:</span> <span style="color:#333;">${displayValue}</span> </div>`;}});}else{html += '<div style="font-size:11px;color:#888;margin-top:4px;">No additional data</div>';}}return html;}// Helper method to get display name for entity types getEntityDisplayName(entityType){// Check native entities if(this.nativeEntities){);if(this.nativeEntities[entityType]){const displayName = this.nativeEntities[entityType].name;return displayName;}else{}}else{}// Check app schema if(this.currentApp?.entityConfigs?.[entityType]){const config = this.currentApp.entityConfigs[entityType];const displayName = config.name || entityType;return displayName;}else{}// Fallback return entityType;}updatePageTitle(){if(this.currentApp){document.title = '. Apps - ' + this.currentApp.name;}}parseUrlForDataFetch(){const path = window.location.pathname;const segments = path.split('/').filter(s => s);if(segments[0] !== 't' || segments[1] !== 'apps' || !segments[2]){return null;}const result ={appId:segments[2]};// Extract all entity IDs const idSegments = segments.slice(3);if(idSegments.length > 0){result.tenantId = idSegments[0];}if(idSegments.length > 1){result.subtenantId = idSegments[1];}// For deeper levels,you can add more or just use idSegments array result.pathIds = idSegments;// Full path for generic handling return result;}// Add these helper methods to the SchemaOrchestrator class // Helper to hide/show app selector button hideAppSelectorButton(){const btn = document.getElementById('app-selector-btn');if(btn)btn.style.display = 'none';}showAppSelectorButton(){const btn = document.getElementById('app-selector-btn');if(btn)btn.style.display = '';}// Helper to hide/show schema button hideSchemaButton(){const btn = document.getElementById('schema-btn');if(btn)btn.style.display = 'none';}showSchemaButton(){const btn = document.getElementById('schema-btn');if(btn)btn.style.display = '';}// ===== FIXED SHARE POPUP METHODS ===== showSharePopup(buttonElement){// Close any existing popup this.closeSharePopup();// Get current URL const currentUrl = window.location.href;// Get contextual guidance text const guidanceText = this.getShareGuidanceText();// Create popup const popup = document.createElement('div');popup.className = 'share-popup';popup.style.display = 'block';popup.innerHTML = ` <button class="share-close">&times;</button> <h4>Share this link</h4> <p>${guidanceText}</p> <input type="text" class="share-link-input" value="${currentUrl}" readonly> <div class="share-actions"> <button class="share-action-btn email" data-action="email"> <span>📧</span> Email </button> <button class="share-action-btn whatsapp" data-action="whatsapp"> <span>💬</span> WhatsApp </button> <button class="share-action-btn telegram" data-action="telegram"> <span>✈️</span> Telegram </button> <button class="share-action-btn copy" data-action="copy"> <span>📋</span> Copy </button> </div> `;// Add to body document.body.appendChild(popup);this.currentSharePopup = popup;// Position popup near the button with edge detection this.positionSharePopup(buttonElement,popup);// Add event listeners popup.querySelector('.share-close').addEventListener('click',()=>{this.closeSharePopup();});// Copy URL when clicking input const linkInput = popup.querySelector('.share-link-input');linkInput.addEventListener('click',()=>{linkInput.select();this.copyToClipboard(currentUrl);});const actionButtons = popup.querySelectorAll('.share-action-btn');actionButtons.forEach(btn =>{btn.addEventListener('click',(e)=>{const action = e.currentTarget.dataset.action;this.handleShareAction(action,currentUrl);});});// Close popup when clicking outside setTimeout(()=>{document.addEventListener('click',this.closeSharePopupOnClickOutside);},100);}// CRITICAL:Position the popup correctly positionSharePopup(buttonElement,popup){if(!buttonElement)return;const isMobile = window.innerWidth <= 768;if(isMobile){// Mobile:Center on screen popup.style.position = 'fixed';popup.style.top = '50%';popup.style.left = '50%';popup.style.transform = 'translate(-50%,-50%)';popup.style.width = '90%';popup.style.maxWidth = '350px';// Add backdrop const backdrop = document.createElement('div');backdrop.className = 'share-popup-backdrop';backdrop.addEventListener('click',()=> this.closeSharePopup());document.body.appendChild(backdrop);this.currentShareBackdrop = backdrop;}else{// Desktop:Position near button const buttonRect = buttonElement.getBoundingClientRect();const popupRect = popup.getBoundingClientRect();popup.style.position = 'fixed';popup.style.transform = 'none';// Calculate initial position(below and to the left of button)let top = buttonRect.bottom + 8;let left = buttonRect.left;// Adjust if popup would go off right edge if(left + popupRect.width > window.innerWidth){left = buttonRect.right - popupRect.width;}// Adjust if popup would go off bottom edge if(top + popupRect.height > window.innerHeight){top = buttonRect.top - popupRect.height - 8;}// Ensure popup doesn't go off left edge if(left < 10){left = 10;}// Ensure popup doesn't go off top edge if(top < 10){top = 10;}popup.style.top = `${top}px`;popup.style.left = `${left}px`;}}// Copy to clipboard copyToClipboard(text){if(navigator.clipboard && navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(()=>{this.showCopyFeedback();});}else{// Fallback for older browsers const textarea = document.createElement('textarea');textarea.value = text;textarea.style.position = 'fixed';textarea.style.opacity = '0';document.body.appendChild(textarea);textarea.select();document.execCommand('copy');document.body.removeChild(textarea);this.showCopyFeedback();}}// Show copy feedback showCopyFeedback(){const copyBtn = this.currentSharePopup?.querySelector('.share-action-btn.copy');if(copyBtn){const originalText = copyBtn.innerHTML;copyBtn.innerHTML = '<span>✓</span> Copied!';copyBtn.style.background = '#4CAF50';copyBtn.style.color = 'white';setTimeout(()=>{copyBtn.innerHTML = originalText;copyBtn.style.background = '';copyBtn.style.color = '';},2000);}}// Get share message(customize as needed)getShareMessage(){return 'Check this out!';}copyShareLink(){const url = this.getAppUrl(this.currentPath);navigator.clipboard.writeText(url).then(()=> alert('Link copied:\n' + url));}getShareGuidanceText(){const currentDepth = this.currentPath.length;);if(currentDepth === 0){return "This is your organization's main dashboard. Share this link with team members who need full access to manage all customers and concerns.";}else if(currentDepth === 1){// Tenant level - sharing customer support function const tenantName = this.currentPath[0]?.shortName || 'your organization';return `Share this link with people in ${tenantName}who would be handling customer support functions. They'll be able to manage all customers and concerns for this organization.`;}else if(currentDepth === 2){// Customer level - sharing with actual customers const customerName = this.currentPath[1]?.shortName || 'your customer';return `Share this link with ${customerName}or their team members who need to report and track support concerns. They'll only see their own concerns and won't have access to other customers.`;}else if(currentDepth >= 3){// Concern level or deeper return "Share this link with specific stakeholders who need to collaborate on this particular concern. They'll have focused access to this issue only.";}return "Share this secure link with authorized collaborators.";}handleShareAction(action,url){switch(action){case 'email':const subject = encodeURIComponent('Shared Support Link');const body = encodeURIComponent(`Hi,\n\nI'm sharing this support link with you:${url}\n\nBest regards`);window.location.href = `mailto:?subject=${subject}&body=${body}`;break;case 'whatsapp':const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(url)}`;window.open(whatsappUrl,'_blank');break;case 'telegram':const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}`;window.open(telegramUrl,'_blank');break;case 'copy':// Copy full URL even if displayed truncated navigator.clipboard.writeText(url).then(()=>{// Show copied feedback const input = this.currentSharePopup.querySelector('.share-link-input');const originalText = input.value;input.value = '✓ Copied to clipboard!';setTimeout(()=>{input.value = originalText;},2000);}).catch(err =>{console.error('Failed to copy:',err);// Fallback for older browsers const input = this.currentSharePopup.querySelector('.share-link-input');input.select();document.execCommand('copy');});break;}// Close popup after action(except copy)if(action !== 'copy'){this.closeSharePopup();}}closeSharePopup(){if(this.currentSharePopup){const existingBackdrop = document.querySelector('.share-popup-backdrop');if(existingBackdrop){existingBackdrop.classList.remove('show');existingBackdrop.style.display = 'none';}this.currentSharePopup.remove();this.currentSharePopup = null;document.removeEventListener('click',this.closeSharePopupOnClickOutside);}}closeSharePopupOnClickOutside =(e)=>{if(this.currentSharePopup && !this.currentSharePopup.contains(e.target)){this.closeSharePopup();}}saveLastViewedContext(appId,pathIds){if(!appId || !pathIds || pathIds.length === 0)return;try{// ✅ NEW FORMAT:Append to history array(max 10 entries)// Key format:savedContexts_${appId}// Determine if this is real UUID or hashed ID const hasRealUUID = pathIds.some(id => this.isRealUuid(id));// Create new context object const newContext ={path:pathIds,// ✅ NOT pathIds timestamp:Date.now(),isOwnerAccess:hasRealUUID // ✅ NOT isOwner};// Get existing contexts for this app const existingContexts = JSON.parse(localStorage.getItem(`savedContexts_${appId}`)|| '[]');// ✅ CRITICAL:Check if owner context already exists for this tenant const currentRootId = pathIds[0];const currentNormalized = this.isRealUuid(currentRootId)? this.db.hashUUID(currentRootId):currentRootId;const existingOwnerContext = existingContexts.find(ctx =>{const ctxRoot = ctx.path[0];const ctxNormalized = this.isRealUuid(ctxRoot)? this.db.hashUUID(ctxRoot):ctxRoot;return ctxNormalized === currentNormalized && ctx.isOwnerAccess;});// ✅ ONLY save if no owner context exists for this tenant if(!existingOwnerContext){// Prepend new context(most recent first),keep max 10 const updatedContexts = [newContext,...existingContexts.slice(0,9)];localStorage.setItem(`savedContexts_${appId}`,JSON.stringify(updatedContexts));}else{}}catch(error){console.error('[saveLastViewedContext] Error:',error);}}redirectToLastViewedContext(targetAppId){if(isowner)return;const context = this.getLastViewedContext(targetAppId);if(context && context.pathIds?.length > 0){// ✅ Hash any real UUIDs(with hyphens)before putting in URL const hashedPathIds = context.pathIds.map(id =>{// If ID contains hyphens,it's a real UUID - hash it if(id && id.includes('-')){return this.db.hashUUID(id);}// Otherwise,assume it's already hashed return id;});const url = `/t/apps/${targetAppId}/${hashedPathIds.join('/')}`;window.location.href = url;}}async showWelcomeForm(tenant,entityType){var self = this;const entitySchema = await this.getEntityConfig(entityType);const modal = document.getElementById('add-modal');const title = document.getElementById('modal-title');const form = document.getElementById('add-form');title.textContent = '🎉 Welcome! Create Your Profile';form.innerHTML = '';// Add welcome message const welcomeMsg = document.createElement('div');welcomeMsg.style.cssText = 'background:#e8f4f8;padding:12px;border-radius:6px;margin-bottom:20px;color:#2c3e50;';welcomeMsg.innerHTML = '<strong>Welcome to . Apps!</strong><br>Please enter your organization details to get started.';form.appendChild(welcomeMsg);// Create form fields for all editable fields entitySchema.fields.forEach(function(field){if(field.name === 'ID')return;// Skip ID field const group = document.createElement('div');group.className = 'form-group';const label = document.createElement('label');label.textContent = field.label +(field.mandatory ? ' *':'');group.appendChild(label);let input;if(field.type === 'textarea'){input = document.createElement('textarea');}else if(field.type === 'checkbox'){const checkboxGroup = document.createElement('div');checkboxGroup.className = 'checkbox-group';input = document.createElement('input');input.type = 'checkbox';const checkboxLabel = document.createElement('label');checkboxLabel.textContent = field.label;checkboxGroup.appendChild(input);checkboxGroup.appendChild(checkboxLabel);group.innerHTML = '';group.appendChild(checkboxGroup);input.checked = tenant[field.name] || false;}else{input = document.createElement('input');input.type = field.type;}input.name = field.name;input.required = field.mandatory;// Pre-fill with existing tenant data if(field.type !== 'checkbox' && tenant[field.name]){input.value = tenant[field.name];}if(field.type !== 'checkbox')group.appendChild(input);form.appendChild(group);});const buttonGroup = document.createElement('div');buttonGroup.style.marginTop = '20px';const submitBtn = document.createElement('button');submitBtn.type = 'submit';submitBtn.className = 'btn btn-primary';submitBtn.textContent = 'Complete Setup & Continue';buttonGroup.appendChild(submitBtn);form.appendChild(buttonGroup);form.onsubmit = async function(e){e.preventDefault();await self.updateTenantProfile(tenant,entityType,form);};modal.style.display = 'block';}async updateTenantProfile(tenant,entityType,form){const formData = new FormData(form);// Update tenant with form data for(let [key,value] of formData.entries()){if(key !== 'ID'){tenant[key] = value;}}// Handle checkboxes const checkboxes = form.querySelectorAll('input[type="checkbox"]');checkboxes.forEach(cb => tenant[cb.name] = cb.checked);// NOW save for the first time if(!this.data.items){this.data.items = [];}this.data.items.push(tenant);// Save to server await this.db.saveAppData(this.currentApp.id,this.data);// Clean up temporary storage localStorage.removeItem('pendingTenant');// Close modal and navigate document.getElementById('add-modal').style.display = 'none';// Now navigate to tenant's children this.navigateTo(tenant,entityType);}getCookie(name){const value = `;${document.cookie}`;const parts = value.split(`;${name}=`);if(parts.length === 2)return parts.pop().split(';').shift();return null;}// Replace the setupEventListeners method in schema-orchestrator.js with this version:// Replace the setupEventListeners method in schema-orchestrator.js with this version:setupEventListeners(){const self = this;// Safe helper:attach event listener only if element exists function safeOn(id,event,handler){const el = document.getElementById(id);if(!el){console.warn(`setupEventListeners:Element #${id}not found`);return;}el.addEventListener(event,handler);}// Safe helper:hide element if it exists function safeHide(id){const el = document.getElementById(id);if(!el){console.warn(`setupEventListeners:Element #${id}not found for hide()`);return;}el.style.display = 'none';}function setupMobileMenu(){const mobileMenuBtn = document.getElementById('mobile-menu-btn');const dropdown = document.getElementById('mobileDropdown');if(!mobileMenuBtn || !dropdown){console.error('❌ Mobile menu elements not found');return false;}// Toggle dropdown on button click mobileMenuBtn.addEventListener('click',(e)=>{e.stopPropagation();dropdown.classList.toggle('show');});// Close dropdown when clicking outside document.addEventListener('click',(e)=>{if(!dropdown.contains(e.target)&& !mobileMenuBtn.contains(e.target)){dropdown.classList.remove('show');}});// Handle dropdown item clicks dropdown.querySelectorAll('.mobile-dropdown-item').forEach(item =>{item.addEventListener('click',(e)=>{e.stopPropagation();const action = item.dataset.action;dropdown.classList.remove('show');if(action === 'share'){window.app.showSharePopup(e.currentTarget);}else if(action === 'switch'){window.app?.openAppSelector?.();}else if(action === 'settings'){window.app?.openSchemaManager?.();}});});// Close dropdown on window resize(desktop view)window.addEventListener('resize',()=>{if(window.innerWidth > 768){dropdown.classList.remove('show');}});return true;}// ===== UPDATE MOBILE DROPDOWN CONTENT ===== function updateMobileDropdown(){const dropdown = document.getElementById('mobileDropdown');if(!dropdown){console.error('❌ Mobile dropdown not found');return false;}const appBtn = document.getElementById('app-selector-btn');const schemaBtn = document.getElementById('schema-btn');// Build dropdown HTML with correct class names let dropdownHTML = ` <button class="mobile-dropdown-item" data-action="share"> <span>📤</span> Share </button> `;// Check if buttons are visible on desktop if(appBtn &&(appBtn.style.display !== 'none' || getComputedStyle(appBtn).display !== 'none')){dropdownHTML += ` <button class="mobile-dropdown-item" data-action="switch"> <span>🔄</span> Switch App </button> `;}if(schemaBtn &&(schemaBtn.style.display !== 'none' || getComputedStyle(schemaBtn).display !== 'none')){dropdownHTML += ` <button class="mobile-dropdown-item" data-action="settings"> <span>⚙️</span> Settings </button> `;}dropdown.innerHTML = dropdownHTML;// Re-attach event listeners dropdown.querySelectorAll('.mobile-dropdown-item').forEach(item =>{item.onclick =(e)=>{e.stopPropagation();const action = item.dataset.action;dropdown.classList.remove('show');if(action === 'share'){window.app.showSharePopup(e.currentTarget);}else if(action === 'switch'){window.app?.openAppSelector?.();}else if(action === 'settings'){window.app?.openSchemaManager?.();}};});return true;}// ===== MAIN REORGANIZATION FUNCTION(Orchestrator)===== function reorganizeHeaderButtons(){// Only run once if(document.querySelector('.header-reorganized')){return;}const actionsContainer = document.querySelector('.header-actions');if(!actionsContainer){console.error('❌ .header-actions container not found');return;}// Mark as reorganized to prevent re-running actionsContainer.classList.add('header-reorganized');try{// ===== CLEAR ONLY DESKTOP BUTTONS(preserve mobile elements)===== const existingDesktopBtns = actionsContainer.querySelectorAll('.header-btn,.share-btn');existingDesktopBtns.forEach(btn => btn.remove());// ===== CREATE DESKTOP BUTTONS ===== // Share button(desktop)const shareBtn = document.createElement('button');shareBtn.className = 'share-btn header-btn';shareBtn.id = 'share-btn';shareBtn.title = 'Share';shareBtn.innerHTML = ` <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <circle cx="18" cy="5" r="3"/> <circle cx="6" cy="12" r="3"/> <circle cx="18" cy="19" r="3"/> <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/> <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/> </svg> `;shareBtn.addEventListener('click',(e)=>{e.stopPropagation();if(window.app?.showSharePopup){window.app.showSharePopup(e.currentTarget);}else if(window.app?.copyShareLink){window.app.copyShareLink();}});// App selector button(desktop)const appBtn = document.createElement('button');appBtn.className = 'header-btn';appBtn.id = 'app-selector-btn';appBtn.textContent = 'Switch App';appBtn.addEventListener('click',()=>{if(window.app?.openAppSelector){window.app.openAppSelector();}});// Settings button(desktop)- only if owner let schemaBtn = null;if(typeof isowner !== 'undefined' && isowner){schemaBtn = document.createElement('button');schemaBtn.className = 'header-btn';schemaBtn.id = 'schema-btn';schemaBtn.textContent = 'Settings';schemaBtn.addEventListener('click',()=>{if(window.app?.openSchemaManager){window.app.openSchemaManager();}});}// ===== APPEND DESKTOP BUTTONS ===== actionsContainer.insertBefore(shareBtn,actionsContainer.firstChild);actionsContainer.insertBefore(appBtn,shareBtn.nextSibling);if(schemaBtn){actionsContainer.insertBefore(schemaBtn,appBtn.nextSibling);}// ===== ORCHESTRATE MOBILE MENU SETUP ===== const mobileMenuSetup = setupMobileMenu();const dropdownUpdated = updateMobileDropdown();if(mobileMenuSetup && dropdownUpdated){}}catch(error){console.error('❌ Error in reorganizeHeaderButtons:',error);actionsContainer.classList.remove('header-reorganized');}}// Attach button listeners safely safeOn('close-app-selector','click',()=> safeHide('app-selector-modal'));safeOn('close-add-modal','click',()=> safeHide('add-modal'));safeOn('close-schema-modal','click',()=> safeHide('schema-modal'));safeOn('close-app-schema-editor','click',()=> safeHide('app-schema-editor-modal'));safeOn('close-entity-editor','click',()=> safeHide('entity-editor-modal'));// Tabs const tabs = document.querySelectorAll('.tab');const tabContents = document.querySelectorAll('.tab-content');if(tabs.length === 0){console.warn("setupEventListeners:No .tab elements found");}tabs.forEach(tab =>{tab.addEventListener('click',e =>{tabs.forEach(t => t.classList.remove('active'));tabContents.forEach(c => c.classList.remove('active'));const target = e.currentTarget;target.classList.add('active');const contentId = target.dataset.tab;if(!contentId){console.warn("Tab clicked but no data-tab attribute found",target);return;}const panel = document.getElementById(contentId);if(!panel){console.warn(`No tab-content found with id #${contentId}`);return;}panel.classList.add('active');if(contentId === 'json-view' && !panel.dataset.wired){self.exportSchemasJSON();panel.dataset.populated = 'true';// Export button document.getElementById('export-schemas-json').onclick =()=> self.exportSchemasJSON();// Import button - triggers file selection document.getElementById('import-schemas-json').onclick =()=> document.getElementById('import-json-file').click();// ✅ File selection handler - actually imports the data document.getElementById('import-json-file').onchange = async(e)=>{const file = e.target.files[0];if(file){try{const text = await file.text();const jsonData = JSON.parse(text);await self.importSchemasJSON(jsonData);// Clear file input for next use e.target.value = '';}catch(error){console.error('Failed to parse JSON file:',error);alert('Invalid JSON file:' + error.message);}}};// Copy to clipboard document.getElementById('copy-json').onclick =()=> self.copyJSONToClipboard(document.getElementById('json-export').value);panel.dataset.wired = 'true';// Mark as wired to prevent duplicate handlers}const jsonBtnBar = document.getElementById('json-buttons');if(jsonBtnBar)jsonBtnBar.style.display =(contentId === 'json-view')? 'flex':'none';});});// Add to constructor or initialization window.addEventListener('beforeunload',()=>{this.stopVersionPolling();});// Also handle tab visibility changes document.addEventListener('visibilitychange',()=>{if(document.hidden && this.isPollingActive){}else if(!document.hidden && this.isPollingActive){}});// Reorganize header buttons after DOM is ready reorganizeHeaderButtons();}async exportSchemasJSON(){var self = this;const schemas = await this.db.getAppSchemas();const nativeEntities = await this.db.getNativeEntities();const exportData ={appSchemas:schemas,nativeEntities:nativeEntities,exportDate:new Date().toISOString(),version:"1.0"};const jsonString = JSON.stringify(exportData,null,2);// Show in JSON view tab document.getElementById('json-export').value = jsonString;// Switch to JSON view tab document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active');});document.querySelector('[data-tab="json-view"]').classList.add('active');document.getElementById('json-view').classList.add('active');// Set up copy and download handlers document.getElementById('copy-json').onclick = function(){self.copyJSONToClipboard(jsonString);};document.getElementById('download-json').onclick = function(){self.downloadJSON(exportData);};}// Add these methods to the SchemaOrchestrator class async sendTenantWelcomeEmail(tenantData,appUrl){const emailData ={to:tenantData.contactemail,subject:`Welcome to . Apps [${this.currentApp.name}] - Your Feedback Management Portal`,htmlBody:this.getTenantEmailTemplate(tenantData,appUrl),textBody:this.getTenantEmailText(tenantData,appUrl)};return await this.sendEmail(emailData);}async sendSubtenantNotificationEmail(subtenantData,parentTenantName,appUrl){const emailData ={to:subtenantData.contactemail,subject:`${parentTenantName}has created a feedback page for you`,htmlBody:this.getSubtenantEmailTemplate(subtenantData,parentTenantName,appUrl),textBody:this.getSubtenantEmailText(subtenantData,parentTenantName,appUrl)};return await this.sendEmail(emailData);}getTenantEmailTemplate(tenantData,appUrl){return ` <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> </head> <body style="margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background-color:#f4f4f5;"> <table width="100%" cellpadding="0" cellspacing="0" style="background-color:#f4f4f5;padding:40px 20px;"> <tr> <td align="center"> <table width="600" cellpadding="0" cellspacing="0" style="background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1);"> <!-- Header --> <tr> <td style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:40px 30px;text-align:center;"> <h1 style="margin:0;color:#ffffff;font-size:28px;font-weight:600;"> Welcome to newauth<span style="color:#ffd700;">.</span>apps </h1> <p style="margin:10px 0 0 0;color:rgba(255,255,255,0.9);font-size:14px;letter-spacing:1px;text-transform:uppercase;"> Visual Data Navigation </p> </td> </tr> <!-- Body --> <tr> <td style="padding:40px 30px;"> <h2 style="margin:0 0 20px 0;color:#1f2937;font-size:22px;font-weight:600;"> 🎉 Your ${this.currentApp.name}Portal is Ready! </h2> <p style="margin:0 0 16px 0;color:#4b5563;font-size:16px;line-height:1.6;"> Hello <strong>${tenantData.name}</strong>,</p> <p style="margin:0 0 16px 0;color:#4b5563;font-size:16px;line-height:1.6;"> Thank you for setting up your account! We've created a personalized feedback management portal for your organization. </p> <div style="background:linear-gradient(135deg,#f0f4ff 0%,#f5f3ff 100%);border-left:4px solid #667eea;padding:20px;margin:24px 0;border-radius:6px;"> <p style="margin:0 0 12px 0;color:#1f2937;font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;"> Your Portal URL </p> <a href="${appUrl}" style="color:#667eea;font-size:16px;font-weight:600;text-decoration:none;word-break:break-all;"> ${appUrl}</a> </div> <h3 style="margin:30px 0 16px 0;color:#1f2937;font-size:18px;font-weight:600;"> What you can do:</h3> <ul style="margin:0 0 24px 0;padding-left:20px;color:#4b5563;font-size:15px;line-height:1.8;"> <li style="margin-bottom:10px;">📊 Manage and organize feedback hierarchically</li> <li style="margin-bottom:10px;">👥 Create customers and track their concerns</li> <li style="margin-bottom:10px;">🔗 Share custom links with your team members</li> <li style="margin-bottom:10px;">📈 Visualize data with interactive dot-based interface</li> </ul> <!-- 🔒 SECURITY NOTICE --> <div style="background:linear-gradient(135deg,#fffbeb 0%,#fef3c7 100%);border-left:4px solid #f59e0b;padding:24px;margin:30px 0;border-radius:6px;position:relative;"> <div style="position:absolute;top:-12px;left:-12px;background:#f59e0b;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:18px;"> 🔒 </div> <h3 style="margin:0 0 12px 28px;color:#92400e;font-size:16px;font-weight:700;display:flex;align-items:center;"> <span style="margin-right:8px;">Security Notice</span> </h3> <p style="margin:0 0 16px 28px;color:#78350f;font-size:14px;line-height:1.6;"> This URL grants full administrative access to your organization's feedback portal. To protect your data:</p> <ul style="margin:0 0 0 28px;padding-left:20px;color:#78350f;font-size:14px;line-height:1.8;"> <li style="margin-bottom:8px;"><strong style="color:#92400e;">✓ Do share</strong> with authorized team members within your organization</li> <li style="margin-bottom:8px;"><strong style="color:#92400e;">✗ Do not forward</strong> to external parties,contractors,or public channels</li> <li style="margin-bottom:8px;"><strong style="color:#92400e;">💡 Need external access?</strong> Use the portal's built-in <strong>"Share"</strong> feature to generate limited-access links for specific customers </li> </ul> <p style="margin:16px 0 0 28px;color:#92400e;font-size:13px;font-style:italic;line-height:1.5;"> Your vigilance ensures the integrity and privacy of your organization's data. </p> </div> <table width="100%" cellpadding="0" cellspacing="0" style="margin:30px 0;"> <tr> <td align="center"> <a href="${appUrl}" style="display:inline-block;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#ffffff;text-decoration:none;padding:14px 32px;border-radius:8px;font-size:16px;font-weight:600;box-shadow:0 4px 12px rgba(102,126,234,0.3);"> Access Your Portal </a> </td> </tr> </table> <p style="margin:24px 0 0 0;color:#6b7280;font-size:14px;line-height:1.6;"> If you have any questions or need assistance,feel free to reach out to our support team. </p> </td> </tr> <!-- Footer --> <tr> <td style="background-color:#f9fafb;padding:24px 30px;border-top:1px solid #e5e7eb;"> <p style="margin:0 0 8px 0;color:#6b7280;font-size:13px;text-align:center;"> This is an automated message from newauth . apps </p> <p style="margin:0;color:#9ca3af;font-size:12px;text-align:center;"> © ${new Date().getFullYear()}Newauth. All rights reserved. </p> </td> </tr> </table> </td> </tr> </table> </body> </html> `.trim();}getTenantEmailText(tenantData,appUrl){return ` Welcome to newauth . apps - ${this.currentApp.name}Hello ${tenantData.name},Thank you for setting up your account! We've created a personalized feedback management portal for your organization. YOUR PORTAL URL:${appUrl}WHAT YOU CAN DO:• Manage and organize feedback hierarchically • Create customers and track their concerns • Share custom links with your team members • Visualize data with interactive dot-based interface Access your portal:${appUrl}If you have any questions or need assistance,feel free to reach out to our support team. --- This is an automated message from newauth . apps © ${new Date().getFullYear()}Newauth. All rights reserved. `.trim();}getSubtenantEmailTemplate(subtenantData,parentTenantName,appUrl){return ` <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> </head> <body style="margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background-color:#f4f4f5;"> <table width="100%" cellpadding="0" cellspacing="0" style="background-color:#f4f4f5;padding:40px 20px;"> <tr> <td align="center"> <table width="600" cellpadding="0" cellspacing="0" style="background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1);"> <!-- Header --> <tr> <td style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:40px 30px;text-align:center;"> <h1 style="margin:0;color:#ffffff;font-size:28px;font-weight:600;"> newauth<span style="color:#ffd700;">.</span>apps </h1> <p style="margin:10px 0 0 0;color:rgba(255,255,255,0.9);font-size:14px;letter-spacing:1px;text-transform:uppercase;"> ${this.currentApp.name}</p> </td> </tr> <!-- Body --> <tr> <td style="padding:40px 30px;"> <h2 style="margin:0 0 20px 0;color:#1f2937;font-size:22px;font-weight:600;"> 📋 Your Feedback Page Has Been Created </h2> <p style="margin:0 0 16px 0;color:#4b5563;font-size:16px;line-height:1.6;"> Hello <strong>${subtenantData.name}</strong>,</p> <p style="margin:0 0 16px 0;color:#4b5563;font-size:16px;line-height:1.6;"> <strong>${parentTenantName}</strong> has created a dedicated feedback management page for your organization on newauth . apps. </p> <div style="background:linear-gradient(135deg,#fff7ed 0%,#fef3c7 100%);border-left:4px solid #f59e0b;padding:20px;margin:24px 0;border-radius:6px;"> <p style="margin:0 0 8px 0;color:#92400e;font-size:14px;font-weight:600;"> ℹ️ Important Note </p> <p style="margin:0;color:#78350f;font-size:14px;line-height:1.6;"> This page has been set up by ${parentTenantName}to help manage and track feedback for your organization. </p> </div> <div style="background:linear-gradient(135deg,#f0f4ff 0%,#f5f3ff 100%);border-left:4px solid #667eea;padding:20px;margin:24px 0;border-radius:6px;"> <p style="margin:0 0 12px 0;color:#1f2937;font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;"> Your Feedback Page URL </p> <a href="${appUrl}" style="color:#667eea;font-size:16px;font-weight:600;text-decoration:none;word-break:break-all;"> ${appUrl}</a> </div> <h3 style="margin:30px 0 16px 0;color:#1f2937;font-size:18px;font-weight:600;"> What's next:</h3> <ul style="margin:0 0 24px 0;padding-left:20px;color:#4b5563;font-size:15px;line-height:1.8;"> <li style="margin-bottom:10px;">🔍 View and manage feedback items assigned to your organization</li> <li style="margin-bottom:10px;">📊 Track concerns and their status</li> <li style="margin-bottom:10px;">🤝 Collaborate with ${parentTenantName}on feedback resolution</li> <li style="margin-bottom:10px;">📈 Monitor trends and patterns in your feedback data</li> </ul> <table width="100%" cellpadding="0" cellspacing="0" style="margin:30px 0;"> <tr> <td align="center"> <a href="${appUrl}" style="display:inline-block;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#ffffff;text-decoration:none;padding:14px 32px;border-radius:8px;font-size:16px;font-weight:600;box-shadow:0 4px 12px rgba(102,126,234,0.3);"> View Your Page </a> </td> </tr> </table> <p style="margin:24px 0 0 0;color:#6b7280;font-size:14px;line-height:1.6;"> If you have questions about this page or need assistance,please contact ${parentTenantName}or our support team. </p> </td> </tr> <!-- Footer --> <tr> <td style="background-color:#f9fafb;padding:24px 30px;border-top:1px solid #e5e7eb;"> <p style="margin:0 0 8px 0;color:#6b7280;font-size:13px;text-align:center;"> This is an automated message from newauth . apps </p> <p style="margin:0;color:#9ca3af;font-size:12px;text-align:center;"> © ${new Date().getFullYear()}Newauth. All rights reserved. </p> </td> </tr> </table> </td> </tr> </table> </body> </html> `.trim();}getSubtenantEmailText(subtenantData,parentTenantName,appUrl){return ` newauth . apps - ${this.currentApp.name}Hello ${subtenantData.name},${parentTenantName}has created a dedicated feedback management page for your organization on newauth . apps. IMPORTANT NOTE:This page has been set up by ${parentTenantName}to help manage and track feedback for your organization. YOUR FEEDBACK PAGE URL:${appUrl}WHAT'S NEXT:• View and manage feedback items assigned to your organization • Track concerns and their status • Collaborate with ${parentTenantName}on feedback resolution • Monitor trends and patterns in your feedback data View your page:${appUrl}If you have questions about this page or need assistance,please contact ${parentTenantName}or our support team. --- This is an automated message from newauth . apps © ${new Date().getFullYear()}Newauth. All rights reserved. `.trim();}async sendEmail(emailData){try{const response = await fetch('/newauth/api/sendappemail',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(emailData)});if(!response.ok){throw new Error('Failed to send email:' + response.statusText);}const result = await response.json();return result;}catch(error){console.error('Error sending email:',error);throw error;}}getAppUrl(pathSegments){// Get full base URL const baseUrl = window.location.origin;if(!pathSegments || pathSegments.length === 0){return `${baseUrl}/t/apps/${this.currentApp.id}`;}// Always use displayID(hashed)for external URLs const pathIds = pathSegments.map(seg =>{// Always use displayID for external URLs if(seg.asuuid)return seg.id;else return seg.displayID || this.db.hashUUID(seg.id);});return `${baseUrl}/t/apps/${this.currentApp.id}/${pathIds.join('/')}`;}copyJSONToClipboard(jsonString){navigator.clipboard.writeText(jsonString).then(function(){alert('JSON copied to clipboard!');}).catch(function(err){console.error('Failed to copy JSON:',err);// Fallback for older browsers const textarea = document.getElementById('json-export');textarea.select();document.execCommand('copy');alert('JSON copied to clipboard!');});}downloadJSON(exportData){const blob = new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});const url = URL.createObjectURL(blob);const a = document.createElement('a');a.href = url;a.download = 'schemas-export-' + new Date().toISOString().slice(0,10)+ '.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}// Add method to import JSON(bonus feature)async importSchemasJSON(jsonData){try{let hasImported = false;// Handle app schemas if(jsonData.appSchemas){for(const schema of jsonData.appSchemas){await this.db.saveAppSchema(schema);}hasImported = true;}// Handle native entities - check both wrapped and direct formats const nativeEntities = jsonData.nativeEntities ||(!jsonData.appSchemas && typeof jsonData === 'object' && !Array.isArray(jsonData)? jsonData:null);if(nativeEntities){for(const [entityId,entityData] of Object.entries(nativeEntities)){await this.db.saveNativeEntity(entityId,entityData);}hasImported = true;}if(hasImported){alert('Schemas imported successfully!');await this.loadAppSchemas();await this.loadNativeEntities();}else{alert('No valid data found. Please select an app schema file or native entities file.');}}catch(error){console.error('Import failed:',error);alert('Import failed:' + error.message);}}getChildCount(item,entityType){const config = this.currentApp.entityConfigs[entityType];if(!config?.childrenField)return 0;const children = item[config.childrenField];return Array.isArray(children)? children.length:0;}calculateDotSize(item,entityType,index){const config = this.currentApp.entityConfigs[entityType];const sortConfig = config?.sortConfig;// Get all items at current level for normalization const currentItems = this.getItemsForCurrentLevel();// Size range configuration const MIN_SIZE = 16;const MAX_SIZE = 40;const DEFAULT_SIZE = 24;if(!sortConfig){// Handle concerns(leaf nodes)with timestamp if(entityType === 'concern' && item.timestamp){return this.calculateSizeByTimestamp(item.timestamp,currentItems,MIN_SIZE,MAX_SIZE);}return DEFAULT_SIZE;}if(sortConfig.type === 'count'){const childrenCount = this.getChildCount(item,entityType);return this.calculateSizeByValue(childrenCount,currentItems,entityType,MIN_SIZE,MAX_SIZE);}else if(sortConfig.type === 'aggregate' && sortConfig.aggregateField){const aggregateValue = this.calculateAggregate(item,entityType,sortConfig);return this.calculateSizeByValue(aggregateValue,currentItems,entityType,MIN_SIZE,MAX_SIZE);}return DEFAULT_SIZE;}// ✅ NEW:Calculate size based on timestamp(exponential)calculateSizeByTimestamp(timestamp,allItems,minSize,maxSize){if(!allItems.length || !timestamp)return minSize;// Find min/max timestamps in current view const timestamps = allItems .filter(item => item.timestamp).map(item => item.timestamp);if(timestamps.length === 0)return minSize;const minTime = Math.min(...timestamps);const maxTime = Math.max(...timestamps);const timeRange = maxTime - minTime;if(timeRange === 0)return maxSize;// All items have same timestamp // Exponential scaling:recent items get much larger const normalized =(timestamp - minTime)/ timeRange;// 0 to 1 const exponentialFactor = Math.pow(normalized,0.3);// Adjust exponent(0.3 = strong emphasis on recent)return minSize +(exponentialFactor *(maxSize - minSize));}// ✅ NEW:Generic size calculation with proper normalization calculateSizeByValue(value,allItems,entityType,minSize,maxSize){if(!allItems.length || value === undefined || value === null)return minSize;// Get values for all items at this entity type let values;const config = this.currentApp.entityConfigs[entityType];const sortConfig = config?.sortConfig;if(sortConfig?.type === 'count'){values = allItems.map(item => this.getChildCount(item,entityType));}else if(sortConfig?.type === 'aggregate'){values = allItems.map(item => this.calculateAggregate(item,entityType,sortConfig));}else{return minSize;}const minValue = Math.min(...values);const maxValue = Math.max(...values);const valueRange = maxValue - minValue;if(valueRange === 0)return maxSize;// All items have same value const normalized =(value - minValue)/ valueRange;// 0 to 1 // For count/aggregate,use linear scaling(you can change to exponential if desired)return minSize +(normalized *(maxSize - minSize));}// Ensure calculateAggregate works properly calculateAggregate(item,entityType,sortConfig){const config = this.currentApp.entityConfigs[entityType];if(!config?.childrenField)return 0;const children = item[config.childrenField] || [];if(!Array.isArray(children))return 0;if(sortConfig.aggregateFunction === 'sum'){return children.reduce((sum,child)=>{const fieldValue = child[sortConfig.aggregateField] || 0;return sum +(typeof fieldValue === 'number' ? fieldValue:0);},0);}return children.length;// fallback to count}async loadAppSelector(){const schemas = await this.db.getAppSchemas();if(schemas.length === 0)return;const urlInfo = this.parseUrlForDataFetch();// ✅ ROOT LEVEL:App selector mode if(!urlInfo || !urlInfo.appId){this.currentApp = null;this.currentPath = [];this.data ={items:schemas.map(schema =>({ID:schema.id,displayID:schema.id,name:schema.name,entityType:'app'}))};this.render();if(this.breadcrumb)this.updateBreadcrumb();if(this.watermark)this.updateWatermark();return;}// ✅ APP LEVEL:Let init()handle(will show tenants for app owners)await this.selectApp(urlInfo.appId);if(!isowner && schemas.length < 2){window.app.hideAppSelectorButton();}}async openAppSelector(){var self = this;const modal = document.getElementById('app-selector-modal');const content = document.getElementById('app-selector-content');const schemas = await this.db.getAppSchemas();content.innerHTML = '<div class="form-group"><label>Select Application:</label></div>';schemas.forEach(function(schema){const card = document.createElement('div');card.className = 'schema-card';card.style.cursor = 'pointer';card.innerHTML = '<h3>' + schema.name + '</h3>' + '<p style="color:#666;margin-top:8px;">' + schema.description + '</p>' + '<p style="color:#999;font-size:13px;margin-top:8px;">' + 'Hierarchy:' + schema.hierarchy.join(' → ')+ '</p>';card.addEventListener('click',async function(){// ✅ UPDATE URL BEFORE SELECTING APP window.history.pushState({},'',`/t/apps/${schema.id}`);// Select the app await self.selectApp(schema.id);// ✅ RE-RENDER EVERYTHING self.render();self.updateBreadcrumb();self.updateWatermark();// Close modal modal.style.display = 'none';});content.appendChild(card);});modal.style.display = 'block';}async selectApp(appId){if(!appId || !appId.trim()){return;}const schemas = await this.db.getAppSchemas();this.currentApp = schemas.find(function(s){return s.id === appId;});if(this.currentApp){// Always load full data - let handleIncomingDeepLink handle filtering this.data = await this.db.getAppData(this.currentApp.id);this.updateWatermark();this.updatePageTitle();}}hash(str){let hash = 0;for(let i = 0;i < str.length;i++){const char = str.charCodeAt(i);hash =((hash << 5)- hash)+ char;hash = hash & hash;}return Math.abs(hash).toString(36);}getCurrentEntityType(){if(!this.currentApp)return null;return this.currentApp.hierarchy[this.currentPath.length];}getNextEntityType(){if(!this.currentApp)return null;const nextIndex = this.currentPath.length;const result = nextIndex < this.currentApp.hierarchy.length ? this.currentApp.hierarchy[nextIndex]:null;// return result;}// ✅ ENHANCED POPSTATE HANDLER - ADD THIS METHOD setupPopstateHandler(){// Handle browser back/forward buttons window.addEventListener('popstate',(e)=>{const state = e.state;if(!state){// No state(initial page load or direct navigation)this.handleInitialState();return;}const targetDepth = state.depth || 0;const statePath = state.path || [];// Rebuild currentPath from state this.currentPath = statePath.map(pathItem =>({id:pathItem.id,displayID:pathItem.displayID || pathItem.id,hashed:pathItem.hashed || false,entityType:pathItem.entityType,shortName:pathItem.shortName || pathItem.id.substring(0,8)}));// Re-render UI this.render();this.updateBreadcrumb();this.updateWatermark();});// Handle initial page load this.handleInitialState();}// ✅ HANDLE INITIAL PAGE LOAD - ADD THIS METHOD handleInitialState(){if(this.currentPath?.length > 0){return;}const urlInfo = this.parseUrlForDataFetch();if(!urlInfo || !urlInfo.appId)return;// Build path from URL info this.currentPath = [];if(urlInfo.pathIds && urlInfo.pathIds.length > 0){for(let i = 0;i < urlInfo.pathIds.length && i < this.currentApp.hierarchy.length;i++){const pathId = urlInfo.pathIds[i];const entityType = this.currentApp.hierarchy[i];this.currentPath.push({id:pathId,displayID:pathId,hashed:true,shortName:pathId.substring(0,8),entityType:entityType});}}}getCurrentData(){let current = this.data.items;for(let i = 0;i < this.currentPath.length;i++){const pathItem = this.currentPath[i];const entityType = this.currentApp.hierarchy[i];const config = this.currentApp.entityConfigs[entityType];const self = this;current = current.find(function(item){// Use the same getItemId logic to ensure consistent ID comparison const itemId = self.getItemId(item,entityType);return itemId === pathItem.id;});if(!current)return [];const childrenField = config.childrenField;if(!current[childrenField])current[childrenField] = [];current = current[childrenField];}return current;}_hasFullDataStructure(){// ✅ CRITICAL:Verify we have ROOT-LEVEL entities matching app schema if(!this.data?.items || this.data.items.length === 0){return false;}// Get expected root entity type from app schema const expectedRootType = this.currentApp?.hierarchy?.[0];if(!expectedRootType)return false;// ✅ VALIDATE:First root item MUST match schema's root entity type // This confirms we have full app data(not partial subtree)const firstRootItem = this.data.items[0];return firstRootItem.entityType === expectedRootType;}// ✅ CHECK IF WE HAVE FULL HIERARCHY(Browser 1 after initial load)_hasFullDataStructure(){// Root level has multiple tenants OR deep level has parent with siblings return this.data?.items?.length > 1 ||(this.data?.items?.[0]?.entityType && this.currentPath.length > 0);}// ✅ SURGICAL MERGE:Update ONLY the changed branch _mergePartialIntoFullData(freshPartial,pathContext){if(pathContext.length === 0){// Root level update(rare for polling)this.data.items = freshPartial.items;return;}// Navigate to parent level in EXISTING full data let current = this.data.items;for(let i = 0;i < pathContext.length - 1;i++){const entityType = this.currentApp.hierarchy[i];const childrenField = this.currentApp.entityConfigs[entityType]?.childrenField;const targetId = pathContext[i];const parent = current.find(item => item.displayID === targetId || item.ID === targetId);if(!parent || !parent[childrenField])return;current = parent[childrenField];}// Replace target entity with fresh version(preserves siblings!)const targetId = pathContext[pathContext.length - 1];const index = current.findIndex(item => item.displayID === targetId || item.ID === targetId);if(index !== -1 && freshPartial.items?.[0]){current[index] ={...freshPartial.items[0]};// Deep copy fresh entity}`);}}getItemsForCurrentLevel(){const currentDepth = this.currentPath.length;:',this.isDataOwner()););if(currentDepth === 0){return this.data.items || [];}if(!this.data?.items || this.data.items.length === 0){return [];}// ✅ Check if we're in filtered view(Browser 2)const isFilteredView = !this.isDataOwner();if(isFilteredView){// Browser 2:data.items contains the CURRENT LEVEL items const targetEntityType = this.currentApp.hierarchy[currentDepth];if(!targetEntityType){// We're at the deepest level,return data.items as-is return this.data.items;}// Get the parent entity type(what we're viewing)const parentEntityType = this.currentApp.hierarchy[currentDepth - 1];const parentConfig = this.currentApp.entityConfigs[parentEntityType];const childrenField = parentConfig.childrenField;if(!childrenField){return this.data.items;// No children field,return as-is}// For Browser 2 with nested data,extract children from first item const parent = this.data.items[0];if(parent && parent[childrenField]){return parent[childrenField];}else{return this.data.items;// Fallback to direct items}}));// Browser 1:navigate through nested hierarchy let currentItems = this.data.items;let currentDepthIndex = 0;if(currentItems.length > 0){}// Navigate TO the parent level while(currentDepthIndex < currentDepth - 1 && currentItems.length > 0){const entityType = this.currentApp.hierarchy[currentDepthIndex];const config = this.currentApp.entityConfigs[entityType];const childrenField = config.childrenField;const pathItem = this.currentPath[currentDepthIndex];// Log all current items for debugging currentItems.forEach((item,idx)=>{});const foundItem = currentItems.find(item => item.ID === pathItem.id || item.displayID === pathItem.id);if(!foundItem){return [];}// Move to next level if(!foundItem[childrenField]){);return [];}currentItems = foundItem[childrenField] || [];currentDepthIndex++;}// Now currentItems contains the PARENT LEVEL items const parentEntityType = this.currentApp.hierarchy[currentDepth - 1];const parentConfig = this.currentApp.entityConfigs[parentEntityType];const childrenField = parentConfig.childrenField;const parentPathItem = this.currentPath[currentDepth - 1];if(currentItems.length > 0){currentItems.forEach((item,idx)=>{});}const parent = currentItems.find(item => item.ID === parentPathItem.id || item.displayID === parentPathItem.id);if(!parent){return [];}if(!parent[childrenField]){);return [];}if(parent[childrenField].length > 0){}return parent[childrenField];}navigateHierarchy(){let currentLevel = this.data.items;// Navigate down the path for(let i = 0;i < this.currentPath.length;i++){const pathItem = this.currentPath[i];const entityType = this.currentApp.hierarchy[i];const config = this.currentApp.entityConfigs[entityType];currentLevel.forEach((item,idx)=>{});// Find the specific item at this level const foundItem = currentLevel.find(item =>{const itemId = this.getItemId(item,entityType);const itemDisplayId = item.displayID;// Try matching both real ID and display ID const matchesRealId = itemId === pathItem.id;const matchesDisplayId = itemDisplayId === pathItem.id;const matches = matchesRealId || matchesDisplayId;return matches;});if(!foundItem){console.error(` [navigateHierarchy] ❌ Item NOT FOUND at level ${i}for ID:`,pathItem.id);,displayId:item.displayID})));return null;// Navigation failed - hierarchy doesn't exist}});// If this is the last level in our path,get its children if(i === this.currentPath.length - 1){const childrenField = config.childrenField;if(!childrenField){console.error(' [navigateHierarchy] ❌ No children field at final level');return [];}const children = foundItem[childrenField] || [];if(children.length > 0){}return children;}// Move to next level const childrenField = config.childrenField;if(!foundItem[childrenField]){console.error(` [navigateHierarchy] ❌ No children field "${childrenField}" at level ${i}`););return null;}currentLevel = foundItem[childrenField];}console.warn(' [navigateHierarchy] ⚠️ Unexpected:Loop completed without returning');return null;}async getEntityConfig(entityType){const entities = await this.db.getNativeEntities();return entities[entityType];}getItemId(item,entityType){const config = this.currentApp.entityConfigs[entityType];// If we previously hashed it,return the exact same hash we stored if(item.hashed && item.ID)return item.ID;// Otherwise fall back to the configured field return item[config.idField];}getItemLabel(item,entityType){const config = this.currentApp.entityConfigs[entityType];const baseLabelField = config.labelField;// If item has ID field,show appropriate version if(item.ID){const userLoggedIn = this.getUserLoginStatus();if(userLoggedIn){return item.ID;// Show real UUID to logged-in users}else{return item.displayID || this.db.hashUUID(item.ID);// Show hash to guests}}return item[baseLabelField];}hashCode(str){let hash = 0;if(!str || str.length === 0)return hash;for(let i = 0;i < str.length;i++){const char = str.charCodeAt(i);hash =((hash << 5)- hash)+ char;hash = hash & hash;// Convert to 32bit integer}return Math.abs(hash);}generateDotPositions(count,items,entityType){// Add safety check for empty or undefined items if(!items || !Array.isArray(items)|| items.length === 0){console.warn('No items provided to generateDotPositions');return [];}const positions = [];const canvas = document.getElementById('canvas-area');// Add safety check for canvas if(!canvas){console.error('Canvas element not found');return [];}const canvasRect = canvas.getBoundingClientRect();// Get canvas dimensions with safety margins const margin = 80;const canvasWidth = Math.max(canvasRect.width -(margin * 2),200);const canvasHeight = Math.max(canvasRect.height -(margin * 2),200);const centerX = canvasRect.width / 2;const centerY = canvasRect.height / 2;const centerRadius = this.centerZoneRadius + 50;for(let i = 0;i < count;i++){// Add safety check for individual item const item = items[i];if(!item){console.warn(`Item at index ${i}is undefined`);continue;}const label = this.getItemLabel(item,entityType);// Create seeded random generator based on item's unique identifier const itemId = this.getItemId(item,entityType)|| label || `item_${i}`;// Add safety check for itemId if(!itemId){console.warn(`No itemId found for item at index ${i},using fallback`);continue;}// FIX:Use the existing hashCode method from SchemaOrchestrator const seedValue = this.hashCode(itemId);const seed = new SeededRandom(seedValue);`);let x,y;let attempts = 0;let validPosition = false;do{// Generate position using seeded random const angle = seed.randomBetween(0,2 * Math.PI);const maxDistance = Math.min(canvasWidth,canvasHeight)/ 2 - 50;const distanceFromCenter = seed.randomBetween(centerRadius + 50,Math.max(maxDistance,centerRadius + 100));x = centerX + Math.cos(angle)* distanceFromCenter;y = centerY + Math.sin(angle)* distanceFromCenter;// Ensure position is within canvas bounds with margin const dotSize = this.calculateDotSize(item,entityType,i);const halfSize = dotSize / 2;validPosition =(x >= margin + halfSize && x <= canvasRect.width - margin - halfSize && y >= margin + halfSize && y <= canvasRect.height - margin - halfSize);attempts++;if(attempts > 50){console.warn(`Could not find valid position for ${label}after ${attempts}attempts,using fallback`);// Use a grid-like fallback based on index const cols = Math.ceil(Math.sqrt(count));const row = Math.floor(i / cols);const col = i % cols;x = margin + halfSize +(col * 60)%(canvasWidth - halfSize * 2);y = margin + halfSize +(row * 60)%(canvasHeight - halfSize * 2);validPosition = true;}}while(!validPosition && attempts < 100);},y=${Math.round(y)}`);positions.push({x:x,y:y});}return positions;}render(){var self = this;));const cnvas = document.getElementById('canvas-area');if(!cnvas){console.error('[Render] Canvas element not found!');return;}const rect = cnvas.getBoundingClientRect();if(rect.width === 0 || rect.height === 0){console.error('[Render] Canvas has zero dimensions - aborting');return;}// ✅ EARLY GUARD:Entity selector mode(apps at root OR tenants for app owners)const isEntitySelectorMode =(// Apps at root(!this.currentApp && this.data?.items?.some?.(item => item.entityType === 'app'))|| // Tenants for app owners at app root(this.currentApp && this.currentPath.length === 0 && this.data?.items?.length > 0 && !this.data.items[0].entityType));if(isEntitySelectorMode){this.renderEntitySelector();return;}// ✅ EARLY RETURN:True no-app state if(!this.currentApp){document.getElementById('canvas-area').innerHTML = '<div class="loading">Please select an application to continue</div>';return;}// Check if we should show create tenant option const urlInfo = this.parseUrlForDataFetch();const isAtRootApp = urlInfo && !urlInfo.tenantId && !urlInfo.subtenantId;const hasSavedContext = !isowner && isAtRootApp && this.hasSavedContextForApp(urlInfo?.appId);if(!isowner && isAtRootApp && !hasSavedContext && this.data.items.length === 0){// Show create tenant option instead of empty state this.showCreateTenantOption();return;}const canvas = document.getElementById('canvas-area');// Clear canvas canvas.innerHTML = '';const nextEntityType = this.getNextEntityType();// Add center zone const centerZone = document.createElement('div');centerZone.className = 'center-zone';if(nextEntityType){// Create add button with contextual hover text const addButton = document.createElement('button');addButton.className = 'add-item-btn';addButton.textContent = '+';// Get contextual hover text from app hierarchy let hoverText;const currentDepth = this.currentPath.length;if(currentDepth === 0){// At root level - adding first level entity if(this.currentApp.hierarchy && this.currentApp.hierarchy.length > 0){const firstEntity = this.currentApp.hierarchy[0];// Capitalize first letter for better display const displayName = firstEntity.charAt(0).toUpperCase()+ firstEntity.slice(1);hoverText = `Create new ${displayName}`;}else{hoverText = 'Create new item';}}else if(currentDepth < this.currentApp.hierarchy.length){// Adding child entity at current depth const childEntity = this.currentApp.hierarchy[currentDepth];const displayName = childEntity.charAt(0).toUpperCase()+ childEntity.slice(1);hoverText = `Add new ${displayName}`;}else{// Beyond defined hierarchy - generic fallback hoverText = 'Add new item';}addButton.title = hoverText;// const plusButton = document.createElement('button');// plusButton.className = 'plus-button';// plusButton.textContent = '+';addButton.addEventListener('click',function(){self.openAddDialog();});centerZone.appendChild(addButton);}else{const maxLabel = document.createElement('div');maxLabel.style.cssText = 'font-size:14px;color:#999;text-align:center;';maxLabel.textContent = 'Maximum nesting level reached';centerZone.appendChild(maxLabel);}canvas.appendChild(centerZone);const context = this.getViewingContext();// ✅ SMART ITEMS RESOLUTION - handles both partial and full responses let items = [];const pathDepth = this.currentPath.length;if(pathDepth === 0){// Root level - show tenants items = this.data?.items || [];}else if(pathDepth >= 1 && this.data?.items?.length > 0){// Determine if we have partial or full data const firstItem = this.data.items[0];const lastPathEntity = this.currentPath[pathDepth - 1];const isPartialResponse = firstItem.entityType === lastPathEntity.entityType &&(firstItem.displayID === lastPathEntity.displayID);if(isPartialResponse){// Partial response:first item IS the entity we're viewing // Get children of the CURRENT entity(not next entity)const currentEntityType = this.currentApp.hierarchy[pathDepth - 1];const config = this.currentApp.entityConfigs[currentEntityType];if(config && config.childrenField){items = firstItem[config.childrenField] || [];}}else{// Full hierarchy response:need to navigate to the correct entity let currentItems = this.data.items;let currentEntity = null;// Navigate to the entity at current path depth for(let i = 0;i < pathDepth;i++){const pathItem = this.currentPath[i];const entityType = this.currentApp.hierarchy[i];currentEntity = currentItems.find(item => item.ID === pathItem.id || item.displayID === pathItem.displayID ||(!pathItem.id.includes('-')&& item.ID.includes('-')&& this.db.hashUUID(item.ID)=== pathItem.id));if(!currentEntity)break;if(i < pathDepth - 1){// Navigate to next level const config = this.currentApp.entityConfigs[entityType];currentItems = currentEntity[config.childrenField] || [];}}// Get children of the CURRENT entity(not next entity)if(currentEntity){const currentEntityType = this.currentApp.hierarchy[pathDepth - 1];const config = this.currentApp.entityConfigs[currentEntityType];if(config && config.childrenField){items = currentEntity[config.childrenField] || [];}}}});//:'No items');// Apply search filtering if search is active items = this.searchResults ? items.filter(item => this.shouldShowItemInSearch(item)!== 'hide'):items;if(!Array.isArray(items)|| items.length === 0){const noDataBox = document.createElement('div');noDataBox.style.cssText = ` position:absolute;left:50%;bottom:40px;transform:translateX(-50%);text-align:center;color:#999;font-size:16px;`;noDataBox.innerHTML = ` <div style="margin-bottom:8px;">📊 No ${nextEntityType ? nextEntityType.replace(/_/g,' '):'item'}to track yet.</div> <div style="font-size:14px;"> Use the + button to add ${nextEntityType ? nextEntityType.replace(/_/g,' '):'item'}s </div> `;canvas.appendChild(noDataBox);return;}if(this.currentApp != null){}if(items.length > 0){);}const entityType = this.getCurrentEntityType()|| this.currentApp.hierarchy[0];// Generate positions with better error handling let positions;try{positions = this.generateDotPositions(items.length,items,entityType);}catch(error){console.error('Error generating positions:',error);return;}if(!positions || positions.length === 0){return;}// In your dot creation loop items.forEach((item,index)=>{if(positions[index]){try{const searchState = this.searchResults ? this.shouldShowItemInSearch(item):null;// In your dot creation loop const dot = document.createElement('div');dot.className = 'dot';// ✅ ADD THIS:Set data-id for ALL dots(optimistic + server data)if(item.ID){// Optimistic items and schema items have ID field dot.dataset.id = item.ID;}else if(item.displayname){// Server tenant data:extract ID from displayname dot.dataset.id = item.displayname.split('/').pop();}else if(item.displayID){// Fallback to displayID dot.dataset.id = item.displayID;}// Calculate original dot properties const dotSize = this.calculateDotSize(item,entityType,index);// Calculate dot color const dotColor = this.getDotColor(item,entityType);// Store original state on the dot element dot.originalState ={width:`${dotSize}px`,height:`${dotSize}px`,backgroundColor:dotColor,borderRadius:'50%',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',fontSize:`${dotSize}px`,fontWeight:'bold',color:'#ffffff',// White text for contrast textAlign:'center',zIndex:100,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'};// Get label for dot text(first 3 characters)const labelField = this.currentApp.entityConfigs[entityType]?.labelField || 'name';// Instead of:dot.innerHTML = labelText;const labelText = item[labelField] ? item[labelField].substring(0,3):'?';// For stylish display:if(labelText.length === 3){const chars = labelText.split('');dot.innerHTML = ` <span class="dot-label"> <span>${chars[0]}</span> <span>${chars[1]}</span> <span>${chars[2]}</span> </span> `;}else{dot.innerHTML = labelText;}// Store item data for later use dot.itemData = item;dot.entityType = entityType;dot.itemIndex = index;// Apply original styles Object.assign(dot.style,dot.originalState);// Position the dot dot.style.position = 'absolute';dot.style.left = `${positions[index].x - dotSize / 2}px`;dot.style.top = `${positions[index].y - dotSize / 2}px`;// Apply styling based on search state if(searchState === 'match'){// Keep normal/styled appearance for matches dot.style.opacity = '1';dot.style.filter = 'brightness(1)';}else if(searchState === 'ancestor'){// Gray out ancestors dot.style.opacity = '0.4';dot.style.filter = 'grayscale(100%)';}// ✅ ADD EVENT HANDLERS DIRECTLY HERE this.attachDotInteractionHandlers(dot,item,entityType);canvas.appendChild(dot);}catch(error){console.error(`Error creating dot ${index}:`,error);}}});// ✅ SMART POLLING MANAGEMENT:if(this.currentPath.length === 0){// At root(app/tenant selector)→ STOP polling if(this.isPollingActive){this.stopVersionPolling();}}else{// At entity level → ALWAYS restart polling for CURRENT path //(Handles navigation between paths at same depth too!)this.startVersionPolling();}}renderEntitySelector(){const canvas = document.getElementById('canvas-area');if(!canvas || !this.data?.items?.length)return;canvas.innerHTML = '';// Title const title = document.createElement('div');title.style.cssText = 'position:absolute;top:30px;left:50%;transform:translateX(-50%);font-size:20px;font-weight:bold;color:#333;z-index:200;';title.textContent = this.getEntitySelectorTitle();canvas.appendChild(title);// ✅ BETTER DETERMINISTIC POSITIONING:Bit-splitting from single hash const getXYFromHash =(input)=>{// Simple but effective FNV-1a hash(better distribution than djb2)const FNV_OFFSET = 0x811c9dc5;const FNV_PRIME = 0x01000193;let hash = FNV_OFFSET;for(let i = 0;i < input.length;i++){hash ^= input.charCodeAt(i);hash =(hash * FNV_PRIME)>>> 0;// Keep as 32-bit unsigned}// Split 32-bit hash into two 16-bit values for X and Y const xBits = hash & 0xFFFF;// Lower 16 bits const yBits =(hash >> 16)& 0xFFFF;// Upper 16 bits // Normalize to [0,1)range const xRatio = xBits / 0xFFFF;const yRatio = yBits / 0xFFFF;return{xRatio,yRatio,hash};};const canvasRect = canvas.getBoundingClientRect();const items = this.data.items;// Time-based sizing logic(unchanged)const hasCreationTimes = items.some(item => item.crTime !== undefined);let minTime = Infinity,maxTime = -Infinity;if(hasCreationTimes){items.forEach(item =>{if(item.crTime < minTime)minTime = item.crTime;if(item.crTime > maxTime)maxTime = item.crTime;});}// Safe bounds const safeBounds ={minX:60,maxX:canvasRect.width - 60,minY:100,maxY:canvasRect.height - 60};items.forEach((item,i)=>{// Size logic(unchanged)let size;if(hasCreationTimes && item.crTime !== undefined){const timeRange = maxTime - minTime;const normalized = timeRange > 0 ?(item.crTime - minTime)/ timeRange:0.5;size = 45 +(normalized * 40);}else{size = !this.currentApp ? 70:60;}// ✅ POSITION:Extract tenant ID,then use bit-splitting let x,y;if(safeBounds.maxX > safeBounds.minX && safeBounds.maxY > safeBounds.minY){// Extract clean identifier let uniqueId = item.displayname || item.ID || item.name || `entity_${i}`;if(item.displayname && item.displayname.includes('/')){uniqueId = item.displayname.split('/').pop();}else if(item.ID && item.ID.includes('-')){uniqueId = this.db.hashUUID(item.ID);}// ✅ CRITICAL:Use bit-splitting for independent X/Y ratios const{xRatio,yRatio}= getXYFromHash(uniqueId);// Map to safe bounds x = safeBounds.minX + xRatio *(safeBounds.maxX - safeBounds.minX);y = safeBounds.minY + yRatio *(safeBounds.maxY - safeBounds.minY);//}→(${xRatio.toFixed(2)},${yRatio.toFixed(2)})→(${x.toFixed(0)},${y.toFixed(0)})`);}else{x = canvasRect.width / 2;y = canvasRect.height / 2;}// Rest of dot creation(unchanged from previous version)const dot = document.createElement('div');dot.className = 'dot entity-selector-dot';// ✅ CRITICAL FIX:SET data-id FOR LATER SELECTION(MUST MATCH newItem.ID)let dotDataId;if(item.ID){// Optimistic items have raw UUID in ID field dotDataId = item.ID;}else if(item.displayname){// Server items:extract tenant ID from displayname path dotDataId = item.displayname.split('/').pop();}else{// Fallback to displayID or index dotDataId = item.displayID || `entity_${i}`;}dot.dataset.id = dotDataId;// ← THIS IS THE MISSING PIECE const color = this.getEntityDotColor(item,!this.currentApp);Object.assign(dot.style,{position:'absolute',left:`${x - size/2}px`,top:`${y - size/2}px`,width:`${size}px`,height:`${size}px`,backgroundColor:color,borderRadius:'50%',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',boxShadow:'0 4px 15px rgba(0,0,0,0.2)',border:'3px solid rgba(255,255,255,0.4)',zIndex:100,transition:'transform 0.2s ease,box-shadow 0.2s ease'});// Label content(unchanged)let label,subLabel;const isAppSelector = !this.currentApp;const isTenantSelector = this.currentApp && this.currentPath.length === 0;if(isAppSelector){label = item.name?.substring(0,3).toUpperCase()|| 'APP';subLabel = item.name;}else if(isTenantSelector){const displayName = item.displayname || item.ID || '';const parts = displayName.split('/');const tenantId = parts[parts.length - 1] || displayName;label = tenantId.substring(0,3).toUpperCase();subLabel = tenantId;}else{label =(item.name || item.ID || '').substring(0,3).toUpperCase()|| '???';subLabel = item.name || item.ID;}dot.innerHTML = ` <div style="font-size:${size*0.35}px;margin-bottom:${subLabel ? '2px':'0'};text-shadow:1px 1px 2px rgba(0,0,0,0.3);"> ${label}</div> ${subLabel ? `<div style="font-size:${size*0.16}px;opacity:0.9;text-shadow:1px 1px 2px rgba(0,0,0,0.3);">${subLabel}</div>`:''}`;// Hover effects(unchanged)dot.addEventListener('mouseenter',()=>{dot.style.transform = 'scale(1.1)translateY(-5px)';dot.style.boxShadow = '0 8px 25px rgba(0,0,0,0.35)';dot.style.zIndex = '150';});dot.addEventListener('mouseleave',()=>{dot.style.transform = 'scale(1)translateY(0)';dot.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';dot.style.zIndex = '100';});// Navigation(unchanged)dot.addEventListener('click',e =>{e.stopPropagation();this.handleEntitySelectorClick(item,isAppSelector,isTenantSelector);});if(item.crTime){const date = new Date(item.crTime).toLocaleDateString();dot.title = `Created:${date}`;}canvas.appendChild(dot);});}// ✅ HELPER:Get title based on selector type getEntitySelectorTitle(){if(!this.currentApp){return 'Select an Application';}if(this.currentPath.length === 0){return 'Select a Tenant';}return 'Select an Item';}// ✅ HELPER:Get dot color getEntityDotColor(item,isAppSelector){// Generate from name/displayname hash const name = item.name || item.displayname || item.ID || '';let hash = 0;for(let i = 0;i < name.length;i++){hash = name.charCodeAt(i)+((hash << 5)- hash);}const hue = Math.abs(hash)% 360;const saturation = isAppSelector ? 70:60;return `hsl(${hue},${saturation}%,50%)`;}// Update handleEntitySelectorClick:handleEntitySelectorClick(item,isAppSelector,isTenantSelector){if(isAppSelector){const appId = item.ID || item.id;const newUrl = `/t/apps/${appId}`;window.history.pushState({appId:appId,fromAppSelector:true},'',newUrl);...');this.init();called');}else if(isTenantSelector){const displayName = item.displayname || item.ID || '';const parts = displayName.split('/');const tenantId = parts[parts.length - 1] || displayName;const newPath = [{id:tenantId,displayID:tenantId,shortName:tenantId.substring(0,8),entityType:this.currentApp?.hierarchy?.[0] || 'tenant'}];const newUrl = this.getAppUrl(newPath);window.history.pushState({path:newPath},'',newUrl);...');this.init();called');}else{}}// Setup search functionality - FIXED VERSION setupSearch(){const searchInput = document.getElementById('entity-search');const searchClear = document.getElementById('search-clear');if(!searchInput)return;// Handle search input changes searchInput.addEventListener('input',(e)=>{const term = e.target.value.trim();// Show/hide clear button if(searchClear){searchClear.style.display = term.length > 0 ? 'block':'none';}// Trigger search if term is long enough if(term.length >= 3){this.handleSearch(term);}else if(term.length === 0){this.handleSearch('');// Clear search when empty}});// Handle Enter key searchInput.addEventListener('keypress',(e)=>{if(e.key === 'Enter'){e.preventDefault();const term = searchInput.value.trim();this.handleSearch(term);}});// Handle Escape key to clear search searchInput.addEventListener('keydown',(e)=>{if(e.key === 'Escape'){searchInput.value = '';if(searchClear){searchClear.style.display = 'none';}this.handleSearch('');searchInput.blur();}});// Handle clear button if(searchClear){searchClear.addEventListener('click',(e)=>{e.stopPropagation();searchInput.value = '';searchClear.style.display = 'none';this.handleSearch('');searchInput.focus();// Keep focus for better UX});}}// ✅ NEW METHOD:Main search handler handleSearch(term){const searchInput = document.getElementById('entity-search');const clearBtn = document.getElementById('search-clear');if(clearBtn){clearBtn.style.display = term ? 'block':'none';}// Update search term this.searchTerm = term;if(term.length < 3){// Clear search results this.searchResults = null;this.render();return;}// Perform search this.searchResults = this.performSearch(term.toLowerCase());this.render();}// ✅ NEW METHOD:Perform recursive search through all entities performSearch(searchTerm){const results ={matches:new Set(),// Direct matches at any level ancestors:new Set(),// Ancestors of matches matchPaths:[] // Full paths to matches};// Start search from root level this.searchRecursive(this.data.items,[],searchTerm,results);return results;}// ✅ NEW METHOD:Recursive search helper searchRecursive(items,currentPath,searchTerm,results){if(!items || !Array.isArray(items))return;items.forEach(item =>{const currentPathWithItem = [...currentPath,item];const currentDepth = currentPathWithItem.length - 1;const entityType = this.currentApp.hierarchy[currentDepth] || `level_${currentDepth}`;// Check if this item matches the search term const isMatch = this.itemMatchesSearch(item,searchTerm,entityType);if(isMatch){// Add this item as a direct match results.matches.add(item.ID);results.matchPaths.push([...currentPathWithItem]);// Add all ancestors to ancestors set for(let i = 0;i < currentPath.length;i++){results.ancestors.add(currentPath[i].ID);}}// Recursively search children const config = this.currentApp.entityConfigs[entityType];if(config && config.childrenField && item[config.childrenField]){this.searchRecursive(item[config.childrenField],currentPathWithItem,searchTerm,results);}});}// ✅ NEW METHOD:Check if item matches search term itemMatchesSearch(item,searchTerm,entityType){if(!item)return false;// Get entity configuration to know which fields to search const entityConfig = this.nativeEntities?.[entityType];const searchableFields = entityConfig?.fields?.filter(field => field.writePermission !== 'system' && field.name !== 'ID' && field.name !== 'displayID' && field.name !== 'dotLabel' && field.name !== 'timestamp' && field.name !== 'count' && field.name !== 'hidden' && field.name !== 'hashed')|| [];// Search in all relevant fields for(const field of searchableFields){const value = item[field.name];if(value !== undefined && value !== null){const stringValue = String(value).toLowerCase();if(stringValue.includes(searchTerm)){return true;}}}// Also search in name and dotLabel as fallback if(item.name && String(item.name).toLowerCase().includes(searchTerm)){return true;}if(item.dotLabel && String(item.dotLabel).toLowerCase().includes(searchTerm)){return true;}return false;}// ✅ NEW METHOD:Check if item should be visible based on search shouldShowItemInSearch(item){if(!this.searchResults)return true;const currentDepth = this.currentPath.length;const isCurrentLevel =(this.getEntityDepth(item)=== currentDepth);if(isCurrentLevel){// At current level:show matches in color,ancestors in gray,hide others if(this.searchResults.matches.has(item.ID)){return 'match';// Show in color}else if(this.searchResults.ancestors.has(item.ID)){return 'ancestor';// Show in gray}else{return 'hide';// Hide completely}}else{// Not at current level - let normal rendering handle it return true;}}// ✅ NEW METHOD:Get entity depth getEntityDepth(entity){// This is tricky without full path,but we can estimate based on current context // For now,we'll use the current path length as reference return this.currentPath.length;}getItemLabel(item,entityType){const config = this.currentApp.entityConfigs[entityType];// 1. If item has explicit 'name' field → use it if(item.name != null){return String(item.name);}// 2. Use configured labelField if available and present if(config?.labelField && item[config.labelField] != null){return String(item[config.labelField]);}// 3. Look for any field containing "name" in its key(case-insensitive)const nameField = Object.keys(item).find(key => key.toLowerCase().includes('name')&& typeof item[key] === 'string');if(nameField){return String(item[nameField]);}// 4. Look for any field containing "text" in its key const textField = Object.keys(item).find(key => key.toLowerCase().includes('text')&& typeof item[key] === 'string');if(textField){return String(item[textField]);}// 5. Fallback:use ID(hashed or raw)if(item.ID){const userLoggedIn = this.getUserLoginStatus();if(userLoggedIn){return item.ID;// Show real UUID to logged-in users}else{return item.displayID || this.db.hashUUID(item.ID);// Show hash to guests}}// 6. Ultimate fallback return 'Un Named';}// ✅ ADD THIS HELPER(10 lines)generateAppColor(name){// Simple deterministic color from name let hash = 0;for(let i = 0;i < name.length;i++){hash = name.charCodeAt(i)+((hash << 5)- hash);}const hue = Math.abs(hash)% 360;return `hsl(${hue},70%,50%)`;}getDotColor(item,entityType){// Get unique identifier for this item const itemId = this.getItemId(item,entityType)|| this.getItemLabel(item,entityType)|| `item_${Math.random()}`;// Create seeded random generator based on item ID(same as position logic)const seedValue = this.hashCode(itemId);const seed = new SeededRandom(seedValue);// Generate RGB values using seeded random let r = Math.floor(seed.randomBetween(0,255));let g = Math.floor(seed.randomBetween(0,255));let b = Math.floor(seed.randomBetween(0,255));// Ensure colors are not too dark/dim const brightness =(r * 299 + g * 587 + b * 114)/ 1000;const minBrightness = 120;// Adjust this value as needed if(brightness < minBrightness){// Scale up the color to make it brighter const scale = minBrightness / brightness;r = Math.min(255,Math.floor(r * scale));g = Math.min(255,Math.floor(g * scale));b = Math.min(255,Math.floor(b * scale));}// Ensure colors are not too light/washed out const maxBrightness = 220;if(brightness > maxBrightness){const scale = maxBrightness / brightness;r = Math.floor(r * scale);g = Math.floor(g * scale);b = Math.floor(b * scale);}return `rgb(${r},${g},${b})`;}getFieldLabel(fieldName,entityType){const entityConfig = this.currentApp.entityConfigs[entityType];if(entityConfig && entityConfig.fields){const fieldConfig = entityConfig.fields.find(f => f.name === fieldName);return fieldConfig?.label || fieldName;}return fieldName.charAt(0).toUpperCase()+ fieldName.slice(1);}truncateText(text,maxLength){if(!text || text.length <= maxLength)return text;return text.substring(0,maxLength - 3)+ '...';}// Add this new method to handle all dot interactions attachDotInteractionHandlers(dot,item,entityType){const self = this;const isMobile = window.innerWidth <= 768;// Desktop:Hover with 1 second delay if(!isMobile){let hoverTimer = null;let isTransformed = false;dot.addEventListener('mouseenter',(e)=>{// Clear any existing timer if(hoverTimer)clearTimeout(hoverTimer);// Set 1 second delay before transformation hoverTimer = setTimeout(()=>{if(!isTransformed){self.transformDotToCard(dot,item,entityType);isTransformed = true;}},600);// 1 second delay});dot.addEventListener('mouseleave',(e)=>{// Clear hover timer if mouse leaves before transformation if(hoverTimer){clearTimeout(hoverTimer);hoverTimer = null;}// Only transform back if it was transformed if(isTransformed){self.transformCardToDot(dot);isTransformed = false;}});// Click handler for navigation dot.addEventListener('click',async(e)=>{if(!isTransformed){const item = dot.itemData;const entityType = item.entityType;const entityConfig = this.currentApp.entityConfigs[entityType];// ✅ Check if this entity has children(can be navigated to)if(!entityConfig.childrenField){// This is a leaf node - handle differently // For example,open detail view,chat,or do nothing // If it has chat support,open chat if(item.convid && typeof item.convid === 'string' && item.convid.trim()){this.openChatView(item.convid,entityType,item);}return;}// Only navigate if entity has children this.navigateTo(item,entityType);}});}// Mobile:Long-press for card,tap for navigation if(isMobile){let pressTimer = null;let isLongPress = false;let startX = 0;let startY = 0;dot.addEventListener('touchstart',(e)=>{e.preventDefault();isLongPress = false;// Record starting touch position const touch = e.touches[0];startX = touch.clientX;startY = touch.clientY;// Set timer for long press(1 second)pressTimer = setTimeout(()=>{isLongPress = true;self.transformDotToCard(dot,item,entityType);},600);});dot.addEventListener('touchmove',(e)=>{// Cancel long press if finger moves too much const touch = e.touches[0];const moveX = Math.abs(touch.clientX - startX);const moveY = Math.abs(touch.clientY - startY);if(moveX > 10 || moveY > 10){clearTimeout(pressTimer);}});dot.addEventListener('touchend',(e)=>{clearTimeout(pressTimer);if(!isLongPress){// ✅ CHECK FOR CHAT BEFORE NAVIGATION if(item.convid && typeof item.convid === 'string' && item.convid.trim()){self.openChatView(item.convid,entityType,item);}else{// Only navigate if entity supports children const entityConfig = self.currentApp.entityConfigs[entityType];// In the else block:if(entityConfig && entityConfig.childrenField){self.navigateTo(item,entityType);}else{// Leaf node without chat - show card on short tap too self.transformDotToCard(dot,item,entityType);}}}});dot.addEventListener('touchcancel',()=>{clearTimeout(pressTimer);});}}openChatView(convid,entityType,item){// Create or get chat container let chatContainer = document.getElementById('chat-container');if(!chatContainer){chatContainer = document.createElement('div');chatContainer.id = 'chat-container';// ✅ Append to body to avoid parent clipping issues document.body.appendChild(chatContainer);}const isMobile = window.innerWidth <= 768;if(isMobile){// Mobile:Full screen overlay with semi-transparent background Object.assign(chatContainer.style,{position:'fixed',top:'0',left:'0',width:'100%',height:'100%',background:'rgba(0,0,0,0.3)',backdropFilter:'blur(2px)',zIndex:'1000',display:'flex',alignItems:'center',justifyContent:'center'});this.loadChatInterface(convid,entityType,item,isMobile);setTimeout(()=> chatContainer.classList.add('loaded'),10);}else{// Desktop:Right sidebar with canvas shifting Object.assign(chatContainer.style,{position:'fixed',top:'0',right:'0',width:'400px',height:'100%',background:'white',zIndex:'1001',// ✅ Higher z-index than canvas boxShadow:'-4px 0 20px rgba(0,0,0,0.15)',display:'flex',flexDirection:'column',transform:'translateX(400px)',opacity:'0',transition:'transform 0.3s ease,opacity 0.3s ease'});// ✅ Shift main canvas BEFORE loading chat interface const canvas = document.getElementById('canvas-area');if(canvas){canvas.classList.add('chat-open');}this.loadChatInterface(convid,entityType,item,isMobile);// Animate chat container in setTimeout(()=>{chatContainer.style.transform = 'translateX(0)';chatContainer.style.opacity = '1';},10);}}closeChatView(){const chatContainer = document.getElementById('chat-container');if(chatContainer){// Animate out first chatContainer.style.transform = 'translateX(400px)';chatContainer.style.opacity = '0';setTimeout(()=>{chatContainer.remove();// ✅ Restore canvas after animation const canvas = document.getElementById('canvas-area');if(canvas){canvas.classList.remove('chat-open');}},300);}}loadChatInterface(convid,entityType,item,isMobile){const chatContainer = document.getElementById('chat-container');if(isMobile){// Mobile:Chat content in a card-like container let html = ` <div id="chat-content" style=" background:white;border-radius:16px;width:95%;max-width:500px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,0.3);"> <div style="padding:16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;"> <h3 style="margin:0;font-size:18px;">Chat:${item.name || item.orgname || entityType}</h3> <button id="close-chat" style="background:#667eea;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:14px;"> ✕ </button> </div> <div id="chat-messages" style="padding:16px;flex:1;overflow-y:auto;min-height:300px;"> <!-- Chat messages will load here --> </div> <div style="padding:16px;border-top:1px solid #eee;"> <div style="display:flex;gap:8px;"> <input type="text" id="chat-input" placeholder="Type a message..." style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;"> <button id="send-chat" style="background:#667eea;color:white;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:14px;"> Send </button> </div> </div> </div> `;chatContainer.innerHTML = html;}else{// Desktop:Full height chat sidebar let html = ` <div style="padding:16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;"> <h3 style="margin:0;">Chat:${item.name || item.orgname || entityType}</h3> <button id="close-chat" style="background:#667eea;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;"> ✕ </button> </div> <div id="chat-messages" style="padding:16px;flex:1;overflow-y:auto;"> <!-- Chat messages will load here --> </div> <div style="padding:16px;border-top:1px solid #eee;"> <input type="text" id="chat-input" placeholder="Type a message..." style="width:100%;padding:8px;margin-right:8px;margin-bottom:8px;"> <button id="send-chat" style="background:#667eea;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;width:100%;"> Send </button> </div> `;chatContainer.innerHTML = html;}// Load existing messages this.loadChatMessages(convid);// Setup event handlers document.getElementById('close-chat').addEventListener('click',()=>{this.closeChatView();});document.getElementById('send-chat').addEventListener('click',()=>{this.sendChatMessage(convid);});const chatInput = document.getElementById('chat-input');chatInput.addEventListener('keypress',(e)=>{if(e.key === 'Enter'){this.sendChatMessage(convid);}});// Focus input on open setTimeout(()=>{chatInput.focus();},100);}// Placeholder methods for chat functionality async loadChatMessages(convid){const messagesContainer = document.getElementById('chat-messages');if(!messagesContainer)return;try{// Replace with your actual chat API endpoint const response = await fetch(`/api/chat/${convid}/messages`);const messages = await response.json();let html = '';messages.forEach(msg =>{html += `<div style="margin-bottom:12px;"> <strong>${msg.sender}:</strong> ${msg.text}</div>`;});messagesContainer.innerHTML = html;}catch(error){console.error('Failed to load chat messages:',error);messagesContainer.innerHTML = '<div>No messages yet.</div>';}}async sendChatMessage(convid){const input = document.getElementById('chat-input');const message = input.value.trim();if(!message)return;try{// Replace with your actual chat API endpoint await fetch(`/api/chat/${convid}/messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:message})});input.value = '';this.loadChatMessages(convid);// Refresh messages}catch(error){console.error('Failed to send message:',error);alert('Failed to send message');}}// Fixed transformDotToCard with proper mobile handling and dot restoration // VERSION:2.0 - Mobile positioning matches desktop transformDotToCard(dot,item,entityType){const self = this;// Prevent multiple rapid transformations(fixes jitter)if(dot._isTransforming || dot.classList.contains('transformed-card')){return;}dot._isTransforming = true;// Detect if mobile const isMobile = window.innerWidth <= 768;// Store original dot appearance BEFORE transformation if(!dot.dataset.originalContent){dot.dataset.originalContent = dot.innerHTML;dot.dataset.originalBgColor = dot.style.backgroundColor || '';dot.dataset.originalBorder = dot.style.border || '';dot.dataset.originalWidth = dot.style.width || '20px';dot.dataset.originalHeight = dot.style.height || '20px';}if(!dot.originalState){const computedStyle = window.getComputedStyle(dot);dot.originalState ={width:computedStyle.width,height:computedStyle.height,backgroundColor:computedStyle.backgroundColor,borderRadius:computedStyle.borderRadius,cursor:computedStyle.cursor,display:computedStyle.display,alignItems:computedStyle.alignItems,justifyContent:computedStyle.justifyContent,fontSize:computedStyle.fontSize,// IMPORTANT fontWeight:computedStyle.fontWeight,// IMPORTANT color:computedStyle.color,textAlign:computedStyle.textAlign,overflow:computedStyle.overflow,textOverflow:computedStyle.textOverflow,whiteSpace:computedStyle.whiteSpace};}// Store original position NOW(when transformation happens,dot is in DOM)if(!dot.originalPosition){const rect = dot.getBoundingClientRect();const canvas = document.getElementById('canvas-area');if(!canvas){console.error('Canvas not found');return;}const canvasRect = canvas.getBoundingClientRect();dot.originalPosition ={left:rect.left - canvasRect.left + canvas.scrollLeft,top:rect.top - canvasRect.top + canvas.scrollTop,centerX:rect.left + rect.width / 2,centerY:rect.top + rect.height / 2};}// Determine card position based on dot location in viewport const viewportWidth = window.innerWidth;const viewportHeight = window.innerHeight;const dotCenterX = dot.originalPosition.centerX;const dotCenterY = dot.originalPosition.centerY;// Card dimensions const cardWidth = isMobile ? Math.min(300,viewportWidth - 40):280;const cardPadding = 20;// Safe padding from edges // Calculate card position let cardLeft,cardTop;let transformOrigin;let useSafePosition = false;if(isMobile){// Mobile:use same smart positioning as desktop const isRightSide = dotCenterX > viewportWidth / 2;const isBottomSide = dotCenterY > viewportHeight / 2;if(isRightSide && isBottomSide){// Bottom-right:expand up and left cardLeft = Math.max(cardPadding,dot.originalPosition.left - cardWidth + 20);cardTop = dot.originalPosition.top;transformOrigin = 'bottom right';}else if(isRightSide && !isBottomSide){// Top-right:expand down and left cardLeft = Math.max(cardPadding,dot.originalPosition.left - cardWidth + 20);cardTop = dot.originalPosition.top;transformOrigin = 'top right';}else if(!isRightSide && isBottomSide){// Bottom-left:expand up and right cardLeft = Math.min(viewportWidth - cardWidth - cardPadding,dot.originalPosition.left);cardTop = dot.originalPosition.top;transformOrigin = 'bottom left';}else{// Top-left:expand down and right cardLeft = Math.min(viewportWidth - cardWidth - cardPadding,dot.originalPosition.left);cardTop = dot.originalPosition.top;transformOrigin = 'top left';}}else{// Desktop:position based on quadrant const isRightSide = dotCenterX > viewportWidth / 2;const isBottomSide = dotCenterY > viewportHeight / 2;if(isRightSide && isBottomSide){// Bottom-right quadrant:expand up and left cardLeft = dot.originalPosition.left - cardWidth + 20;cardTop = dot.originalPosition.top;transformOrigin = 'bottom right';}else if(isRightSide && !isBottomSide){// Top-right quadrant:expand down and left cardLeft = dot.originalPosition.left - cardWidth + 20;cardTop = dot.originalPosition.top;transformOrigin = 'top right';}else if(!isRightSide && isBottomSide){// Bottom-left quadrant:expand up and right cardLeft = dot.originalPosition.left;cardTop = dot.originalPosition.top;transformOrigin = 'bottom left';}else{// Top-left quadrant:expand down and right cardLeft = dot.originalPosition.left;cardTop = dot.originalPosition.top;transformOrigin = 'top left';}}// Create card content(mobile vs desktop)const cardContent = isMobile ? this.createMobileDotCardContent(item,entityType):this.createDotCardContent(item,entityType);// Transform dot into card dot.innerHTML = cardContent;dot.classList.add('transformed-card');const expandBtn = dot.querySelector('.expand-image-btn');if(expandBtn && item.image){const handleExpand =(e)=>{}`);e.stopPropagation();e.preventDefault();dot._preventCardClose = true;// Auto-reset after safe delay setTimeout(()=>{dot._preventCardClose = false;},500);this.showImageOverlay(item.image);};// Attach to ALL relevant events ['click','touchstart','mousedown'].forEach(evt =>{expandBtn.addEventListener(evt,handleExpand,{passive:false});});// Image container handler const imgContainer = dot.querySelector('.entity-image-container');if(imgContainer){const handleImageClick =(e)=>{if(!e.target.closest('.expand-image-btn')){}`);e.stopPropagation();e.preventDefault();dot._preventCardClose = true;setTimeout(()=> dot._preventCardClose = false,500);this.showImageOverlay(item.image);}};['click','touchstart','mousedown'].forEach(evt =>{imgContainer.addEventListener(evt,handleImageClick,{passive:false});});}}if(useSafePosition){dot.classList.add('safe-mobile-position');}// Apply card styles with smooth transition Object.assign(dot.style,{position:'absolute',left:`${cardLeft}px`,top:`${cardTop}px`,width:isMobile ? `${cardWidth}px`:`${cardWidth}px`,maxWidth:isMobile ? 'calc(100vw - 40px)':'none',height:'auto',maxHeight:isMobile ? 'none':'none',minWidth:'unset',padding:isMobile ? '14px':'16px',backgroundColor:'white',border:'none',borderRadius:isMobile ? '10px':'12px',boxShadow:isMobile ? '0 4px 20px rgba(0,0,0,0.25)':'0 8px 24px rgba(0,0,0,0.2)',zIndex:'1001',cursor:'default',fontSize:isMobile ? '13px':'14px',color:'#333',fontWeight:'normal',textAlign:'left',transition:'all 0.3s cubic-bezier(0.4,0,0.2,1)',transform:'scale(1)',transformOrigin:transformOrigin,overflow:isMobile ? 'visible':'visible',display:'block',alignItems:'unset',justifyContent:'unset',whiteSpace:'normal',opacity:'1',pointerEvents:'auto'});// Release transformation lock after transition setTimeout(()=>{dot._isTransforming = false;},100);// Adjust position after rendering for bottom quadrants(both mobile and desktop)const isBottomSide = dotCenterY > viewportHeight / 2;if(isBottomSide){setTimeout(()=>{const cardRect = dot.getBoundingClientRect();const cardHeight = cardRect.height;// Adjust top position so card expands upward const adjustedTop = dot.originalPosition.top - cardHeight + 20;dot.style.top = `${Math.max(10,adjustedTop)}px`;},10);}if(isMobile){const closeHandler =(e)=>{const now = Date.now();// ✅ CRITICAL FIX:Ignore clicks on image overlay(it's a separate element)if(e.target.closest('#image-overlay')|| e.target.id === 'image-overlay'){return;}// Check flag FIRST if(dot._preventCardClose){`);dot._preventCardClose = false;return;}// Safety checks if(e.target.closest('.expand-image-btn')|| e.target.closest('.entity-image-container')){return;}if(!dot.contains(e.target)){self.transformCardToDot(dot);document.removeEventListener('touchstart',closeHandler);document.removeEventListener('click',closeHandler);}else{}};setTimeout(()=>{document.addEventListener('touchstart',closeHandler,{passive:true});document.addEventListener('click',closeHandler,{passive:true});dot._closeHandler = closeHandler;},100);}else{let leaveTimer;const mouseLeaveHandler =(e)=>{// CRITICAL:Check flag FIRST if(dot._preventCardClose){return;}if(leaveTimer)clearTimeout(leaveTimer);leaveTimer = setTimeout(()=>{const rect = dot.getBoundingClientRect();const x = e.clientX;const y = e.clientY;const isOutside =(x < rect.left || x > rect.right || y < rect.top || y > rect.bottom);| Card:${rect.left},${rect.top},${rect.right},${rect.bottom}| Outside:${isOutside}`);if(isOutside){self.transformCardToDot(dot);}},50);};dot.addEventListener('mouseleave',mouseLeaveHandler);dot._mouseLeaveHandler = mouseLeaveHandler;}// Add action handlers to card buttons const editBtn = dot.querySelector('.dot-action-btn.edit');const copyBtn = dot.querySelector('.dot-action-btn.copy');const deleteBtn = dot.querySelector('.dot-action-btn.delete');if(editBtn){const editHandler =(e)=>{e.stopPropagation();e.preventDefault();this.editItem(item,entityType);this.transformCardToDot(dot);};editBtn.addEventListener('click',editHandler);if(isMobile)editBtn.addEventListener('touchend',editHandler);}if(copyBtn){const copyHandler =(e)=>{e.stopPropagation();e.preventDefault();this.duplicateItem(item,entityType);this.transformCardToDot(dot);};copyBtn.addEventListener('click',copyHandler);if(isMobile)copyBtn.addEventListener('touchend',copyHandler);}if(deleteBtn){const deleteHandler =(e)=>{e.stopPropagation();e.preventDefault();if(confirm(`Are you sure you want to delete this ${entityType}?`)){this.deleteItem(item,entityType);}this.transformCardToDot(dot);};deleteBtn.addEventListener('click',deleteHandler);if(isMobile)deleteBtn.addEventListener('touchend',deleteHandler);}}// Fixed transformCardToDot with proper restoration transformCardToDot(dot){if(!dot.originalPosition || !dot.originalState){console.warn('Missing original state or position');return;}// Reset transformation flag dot._isTransforming = false;const __isMobile__ = window.innerWidth <= 768;// Remove event listeners if(dot._mouseLeaveHandler){dot.removeEventListener('mouseleave',dot._mouseLeaveHandler);delete dot._mouseLeaveHandler;}if(dot._closeHandler){document.removeEventListener('touchstart',dot._closeHandler);document.removeEventListener('click',dot._closeHandler);delete dot._closeHandler;}// Get the label for the dot(3 characters only)const item = dot.itemData;const entityType = dot.entityType;const label = this.getItemLabel(item,entityType)|| 'Unnamed';const displayLabel = label.substring(0,3).toLowerCase();// Clear card content and restore dot HTML structure dot.classList.remove('transformed-card');dot.classList.remove('safe-mobile-position');// Restore the original span structure dot.innerHTML = ` <span class="dot-label"> <span>${displayLabel[0] || ''}</span> <span>${displayLabel[1] || ''}</span> <span>${displayLabel[2] || ''}</span> </span> `;// Reset styles using saved original state Object.assign(dot.style,{position:'absolute',left:`${dot.originalPosition.left}px`,top:`${dot.originalPosition.top}px`,width:dot.originalState.width,height:dot.originalState.height,padding:'0',backgroundColor:dot.originalState.backgroundColor,border:'none',borderRadius:dot.originalState.borderRadius,boxShadow:'0 2px 4px rgba(0,0,0,0.2)',zIndex:'1000',cursor:dot.originalState.cursor,fontSize:dot.originalState.fontSize,// Use saved value color:dot.originalState.color,// Use saved value fontWeight:dot.originalState.fontWeight,// Use saved value textAlign:dot.originalState.textAlign,transition:'all 0.3s ease',transform:'scale(1)',transformOrigin:'center',overflow:dot.originalState.overflow,display:dot.originalState.display,alignItems:dot.originalState.alignItems,justifyContent:dot.originalState.justifyContent,whiteSpace:dot.originalState.whiteSpace,minWidth:'unset',maxWidth:'unset',opacity:'1',pointerEvents:'auto'});// Remove transition after animation completes setTimeout(()=>{if(dot.style.transition){dot.style.transition = '';}},300);}createDotCardContent(item,entityType){// ✅ GET COLOR FROM ENTITY TYPE(no hardcoded values)// ✅ REPLACE THE IMAGE HTML WITH THUMBNAIL + EXPAND BUTTON const imageHTML = item.image ? `<div class="entity-image-container"> <img src="${item.image}" alt="${item.name || 'Entity'}" class="entity-image-thumbnail"> <button class="expand-image-btn" title="View full size"> <!-- Standard fullscreen icon(four arrows)--> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/> </svg> </button> </div>`:'';const typeConfig = this.getEntityTypeColor(entityType);// Get entity configuration const entityConfig = this.nativeEntities?.[entityType];const fields = entityConfig?.fields || [];// Build field content with hover tooltips let fieldHTML = '';fields.forEach(field =>{// Skip system/internal fields if(field.writePermission === 'system' || ['ID','displayID','dotLabel','timestamp','count','hidden','hashed','parentId','path','image'].includes(field.name)){return;}const value = item[field.name];if(value === undefined || value === null || value === '')return;// Determine field importance const isPrimary = field.name === 'name' || field.name === 'title';const isDescription = field.name === 'description';const cssClass = isPrimary ? 'primary':(isDescription ? 'description':'');// Format value let displayValue = String(value);if(field.type === 'boolean'){displayValue = value ? '✓ Yes':'✗ No';}else if(field.type === 'number'){displayValue = Number(value).toLocaleString();}fieldHTML += ` <div class="field-value ${cssClass}" title="${field.label || field.name}"> ${displayValue}</div> `;});// Build child count let childCountHTML = '';const config = this.currentApp.entityConfigs[entityType];if(config?.childrenField && item[config.childrenField]){const childCount = item[config.childrenField].length;const childType = this.currentApp.hierarchy[this.currentApp.hierarchy.indexOf(entityType)+ 1] || 'item';childCountHTML = ` <div class="dot-info-child-count"> <span class="child-count-icon">🔗</span> <span>${childCount}${childType}${childCount !== 1 ? 's':''}</span> </div> `;}// Build action buttons const actionsHTML = ` <div class="dot-info-actions"> <button class="dot-action-btn edit" title="Edit"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M12 20h9v-9l-9 9-9 9v-9"/> <path d="M12 20v-9l-9 9"/> </svg> </button> <button class="dot-action-btn copy" title="Duplicate"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <rect x="9" y="9" width="13" height="13" rx="2"/> <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/> </svg> </button> <button class="dot-action-btn delete" title="Delete"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/> </svg> </button> </div> `;// Build complete card HTML return ` <div class="dot-info-card"> <div class="dot-info-header"> <span class="entity-type-badge" style="background:${typeConfig.bg};color:${typeConfig.color};"> ${typeConfig.label}</span> ${actionsHTML}</div> ${imageHTML}<div class="dot-info-fields"> ${fieldHTML}</div> ${childCountHTML}</div> `;}createMobileDotCardContent(item,entityType){// ✅ GET COLOR FROM ENTITY TYPE(no hardcoded values)// ✅ REPLACE THE IMAGE HTML WITH THUMBNAIL + EXPAND BUTTON const imageHTML = item.image ? `<div class="entity-image-container"> <img src="${item.image}" alt="${item.name || 'Entity'}" class="entity-image-thumbnail"> <button class="expand-image-btn" title="View full size"> <!-- Standard fullscreen icon(four arrows)--> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/> </svg> </button> </div>`:'';const typeConfig = this.getEntityTypeColor(entityType);// Get entity configuration const entityConfig = this.nativeEntities?.[entityType];const fields = entityConfig?.fields || [];// Build field content let fieldHTML = '';fields.forEach(field =>{if(field.writePermission === 'system' || ['ID','displayID','dotLabel','timestamp','count','hidden','hashed','parentId','path','image'].includes(field.name)){return;}const value = item[field.name];if(value === undefined || value === null || value === '')return;const isPrimary = field.name === 'name' || field.name === 'title';const isDescription = field.name === 'description';const cssClass = isPrimary ? 'primary':(isDescription ? 'description':'');let displayValue = String(value);if(field.type === 'boolean'){displayValue = value ? '✓ Yes':'✗ No';}else if(field.type === 'number'){displayValue = Number(value).toLocaleString();}fieldHTML += ` <div class="field-value ${cssClass}" title="${field.label || field.name}"> ${displayValue}</div> `;});// Build child count let childCountHTML = '';const config = this.currentApp.entityConfigs[entityType];if(config?.childrenField && item[config.childrenField]){const childCount = item[config.childrenField].length;const childType = this.currentApp.hierarchy[this.currentApp.hierarchy.indexOf(entityType)+ 1] || 'item';childCountHTML = ` <div class="dot-info-child-count"> <span class="child-count-icon">🔗</span> <span>${childCount}${childType}${childCount !== 1 ? 's':''}</span> </div> `;}// Mobile actions(stacked vertically)const actionsHTML = ` <div class="dot-info-actions mobile-actions"> <button class="dot-action-btn edit" title="Edit"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M12 20h9v-9l-9 9-9 9v-9"/> <path d="M12 20v-9l-9 9"/> </svg> </button> <button class="dot-action-btn copy" title="Duplicate"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <rect x="9" y="9" width="13" height="13" rx="2"/> <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/> </svg> </button> <button class="dot-action-btn delete" title="Delete"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/> </svg> </button> </div> `;// Build complete mobile card HTML return ` <div class="dot-info-card mobile-card"> <div class="dot-info-header"> <span class="entity-type-badge" style="background:${typeConfig.bg};color:${typeConfig.color};"> ${typeConfig.label}</span> ${actionsHTML}</div> ${imageHTML}<div class="dot-info-fields"> ${fieldHTML}</div> ${childCountHTML}</div> `;}// ✅ ADD THIS METHOD TO YOUR SchemaOrchestrator CLASS showImageOverlay(imageSrc){// Remove any existing overlay to prevent duplicates const existingOverlay = document.getElementById('image-overlay');if(existingOverlay)existingOverlay.remove();// Create overlay container const overlay = document.createElement('div');overlay.id = 'image-overlay';Object.assign(overlay.style,{position:'fixed',top:'0',left:'0',width:'100%',height:'100%',background:'rgba(0,0,0,0.92)',display:'flex',justifyContent:'center',alignItems:'center',zIndex:'2000',opacity:'0',transition:'opacity 0.3s ease',cursor:'pointer',outline:'none',tabIndex:'0' // Make focusable for keyboard events});// Create content container const content = document.createElement('div');Object.assign(content.style,{position:'relative',maxWidth:'95%',maxHeight:'95%'});// Create close button const closeBtn = document.createElement('button');closeBtn.innerHTML = '&times;';Object.assign(closeBtn.style,{position:'absolute',top:'15px',right:'15px',background:'rgba(0,0,0,0.5)',border:'none',color:'white',width:'36px',height:'36px',borderRadius:'50%',fontSize:'24px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',zIndex:'10',transition:'all 0.2s',border:'2px solid rgba(255,255,255,0.3)',WebkitTapHighlightColor:'transparent'});// Hover effects closeBtn.addEventListener('mouseenter',()=>{closeBtn.style.background = 'rgba(255,255,255,0.2)';closeBtn.style.transform = 'scale(1.1)';});closeBtn.addEventListener('mouseleave',()=>{closeBtn.style.background = 'rgba(0,0,0,0.5)';closeBtn.style.transform = 'scale(1)';});// Create image element const img = document.createElement('img');img.src = imageSrc;Object.assign(img.style,{maxWidth:'90%',maxHeight:'90%',objectFit:'contain',borderRadius:'8px',boxShadow:'0 10px 40px rgba(0,0,0,0.6)',cursor:'default',transition:'transform 0.3s',userSelect:'none'});// Prevent image drag img.addEventListener('dragstart',(e)=> e.preventDefault());// Assemble DOM content.appendChild(closeBtn);content.appendChild(img);overlay.appendChild(content);document.body.appendChild(overlay);// Focus overlay for keyboard events overlay.focus();// Fade in setTimeout(()=>{overlay.style.opacity = '1';},10);// Close handler const closeOverlay =()=>{overlay.style.opacity = '0';// Remove after transition completes setTimeout(()=>{if(overlay.parentNode)overlay.remove();},300);};// Close button click closeBtn.addEventListener('click',(e)=>{e.stopPropagation();closeOverlay();});// Click background to close overlay.addEventListener('click',(e)=>{if(e.target === overlay)closeOverlay();});// Keyboard navigation overlay.addEventListener('keydown',(e)=>{if(e.key === 'Escape' || e.key === ' '){e.preventDefault();closeOverlay();}});// Prevent closing when clicking image img.addEventListener('click',(e)=> e.stopPropagation());// Prevent scroll when overlay is open document.body.style.overflow = 'hidden';// Restore scroll on close const originalOverflow = document.body.style.overflow;const restoreScroll =()=>{document.body.style.overflow = originalOverflow;overlay.removeEventListener('transitionend',restoreScroll);};overlay.addEventListener('transitionend',restoreScroll);}// ✅ ADD THIS TO YOUR CLASS resizeImage(file,maxWidth = 800,maxHeight = 600){return new Promise((resolve,reject)=>{const reader = new FileReader();reader.onload =(e)=>{const img = new Image();img.onload =()=>{// Calculate new dimensions while maintaining aspect ratio let width = img.width;let height = img.height;if(width > height){if(width > maxWidth){height = Math.round(height * maxWidth / width);width = maxWidth;}}else{if(height > maxHeight){width = Math.round(width * maxHeight / height);height = maxHeight;}}// Create canvas for resizing const canvas = document.createElement('canvas');canvas.width = width;canvas.height = height;const ctx = canvas.getContext('2d');ctx.drawImage(img,0,0,width,height);// Convert to base64 with quality compression const resizedDataUrl = canvas.toDataURL('image/jpeg',0.85);// 85% quality resolve(resizedDataUrl);};img.onerror = reject;img.src = e.target.result;};reader.onerror = reject;reader.readAsDataURL(file);});}// ✅ ADD THIS NEW METHOD - generates consistent colors from entityType name getEntityTypeColor(entityType){// Simple hash function for consistent color generation const hash = entityType.split('').reduce((acc,char)=>{return acc + char.charCodeAt(0);},0);// Generate consistent HSL color from hash const hue = hash % 360;const saturation = 60 +(hash % 20);// 60-80% const lightness = 92 +(hash % 5);// 92-97% // Generate contrasting text color const textColorHue =(hue + 180)% 360;const textColor = `hsl(${textColorHue},70%,30%)`;const bgColor = `hsl(${hue},${saturation}%,${lightness}%)`;// Generate accent color for borders(darker version)const accentHue = hue;const accentSaturation = saturation + 10;const accentLightness = lightness - 30;const accentColor = `hsl(${accentHue},${accentSaturation}%,${accentLightness}%)`;return{bg:bgColor,color:textColor,accent:accentColor,label:entityType.toUpperCase()};}getEntityFields(entityType){const entityConfig = this.currentApp.entityConfigs[entityType];if(entityConfig && entityConfig.fields){// Return only field names that belong to this entity return entityConfig.fields .filter(field => field.type !== 'system' && field.name !== 'children').map(field => field.name);}// Fallback for common entity types switch(entityType){case 'tenant':return ['name','contactemail'];case 'customer':return ['name','contactemail'];case 'concern':return ['name','description'];default:// Return non-object,non-array fields return [];}}getChildCountInfo(item,entityType){const hierarchy = this.currentApp.hierarchy;const currentIndex = hierarchy.indexOf(entityType);if(currentIndex === -1 || currentIndex >= hierarchy.length - 1){return null;// No children or unknown entity}const childEntityType = hierarchy[currentIndex + 1];const entityConfig = this.currentApp.entityConfigs[entityType];const childrenField = entityConfig?.childrenField || 'children';if(item[childrenField] && Array.isArray(item[childrenField])){const count = item[childrenField].length;const childLabel = childEntityType.charAt(0).toUpperCase()+ childEntityType.slice(1);const pluralLabel = count === 1 ? childLabel:`${childLabel}s`;return `${count}${pluralLabel}`;}// Check if there's a count field if(item.count !== undefined){const count = parseInt(item.count)|| 0;const childLabel = childEntityType.charAt(0).toUpperCase()+ childEntityType.slice(1);const pluralLabel = count === 1 ? childLabel:`${childLabel}s`;return `${count}${pluralLabel}`;}return null;}// Helper method to add action handlers to mobile card addCardActionHandlers(card,item,entityType){const self = this;const editBtn = card.querySelector('.dot-action-btn.edit');const copyBtn = card.querySelector('.dot-action-btn.copy');const deleteBtn = card.querySelector('.dot-action-btn.delete');if(editBtn){editBtn.addEventListener('click',(e)=>{e.stopPropagation();self.hideMobileDotCard();self.editItem(item,entityType);});}if(copyBtn){copyBtn.addEventListener('click',(e)=>{e.stopPropagation();self.hideMobileDotCard();self.duplicateItem(item,entityType);});}if(deleteBtn){deleteBtn.addEventListener('click',(e)=>{e.stopPropagation();if(confirm(`Are you sure you want to delete this ${entityType}?`)){self.hideMobileDotCard();self.deleteItem(item,entityType);}});}}// Improved hideMobileDotCard hideMobileDotCard(){if(this.currentMobileCard){this.currentMobileCard.style.animation = 'slideDown 0.3s ease';setTimeout(()=>{if(this.currentMobileCard){this.currentMobileCard.remove();this.currentMobileCard = null;}},300);}if(this.currentMobileCardOverlay){this.currentMobileCardOverlay.style.animation = 'fadeOut 0.3s ease';setTimeout(()=>{if(this.currentMobileCardOverlay){this.currentMobileCardOverlay.remove();this.currentMobileCardOverlay = null;}},300);}this.isShowingMobileCard = false;}deleteItem(item,entityType){if(confirm(`Are you sure you want to delete this ${entityType}?`)){// Your existing delete logic here this.hideDotInfoCard();}}duplicateItem(item,entityType){// Check if user can add items at this level if(!this.canAddItemsAtCurrentLevel()){alert('You do not have permission to create items here.');return;}// Create a new item based on the existing one const newItem ={...item};// Remove system fields that should be regenerated delete newItem.ID;// This ensures new itemId delete newItem.displayID;delete newItem.hashed;delete newItem.timestamp;delete newItem.count;delete newItem.childrenRef;// Remove relationship fields that need to be recalculated delete newItem.parentId;delete newItem.path;// Add timestamp for the new item newItem.timestamp = Date.now();// Generate unique dotLabel newItem.dotLabel = this.generateUniqueDotLabel(newItem.name,entityType);// Generate unique name newItem.name = `${newItem.name}(copy)`;// ✅ THAT'S IT! By removing ID,generateDotPositions will use // either the new label "(copy)" or fallback to `item_${i}` // which will definitely create a different hash and position // Add the new item using your existing addItem logic this.addItem(entityType,newItem).then(()=>{this.hideDotInfoCard();}).catch((error)=>{console.error('Failed to duplicate item:',error);alert('Failed to duplicate item. Please try again.');});}canAddItemsAtCurrentLevel(){const currentDepth = this.currentPath.length;// Browser 1(data owner)- full access if(this.isDataOwner()){return true;}// Browser 2(shared user)- check writeAccess if(currentDepth === 0){return false;// Can't create at root level}// Get the parent entity that would contain the new item const parentEntity = this.getParentEntity();if(!parentEntity){return false;}// Check parent's writeAccess policy const writeAccess = parentEntity.writeAccess || 'owner';switch(writeAccess){case 'any':return true;case 'parent':// Can add if we have direct access to parent return this.hasAccessToEntity(parentEntity);case 'ancestor':// Can add if we have access to any ancestor return this.hasAncestorAccess();case 'owner':default:return false;}}getParentEntity(){if(this.currentPath.length === 0){return null;// Root level}// Return the entity at current depth - 1 const parentDepth = this.currentPath.length - 1;return this.getEntityAtDepth(parentDepth);}// ✅ UPDATED NAVIGATE TO METHOD WITH FULL HISTORY SUPPORT navigateTo(item,entityType){this.stopVersionPolling();const currentDepth = this.currentPath.length;const targetDepth = currentDepth + 1;// Always update currentPath and render const newPath = [...this.currentPath,{id:item.ID,displayID:item.displayID,hashed:item.hashed,shortName:this.getShortName(item,entityType),entityType:entityType}];this.currentPath = newPath;this.render();this.updateBreadcrumb();this.updateWatermark();// Create history state with depth information const historyState ={depth:targetDepth,path:newPath.map(p =>({id:p.id,entityType:p.entityType}))};// Determine URL to use if(targetDepth <= 2){// Real URL for supported levels(0,1,2)const newUrl = this.getAppUrl(this.currentPath);window.history.pushState(historyState,'',newUrl);}else{// Same URL but different history entry for deeper levels(3+)const currentUrl = window.location.pathname + window.location.search;window.history.pushState(historyState,'',currentUrl);}// After loading customer data}updateUrl(){const baseUrl = '/t/apps/';const appId = this.currentApp?.id || 'custsupport';if(this.currentPath.length === 0){window.history.pushState({},'',`${baseUrl}${appId}`);}else{const pathIds = this.currentPath.map(item => item.displayID).join('/');window.history.pushState({},'',`${baseUrl}${appId}/${pathIds}`);}}updateBreadcrumb(){if(!this.currentApp){this.breadcrumb.innerHTML = '<span style="color:#666;">Apps</span>';return;}const self = this;const context = this.getViewingContext();const isMobile = window.innerWidth <= 768;));// Helper:truncate text safely const truncateText =(text,maxLength)=>{if(!text || text.length <= maxLength)return text;return text.substring(0,maxLength - 3)+ '...';};// Helper:format breadcrumb segment const formatSegment =(displayName,displayID,isClickable,dataIndex)=>{const nameLen = isMobile ? 6:10;const idLen = isMobile ? 4:8;const truncatedName = truncateText(displayName,nameLen);const truncatedID = truncateText(displayID,idLen);if(isMobile){const clickableStyle = isClickable ? `color:#667eea;text-decoration:none;`:`color:#999;cursor:not-allowed;`;return ` <${isClickable ? 'a':'span'}${isClickable ? `href="#" data-index="${dataIndex}"`:''}title="${displayName}(${displayID})" style="display:inline-flex;align-items:center;max-width:70px;${clickableStyle}font-size:11px;white-space:nowrap;"> <span style="font-weight:500;overflow:hidden;text-overflow:ellipsis;">${truncatedName}</span> <span style="font-size:9px;color:${isClickable ? '#999':'#bbb'};margin-left:2px;overflow:hidden;text-overflow:ellipsis;">${truncatedID}</span> </${isClickable ? 'a':'span'}> `;}else{const displayText = `${truncatedName}(${truncatedID})`;if(isClickable){return `<a href="#" data-index="${dataIndex}" title="${displayName}(${displayID})">${displayText}</a>`;}else{return `<span style="color:#999;cursor:not-allowed;" title="${displayName}(${displayID})">${displayText}</span>`;}}};// Start with Home let html = '<a href="#" data-index="0">Home</a>';// Add app name(always clickable for app owners)if(this.currentApp){const appName = truncateText(this.currentApp.name,15);// ✅ FIXED:App ID always clickable for app owners(any depth)if(isowner){html += ` / <a href="#" data-index="1" title="${this.currentApp.name}">${appName}</a>`;}else{html += ` / <span title="${this.currentApp.name}">${appName}</span>`;}}// Add path segments this.currentPath.forEach((seg,idx)=>{});// Determine if current user is data owner const isDataOwner = this.isDataOwner();this.currentPath.forEach((seg,idx)=>{// Always use displayID for consistent formatting const displayID = seg.displayID || this.db.hashUUID(seg.id);const displayName = seg.shortName || displayID;// ✅ FINAL CLICKABILITY LOGIC let isClickable = true;if(isDataOwner){// Browser 1:All path segments are clickable isClickable = true;}else{// Browser 2:Only allow navigation back to immediate parent levels // Don't allow jumping to root/tenant level if(this.currentPath.length <= 1){// At tenant or customer level - no navigation needed isClickable = false;}else{// At concern level or deeper - allow navigation to ancestors EXCEPT tenant // idx 0 = tenant(never clickable for Browser 2)// idx >= 1 = customer and below(clickable if within current path)isClickable =(idx > 0 && idx <= this.currentPath.length - 1);}}html += ' / ' + formatSegment(displayName,displayID,isClickable,idx + 2);});// Apply to DOM const breadcrumb = document.getElementById('breadcrumb');breadcrumb.innerHTML = html;// Mobile styling if(isMobile){Object.assign(breadcrumb.style,{padding:'6px 10px',fontSize:'10px',gap:'1px',maxWidth:'calc(100vw - 20px)',overflowX:'auto',whiteSpace:'nowrap',display:'flex',alignItems:'center',lineHeight:'1'});breadcrumb.querySelectorAll('a,span').forEach(el =>{Object.assign(el.style,{display:'inline-flex',alignItems:'center',whiteSpace:'nowrap'});});}// Click handlers breadcrumb.querySelectorAll('a').forEach(link =>{link.addEventListener('click',async(e)=>{e.preventDefault();const index = parseInt(e.currentTarget.dataset.index,10);const isDataOwner = this.isDataOwner();const currentPathLength = this.currentPath.length;// ✅ INDEX 0:HOME - FIXED WITH DIRECT NAVIGATION if(index === 0){if(!this.currentApp){return;}// ✅ CRITICAL FIX:DIRECT NAVIGATION FOR APP OWNERS(NO PUSHSTATE + RELOAD)if(isowner){// ✅ USE DIRECT ASSIGNMENT - GUARANTEES NAVIGATION window.location.href = '/t/apps';return;// Prevents any further execution}// ✅ NON-OWNERS:PRESERVED EXACTLY FROM YOUR ORIGINAL CODE(NO CHANGES)const urlInfo = this.parseUrlForDataFetch();const savedContexts = this.getLastViewedContext(urlInfo?.appId);const savedContext = savedContexts?.[0];if(savedContext && savedContext.path?.length > 0){this.currentPath = [];for(let i = 0;i < savedContext.path.length;i++){const id = savedContext.path[i];let displayID = id;if(displayID.includes('-')){displayID = this.db.hashUUID(id);}const entityType = this.currentApp.hierarchy[i];this.currentPath.push({id:id,displayID:displayID,shortName:this.getShortName({ID:id,displayID},entityType)|| id.substring(0,8),entityType:entityType});}this.updateUrl();const pathContext = this.currentPath.map(item => item.displayID);this.db.getAppData(this.currentApp.id,pathContext).then(data =>{this.data = data;this.render();this.updateBreadcrumb();this.updateWatermark();}).catch(error =>{console.error('[Breadcrumb] Error fetching tenant data:',error);this.render();this.updateBreadcrumb();this.updateWatermark();});}else{this.currentPath = [];this.updateUrl();await this.loadAppSelector();this.data ={items:[]};this.render();this.updateBreadcrumb();this.updateWatermark();}return;}// ✅ INDEX 1:APP ID LINK - PRESERVED FROM YOUR WORKING VERSION if(index === 1 && isowner && this.currentPath.length === 0){// App name clicked by owner at root this.currentPath = [];this.updateUrl();this.render();this.updateBreadcrumb();this.updateWatermark();return;}// ✅ INDEX ≥ 2:PRESERVED EXACTLY FROM YOUR ORIGINAL CODE if(index >= 2){const targetDepth = index - 1;if(targetDepth >= this.currentApp.hierarchy.length){return;}if(targetDepth > 0 && targetDepth <= this.currentPath.length){this.currentPath = this.currentPath.slice(0,targetDepth);const historyState ={depth:targetDepth,path:this.currentPath.map(p =>({id:p.id,entityType:p.entityType,displayID:p.displayID,hashed:p.hashed}))};if(targetDepth <= 2){const newUrl = this.getAppUrl(this.currentPath);window.history.pushState(historyState,'',newUrl);}else{const currentUrl = window.location.pathname + window.location.search;window.history.pushState(historyState,'',currentUrl);}this.render();this.updateBreadcrumb();this.updateWatermark();}}});});}// ✅ HELPER:Get display ID for item getDisplayIdForItem(itemId,entityType){// Try to find the actual item to get its displayID let currentItems = this.data.items;for(let i = 0;i < this.currentPath.length;i++){const pathItem = this.currentPath[i];if(pathItem.id === itemId && pathItem.entityType === entityType){return pathItem.displayID || itemId;}}return itemId;}// ✅ HELPER:Check if item is hashed isItemHashed(itemId,entityType){return false;// Adjust based on your needs}openAddDialogForTenant(){// This uses your existing openAddDialog method // But ensures it's creating a tenant(root level)this.currentPath = [];// Ensure we're at root level this.openAddDialog();}async openAddDialog(){var self = this;const nextEntityType = this.getNextEntityType();if(!nextEntityType){alert('Maximum nesting level reached');return;}const entitySchema = await this.getEntityConfig(nextEntityType);if(!entitySchema){alert('Entity schema not found');return;}const modal = document.getElementById('add-modal');const title = document.getElementById('modal-title');const form = document.getElementById('add-form');title.textContent = 'Add ' + entitySchema.name;form.innerHTML = '';// Build form fields entitySchema.fields.forEach(function(field){// Skip system fields(writePermission:"system")if(field.writePermission === 'system'){return;}// ✅ SIMPLIFIED:Compact single-line controls(like any other field)if(field.name === 'image'){const imageGroup = document.createElement('div');imageGroup.className = 'form-group image-upload-group';// Hidden input for form submission const hiddenInput = document.createElement('input');hiddenInput.type = 'hidden';hiddenInput.name = 'image';imageGroup.appendChild(hiddenInput);// Label const label = document.createElement('label');label.textContent = field.label +(field.mandatory ? ' *':'');imageGroup.appendChild(label);// ✅ SINGLE CONTROL ROW(URL + buttons on same line)const controlRow = document.createElement('div');controlRow.className = 'image-control-row';// URL input(takes most space)const urlInput = document.createElement('input');urlInput.type = 'url';urlInput.className = 'form-control image-url-input';urlInput.placeholder = 'Paste image URL or click 📁 to upload';urlInput.style.flex = '1';urlInput.style.minWidth = '0';// Allow shrinking // Upload button(compact)const uploadBtn = document.createElement('button');uploadBtn.type = 'button';uploadBtn.className = 'btn btn-secondary image-upload-btn';uploadBtn.innerHTML = '📁';uploadBtn.title = 'Upload image file';uploadBtn.style.padding = '0 10px';uploadBtn.style.minWidth = '36px';// Remove button(compact,hidden initially)const removeBtn = document.createElement('button');removeBtn.type = 'button';removeBtn.className = 'btn btn-danger image-remove-btn';removeBtn.innerHTML = '&times;';removeBtn.title = 'Remove image';removeBtn.style.padding = '0 8px';removeBtn.style.minWidth = '28px';removeBtn.style.display = 'none';// Hidden until image selected // Assemble control row controlRow.appendChild(urlInput);controlRow.appendChild(uploadBtn);controlRow.appendChild(removeBtn);// Preview container(below controls)const previewContainer = document.createElement('div');previewContainer.className = 'image-preview';previewContainer.style.marginTop = '8px';previewContainer.style.display = 'none';const previewImg = document.createElement('img');previewImg.style.maxWidth = '100%';previewImg.style.maxHeight = '100px';previewImg.style.borderRadius = '4px';previewImg.style.border = '1px solid #ddd';previewContainer.appendChild(previewImg);// Event handlers uploadBtn.addEventListener('click',()=>{const input = document.createElement('input');input.type = 'file';input.accept = 'image showNotification(message,type = 'success',duration = 3000){// Remove existing notification if any const existing = document.getElementById('notification-toast');if(existing)existing.remove();const toast = document.createElement('div');toast.id = 'notification-toast';toast.style.cssText = ` position:fixed;bottom:30px;left:50%;transform:translateX(-50%);color:white;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:15px;font-weight:500;z-index:10000;animation:slideUp 0.3s ease;`;// ✅ Set background based on notification type if(type === 'error'){toast.style.background = 'linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)';// Red gradient for errors}else{toast.style.background = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)';// Original purple for success}toast.textContent = message;// Add animation const style = document.createElement('style');style.textContent = ` @keyframes slideUp{from{transform:translateX(-50%)translateY(20px);opacity:0;}to{transform:translateX(-50%)translateY(0);opacity:1;}}`;document.head.appendChild(style);document.body.appendChild(toast);// Auto remove after duration setTimeout(()=>{toast.style.animation = 'slideUp 0.3s ease reverse';setTimeout(()=> toast.remove(),300);},duration);}processItemID(item,entityType){if(!item.ID)return;// ✅ KEY FIX:Check if ID is already hashed by checking length/format // Real UUIDs are 36 characters,hashed IDs are shorter(like 12-15 chars)const isProbablyRealUUID = item.ID.length === 36 && item.ID.includes('-');if(!item.displayID){if(isProbablyRealUUID){// ID is real UUID - hash it for display item.displayID = this.db.hashUUID(item.ID);item.hashed = false;// Real item,just displaying hashed ID}else{// ID is already hashed - use as-is for display item.displayID = item.ID;item.hashed = true;// This is a hashed ID}}else{// Server provided displayID - trust it item.hashed = !isProbablyRealUUID;}}getUserLoginStatus(){// Implement your user authentication check // This could check localStorage,session,cookies,etc. const userData = localStorage.getItem('userloggedin');return userData ? JSON.parse(userData):null;}async openSchemaManager(){var self = this;document.getElementById('schema-modal').style.display = 'block';await this.loadAppSchemas();await this.loadNativeEntities();// Set up button handlers document.getElementById('add-app-schema').onclick = function(){self.createAppSchema();};document.getElementById('add-native-entity').onclick = function(){self.createNativeEntity();};// Tab switching handlers(enhanced to include JSON tab)document.querySelectorAll('.tab').forEach(function(tab){tab.addEventListener('click',function(e){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active');});e.target.classList.add('active');document.getElementById(e.target.dataset.tab).classList.add('active');});});// Close handler document.getElementById('close-schema-modal').onclick = function(){document.getElementById('schema-modal').style.display = 'none';};// Load the initial content await this.loadAppSchemas();await this.loadNativeEntities();}async loadAppSchemas(){var self = this;const container = document.getElementById('app-schemas-list');const schemas = await this.db.getAppSchemas();container.innerHTML = '';schemas.forEach(function(schema){const card = document.createElement('div');card.className = 'schema-card';card.innerHTML = '<div class="schema-card-header">' + '<h3>' + schema.name + '</h3>' + '<div>' + '<button class="btn btn-primary" style="margin-right:10px;">Edit</button>' + '<button class="btn btn-danger">Delete</button>' + '</div>' + '</div>' + '<p style="color:#666;margin-bottom:10px;">' + schema.description + '</p>' + '<p style="color:#999;font-size:13px;">' + '<strong>Hierarchy:</strong> ' + schema.hierarchy.join(' → ')+ '</p>';card.querySelector('.btn-primary').onclick = function(){self.editAppSchema(schema);};card.querySelector('.btn-danger').onclick = async function(){if(confirm('Delete app schema "' + schema.name + '"?')){await self.db.deleteAppSchema(schema.id);await self.loadAppSchemas();}};container.appendChild(card);});}async loadNativeEntities(){var self = this;const container = document.getElementById('native-entities-list');const entities = await this.db.getNativeEntities();container.innerHTML = '';Object.keys(entities).forEach(function(key){const entity = entities[key];const card = document.createElement('div');card.className = 'entity-item';card.innerHTML = '<div class="entity-header">' + '<div>' + '<h4>' + entity.name + '</h4>' + '<p style="color:#666;font-size:13px;">' + entity.description + '</p>' + '</div>' + '<div>' + '<button class="btn btn-primary" style="margin-right:10px;">Edit</button>' + '<button class="btn btn-danger">Delete</button>' + '</div>' + '</div>' + '<div class="field-list">' + '<strong>Fields(' + entity.fields.length + '):</strong> ' + entity.fields.map(function(f){return f.label;}).join(',')+ '</div>';card.querySelector('.btn-primary').onclick = function(){self.editNativeEntity(key,entity);};card.querySelector('.btn-danger').onclick = async function(){if(confirm('Delete entity "' + entity.name + '"?')){await self.db.deleteNativeEntity(key);await self.loadNativeEntities();}};container.appendChild(card);});}createAppSchema(){this.editAppSchema({id:'new_' + Date.now(),name:'New App',description:'',hierarchy:[],entityConfigs:{}});}async editAppSchema(schema){var self = this;const modal = document.getElementById('app-schema-editor-modal');const title = document.getElementById('app-schema-editor-title');const content = document.getElementById('app-schema-editor-content');title.textContent = schema.id.startsWith('new_')? 'Create App Schema':'Edit App Schema';const entities = await this.db.getNativeEntities();const entityKeys = Object.keys(entities);content.innerHTML = '<div class="form-group">' + '<label>App ID</label>' + '<input type="text" id="schema-id" required placeholder="e.g. hr-support">' + '</div>' + '<div class="form-group">' + '<label>App Name</label>' + '<input type="text" id="schema-name" value="' + schema.name + '">' + '</div>' + '<div class="form-group">' + '<label>Description</label>' + '<textarea id="schema-description">' + schema.description + '</textarea>' + '</div>' + '<div class="form-group">' + '<label>Hierarchy(in order)</label>' + '<div id="hierarchy-list"></div>' + '<select id="add-hierarchy-entity" style="margin-top:10px;">' + '<option value="">-- Add Entity --</option>' + entityKeys.map(function(key){return '<option value="' + key + '">' + entities[key].name + '</option>';}).join('')+ '</select>' + '</div>' + '<div class="form-group">' + '<label>Sort Configuration</label>' + '<div id="sort-config-list"></div>' + '</div>' + '<div style="margin-top:20px;">' + '<button class="btn btn-primary" id="save-app-schema">Save</button>' + '<button class="btn btn-secondary" id="cancel-app-schema">Cancel</button>' + '</div>';// Render hierarchy list const hierarchyList = content.querySelector('#hierarchy-list');const updateHierarchyList = function(){hierarchyList.innerHTML = '';schema.hierarchy.forEach(function(entityType,index){const item = document.createElement('div');item.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f5f5f5;margin-bottom:5px;border-radius:4px;';item.innerHTML = '<span>' +(index + 1)+ '. ' +(entities[entityType] ? entities[entityType].name:entityType)+ '</span>' + '<div>' +(index > 0 ? '<button class="btn-secondary" style="padding:4px 8px;margin-right:5px;">↑</button>':'')+(index < schema.hierarchy.length - 1 ? '<button class="btn-secondary" style="padding:4px 8px;margin-right:5px;">↓</button>':'')+ '<button class="btn-danger" style="padding:4px 8px;">Remove</button>' + '</div>';const buttons = item.querySelectorAll('button');let btnIndex = 0;if(index > 0){buttons[btnIndex++].onclick = function(){var temp = schema.hierarchy[index];schema.hierarchy[index] = schema.hierarchy[index - 1];schema.hierarchy[index - 1] = temp;updateHierarchyList();updateSortConfigs();};}if(index < schema.hierarchy.length - 1){buttons[btnIndex++].onclick = function(){var temp = schema.hierarchy[index];schema.hierarchy[index] = schema.hierarchy[index + 1];schema.hierarchy[index + 1] = temp;updateHierarchyList();updateSortConfigs();};}buttons[btnIndex].onclick = function(){schema.hierarchy.splice(index,1);updateHierarchyList();updateSortConfigs();};hierarchyList.appendChild(item);});};// Replace the entire sort config rendering section in editAppSchema const updateSortConfigs = function(){const sortConfigList = content.querySelector('#sort-config-list');sortConfigList.innerHTML = '';schema.hierarchy.forEach(function(entityType,index){const nextEntity = index < schema.hierarchy.length - 1 ? schema.hierarchy[index + 1]:null;if(nextEntity){// Only for entities that have children const config = schema.entityConfigs[entityType] ||{};const sortConfig = config.sortConfig ||{type:'count'};const sortDiv = document.createElement('div');sortDiv.style.cssText = 'border:1px solid #ddd;padding:10px;margin-bottom:10px;border-radius:4px;';sortDiv.innerHTML = '<h4>' +(entities[entityType] ? entities[entityType].name:entityType)+ '</h4>' + '<p style="color:#666;font-size:12px;margin-bottom:10px;">' + 'This dot size is determined by:<strong>children in ' +(entities[nextEntity] ? entities[nextEntity].name:nextEntity)+ 's</strong>' + '</p>' + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' + '<div>' + '<label style="font-size:12px;">Sort Method</label>' + '<select data-entity="' + entityType + '" data-prop="type" style="width:100%;padding:6px;">' + '<option value="count" ' +(sortConfig.type === 'count' ? 'selected':'')+ '>Count of ' + nextEntity + 's</option>' + '<option value="aggregate" ' +(sortConfig.type === 'aggregate' ? 'selected':'')+ '>Aggregate ' + nextEntity + ' data</option>' + '</select>' + '</div>' + '<div class="aggregate-fields-' + entityType + '" style="display:' +(sortConfig.type === 'aggregate' ? 'block':'none')+ ';">' + '<label style="font-size:12px;">Function</label>' + '<select data-entity="' + entityType + '" data-prop="aggregateFunction" style="width:100%;padding:6px;">' + '<option value="sum" ' +(sortConfig.aggregateFunction === 'sum' ? 'selected':'')+ '>Sum</option>' + '<option value="avg" ' +(sortConfig.aggregateFunction === 'avg' ? 'selected':'')+ '>Average</option>' + '<option value="max" ' +(sortConfig.aggregateFunction === 'max' ? 'selected':'')+ '>Max</option>' + '<option value="min" ' +(sortConfig.aggregateFunction === 'min' ? 'selected':'')+ '>Min</option>' + '</select>' + '</div>' + '<div class="aggregate-fields-' + entityType + '" style="grid-column:1 / -1;display:' +(sortConfig.type === 'aggregate' ? 'block':'none')+ ';">' + '<label style="font-size:12px;">Field to Aggregate(in ' + nextEntity + ')</label>' + '<input type="text" data-entity="' + entityType + '" data-prop="aggregateField" ' + 'value="' +(sortConfig.aggregateField || '')+ '" ' + 'placeholder="e.g.,count,amount,priority" ' + 'style="width:100%;padding:6px;">' + '</div>' + '</div>';// Add dynamic show/hide for aggregate fields const typeSelect = sortDiv.querySelector('select[data-entity="' + entityType + '"][data-prop="type"]');typeSelect.addEventListener('change',function(e){const aggregateFields = sortDiv.querySelectorAll('.aggregate-fields-' + entityType);aggregateFields.forEach(function(field){field.style.display = e.target.value === 'aggregate' ? 'block':'none';});});sortConfigList.appendChild(sortDiv);}});// Add event listeners for sort config changes sortConfigList.querySelectorAll('select[data-entity],input[data-entity]').forEach(function(input){input.addEventListener('change',function(e){const entityType = e.target.dataset.entity;const prop = e.target.dataset.prop;const value = e.target.value;if(!schema.entityConfigs[entityType]){schema.entityConfigs[entityType] ={};}if(!schema.entityConfigs[entityType].sortConfig){schema.entityConfigs[entityType].sortConfig ={};}schema.entityConfigs[entityType].sortConfig[prop] = value;});});};updateHierarchyList();updateSortConfigs();// Add hierarchy entity content.querySelector('#add-hierarchy-entity').onchange = function(e){if(e.target.value && !schema.hierarchy.includes(e.target.value)){schema.hierarchy.push(e.target.value);if(!schema.entityConfigs[e.target.value]){const entity = entities[e.target.value];const labelField = entity.fields.find(function(f){return f.name.includes('name');})? entity.fields.find(function(f){return f.name.includes('name');}).name:entity.fields[0].name;const idField = entity.fields.find(function(f){return f.name.includes('id');})? entity.fields.find(function(f){return f.name.includes('id');}).name:entity.fields[0].name;schema.entityConfigs[e.target.value] ={labelField:labelField,idField:idField,childEntity:null,childrenField:e.target.value + 's'};}updateHierarchyList();updateSortConfigs();e.target.value = '';}};// Save handler content.querySelector('#save-app-schema').onclick = async function(){const idInput = content.querySelector('#schema-id');const nameInput = content.querySelector('#schema-name');let ok = true;[idInput,nameInput].forEach(inp => inp.classList.remove('input-error'));if(!idInput.value.trim()){idInput.classList.add('input-error');ok = false;}if(!nameInput.value.trim()){nameInput.classList.add('input-error');ok = false;}if(!ok)return;// stop here – user sees red borders schema.id = idInput.value.trim();schema.name = nameInput.value.trim();schema.description = content.querySelector('#schema-description').value.trim();schema.hierarchy.forEach(function(entityType,index){const nextEntity = index < schema.hierarchy.length - 1 ? schema.hierarchy[index + 1]:null;if(!schema.entityConfigs[entityType]){schema.entityConfigs[entityType] ={};}schema.entityConfigs[entityType].childrenField = nextEntity ? nextEntity.toLowerCase()+ 's':null;});await self.db.saveAppSchema(schema);modal.style.display = 'none';await self.loadAppSchemas();};content.querySelector('#cancel-app-schema').onclick = function(){modal.style.display = 'none';};modal.style.display = 'block';}getBaseEntityFields(){return [{name:'ID',label:'ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'displayID',label:'Display ID',type:'text',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'name',label:'Name',type:'text',mandatory:true,writePermission:'any',dataSource:'manual'},{name:'dotLabel',label:'Dot Label',type:'text',mandatory:true,writePermission:'any',dataSource:'manual'},{name:'timestamp',label:'Timestamp',type:'number',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'count',label:'Count',type:'number',mandatory:false,writePermission:'any',dataSource:'manual'},{name:'hidden',label:'Hidden',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'hashed',label:'Hashed',type:'checkbox',mandatory:false,writePermission:'system',dataSource:'manual'},{name:'image',label:'Image URL',type:'url',mandatory:false,writePermission:'any',dataSource:'manual'},{name:'website',label:'Website URL',type:'url',mandatory:false,writePermission:'any',dataSource:'manual'},{name:'writeAccess',label:'Write Access',type:'select',mandatory:false,writePermission:'root',dataSource:'manual',options:['owner','parent','ancestor','any']},{name:'readAccess',label:'Read Access',type:'select',mandatory:false,writePermission:'root',dataSource:'manual',options:['owner','parent','ancestor','any']}];}createNativeEntity(){const baseEntity ={name:'New Entity',description:'',fields:this.getBaseEntityFields()};this.editNativeEntity('new_entity_' + Date.now(),baseEntity);}editNativeEntity(key,entity){const modal = document.getElementById('entity-editor-modal');const title = document.getElementById('entity-editor-title');const content = document.getElementById('entity-editor-content');title.textContent = key.startsWith('new_')? 'Create Native Entity':'Edit Native Entity';content.innerHTML = '<div class="form-group">' + '<label>Entity Key</label>' + '<input type="text" id="entity-key" value="' + key + '" ' +(!key.startsWith('new_')? 'readonly':'')+ '>' + '</div>' + '<div class="form-group">' + '<label>Entity Name</label>' + '<input type="text" id="entity-name" value="' + entity.name + '">' + '</div>' + '<div class="form-group">' + '<label>Description</label>' + '<textarea id="entity-description">' + entity.description + '</textarea>' + '</div>' + '<div class="form-group">' + '<label>Fields</label>' + '<div id="entity-fields-list"></div>' + '<button class="btn btn-primary" id="add-entity-field" style="margin-top:10px;">+ Add Field</button>' + '</div>' + '<div style="margin-top:20px;">' + '<button class="btn btn-primary" id="save-entity">Save</button>' + '<button class="btn btn-secondary" id="cancel-entity">Cancel</button>' + '</div>';const fieldsList = content.querySelector('#entity-fields-list');// Inside editNativeEntity(),replace the field rendering section with:const renderFields = function(){fieldsList.innerHTML = '';entity.fields.forEach(function(field,index){const fieldDiv = document.createElement('div');fieldDiv.className = 'field-item';// System ID field(read-only)if(field.name === 'ID'){fieldDiv.innerHTML = ` <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr auto;gap:10px;align-items:end;"> <div><label style="font-size:12px;">Name</label> <input type="text" value="ID" readonly style="background-color:#e8f4f8;"></div> <div><label style="font-size:12px;">Label</label> <input type="text" value="ID" readonly style="background-color:#e8f4f8;"></div> <div><label style="font-size:12px;">Type</label> <select disabled style="background-color:#e8f4f8;"><option>Text</option></select></div> <div><label style="font-size:12px;">Write Permission</label> <select disabled style="background-color:#e8f4f8;"><option>system</option></select></div> <div><label style="font-size:12px;">Data Source</label> <select disabled style="background-color:#e8f4f8;"><option>manual</option></select></div> <button class="btn-danger" disabled>System Field</button> </div> <div style="margin-top:5px;font-size:11px;color:#17a2b8;">🔒 System-generated unique identifier</div> `;}// Regular fields else{const writePermissionOptions = ` <option value="any" ${field.writePermission === 'any' ? 'selected':''}>Any User</option> <option value="parent" ${field.writePermission === 'parent' ? 'selected':''}>Parent Only</option> <option value="root" ${field.writePermission === 'root' ? 'selected':''}>Root Tenant</option> <option value="owner" ${field.writePermission === 'owner' ? 'selected':''}>App Owner</option> <option value="system" ${field.writePermission === 'system' ? 'selected':''}>System Only</option> `;const dataSourceOptions = ` <option value="manual" ${field.dataSource === 'manual' ? 'selected':''}>Manual Input</option> <option value="web" ${field.dataSource === 'web' ? 'selected':''}>Web API</option> <option value="api" ${field.dataSource === 'api' ? 'selected':''}>Internal API</option> `;fieldDiv.innerHTML = ` <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr auto;gap:10px;align-items:end;"> <div><label style="font-size:12px;">Name</label> <input type="text" value="${field.name}" data-index="${index}" data-prop="name"></div> <div><label style="font-size:12px;">Label</label> <input type="text" value="${field.label}" data-index="${index}" data-prop="label"></div> <div><label style="font-size:12px;">Type</label> <select data-index="${index}" data-prop="type"> <option value="text" ${field.type === 'text' ? 'selected':''}>Text</option> <option value="textarea" ${field.type === 'textarea' ? 'selected':''}>Textarea</option> <option value="email" ${field.type === 'email' ? 'selected':''}>Email</option> <option value="checkbox" ${field.type === 'checkbox' ? 'selected':''}>Checkbox</option> <option value="select" ${field.type === 'select' ? 'selected':''}>Select</option> </select></div> <div><label style="font-size:12px;">Write Permission</label> <select data-index="${index}" data-prop="writePermission">${writePermissionOptions}</select></div> <div><label style="font-size:12px;">Data Source</label> <select data-index="${index}" data-prop="dataSource">${dataSourceOptions}</select></div> <button class="btn-danger" data-index="${index}">Remove</button> </div> ${field.type === 'select' ? ` <div style="margin-top:5px;"> <label style="font-size:12px;">Options(comma-separated)</label> <input type="text" value="${field.options ? field.options.join(','):''}" data-index="${index}" data-prop="optionsStr" placeholder="Option1,Option2,Option3" style="width:100%;padding:4px;margin-top:2px;"> </div>`:''}<div style="margin-top:5px;display:flex;gap:10px;align-items:center;"> <label style="font-size:12px;display:flex;align-items:center;gap:5px;"> <input type="checkbox" ${field.mandatory ? 'checked':''}data-index="${index}" data-prop="mandatory"> Required </label> </div> `;// Handle option input for select fields const optionsInput = fieldDiv.querySelector(`[data-prop="optionsStr"]`);if(optionsInput){optionsInput.onchange = function(e){const idx = parseInt(e.target.dataset.index);const values = e.target.value.split(',').map(v => v.trim()).filter(v => v);entity.fields[idx].options = values;};}}// Add change handlers for editable fields if(field.name !== 'ID'){fieldDiv.querySelectorAll('input[data-prop],select[data-prop]').forEach(function(input){input.onchange = function(e){const idx = parseInt(e.target.dataset.index);const prop = e.target.dataset.prop;if(prop === 'mandatory'){entity.fields[idx][prop] = e.target.checked;}else if(prop === 'optionsStr'){// Handled separately above}else{entity.fields[idx][prop] = e.target.value;}};});fieldDiv.querySelector('button').onclick = function(){entity.fields.splice(index,1);renderFields();};}fieldsList.appendChild(fieldDiv);});};renderFields();content.querySelector('#add-entity-field').onclick =()=>{// Don't allow adding ID field manually entity.fields.push({name:'newfield',label:'New Field',type:'text',mandatory:false});renderFields();};content.querySelector('#save-entity').onclick = async()=>{const newKey = content.querySelector('#entity-key').value;entity.name = content.querySelector('#entity-name').value;entity.description = content.querySelector('#entity-description').value;if(newKey !== key)await this.db.deleteNativeEntity(key);await this.db.saveNativeEntity(newKey,entity);modal.style.display = 'none';await this.loadNativeEntities();};content.querySelector('#cancel-entity').onclick = function(){modal.style.display = 'none';};modal.style.display = 'block';}}function displayapprootaccesssmessage(){var div = document.createElement("div");div.id = "notification-div";div.style.position = "fixed";div.style.bottom = "25px";div.style.width = "80%";div.style.left = "10%";div.style.right = "10%";div.style.backgroundColor = "#fafafa";div.style.color = "#787878";div.style.textAlign = "center";div.style.fontSize = "18px";div.style.padding = "10px";div.style.border = "1px solid #ccc";div.style.borderRadius = "20px";div.innerHTML = "Access to this page is retricted.";document.body.appendChild(div);//alert('No data');}// Also handle the canvas area height calculation function updateCanvasHeight(){const header = document.querySelector('.app-header');const breadcrumb = document.getElementById('breadcrumb');const headerHeight = header ? header.offsetHeight:0;const breadcrumbHeight = breadcrumb ? breadcrumb.offsetHeight:0;const totalHeaderHeight = headerHeight + breadcrumbHeight;const canvasArea = document.getElementById('canvas-area');if(canvasArea){canvasArea.style.height = `calc(100vh - ${totalHeaderHeight}px)`;canvasArea.style.height = `calc(var(--vh,1vh)* 100 - ${totalHeaderHeight}px)`;}}// Initialize when DOM is ready if(typeof window !== 'undefined'){window.SchemaOrchestrator = SchemaOrchestrator;window.DatabaseService = DatabaseService;// At the very top let originalRender = SchemaOrchestrator.prototype.render;SchemaOrchestrator.prototype.render = function(){.stack.split('\n')[2]);return originalRender.call(this);};}